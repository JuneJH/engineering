{"remainingRequest":"/Users/june/Desktop/work/engineering/node_modules/babel-loader/lib/index.js!/Users/june/Desktop/work/engineering/node_modules/jquery/dist/jquery.js","dependencies":[{"path":"/Users/june/Desktop/work/engineering/node_modules/jquery/dist/jquery.js","mtime":499162500000},{"path":"/Users/june/Desktop/work/engineering/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/june/Desktop/work/engineering/node_modules/babel-loader/lib/index.js","mtime":456789000000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:LyohCiAqIGpRdWVyeSBKYXZhU2NyaXB0IExpYnJhcnkgdjMuNi4yCiAqIGh0dHBzOi8vanF1ZXJ5LmNvbS8KICoKICogSW5jbHVkZXMgU2l6emxlLmpzCiAqIGh0dHBzOi8vc2l6emxlanMuY29tLwogKgogKiBDb3B5cmlnaHQgT3BlbkpTIEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UKICogaHR0cHM6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKICoKICogRGF0ZTogMjAyMi0xMi0xM1QxNDo1NloKICovCihmdW5jdGlvbiAoZ2xvYmFsLCBmYWN0b3J5KSB7CiAgInVzZSBzdHJpY3QiOwoKICBpZiAodHlwZW9mIG1vZHVsZSA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAib2JqZWN0IikgewogICAgLy8gRm9yIENvbW1vbkpTIGFuZCBDb21tb25KUy1saWtlIGVudmlyb25tZW50cyB3aGVyZSBhIHByb3BlciBgd2luZG93YAogICAgLy8gaXMgcHJlc2VudCwgZXhlY3V0ZSB0aGUgZmFjdG9yeSBhbmQgZ2V0IGpRdWVyeS4KICAgIC8vIEZvciBlbnZpcm9ubWVudHMgdGhhdCBkbyBub3QgaGF2ZSBhIGB3aW5kb3dgIHdpdGggYSBgZG9jdW1lbnRgCiAgICAvLyAoc3VjaCBhcyBOb2RlLmpzKSwgZXhwb3NlIGEgZmFjdG9yeSBhcyBtb2R1bGUuZXhwb3J0cy4KICAgIC8vIFRoaXMgYWNjZW50dWF0ZXMgdGhlIG5lZWQgZm9yIHRoZSBjcmVhdGlvbiBvZiBhIHJlYWwgYHdpbmRvd2AuCiAgICAvLyBlLmcuIHZhciBqUXVlcnkgPSByZXF1aXJlKCJqcXVlcnkiKSh3aW5kb3cpOwogICAgLy8gU2VlIHRpY2tldCB0cmFjLTE0NTQ5IGZvciBtb3JlIGluZm8uCiAgICBtb2R1bGUuZXhwb3J0cyA9IGdsb2JhbC5kb2N1bWVudCA/IGZhY3RvcnkoZ2xvYmFsLCB0cnVlKSA6IGZ1bmN0aW9uICh3KSB7CiAgICAgIGlmICghdy5kb2N1bWVudCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigialF1ZXJ5IHJlcXVpcmVzIGEgd2luZG93IHdpdGggYSBkb2N1bWVudCIpOwogICAgICB9CiAgICAgIHJldHVybiBmYWN0b3J5KHcpOwogICAgfTsKICB9IGVsc2UgewogICAgZmFjdG9yeShnbG9iYWwpOwogIH0KCiAgLy8gUGFzcyB0aGlzIGlmIHdpbmRvdyBpcyBub3QgZGVmaW5lZCB5ZXQKfSkodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgPyB3aW5kb3cgOiB0aGlzLCBmdW5jdGlvbiAod2luZG93LCBub0dsb2JhbCkgewogIC8vIEVkZ2UgPD0gMTIgLSAxMyssIEZpcmVmb3ggPD0xOCAtIDQ1KywgSUUgMTAgLSAxMSwgU2FmYXJpIDUuMSAtIDkrLCBpT1MgNiAtIDkuMQogIC8vIHRocm93IGV4Y2VwdGlvbnMgd2hlbiBub24tc3RyaWN0IGNvZGUgKGUuZy4sIEFTUC5ORVQgNC41KSBhY2Nlc3NlcyBzdHJpY3QgbW9kZQogIC8vIGFyZ3VtZW50cy5jYWxsZWUuY2FsbGVyICh0cmFjLTEzMzM1KS4gQnV0IGFzIG9mIGpRdWVyeSAzLjAgKDIwMTYpLCBzdHJpY3QgbW9kZSBzaG91bGQgYmUgY29tbW9uCiAgLy8gZW5vdWdoIHRoYXQgYWxsIHN1Y2ggYXR0ZW1wdHMgYXJlIGd1YXJkZWQgaW4gYSB0cnkgYmxvY2suCiAgInVzZSBzdHJpY3QiOwoKICB2YXIgYXJyID0gW107CiAgdmFyIGdldFByb3RvID0gT2JqZWN0LmdldFByb3RvdHlwZU9mOwogIHZhciBzbGljZSA9IGFyci5zbGljZTsKICB2YXIgZmxhdCA9IGFyci5mbGF0ID8gZnVuY3Rpb24gKGFycmF5KSB7CiAgICByZXR1cm4gYXJyLmZsYXQuY2FsbChhcnJheSk7CiAgfSA6IGZ1bmN0aW9uIChhcnJheSkgewogICAgcmV0dXJuIGFyci5jb25jYXQuYXBwbHkoW10sIGFycmF5KTsKICB9OwogIHZhciBwdXNoID0gYXJyLnB1c2g7CiAgdmFyIGluZGV4T2YgPSBhcnIuaW5kZXhPZjsKICB2YXIgY2xhc3MydHlwZSA9IHt9OwogIHZhciB0b1N0cmluZyA9IGNsYXNzMnR5cGUudG9TdHJpbmc7CiAgdmFyIGhhc093biA9IGNsYXNzMnR5cGUuaGFzT3duUHJvcGVydHk7CiAgdmFyIGZuVG9TdHJpbmcgPSBoYXNPd24udG9TdHJpbmc7CiAgdmFyIE9iamVjdEZ1bmN0aW9uU3RyaW5nID0gZm5Ub1N0cmluZy5jYWxsKE9iamVjdCk7CiAgdmFyIHN1cHBvcnQgPSB7fTsKICB2YXIgaXNGdW5jdGlvbiA9IGZ1bmN0aW9uIGlzRnVuY3Rpb24ob2JqKSB7CiAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD01NywgRmlyZWZveCA8PTUyCiAgICAvLyBJbiBzb21lIGJyb3dzZXJzLCB0eXBlb2YgcmV0dXJucyAiZnVuY3Rpb24iIGZvciBIVE1MIDxvYmplY3Q+IGVsZW1lbnRzCiAgICAvLyAoaS5lLiwgYHR5cGVvZiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAib2JqZWN0IiApID09PSAiZnVuY3Rpb24iYCkuCiAgICAvLyBXZSBkb24ndCB3YW50IHRvIGNsYXNzaWZ5ICphbnkqIERPTSBub2RlIGFzIGEgZnVuY3Rpb24uCiAgICAvLyBTdXBwb3J0OiBRdFdlYiA8PTMuOC41LCBXZWJLaXQgPD01MzQuMzQsIHdraHRtbHRvcGRmIHRvb2wgPD0wLjEyLjUKICAgIC8vIFBsdXMgZm9yIG9sZCBXZWJLaXQsIHR5cGVvZiByZXR1cm5zICJmdW5jdGlvbiIgZm9yIEhUTUwgY29sbGVjdGlvbnMKICAgIC8vIChlLmcuLCBgdHlwZW9mIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJkaXYiKSA9PT0gImZ1bmN0aW9uImApLiAoZ2gtNDc1NikKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgIT09ICJudW1iZXIiICYmIHR5cGVvZiBvYmouaXRlbSAhPT0gImZ1bmN0aW9uIjsKICB9OwogIHZhciBpc1dpbmRvdyA9IGZ1bmN0aW9uIGlzV2luZG93KG9iaikgewogICAgcmV0dXJuIG9iaiAhPSBudWxsICYmIG9iaiA9PT0gb2JqLndpbmRvdzsKICB9OwogIHZhciBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICB2YXIgcHJlc2VydmVkU2NyaXB0QXR0cmlidXRlcyA9IHsKICAgIHR5cGU6IHRydWUsCiAgICBzcmM6IHRydWUsCiAgICBub25jZTogdHJ1ZSwKICAgIG5vTW9kdWxlOiB0cnVlCiAgfTsKICBmdW5jdGlvbiBET01FdmFsKGNvZGUsIG5vZGUsIGRvYykgewogICAgZG9jID0gZG9jIHx8IGRvY3VtZW50OwogICAgdmFyIGksCiAgICAgIHZhbCwKICAgICAgc2NyaXB0ID0gZG9jLmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgc2NyaXB0LnRleHQgPSBjb2RlOwogICAgaWYgKG5vZGUpIHsKICAgICAgZm9yIChpIGluIHByZXNlcnZlZFNjcmlwdEF0dHJpYnV0ZXMpIHsKICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDY0KywgRWRnZSAxOCsKICAgICAgICAvLyBTb21lIGJyb3dzZXJzIGRvbid0IHN1cHBvcnQgdGhlICJub25jZSIgcHJvcGVydHkgb24gc2NyaXB0cy4KICAgICAgICAvLyBPbiB0aGUgb3RoZXIgaGFuZCwganVzdCB1c2luZyBgZ2V0QXR0cmlidXRlYCBpcyBub3QgZW5vdWdoIGFzCiAgICAgICAgLy8gdGhlIGBub25jZWAgYXR0cmlidXRlIGlzIHJlc2V0IHRvIGFuIGVtcHR5IHN0cmluZyB3aGVuZXZlciBpdAogICAgICAgIC8vIGJlY29tZXMgYnJvd3NpbmctY29udGV4dCBjb25uZWN0ZWQuCiAgICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS93aGF0d2cvaHRtbC9pc3N1ZXMvMjM2OQogICAgICAgIC8vIFNlZSBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnLyNub25jZS1hdHRyaWJ1dGVzCiAgICAgICAgLy8gVGhlIGBub2RlLmdldEF0dHJpYnV0ZWAgY2hlY2sgd2FzIGFkZGVkIGZvciB0aGUgc2FrZSBvZgogICAgICAgIC8vIGBqUXVlcnkuZ2xvYmFsRXZhbGAgc28gdGhhdCBpdCBjYW4gZmFrZSBhIG5vbmNlLWNvbnRhaW5pbmcgbm9kZQogICAgICAgIC8vIHZpYSBhbiBvYmplY3QuCiAgICAgICAgdmFsID0gbm9kZVtpXSB8fCBub2RlLmdldEF0dHJpYnV0ZSAmJiBub2RlLmdldEF0dHJpYnV0ZShpKTsKICAgICAgICBpZiAodmFsKSB7CiAgICAgICAgICBzY3JpcHQuc2V0QXR0cmlidXRlKGksIHZhbCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBkb2MuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKICB9CiAgZnVuY3Rpb24gdG9UeXBlKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSB7CiAgICAgIHJldHVybiBvYmogKyAiIjsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9Mi4zIG9ubHkgKGZ1bmN0aW9uaXNoIFJlZ0V4cCkKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAib2JqZWN0IiB8fCB0eXBlb2Ygb2JqID09PSAiZnVuY3Rpb24iID8gY2xhc3MydHlwZVt0b1N0cmluZy5jYWxsKG9iaildIHx8ICJvYmplY3QiIDogdHlwZW9mIG9iajsKICB9CiAgLyogZ2xvYmFsIFN5bWJvbCAqLwogIC8vIERlZmluaW5nIHRoaXMgZ2xvYmFsIGluIC5lc2xpbnRyYy5qc29uIHdvdWxkIGNyZWF0ZSBhIGRhbmdlciBvZiB1c2luZyB0aGUgZ2xvYmFsCiAgLy8gdW5ndWFyZGVkIGluIGFub3RoZXIgcGxhY2UsIGl0IHNlZW1zIHNhZmVyIHRvIGRlZmluZSBnbG9iYWwgb25seSBmb3IgdGhpcyBtb2R1bGUKCiAgdmFyIHZlcnNpb24gPSAiMy42LjIiLAogICAgLy8gRGVmaW5lIGEgbG9jYWwgY29weSBvZiBqUXVlcnkKICAgIGpRdWVyeSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCkgewogICAgICAvLyBUaGUgalF1ZXJ5IG9iamVjdCBpcyBhY3R1YWxseSBqdXN0IHRoZSBpbml0IGNvbnN0cnVjdG9yICdlbmhhbmNlZCcKICAgICAgLy8gTmVlZCBpbml0IGlmIGpRdWVyeSBpcyBjYWxsZWQgKGp1c3QgYWxsb3cgZXJyb3IgdG8gYmUgdGhyb3duIGlmIG5vdCBpbmNsdWRlZCkKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuZm4uaW5pdChzZWxlY3RvciwgY29udGV4dCk7CiAgICB9OwogIGpRdWVyeS5mbiA9IGpRdWVyeS5wcm90b3R5cGUgPSB7CiAgICAvLyBUaGUgY3VycmVudCB2ZXJzaW9uIG9mIGpRdWVyeSBiZWluZyB1c2VkCiAgICBqcXVlcnk6IHZlcnNpb24sCiAgICBjb25zdHJ1Y3RvcjogalF1ZXJ5LAogICAgLy8gVGhlIGRlZmF1bHQgbGVuZ3RoIG9mIGEgalF1ZXJ5IG9iamVjdCBpcyAwCiAgICBsZW5ndGg6IDAsCiAgICB0b0FycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBzbGljZS5jYWxsKHRoaXMpOwogICAgfSwKICAgIC8vIEdldCB0aGUgTnRoIGVsZW1lbnQgaW4gdGhlIG1hdGNoZWQgZWxlbWVudCBzZXQgT1IKICAgIC8vIEdldCB0aGUgd2hvbGUgbWF0Y2hlZCBlbGVtZW50IHNldCBhcyBhIGNsZWFuIGFycmF5CiAgICBnZXQ6IGZ1bmN0aW9uIChudW0pIHsKICAgICAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgaW4gYSBjbGVhbiBhcnJheQogICAgICBpZiAobnVtID09IG51bGwpIHsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgLy8gUmV0dXJuIGp1c3QgdGhlIG9uZSBlbGVtZW50IGZyb20gdGhlIHNldAogICAgICByZXR1cm4gbnVtIDwgMCA/IHRoaXNbbnVtICsgdGhpcy5sZW5ndGhdIDogdGhpc1tudW1dOwogICAgfSwKICAgIC8vIFRha2UgYW4gYXJyYXkgb2YgZWxlbWVudHMgYW5kIHB1c2ggaXQgb250byB0aGUgc3RhY2sKICAgIC8vIChyZXR1cm5pbmcgdGhlIG5ldyBtYXRjaGVkIGVsZW1lbnQgc2V0KQogICAgcHVzaFN0YWNrOiBmdW5jdGlvbiAoZWxlbXMpIHsKICAgICAgLy8gQnVpbGQgYSBuZXcgalF1ZXJ5IG1hdGNoZWQgZWxlbWVudCBzZXQKICAgICAgdmFyIHJldCA9IGpRdWVyeS5tZXJnZSh0aGlzLmNvbnN0cnVjdG9yKCksIGVsZW1zKTsKCiAgICAgIC8vIEFkZCB0aGUgb2xkIG9iamVjdCBvbnRvIHRoZSBzdGFjayAoYXMgYSByZWZlcmVuY2UpCiAgICAgIHJldC5wcmV2T2JqZWN0ID0gdGhpczsKCiAgICAgIC8vIFJldHVybiB0aGUgbmV3bHktZm9ybWVkIGVsZW1lbnQgc2V0CiAgICAgIHJldHVybiByZXQ7CiAgICB9LAogICAgLy8gRXhlY3V0ZSBhIGNhbGxiYWNrIGZvciBldmVyeSBlbGVtZW50IGluIHRoZSBtYXRjaGVkIHNldC4KICAgIGVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmVhY2godGhpcywgY2FsbGJhY2spOwogICAgfSwKICAgIG1hcDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkubWFwKHRoaXMsIGZ1bmN0aW9uIChlbGVtLCBpKSB7CiAgICAgICAgcmV0dXJuIGNhbGxiYWNrLmNhbGwoZWxlbSwgaSwgZWxlbSk7CiAgICAgIH0pKTsKICAgIH0sCiAgICBzbGljZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soc2xpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIHRoaXMuZXEoMCk7CiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5lcSgtMSk7CiAgICB9LAogICAgZXZlbjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soalF1ZXJ5LmdyZXAodGhpcywgZnVuY3Rpb24gKF9lbGVtLCBpKSB7CiAgICAgICAgcmV0dXJuIChpICsgMSkgJSAyOwogICAgICB9KSk7CiAgICB9LAogICAgb2RkOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkuZ3JlcCh0aGlzLCBmdW5jdGlvbiAoX2VsZW0sIGkpIHsKICAgICAgICByZXR1cm4gaSAlIDI7CiAgICAgIH0pKTsKICAgIH0sCiAgICBlcTogZnVuY3Rpb24gKGkpIHsKICAgICAgdmFyIGxlbiA9IHRoaXMubGVuZ3RoLAogICAgICAgIGogPSAraSArIChpIDwgMCA/IGxlbiA6IDApOwogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2soaiA+PSAwICYmIGogPCBsZW4gPyBbdGhpc1tqXV0gOiBbXSk7CiAgICB9LAogICAgZW5kOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLnByZXZPYmplY3QgfHwgdGhpcy5jb25zdHJ1Y3RvcigpOwogICAgfSwKICAgIC8vIEZvciBpbnRlcm5hbCB1c2Ugb25seS4KICAgIC8vIEJlaGF2ZXMgbGlrZSBhbiBBcnJheSdzIG1ldGhvZCwgbm90IGxpa2UgYSBqUXVlcnkgbWV0aG9kLgogICAgcHVzaDogcHVzaCwKICAgIHNvcnQ6IGFyci5zb3J0LAogICAgc3BsaWNlOiBhcnIuc3BsaWNlCiAgfTsKICBqUXVlcnkuZXh0ZW5kID0galF1ZXJ5LmZuLmV4dGVuZCA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciBvcHRpb25zLAogICAgICBuYW1lLAogICAgICBzcmMsCiAgICAgIGNvcHksCiAgICAgIGNvcHlJc0FycmF5LAogICAgICBjbG9uZSwKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAogICAgICBpID0gMSwKICAgICAgbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKICAgICAgZGVlcCA9IGZhbHNlOwoKICAgIC8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAiYm9vbGVhbiIpIHsKICAgICAgZGVlcCA9IHRhcmdldDsKCiAgICAgIC8vIFNraXAgdGhlIGJvb2xlYW4gYW5kIHRoZSB0YXJnZXQKICAgICAgdGFyZ2V0ID0gYXJndW1lbnRzW2ldIHx8IHt9OwogICAgICBpKys7CiAgICB9CgogICAgLy8gSGFuZGxlIGNhc2Ugd2hlbiB0YXJnZXQgaXMgYSBzdHJpbmcgb3Igc29tZXRoaW5nIChwb3NzaWJsZSBpbiBkZWVwIGNvcHkpCiAgICBpZiAodHlwZW9mIHRhcmdldCAhPT0gIm9iamVjdCIgJiYgIWlzRnVuY3Rpb24odGFyZ2V0KSkgewogICAgICB0YXJnZXQgPSB7fTsKICAgIH0KCiAgICAvLyBFeHRlbmQgalF1ZXJ5IGl0c2VsZiBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKICAgIGlmIChpID09PSBsZW5ndGgpIHsKICAgICAgdGFyZ2V0ID0gdGhpczsKICAgICAgaS0tOwogICAgfQogICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAvLyBPbmx5IGRlYWwgd2l0aCBub24tbnVsbC91bmRlZmluZWQgdmFsdWVzCiAgICAgIGlmICgob3B0aW9ucyA9IGFyZ3VtZW50c1tpXSkgIT0gbnVsbCkgewogICAgICAgIC8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKICAgICAgICBmb3IgKG5hbWUgaW4gb3B0aW9ucykgewogICAgICAgICAgY29weSA9IG9wdGlvbnNbbmFtZV07CgogICAgICAgICAgLy8gUHJldmVudCBPYmplY3QucHJvdG90eXBlIHBvbGx1dGlvbgogICAgICAgICAgLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAogICAgICAgICAgaWYgKG5hbWUgPT09ICJfX3Byb3RvX18iIHx8IHRhcmdldCA9PT0gY29weSkgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKICAgICAgICAgIGlmIChkZWVwICYmIGNvcHkgJiYgKGpRdWVyeS5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IEFycmF5LmlzQXJyYXkoY29weSkpKSkgewogICAgICAgICAgICBzcmMgPSB0YXJnZXRbbmFtZV07CgogICAgICAgICAgICAvLyBFbnN1cmUgcHJvcGVyIHR5cGUgZm9yIHRoZSBzb3VyY2UgdmFsdWUKICAgICAgICAgICAgaWYgKGNvcHlJc0FycmF5ICYmICFBcnJheS5pc0FycmF5KHNyYykpIHsKICAgICAgICAgICAgICBjbG9uZSA9IFtdOwogICAgICAgICAgICB9IGVsc2UgaWYgKCFjb3B5SXNBcnJheSAmJiAhalF1ZXJ5LmlzUGxhaW5PYmplY3Qoc3JjKSkgewogICAgICAgICAgICAgIGNsb25lID0ge307CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgY2xvbmUgPSBzcmM7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29weUlzQXJyYXkgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIE5ldmVyIG1vdmUgb3JpZ2luYWwgb2JqZWN0cywgY2xvbmUgdGhlbQogICAgICAgICAgICB0YXJnZXRbbmFtZV0gPSBqUXVlcnkuZXh0ZW5kKGRlZXAsIGNsb25lLCBjb3B5KTsKCiAgICAgICAgICAgIC8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKICAgICAgICAgIH0gZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRhcmdldFtuYW1lXSA9IGNvcHk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSBtb2RpZmllZCBvYmplY3QKICAgIHJldHVybiB0YXJnZXQ7CiAgfTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIFVuaXF1ZSBmb3IgZWFjaCBjb3B5IG9mIGpRdWVyeSBvbiB0aGUgcGFnZQogICAgZXhwYW5kbzogImpRdWVyeSIgKyAodmVyc2lvbiArIE1hdGgucmFuZG9tKCkpLnJlcGxhY2UoL1xEL2csICIiKSwKICAgIC8vIEFzc3VtZSBqUXVlcnkgaXMgcmVhZHkgd2l0aG91dCB0aGUgcmVhZHkgbW9kdWxlCiAgICBpc1JlYWR5OiB0cnVlLAogICAgZXJyb3I6IGZ1bmN0aW9uIChtc2cpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7CiAgICB9LAogICAgbm9vcDogZnVuY3Rpb24gKCkge30sCiAgICBpc1BsYWluT2JqZWN0OiBmdW5jdGlvbiAob2JqKSB7CiAgICAgIHZhciBwcm90bywgQ3RvcjsKCiAgICAgIC8vIERldGVjdCBvYnZpb3VzIG5lZ2F0aXZlcwogICAgICAvLyBVc2UgdG9TdHJpbmcgaW5zdGVhZCBvZiBqUXVlcnkudHlwZSB0byBjYXRjaCBob3N0IG9iamVjdHMKICAgICAgaWYgKCFvYmogfHwgdG9TdHJpbmcuY2FsbChvYmopICE9PSAiW29iamVjdCBPYmplY3RdIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBwcm90byA9IGdldFByb3RvKG9iaik7CgogICAgICAvLyBPYmplY3RzIHdpdGggbm8gcHJvdG90eXBlIChlLmcuLCBgT2JqZWN0LmNyZWF0ZSggbnVsbCApYCkgYXJlIHBsYWluCiAgICAgIGlmICghcHJvdG8pIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgLy8gT2JqZWN0cyB3aXRoIHByb3RvdHlwZSBhcmUgcGxhaW4gaWZmIHRoZXkgd2VyZSBjb25zdHJ1Y3RlZCBieSBhIGdsb2JhbCBPYmplY3QgZnVuY3Rpb24KICAgICAgQ3RvciA9IGhhc093bi5jYWxsKHByb3RvLCAiY29uc3RydWN0b3IiKSAmJiBwcm90by5jb25zdHJ1Y3RvcjsKICAgICAgcmV0dXJuIHR5cGVvZiBDdG9yID09PSAiZnVuY3Rpb24iICYmIGZuVG9TdHJpbmcuY2FsbChDdG9yKSA9PT0gT2JqZWN0RnVuY3Rpb25TdHJpbmc7CiAgICB9LAogICAgaXNFbXB0eU9iamVjdDogZnVuY3Rpb24gKG9iaikgewogICAgICB2YXIgbmFtZTsKICAgICAgZm9yIChuYW1lIGluIG9iaikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICAvLyBFdmFsdWF0ZXMgYSBzY3JpcHQgaW4gYSBwcm92aWRlZCBjb250ZXh0OyBmYWxscyBiYWNrIHRvIHRoZSBnbG9iYWwgb25lCiAgICAvLyBpZiBub3Qgc3BlY2lmaWVkLgogICAgZ2xvYmFsRXZhbDogZnVuY3Rpb24gKGNvZGUsIG9wdGlvbnMsIGRvYykgewogICAgICBET01FdmFsKGNvZGUsIHsKICAgICAgICBub25jZTogb3B0aW9ucyAmJiBvcHRpb25zLm5vbmNlCiAgICAgIH0sIGRvYyk7CiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24gKG9iaiwgY2FsbGJhY2spIHsKICAgICAgdmFyIGxlbmd0aCwKICAgICAgICBpID0gMDsKICAgICAgaWYgKGlzQXJyYXlMaWtlKG9iaikpIHsKICAgICAgICBsZW5ndGggPSBvYmoubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZvciAoaSBpbiBvYmopIHsKICAgICAgICAgIGlmIChjYWxsYmFjay5jYWxsKG9ialtpXSwgaSwgb2JqW2ldKSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBvYmo7CiAgICB9LAogICAgLy8gcmVzdWx0cyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgbWFrZUFycmF5OiBmdW5jdGlvbiAoYXJyLCByZXN1bHRzKSB7CiAgICAgIHZhciByZXQgPSByZXN1bHRzIHx8IFtdOwogICAgICBpZiAoYXJyICE9IG51bGwpIHsKICAgICAgICBpZiAoaXNBcnJheUxpa2UoT2JqZWN0KGFycikpKSB7CiAgICAgICAgICBqUXVlcnkubWVyZ2UocmV0LCB0eXBlb2YgYXJyID09PSAic3RyaW5nIiA/IFthcnJdIDogYXJyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcHVzaC5jYWxsKHJldCwgYXJyKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHJldDsKICAgIH0sCiAgICBpbkFycmF5OiBmdW5jdGlvbiAoZWxlbSwgYXJyLCBpKSB7CiAgICAgIHJldHVybiBhcnIgPT0gbnVsbCA/IC0xIDogaW5kZXhPZi5jYWxsKGFyciwgZWxlbSwgaSk7CiAgICB9LAogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICBtZXJnZTogZnVuY3Rpb24gKGZpcnN0LCBzZWNvbmQpIHsKICAgICAgdmFyIGxlbiA9ICtzZWNvbmQubGVuZ3RoLAogICAgICAgIGogPSAwLAogICAgICAgIGkgPSBmaXJzdC5sZW5ndGg7CiAgICAgIGZvciAoOyBqIDwgbGVuOyBqKyspIHsKICAgICAgICBmaXJzdFtpKytdID0gc2Vjb25kW2pdOwogICAgICB9CiAgICAgIGZpcnN0Lmxlbmd0aCA9IGk7CiAgICAgIHJldHVybiBmaXJzdDsKICAgIH0sCiAgICBncmVwOiBmdW5jdGlvbiAoZWxlbXMsIGNhbGxiYWNrLCBpbnZlcnQpIHsKICAgICAgdmFyIGNhbGxiYWNrSW52ZXJzZSwKICAgICAgICBtYXRjaGVzID0gW10sCiAgICAgICAgaSA9IDAsCiAgICAgICAgbGVuZ3RoID0gZWxlbXMubGVuZ3RoLAogICAgICAgIGNhbGxiYWNrRXhwZWN0ID0gIWludmVydDsKCiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCBvbmx5IHNhdmluZyB0aGUgaXRlbXMKICAgICAgLy8gdGhhdCBwYXNzIHRoZSB2YWxpZGF0b3IgZnVuY3Rpb24KICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIGNhbGxiYWNrSW52ZXJzZSA9ICFjYWxsYmFjayhlbGVtc1tpXSwgaSk7CiAgICAgICAgaWYgKGNhbGxiYWNrSW52ZXJzZSAhPT0gY2FsbGJhY2tFeHBlY3QpIHsKICAgICAgICAgIG1hdGNoZXMucHVzaChlbGVtc1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBtYXRjaGVzOwogICAgfSwKICAgIC8vIGFyZyBpcyBmb3IgaW50ZXJuYWwgdXNhZ2Ugb25seQogICAgbWFwOiBmdW5jdGlvbiAoZWxlbXMsIGNhbGxiYWNrLCBhcmcpIHsKICAgICAgdmFyIGxlbmd0aCwKICAgICAgICB2YWx1ZSwKICAgICAgICBpID0gMCwKICAgICAgICByZXQgPSBbXTsKCiAgICAgIC8vIEdvIHRocm91Z2ggdGhlIGFycmF5LCB0cmFuc2xhdGluZyBlYWNoIG9mIHRoZSBpdGVtcyB0byB0aGVpciBuZXcgdmFsdWVzCiAgICAgIGlmIChpc0FycmF5TGlrZShlbGVtcykpIHsKICAgICAgICBsZW5ndGggPSBlbGVtcy5sZW5ndGg7CiAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtc1tpXSwgaSwgYXJnKTsKICAgICAgICAgIGlmICh2YWx1ZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHJldC5wdXNoKHZhbHVlKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIEdvIHRocm91Z2ggZXZlcnkga2V5IG9uIHRoZSBvYmplY3QsCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChpIGluIGVsZW1zKSB7CiAgICAgICAgICB2YWx1ZSA9IGNhbGxiYWNrKGVsZW1zW2ldLCBpLCBhcmcpOwogICAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHsKICAgICAgICAgICAgcmV0LnB1c2godmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgICByZXR1cm4gZmxhdChyZXQpOwogICAgfSwKICAgIC8vIEEgZ2xvYmFsIEdVSUQgY291bnRlciBmb3Igb2JqZWN0cwogICAgZ3VpZDogMSwKICAgIC8vIGpRdWVyeS5zdXBwb3J0IGlzIG5vdCB1c2VkIGluIENvcmUgYnV0IG90aGVyIHByb2plY3RzIGF0dGFjaCB0aGVpcgogICAgLy8gcHJvcGVydGllcyB0byBpdCBzbyBpdCBuZWVkcyB0byBleGlzdC4KICAgIHN1cHBvcnQ6IHN1cHBvcnQKICB9KTsKICBpZiAodHlwZW9mIFN5bWJvbCA9PT0gImZ1bmN0aW9uIikgewogICAgalF1ZXJ5LmZuW1N5bWJvbC5pdGVyYXRvcl0gPSBhcnJbU3ltYm9sLml0ZXJhdG9yXTsKICB9CgogIC8vIFBvcHVsYXRlIHRoZSBjbGFzczJ0eXBlIG1hcAogIGpRdWVyeS5lYWNoKCJCb29sZWFuIE51bWJlciBTdHJpbmcgRnVuY3Rpb24gQXJyYXkgRGF0ZSBSZWdFeHAgT2JqZWN0IEVycm9yIFN5bWJvbCIuc3BsaXQoIiAiKSwgZnVuY3Rpb24gKF9pLCBuYW1lKSB7CiAgICBjbGFzczJ0eXBlWyJbb2JqZWN0ICIgKyBuYW1lICsgIl0iXSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9KTsKICBmdW5jdGlvbiBpc0FycmF5TGlrZShvYmopIHsKICAgIC8vIFN1cHBvcnQ6IHJlYWwgaU9TIDguMiBvbmx5IChub3QgcmVwcm9kdWNpYmxlIGluIHNpbXVsYXRvcikKICAgIC8vIGBpbmAgY2hlY2sgdXNlZCB0byBwcmV2ZW50IEpJVCBlcnJvciAoZ2gtMjE0NSkKICAgIC8vIGhhc093biBpc24ndCB1c2VkIGhlcmUgZHVlIHRvIGZhbHNlIG5lZ2F0aXZlcwogICAgLy8gcmVnYXJkaW5nIE5vZGVsaXN0IGxlbmd0aCBpbiBJRQogICAgdmFyIGxlbmd0aCA9ICEhb2JqICYmICJsZW5ndGgiIGluIG9iaiAmJiBvYmoubGVuZ3RoLAogICAgICB0eXBlID0gdG9UeXBlKG9iaik7CiAgICBpZiAoaXNGdW5jdGlvbihvYmopIHx8IGlzV2luZG93KG9iaikpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHR5cGUgPT09ICJhcnJheSIgfHwgbGVuZ3RoID09PSAwIHx8IHR5cGVvZiBsZW5ndGggPT09ICJudW1iZXIiICYmIGxlbmd0aCA+IDAgJiYgbGVuZ3RoIC0gMSBpbiBvYmo7CiAgfQogIHZhciBTaXp6bGUgPQogIC8qIQogICAqIFNpenpsZSBDU1MgU2VsZWN0b3IgRW5naW5lIHYyLjMuOAogICAqIGh0dHBzOi8vc2l6emxlanMuY29tLwogICAqCiAgICogQ29weXJpZ2h0IEpTIEZvdW5kYXRpb24gYW5kIG90aGVyIGNvbnRyaWJ1dG9ycwogICAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZQogICAqIGh0dHBzOi8vanMuZm91bmRhdGlvbi8KICAgKgogICAqIERhdGU6IDIwMjItMTEtMTYKICAgKi8KICBmdW5jdGlvbiAod2luZG93KSB7CiAgICB2YXIgaSwKICAgICAgc3VwcG9ydCwKICAgICAgRXhwciwKICAgICAgZ2V0VGV4dCwKICAgICAgaXNYTUwsCiAgICAgIHRva2VuaXplLAogICAgICBjb21waWxlLAogICAgICBzZWxlY3QsCiAgICAgIG91dGVybW9zdENvbnRleHQsCiAgICAgIHNvcnRJbnB1dCwKICAgICAgaGFzRHVwbGljYXRlLAogICAgICAvLyBMb2NhbCBkb2N1bWVudCB2YXJzCiAgICAgIHNldERvY3VtZW50LAogICAgICBkb2N1bWVudCwKICAgICAgZG9jRWxlbSwKICAgICAgZG9jdW1lbnRJc0hUTUwsCiAgICAgIHJidWdneVFTQSwKICAgICAgcmJ1Z2d5TWF0Y2hlcywKICAgICAgbWF0Y2hlcywKICAgICAgY29udGFpbnMsCiAgICAgIC8vIEluc3RhbmNlLXNwZWNpZmljIGRhdGEKICAgICAgZXhwYW5kbyA9ICJzaXp6bGUiICsgMSAqIG5ldyBEYXRlKCksCiAgICAgIHByZWZlcnJlZERvYyA9IHdpbmRvdy5kb2N1bWVudCwKICAgICAgZGlycnVucyA9IDAsCiAgICAgIGRvbmUgPSAwLAogICAgICBjbGFzc0NhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICAgICAgdG9rZW5DYWNoZSA9IGNyZWF0ZUNhY2hlKCksCiAgICAgIGNvbXBpbGVyQ2FjaGUgPSBjcmVhdGVDYWNoZSgpLAogICAgICBub25uYXRpdmVTZWxlY3RvckNhY2hlID0gY3JlYXRlQ2FjaGUoKSwKICAgICAgc29ydE9yZGVyID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0sCiAgICAgIC8vIEluc3RhbmNlIG1ldGhvZHMKICAgICAgaGFzT3duID0ge30uaGFzT3duUHJvcGVydHksCiAgICAgIGFyciA9IFtdLAogICAgICBwb3AgPSBhcnIucG9wLAogICAgICBwdXNoTmF0aXZlID0gYXJyLnB1c2gsCiAgICAgIHB1c2ggPSBhcnIucHVzaCwKICAgICAgc2xpY2UgPSBhcnIuc2xpY2UsCiAgICAgIC8vIFVzZSBhIHN0cmlwcGVkLWRvd24gaW5kZXhPZiBhcyBpdCdzIGZhc3RlciB0aGFuIG5hdGl2ZQogICAgICAvLyBodHRwczovL2pzcGVyZi5jb20vdGhvci1pbmRleG9mLXZzLWZvci81CiAgICAgIGluZGV4T2YgPSBmdW5jdGlvbiAobGlzdCwgZWxlbSkgewogICAgICAgIHZhciBpID0gMCwKICAgICAgICAgIGxlbiA9IGxpc3QubGVuZ3RoOwogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGlmIChsaXN0W2ldID09PSBlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gLTE7CiAgICAgIH0sCiAgICAgIGJvb2xlYW5zID0gImNoZWNrZWR8c2VsZWN0ZWR8YXN5bmN8YXV0b2ZvY3VzfGF1dG9wbGF5fGNvbnRyb2xzfGRlZmVyfGRpc2FibGVkfGhpZGRlbnwiICsgImlzbWFwfGxvb3B8bXVsdGlwbGV8b3BlbnxyZWFkb25seXxyZXF1aXJlZHxzY29wZWQiLAogICAgICAvLyBSZWd1bGFyIGV4cHJlc3Npb25zCgogICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9jc3MzLXNlbGVjdG9ycy8jd2hpdGVzcGFjZQogICAgICB3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iLAogICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvY3NzLXN5bnRheC0zLyNpZGVudC10b2tlbi1kaWFncmFtCiAgICAgIGlkZW50aWZpZXIgPSAiKD86XFxcXFtcXGRhLWZBLUZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fFxcXFxbXlxcclxcblxcZl18W1xcdy1dfFteXDAtXFx4N2ZdKSsiLAogICAgICAvLyBBdHRyaWJ1dGUgc2VsZWN0b3JzOiBodHRwOi8vd3d3LnczLm9yZy9UUi9zZWxlY3RvcnMvI2F0dHJpYnV0ZS1zZWxlY3RvcnMKICAgICAgYXR0cmlidXRlcyA9ICJcXFsiICsgd2hpdGVzcGFjZSArICIqKCIgKyBpZGVudGlmaWVyICsgIikoPzoiICsgd2hpdGVzcGFjZSArCiAgICAgIC8vIE9wZXJhdG9yIChjYXB0dXJlIDIpCiAgICAgICIqKFsqXiR8IX5dPz0pIiArIHdoaXRlc3BhY2UgKwogICAgICAvLyAiQXR0cmlidXRlIHZhbHVlcyBtdXN0IGJlIENTUyBpZGVudGlmaWVycyBbY2FwdHVyZSA1XQogICAgICAvLyBvciBzdHJpbmdzIFtjYXB0dXJlIDMgb3IgY2FwdHVyZSA0XSIKICAgICAgIiooPzonKCg/OlxcXFwufFteXFxcXCddKSopJ3xcIigoPzpcXFxcLnxbXlxcXFxcIl0pKilcInwoIiArIGlkZW50aWZpZXIgKyAiKSl8KSIgKyB3aGl0ZXNwYWNlICsgIipcXF0iLAogICAgICBwc2V1ZG9zID0gIjooIiArIGlkZW50aWZpZXIgKyAiKSg/OlxcKCgiICsKICAgICAgLy8gVG8gcmVkdWNlIHRoZSBudW1iZXIgb2Ygc2VsZWN0b3JzIG5lZWRpbmcgdG9rZW5pemUgaW4gdGhlIHByZUZpbHRlciwgcHJlZmVyIGFyZ3VtZW50czoKICAgICAgLy8gMS4gcXVvdGVkIChjYXB0dXJlIDM7IGNhcHR1cmUgNCBvciBjYXB0dXJlIDUpCiAgICAgICIoJygoPzpcXFxcLnxbXlxcXFwnXSkqKSd8XCIoKD86XFxcXC58W15cXFxcXCJdKSopXCIpfCIgKwogICAgICAvLyAyLiBzaW1wbGUgKGNhcHR1cmUgNikKICAgICAgIigoPzpcXFxcLnxbXlxcXFwoKVtcXF1dfCIgKyBhdHRyaWJ1dGVzICsgIikqKXwiICsKICAgICAgLy8gMy4gYW55dGhpbmcgZWxzZSAoY2FwdHVyZSAyKQogICAgICAiLioiICsgIilcXCl8KSIsCiAgICAgIC8vIExlYWRpbmcgYW5kIG5vbi1lc2NhcGVkIHRyYWlsaW5nIHdoaXRlc3BhY2UsIGNhcHR1cmluZyBzb21lIG5vbi13aGl0ZXNwYWNlIGNoYXJhY3RlcnMgcHJlY2VkaW5nIHRoZSBsYXR0ZXIKICAgICAgcndoaXRlc3BhY2UgPSBuZXcgUmVnRXhwKHdoaXRlc3BhY2UgKyAiKyIsICJnIiksCiAgICAgIHJ0cmltID0gbmV3IFJlZ0V4cCgiXiIgKyB3aGl0ZXNwYWNlICsgIit8KCg/Ol58W15cXFxcXSkoPzpcXFxcLikqKSIgKyB3aGl0ZXNwYWNlICsgIiskIiwgImciKSwKICAgICAgcmNvbW1hID0gbmV3IFJlZ0V4cCgiXiIgKyB3aGl0ZXNwYWNlICsgIiosIiArIHdoaXRlc3BhY2UgKyAiKiIpLAogICAgICByY29tYmluYXRvcnMgPSBuZXcgUmVnRXhwKCJeIiArIHdoaXRlc3BhY2UgKyAiKihbPit+XXwiICsgd2hpdGVzcGFjZSArICIpIiArIHdoaXRlc3BhY2UgKyAiKiIpLAogICAgICByZGVzY2VuZCA9IG5ldyBSZWdFeHAod2hpdGVzcGFjZSArICJ8PiIpLAogICAgICBycHNldWRvID0gbmV3IFJlZ0V4cChwc2V1ZG9zKSwKICAgICAgcmlkZW50aWZpZXIgPSBuZXcgUmVnRXhwKCJeIiArIGlkZW50aWZpZXIgKyAiJCIpLAogICAgICBtYXRjaEV4cHIgPSB7CiAgICAgICAgIklEIjogbmV3IFJlZ0V4cCgiXiMoIiArIGlkZW50aWZpZXIgKyAiKSIpLAogICAgICAgICJDTEFTUyI6IG5ldyBSZWdFeHAoIl5cXC4oIiArIGlkZW50aWZpZXIgKyAiKSIpLAogICAgICAgICJUQUciOiBuZXcgUmVnRXhwKCJeKCIgKyBpZGVudGlmaWVyICsgInxbKl0pIiksCiAgICAgICAgIkFUVFIiOiBuZXcgUmVnRXhwKCJeIiArIGF0dHJpYnV0ZXMpLAogICAgICAgICJQU0VVRE8iOiBuZXcgUmVnRXhwKCJeIiArIHBzZXVkb3MpLAogICAgICAgICJDSElMRCI6IG5ldyBSZWdFeHAoIl46KG9ubHl8Zmlyc3R8bGFzdHxudGh8bnRoLWxhc3QpLShjaGlsZHxvZi10eXBlKSg/OlxcKCIgKyB3aGl0ZXNwYWNlICsgIiooZXZlbnxvZGR8KChbKy1dfCkoXFxkKilufCkiICsgd2hpdGVzcGFjZSArICIqKD86KFsrLV18KSIgKyB3aGl0ZXNwYWNlICsgIiooXFxkKyl8KSkiICsgd2hpdGVzcGFjZSArICIqXFwpfCkiLCAiaSIpLAogICAgICAgICJib29sIjogbmV3IFJlZ0V4cCgiXig/OiIgKyBib29sZWFucyArICIpJCIsICJpIiksCiAgICAgICAgLy8gRm9yIHVzZSBpbiBsaWJyYXJpZXMgaW1wbGVtZW50aW5nIC5pcygpCiAgICAgICAgLy8gV2UgdXNlIHRoaXMgZm9yIFBPUyBtYXRjaGluZyBpbiBgc2VsZWN0YAogICAgICAgICJuZWVkc0NvbnRleHQiOiBuZXcgUmVnRXhwKCJeIiArIHdoaXRlc3BhY2UgKyAiKls+K35dfDooZXZlbnxvZGR8ZXF8Z3R8bHR8bnRofGZpcnN0fGxhc3QpKD86XFwoIiArIHdoaXRlc3BhY2UgKyAiKigoPzotXFxkKT9cXGQqKSIgKyB3aGl0ZXNwYWNlICsgIipcXCl8KSg/PVteLV18JCkiLCAiaSIpCiAgICAgIH0sCiAgICAgIHJodG1sID0gL0hUTUwkL2ksCiAgICAgIHJpbnB1dHMgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b24pJC9pLAogICAgICByaGVhZGVyID0gL15oXGQkL2ksCiAgICAgIHJuYXRpdmUgPSAvXltee10rXHtccypcW25hdGl2ZSBcdy8sCiAgICAgIC8vIEVhc2lseS1wYXJzZWFibGUvcmV0cmlldmFibGUgSUQgb3IgVEFHIG9yIENMQVNTIHNlbGVjdG9ycwogICAgICBycXVpY2tFeHByID0gL14oPzojKFtcdy1dKyl8KFx3Kyl8XC4oW1x3LV0rKSkkLywKICAgICAgcnNpYmxpbmcgPSAvWyt+XS8sCiAgICAgIC8vIENTUyBlc2NhcGVzCiAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL0NTUzIxL3N5bmRhdGEuaHRtbCNlc2NhcGVkLWNoYXJhY3RlcnMKICAgICAgcnVuZXNjYXBlID0gbmV3IFJlZ0V4cCgiXFxcXFtcXGRhLWZBLUZdezEsNn0iICsgd2hpdGVzcGFjZSArICI/fFxcXFwoW15cXHJcXG5cXGZdKSIsICJnIiksCiAgICAgIGZ1bmVzY2FwZSA9IGZ1bmN0aW9uIChlc2NhcGUsIG5vbkhleCkgewogICAgICAgIHZhciBoaWdoID0gIjB4IiArIGVzY2FwZS5zbGljZSgxKSAtIDB4MTAwMDA7CiAgICAgICAgcmV0dXJuIG5vbkhleCA/CiAgICAgICAgLy8gU3RyaXAgdGhlIGJhY2tzbGFzaCBwcmVmaXggZnJvbSBhIG5vbi1oZXggZXNjYXBlIHNlcXVlbmNlCiAgICAgICAgbm9uSGV4IDoKICAgICAgICAvLyBSZXBsYWNlIGEgaGV4YWRlY2ltYWwgZXNjYXBlIHNlcXVlbmNlIHdpdGggdGhlIGVuY29kZWQgVW5pY29kZSBjb2RlIHBvaW50CiAgICAgICAgLy8gU3VwcG9ydDogSUUgPD0xMSsKICAgICAgICAvLyBGb3IgdmFsdWVzIG91dHNpZGUgdGhlIEJhc2ljIE11bHRpbGluZ3VhbCBQbGFuZSAoQk1QKSwgbWFudWFsbHkgY29uc3RydWN0IGEKICAgICAgICAvLyBzdXJyb2dhdGUgcGFpcgogICAgICAgIGhpZ2ggPCAwID8gU3RyaW5nLmZyb21DaGFyQ29kZShoaWdoICsgMHgxMDAwMCkgOiBTdHJpbmcuZnJvbUNoYXJDb2RlKGhpZ2ggPj4gMTAgfCAweEQ4MDAsIGhpZ2ggJiAweDNGRiB8IDB4REMwMCk7CiAgICAgIH0sCiAgICAgIC8vIENTUyBzdHJpbmcvaWRlbnRpZmllciBzZXJpYWxpemF0aW9uCiAgICAgIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3NvbS8jY29tbW9uLXNlcmlhbGl6aW5nLWlkaW9tcwogICAgICByY3NzZXNjYXBlID0gLyhbXDAtXHgxZlx4N2ZdfF4tP1xkKXxeLSR8W15cMC1ceDFmXHg3Zi1cdUZGRkZcdy1dL2csCiAgICAgIGZjc3Nlc2NhcGUgPSBmdW5jdGlvbiAoY2gsIGFzQ29kZVBvaW50KSB7CiAgICAgICAgaWYgKGFzQ29kZVBvaW50KSB7CiAgICAgICAgICAvLyBVKzAwMDAgTlVMTCBiZWNvbWVzIFUrRkZGRCBSRVBMQUNFTUVOVCBDSEFSQUNURVIKICAgICAgICAgIGlmIChjaCA9PT0gIlwwIikgewogICAgICAgICAgICByZXR1cm4gIlx1RkZGRCI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ29udHJvbCBjaGFyYWN0ZXJzIGFuZCAoZGVwZW5kZW50IHVwb24gcG9zaXRpb24pIG51bWJlcnMgZ2V0IGVzY2FwZWQgYXMgY29kZSBwb2ludHMKICAgICAgICAgIHJldHVybiBjaC5zbGljZSgwLCAtMSkgKyAiXFwiICsgY2guY2hhckNvZGVBdChjaC5sZW5ndGggLSAxKS50b1N0cmluZygxNikgKyAiICI7CiAgICAgICAgfQoKICAgICAgICAvLyBPdGhlciBwb3RlbnRpYWxseS1zcGVjaWFsIEFTQ0lJIGNoYXJhY3RlcnMgZ2V0IGJhY2tzbGFzaC1lc2NhcGVkCiAgICAgICAgcmV0dXJuICJcXCIgKyBjaDsKICAgICAgfSwKICAgICAgLy8gVXNlZCBmb3IgaWZyYW1lcwogICAgICAvLyBTZWUgc2V0RG9jdW1lbnQoKQogICAgICAvLyBSZW1vdmluZyB0aGUgZnVuY3Rpb24gd3JhcHBlciBjYXVzZXMgYSAiUGVybWlzc2lvbiBEZW5pZWQiCiAgICAgIC8vIGVycm9yIGluIElFCiAgICAgIHVubG9hZEhhbmRsZXIgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2V0RG9jdW1lbnQoKTsKICAgICAgfSwKICAgICAgaW5EaXNhYmxlZEZpZWxkc2V0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSB0cnVlICYmIGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gImZpZWxkc2V0IjsKICAgICAgfSwgewogICAgICAgIGRpcjogInBhcmVudE5vZGUiLAogICAgICAgIG5leHQ6ICJsZWdlbmQiCiAgICAgIH0pOwoKICAgIC8vIE9wdGltaXplIGZvciBwdXNoLmFwcGx5KCBfLCBOb2RlTGlzdCApCiAgICB0cnkgewogICAgICBwdXNoLmFwcGx5KGFyciA9IHNsaWNlLmNhbGwocHJlZmVycmVkRG9jLmNoaWxkTm9kZXMpLCBwcmVmZXJyZWREb2MuY2hpbGROb2Rlcyk7CgogICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkPDQuMAogICAgICAvLyBEZXRlY3Qgc2lsZW50bHkgZmFpbGluZyBwdXNoLmFwcGx5CiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnMKICAgICAgYXJyW3ByZWZlcnJlZERvYy5jaGlsZE5vZGVzLmxlbmd0aF0ubm9kZVR5cGU7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHB1c2ggPSB7CiAgICAgICAgYXBwbHk6IGFyci5sZW5ndGggPwogICAgICAgIC8vIExldmVyYWdlIHNsaWNlIGlmIHBvc3NpYmxlCiAgICAgICAgZnVuY3Rpb24gKHRhcmdldCwgZWxzKSB7CiAgICAgICAgICBwdXNoTmF0aXZlLmFwcGx5KHRhcmdldCwgc2xpY2UuY2FsbChlbHMpKTsKICAgICAgICB9IDoKICAgICAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAgICAgLy8gT3RoZXJ3aXNlIGFwcGVuZCBkaXJlY3RseQogICAgICAgIGZ1bmN0aW9uICh0YXJnZXQsIGVscykgewogICAgICAgICAgdmFyIGogPSB0YXJnZXQubGVuZ3RoLAogICAgICAgICAgICBpID0gMDsKCiAgICAgICAgICAvLyBDYW4ndCB0cnVzdCBOb2RlTGlzdC5sZW5ndGgKICAgICAgICAgIHdoaWxlICh0YXJnZXRbaisrXSA9IGVsc1tpKytdKSB7fQogICAgICAgICAgdGFyZ2V0Lmxlbmd0aCA9IGogLSAxOwogICAgICAgIH0KICAgICAgfTsKICAgIH0KICAgIGZ1bmN0aW9uIFNpenpsZShzZWxlY3RvciwgY29udGV4dCwgcmVzdWx0cywgc2VlZCkgewogICAgICB2YXIgbSwKICAgICAgICBpLAogICAgICAgIGVsZW0sCiAgICAgICAgbmlkLAogICAgICAgIG1hdGNoLAogICAgICAgIGdyb3VwcywKICAgICAgICBuZXdTZWxlY3RvciwKICAgICAgICBuZXdDb250ZXh0ID0gY29udGV4dCAmJiBjb250ZXh0Lm93bmVyRG9jdW1lbnQsCiAgICAgICAgLy8gbm9kZVR5cGUgZGVmYXVsdHMgdG8gOSwgc2luY2UgY29udGV4dCBkZWZhdWx0cyB0byBkb2N1bWVudAogICAgICAgIG5vZGVUeXBlID0gY29udGV4dCA/IGNvbnRleHQubm9kZVR5cGUgOiA5OwogICAgICByZXN1bHRzID0gcmVzdWx0cyB8fCBbXTsKCiAgICAgIC8vIFJldHVybiBlYXJseSBmcm9tIGNhbGxzIHdpdGggaW52YWxpZCBzZWxlY3RvciBvciBjb250ZXh0CiAgICAgIGlmICh0eXBlb2Ygc2VsZWN0b3IgIT09ICJzdHJpbmciIHx8ICFzZWxlY3RvciB8fCBub2RlVHlwZSAhPT0gMSAmJiBub2RlVHlwZSAhPT0gOSAmJiBub2RlVHlwZSAhPT0gMTEpIHsKICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgfQoKICAgICAgLy8gVHJ5IHRvIHNob3J0Y3V0IGZpbmQgb3BlcmF0aW9ucyAoYXMgb3Bwb3NlZCB0byBmaWx0ZXJzKSBpbiBIVE1MIGRvY3VtZW50cwogICAgICBpZiAoIXNlZWQpIHsKICAgICAgICBzZXREb2N1bWVudChjb250ZXh0KTsKICAgICAgICBjb250ZXh0ID0gY29udGV4dCB8fCBkb2N1bWVudDsKICAgICAgICBpZiAoZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgIC8vIElmIHRoZSBzZWxlY3RvciBpcyBzdWZmaWNpZW50bHkgc2ltcGxlLCB0cnkgdXNpbmcgYSAiZ2V0KkJ5KiIgRE9NIG1ldGhvZAogICAgICAgICAgLy8gKGV4Y2VwdGluZyBEb2N1bWVudEZyYWdtZW50IGNvbnRleHQsIHdoZXJlIHRoZSBtZXRob2RzIGRvbid0IGV4aXN0KQogICAgICAgICAgaWYgKG5vZGVUeXBlICE9PSAxMSAmJiAobWF0Y2ggPSBycXVpY2tFeHByLmV4ZWMoc2VsZWN0b3IpKSkgewogICAgICAgICAgICAvLyBJRCBzZWxlY3RvcgogICAgICAgICAgICBpZiAobSA9IG1hdGNoWzFdKSB7CiAgICAgICAgICAgICAgLy8gRG9jdW1lbnQgY29udGV4dAogICAgICAgICAgICAgIGlmIChub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICAgICAgaWYgKGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG0pKSB7CiAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFLCBPcGVyYSwgV2Via2l0CiAgICAgICAgICAgICAgICAgIC8vIFRPRE86IGlkZW50aWZ5IHZlcnNpb25zCiAgICAgICAgICAgICAgICAgIC8vIGdldEVsZW1lbnRCeUlkIGNhbiBtYXRjaCBlbGVtZW50cyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgICAgICAgaWYgKGVsZW0uaWQgPT09IG0pIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVsZW1lbnQgY29udGV4dAogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSwgT3BlcmEsIFdlYmtpdAogICAgICAgICAgICAgICAgLy8gVE9ETzogaWRlbnRpZnkgdmVyc2lvbnMKICAgICAgICAgICAgICAgIC8vIGdldEVsZW1lbnRCeUlkIGNhbiBtYXRjaCBlbGVtZW50cyBieSBuYW1lIGluc3RlYWQgb2YgSUQKICAgICAgICAgICAgICAgIGlmIChuZXdDb250ZXh0ICYmIChlbGVtID0gbmV3Q29udGV4dC5nZXRFbGVtZW50QnlJZChtKSkgJiYgY29udGFpbnMoY29udGV4dCwgZWxlbSkgJiYgZWxlbS5pZCA9PT0gbSkgewogICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gVHlwZSBzZWxlY3RvcgogICAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzJdKSB7CiAgICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSk7CiAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CgogICAgICAgICAgICAgIC8vIENsYXNzIHNlbGVjdG9yCiAgICAgICAgICAgIH0gZWxzZSBpZiAoKG0gPSBtYXRjaFszXSkgJiYgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSkgewogICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKG0pKTsKICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIFRha2UgYWR2YW50YWdlIG9mIHF1ZXJ5U2VsZWN0b3JBbGwKICAgICAgICAgIGlmIChzdXBwb3J0LnFzYSAmJiAhbm9ubmF0aXZlU2VsZWN0b3JDYWNoZVtzZWxlY3RvciArICIgIl0gJiYgKCFyYnVnZ3lRU0EgfHwgIXJidWdneVFTQS50ZXN0KHNlbGVjdG9yKSkgJiYgKAogICAgICAgICAgLy8gU3VwcG9ydDogSUUgOCBvbmx5CiAgICAgICAgICAvLyBFeGNsdWRlIG9iamVjdCBlbGVtZW50cwogICAgICAgICAgbm9kZVR5cGUgIT09IDEgfHwgY29udGV4dC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9PSAib2JqZWN0IikpIHsKICAgICAgICAgICAgbmV3U2VsZWN0b3IgPSBzZWxlY3RvcjsKICAgICAgICAgICAgbmV3Q29udGV4dCA9IGNvbnRleHQ7CgogICAgICAgICAgICAvLyBxU0EgY29uc2lkZXJzIGVsZW1lbnRzIG91dHNpZGUgYSBzY29waW5nIHJvb3Qgd2hlbiBldmFsdWF0aW5nIGNoaWxkIG9yCiAgICAgICAgICAgIC8vIGRlc2NlbmRhbnQgY29tYmluYXRvcnMsIHdoaWNoIGlzIG5vdCB3aGF0IHdlIHdhbnQuCiAgICAgICAgICAgIC8vIEluIHN1Y2ggY2FzZXMsIHdlIHdvcmsgYXJvdW5kIHRoZSBiZWhhdmlvciBieSBwcmVmaXhpbmcgZXZlcnkgc2VsZWN0b3IgaW4gdGhlCiAgICAgICAgICAgIC8vIGxpc3Qgd2l0aCBhbiBJRCBzZWxlY3RvciByZWZlcmVuY2luZyB0aGUgc2NvcGUgY29udGV4dC4KICAgICAgICAgICAgLy8gVGhlIHRlY2huaXF1ZSBoYXMgdG8gYmUgdXNlZCBhcyB3ZWxsIHdoZW4gYSBsZWFkaW5nIGNvbWJpbmF0b3IgaXMgdXNlZAogICAgICAgICAgICAvLyBhcyBzdWNoIHNlbGVjdG9ycyBhcmUgbm90IHJlY29nbml6ZWQgYnkgcXVlcnlTZWxlY3RvckFsbC4KICAgICAgICAgICAgLy8gVGhhbmtzIHRvIEFuZHJldyBEdXBvbnQgZm9yIHRoaXMgdGVjaG5pcXVlLgogICAgICAgICAgICBpZiAobm9kZVR5cGUgPT09IDEgJiYgKHJkZXNjZW5kLnRlc3Qoc2VsZWN0b3IpIHx8IHJjb21iaW5hdG9ycy50ZXN0KHNlbGVjdG9yKSkpIHsKICAgICAgICAgICAgICAvLyBFeHBhbmQgY29udGV4dCBmb3Igc2libGluZyBzZWxlY3RvcnMKICAgICAgICAgICAgICBuZXdDb250ZXh0ID0gcnNpYmxpbmcudGVzdChzZWxlY3RvcikgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0OwoKICAgICAgICAgICAgICAvLyBXZSBjYW4gdXNlIDpzY29wZSBpbnN0ZWFkIG9mIHRoZSBJRCBoYWNrIGlmIHRoZSBicm93c2VyCiAgICAgICAgICAgICAgLy8gc3VwcG9ydHMgaXQgJiBpZiB3ZSdyZSBub3QgY2hhbmdpbmcgdGhlIGNvbnRleHQuCiAgICAgICAgICAgICAgaWYgKG5ld0NvbnRleHQgIT09IGNvbnRleHQgfHwgIXN1cHBvcnQuc2NvcGUpIHsKICAgICAgICAgICAgICAgIC8vIENhcHR1cmUgdGhlIGNvbnRleHQgSUQsIHNldHRpbmcgaXQgZmlyc3QgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICBpZiAobmlkID0gY29udGV4dC5nZXRBdHRyaWJ1dGUoImlkIikpIHsKICAgICAgICAgICAgICAgICAgbmlkID0gbmlkLnJlcGxhY2UocmNzc2VzY2FwZSwgZmNzc2VzY2FwZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb250ZXh0LnNldEF0dHJpYnV0ZSgiaWQiLCBuaWQgPSBleHBhbmRvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIFByZWZpeCBldmVyeSBzZWxlY3RvciBpbiB0aGUgbGlzdAogICAgICAgICAgICAgIGdyb3VwcyA9IHRva2VuaXplKHNlbGVjdG9yKTsKICAgICAgICAgICAgICBpID0gZ3JvdXBzLmxlbmd0aDsKICAgICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgICBncm91cHNbaV0gPSAobmlkID8gIiMiICsgbmlkIDogIjpzY29wZSIpICsgIiAiICsgdG9TZWxlY3Rvcihncm91cHNbaV0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBuZXdTZWxlY3RvciA9IGdyb3Vwcy5qb2luKCIsIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAvLyBgcVNBYCBtYXkgbm90IHRocm93IGZvciB1bnJlY29nbml6ZWQgcGFydHMgdXNpbmcgZm9yZ2l2aW5nIHBhcnNpbmc6CiAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL3NlbGVjdG9ycy8jZm9yZ2l2aW5nLXNlbGVjdG9yCiAgICAgICAgICAgICAgLy8gbGlrZSB0aGUgYDpoYXMoKWAgcHNldWRvLWNsYXNzOgogICAgICAgICAgICAgIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9zZWxlY3RvcnMvI3JlbGF0aW9uYWwKICAgICAgICAgICAgICAvLyBgQ1NTLnN1cHBvcnRzYCBpcyBzdGlsbCBleHBlY3RlZCB0byByZXR1cm4gYGZhbHNlYCB0aGVuOgogICAgICAgICAgICAgIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3MtY29uZGl0aW9uYWwtNC8jdHlwZWRlZi1zdXBwb3J0cy1zZWxlY3Rvci1mbgogICAgICAgICAgICAgIC8vIGh0dHBzOi8vZHJhZnRzLmNzc3dnLm9yZy9jc3MtY29uZGl0aW9uYWwtNC8jZGZuLXN1cHBvcnQtc2VsZWN0b3IKICAgICAgICAgICAgICBpZiAoc3VwcG9ydC5jc3NTdXBwb3J0c1NlbGVjdG9yICYmCiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVuZGVmCiAgICAgICAgICAgICAgIUNTUy5zdXBwb3J0cygic2VsZWN0b3IoIiArIG5ld1NlbGVjdG9yICsgIikiKSkgewogICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErCiAgICAgICAgICAgICAgICAvLyBUaHJvdyB0byBnZXQgdG8gdGhlIHNhbWUgY29kZSBwYXRoIGFzIGFuIGVycm9yIGRpcmVjdGx5IGluIHFTQS4KICAgICAgICAgICAgICAgIC8vIE5vdGU6IG9uY2Ugd2Ugb25seSBzdXBwb3J0IGJyb3dzZXIgc3VwcG9ydGluZwogICAgICAgICAgICAgICAgLy8gYENTUy5zdXBwb3J0cygnc2VsZWN0b3IoLi4uKScpYCwgd2UgY2FuIG1vc3QgbGlrZWx5IGRyb3AKICAgICAgICAgICAgICAgIC8vIHRoZSBgdHJ5LWNhdGNoYC4gSUUgZG9lc24ndCBpbXBsZW1lbnQgdGhlIEFQSS4KICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBwdXNoLmFwcGx5KHJlc3VsdHMsIG5ld0NvbnRleHQucXVlcnlTZWxlY3RvckFsbChuZXdTZWxlY3RvcikpOwogICAgICAgICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICAgICAgICB9IGNhdGNoIChxc2FFcnJvcikgewogICAgICAgICAgICAgIG5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUoc2VsZWN0b3IsIHRydWUpOwogICAgICAgICAgICB9IGZpbmFsbHkgewogICAgICAgICAgICAgIGlmIChuaWQgPT09IGV4cGFuZG8pIHsKICAgICAgICAgICAgICAgIGNvbnRleHQucmVtb3ZlQXR0cmlidXRlKCJpZCIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQWxsIG90aGVycwogICAgICByZXR1cm4gc2VsZWN0KHNlbGVjdG9yLnJlcGxhY2UocnRyaW0sICIkMSIpLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKTsKICAgIH0KCiAgICAvKioKICAgICAqIENyZWF0ZSBrZXktdmFsdWUgY2FjaGVzIG9mIGxpbWl0ZWQgc2l6ZQogICAgICogQHJldHVybnMge2Z1bmN0aW9uKHN0cmluZywgb2JqZWN0KX0gUmV0dXJucyB0aGUgT2JqZWN0IGRhdGEgYWZ0ZXIgc3RvcmluZyBpdCBvbiBpdHNlbGYgd2l0aAogICAgICoJcHJvcGVydHkgbmFtZSB0aGUgKHNwYWNlLXN1ZmZpeGVkKSBzdHJpbmcgYW5kIChpZiB0aGUgY2FjaGUgaXMgbGFyZ2VyIHRoYW4gRXhwci5jYWNoZUxlbmd0aCkKICAgICAqCWRlbGV0aW5nIHRoZSBvbGRlc3QgZW50cnkKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlQ2FjaGUoKSB7CiAgICAgIHZhciBrZXlzID0gW107CiAgICAgIGZ1bmN0aW9uIGNhY2hlKGtleSwgdmFsdWUpIHsKICAgICAgICAvLyBVc2UgKGtleSArICIgIikgdG8gYXZvaWQgY29sbGlzaW9uIHdpdGggbmF0aXZlIHByb3RvdHlwZSBwcm9wZXJ0aWVzIChzZWUgSXNzdWUgIzE1NykKICAgICAgICBpZiAoa2V5cy5wdXNoKGtleSArICIgIikgPiBFeHByLmNhY2hlTGVuZ3RoKSB7CiAgICAgICAgICAvLyBPbmx5IGtlZXAgdGhlIG1vc3QgcmVjZW50IGVudHJpZXMKICAgICAgICAgIGRlbGV0ZSBjYWNoZVtrZXlzLnNoaWZ0KCldOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY2FjaGVba2V5ICsgIiAiXSA9IHZhbHVlOwogICAgICB9CiAgICAgIHJldHVybiBjYWNoZTsKICAgIH0KCiAgICAvKioKICAgICAqIE1hcmsgYSBmdW5jdGlvbiBmb3Igc3BlY2lhbCB1c2UgYnkgU2l6emxlCiAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBUaGUgZnVuY3Rpb24gdG8gbWFyawogICAgICovCiAgICBmdW5jdGlvbiBtYXJrRnVuY3Rpb24oZm4pIHsKICAgICAgZm5bZXhwYW5kb10gPSB0cnVlOwogICAgICByZXR1cm4gZm47CiAgICB9CgogICAgLyoqCiAgICAgKiBTdXBwb3J0IHRlc3RpbmcgdXNpbmcgYW4gZWxlbWVudAogICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gUGFzc2VkIHRoZSBjcmVhdGVkIGVsZW1lbnQgYW5kIHJldHVybnMgYSBib29sZWFuIHJlc3VsdAogICAgICovCiAgICBmdW5jdGlvbiBhc3NlcnQoZm4pIHsKICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKTsKICAgICAgdHJ5IHsKICAgICAgICByZXR1cm4gISFmbihlbCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gZmluYWxseSB7CiAgICAgICAgLy8gUmVtb3ZlIGZyb20gaXRzIHBhcmVudCBieSBkZWZhdWx0CiAgICAgICAgaWYgKGVsLnBhcmVudE5vZGUpIHsKICAgICAgICAgIGVsLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWwpOwogICAgICAgIH0KCiAgICAgICAgLy8gcmVsZWFzZSBtZW1vcnkgaW4gSUUKICAgICAgICBlbCA9IG51bGw7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIEFkZHMgdGhlIHNhbWUgaGFuZGxlciBmb3IgYWxsIG9mIHRoZSBzcGVjaWZpZWQgYXR0cnMKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBhdHRycyBQaXBlLXNlcGFyYXRlZCBsaXN0IG9mIGF0dHJpYnV0ZXMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGhhbmRsZXIgVGhlIG1ldGhvZCB0aGF0IHdpbGwgYmUgYXBwbGllZAogICAgICovCiAgICBmdW5jdGlvbiBhZGRIYW5kbGUoYXR0cnMsIGhhbmRsZXIpIHsKICAgICAgdmFyIGFyciA9IGF0dHJzLnNwbGl0KCJ8IiksCiAgICAgICAgaSA9IGFyci5sZW5ndGg7CiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBFeHByLmF0dHJIYW5kbGVbYXJyW2ldXSA9IGhhbmRsZXI7CiAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBkb2N1bWVudCBvcmRlciBvZiB0d28gc2libGluZ3MKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gYQogICAgICogQHBhcmFtIHtFbGVtZW50fSBiCiAgICAgKiBAcmV0dXJucyB7TnVtYmVyfSBSZXR1cm5zIGxlc3MgdGhhbiAwIGlmIGEgcHJlY2VkZXMgYiwgZ3JlYXRlciB0aGFuIDAgaWYgYSBmb2xsb3dzIGIKICAgICAqLwogICAgZnVuY3Rpb24gc2libGluZ0NoZWNrKGEsIGIpIHsKICAgICAgdmFyIGN1ciA9IGIgJiYgYSwKICAgICAgICBkaWZmID0gY3VyICYmIGEubm9kZVR5cGUgPT09IDEgJiYgYi5ub2RlVHlwZSA9PT0gMSAmJiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCiAgICAgIC8vIFVzZSBJRSBzb3VyY2VJbmRleCBpZiBhdmFpbGFibGUgb24gYm90aCBub2RlcwogICAgICBpZiAoZGlmZikgewogICAgICAgIHJldHVybiBkaWZmOwogICAgICB9CgogICAgICAvLyBDaGVjayBpZiBiIGZvbGxvd3MgYQogICAgICBpZiAoY3VyKSB7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5uZXh0U2libGluZykgewogICAgICAgICAgaWYgKGN1ciA9PT0gYikgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBhID8gMSA6IC0xOwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciBpbnB1dCB0eXBlcwogICAgICogQHBhcmFtIHtTdHJpbmd9IHR5cGUKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlSW5wdXRQc2V1ZG8odHlwZSkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICB2YXIgbmFtZSA9IGVsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgICByZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09IHR5cGU7CiAgICAgIH07CiAgICB9CgogICAgLyoqCiAgICAgKiBSZXR1cm5zIGEgZnVuY3Rpb24gdG8gdXNlIGluIHBzZXVkb3MgZm9yIGJ1dHRvbnMKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0eXBlCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZUJ1dHRvblBzZXVkbyh0eXBlKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIHZhciBuYW1lID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwogICAgICAgIHJldHVybiAobmFtZSA9PT0gImlucHV0IiB8fCBuYW1lID09PSAiYnV0dG9uIikgJiYgZWxlbS50eXBlID09PSB0eXBlOwogICAgICB9OwogICAgfQoKICAgIC8qKgogICAgICogUmV0dXJucyBhIGZ1bmN0aW9uIHRvIHVzZSBpbiBwc2V1ZG9zIGZvciA6ZW5hYmxlZC86ZGlzYWJsZWQKICAgICAqIEBwYXJhbSB7Qm9vbGVhbn0gZGlzYWJsZWQgdHJ1ZSBmb3IgOmRpc2FibGVkOyBmYWxzZSBmb3IgOmVuYWJsZWQKICAgICAqLwogICAgZnVuY3Rpb24gY3JlYXRlRGlzYWJsZWRQc2V1ZG8oZGlzYWJsZWQpIHsKICAgICAgLy8gS25vd24gOmRpc2FibGVkIGZhbHNlIHBvc2l0aXZlczogZmllbGRzZXRbZGlzYWJsZWRdID4gbGVnZW5kOm50aC1vZi10eXBlKG4rMikgOmNhbi1kaXNhYmxlCiAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIC8vIE9ubHkgY2VydGFpbiBlbGVtZW50cyBjYW4gbWF0Y2ggOmVuYWJsZWQgb3IgOmRpc2FibGVkCiAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2Uvc2NyaXB0aW5nLmh0bWwjc2VsZWN0b3ItZW5hYmxlZAogICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3NjcmlwdGluZy5odG1sI3NlbGVjdG9yLWRpc2FibGVkCiAgICAgICAgaWYgKCJmb3JtIiBpbiBlbGVtKSB7CiAgICAgICAgICAvLyBDaGVjayBmb3IgaW5oZXJpdGVkIGRpc2FibGVkbmVzcyBvbiByZWxldmFudCBub24tZGlzYWJsZWQgZWxlbWVudHM6CiAgICAgICAgICAvLyAqIGxpc3RlZCBmb3JtLWFzc29jaWF0ZWQgZWxlbWVudHMgaW4gYSBkaXNhYmxlZCBmaWVsZHNldAogICAgICAgICAgLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NhdGVnb3J5LWxpc3RlZAogICAgICAgICAgLy8gICBodHRwczovL2h0bWwuc3BlYy53aGF0d2cub3JnL211bHRpcGFnZS9mb3Jtcy5odG1sI2NvbmNlcHQtZmUtZGlzYWJsZWQKICAgICAgICAgIC8vICogb3B0aW9uIGVsZW1lbnRzIGluIGEgZGlzYWJsZWQgb3B0Z3JvdXAKICAgICAgICAgIC8vICAgaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy9tdWx0aXBhZ2UvZm9ybXMuaHRtbCNjb25jZXB0LW9wdGlvbi1kaXNhYmxlZAogICAgICAgICAgLy8gQWxsIHN1Y2ggZWxlbWVudHMgaGF2ZSBhICJmb3JtIiBwcm9wZXJ0eS4KICAgICAgICAgIGlmIChlbGVtLnBhcmVudE5vZGUgJiYgZWxlbS5kaXNhYmxlZCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgLy8gT3B0aW9uIGVsZW1lbnRzIGRlZmVyIHRvIGEgcGFyZW50IG9wdGdyb3VwIGlmIHByZXNlbnQKICAgICAgICAgICAgaWYgKCJsYWJlbCIgaW4gZWxlbSkgewogICAgICAgICAgICAgIGlmICgibGFiZWwiIGluIGVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGVsZW0ucGFyZW50Tm9kZS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDYgLSAxMQogICAgICAgICAgICAvLyBVc2UgdGhlIGlzRGlzYWJsZWQgc2hvcnRjdXQgcHJvcGVydHkgdG8gY2hlY2sgZm9yIGRpc2FibGVkIGZpZWxkc2V0IGFuY2VzdG9ycwogICAgICAgICAgICByZXR1cm4gZWxlbS5pc0Rpc2FibGVkID09PSBkaXNhYmxlZCB8fAogICAgICAgICAgICAvLyBXaGVyZSB0aGVyZSBpcyBubyBpc0Rpc2FibGVkLCBjaGVjayBtYW51YWxseQogICAgICAgICAgICAvKiBqc2hpbnQgLVcwMTggKi8KICAgICAgICAgICAgZWxlbS5pc0Rpc2FibGVkICE9PSAhZGlzYWJsZWQgJiYgaW5EaXNhYmxlZEZpZWxkc2V0KGVsZW0pID09PSBkaXNhYmxlZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtLmRpc2FibGVkID09PSBkaXNhYmxlZDsKCiAgICAgICAgICAvLyBUcnkgdG8gd2lubm93IG91dCBlbGVtZW50cyB0aGF0IGNhbid0IGJlIGRpc2FibGVkIGJlZm9yZSB0cnVzdGluZyB0aGUgZGlzYWJsZWQgcHJvcGVydHkuCiAgICAgICAgICAvLyBTb21lIHZpY3RpbXMgZ2V0IGNhdWdodCBpbiBvdXIgbmV0IChsYWJlbCwgbGVnZW5kLCBtZW51LCB0cmFjayksIGJ1dCBpdCBzaG91bGRuJ3QKICAgICAgICAgIC8vIGV2ZW4gZXhpc3Qgb24gdGhlbSwgbGV0IGFsb25lIGhhdmUgYSBib29sZWFuIHZhbHVlLgogICAgICAgIH0gZWxzZSBpZiAoImxhYmVsIiBpbiBlbGVtKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5kaXNhYmxlZCA9PT0gZGlzYWJsZWQ7CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1haW5pbmcgZWxlbWVudHMgYXJlIG5laXRoZXIgOmVuYWJsZWQgbm9yIDpkaXNhYmxlZAogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfTsKICAgIH0KCiAgICAvKioKICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB0byB1c2UgaW4gcHNldWRvcyBmb3IgcG9zaXRpb25hbHMKICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICAgKi8KICAgIGZ1bmN0aW9uIGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZm4pIHsKICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoYXJndW1lbnQpIHsKICAgICAgICBhcmd1bWVudCA9ICthcmd1bWVudDsKICAgICAgICByZXR1cm4gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICB2YXIgaiwKICAgICAgICAgICAgbWF0Y2hJbmRleGVzID0gZm4oW10sIHNlZWQubGVuZ3RoLCBhcmd1bWVudCksCiAgICAgICAgICAgIGkgPSBtYXRjaEluZGV4ZXMubGVuZ3RoOwoKICAgICAgICAgIC8vIE1hdGNoIGVsZW1lbnRzIGZvdW5kIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXhlcwogICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICBpZiAoc2VlZFtqID0gbWF0Y2hJbmRleGVzW2ldXSkgewogICAgICAgICAgICAgIHNlZWRbal0gPSAhKG1hdGNoZXNbal0gPSBzZWVkW2pdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KCiAgICAvKioKICAgICAqIENoZWNrcyBhIG5vZGUgZm9yIHZhbGlkaXR5IGFzIGEgU2l6emxlIGNvbnRleHQKICAgICAqIEBwYXJhbSB7RWxlbWVudHxPYmplY3Q9fSBjb250ZXh0CiAgICAgKiBAcmV0dXJucyB7RWxlbWVudHxPYmplY3R8Qm9vbGVhbn0gVGhlIGlucHV0IG5vZGUgaWYgYWNjZXB0YWJsZSwgb3RoZXJ3aXNlIGEgZmFsc3kgdmFsdWUKICAgICAqLwogICAgZnVuY3Rpb24gdGVzdENvbnRleHQoY29udGV4dCkgewogICAgICByZXR1cm4gY29udGV4dCAmJiB0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgY29udGV4dDsKICAgIH0KCiAgICAvLyBFeHBvc2Ugc3VwcG9ydCB2YXJzIGZvciBjb252ZW5pZW5jZQogICAgc3VwcG9ydCA9IFNpenpsZS5zdXBwb3J0ID0ge307CgogICAgLyoqCiAgICAgKiBEZXRlY3RzIFhNTCBub2RlcwogICAgICogQHBhcmFtIHtFbGVtZW50fE9iamVjdH0gZWxlbSBBbiBlbGVtZW50IG9yIGEgZG9jdW1lbnQKICAgICAqIEByZXR1cm5zIHtCb29sZWFufSBUcnVlIGlmZiBlbGVtIGlzIGEgbm9uLUhUTUwgWE1MIG5vZGUKICAgICAqLwogICAgaXNYTUwgPSBTaXp6bGUuaXNYTUwgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICB2YXIgbmFtZXNwYWNlID0gZWxlbSAmJiBlbGVtLm5hbWVzcGFjZVVSSSwKICAgICAgICBkb2NFbGVtID0gZWxlbSAmJiAoZWxlbS5vd25lckRvY3VtZW50IHx8IGVsZW0pLmRvY3VtZW50RWxlbWVudDsKCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OAogICAgICAvLyBBc3N1bWUgSFRNTCB3aGVuIGRvY3VtZW50RWxlbWVudCBkb2Vzbid0IHlldCBleGlzdCwgc3VjaCBhcyBpbnNpZGUgbG9hZGluZyBpZnJhbWVzCiAgICAgIC8vIGh0dHBzOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC80ODMzCiAgICAgIHJldHVybiAhcmh0bWwudGVzdChuYW1lc3BhY2UgfHwgZG9jRWxlbSAmJiBkb2NFbGVtLm5vZGVOYW1lIHx8ICJIVE1MIik7CiAgICB9OwoKICAgIC8qKgogICAgICogU2V0cyBkb2N1bWVudC1yZWxhdGVkIHZhcmlhYmxlcyBvbmNlIGJhc2VkIG9uIHRoZSBjdXJyZW50IGRvY3VtZW50CiAgICAgKiBAcGFyYW0ge0VsZW1lbnR8T2JqZWN0fSBbZG9jXSBBbiBlbGVtZW50IG9yIGRvY3VtZW50IG9iamVjdCB0byB1c2UgdG8gc2V0IHRoZSBkb2N1bWVudAogICAgICogQHJldHVybnMge09iamVjdH0gUmV0dXJucyB0aGUgY3VycmVudCBkb2N1bWVudAogICAgICovCiAgICBzZXREb2N1bWVudCA9IFNpenpsZS5zZXREb2N1bWVudCA9IGZ1bmN0aW9uIChub2RlKSB7CiAgICAgIHZhciBoYXNDb21wYXJlLAogICAgICAgIHN1YldpbmRvdywKICAgICAgICBkb2MgPSBub2RlID8gbm9kZS5vd25lckRvY3VtZW50IHx8IG5vZGUgOiBwcmVmZXJyZWREb2M7CgogICAgICAvLyBSZXR1cm4gZWFybHkgaWYgZG9jIGlzIGludmFsaWQgb3IgYWxyZWFkeSBzZWxlY3RlZAogICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgaWYgKGRvYyA9PSBkb2N1bWVudCB8fCBkb2Mubm9kZVR5cGUgIT09IDkgfHwgIWRvYy5kb2N1bWVudEVsZW1lbnQpIHsKICAgICAgICByZXR1cm4gZG9jdW1lbnQ7CiAgICAgIH0KCiAgICAgIC8vIFVwZGF0ZSBnbG9iYWwgdmFyaWFibGVzCiAgICAgIGRvY3VtZW50ID0gZG9jOwogICAgICBkb2NFbGVtID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICBkb2N1bWVudElzSFRNTCA9ICFpc1hNTChkb2N1bWVudCk7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTErLCBFZGdlIDEyIC0gMTgrCiAgICAgIC8vIEFjY2Vzc2luZyBpZnJhbWUgZG9jdW1lbnRzIGFmdGVyIHVubG9hZCB0aHJvd3MgInBlcm1pc3Npb24gZGVuaWVkIiBlcnJvcnMgKGpRdWVyeSAjMTM5MzYpCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICBpZiAocHJlZmVycmVkRG9jICE9IGRvY3VtZW50ICYmIChzdWJXaW5kb3cgPSBkb2N1bWVudC5kZWZhdWx0VmlldykgJiYgc3ViV2luZG93LnRvcCAhPT0gc3ViV2luZG93KSB7CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTEsIEVkZ2UKICAgICAgICBpZiAoc3ViV2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgIHN1YldpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ1bmxvYWQiLCB1bmxvYWRIYW5kbGVyLCBmYWxzZSk7CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDEwIG9ubHkKICAgICAgICB9IGVsc2UgaWYgKHN1YldpbmRvdy5hdHRhY2hFdmVudCkgewogICAgICAgICAgc3ViV2luZG93LmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIHVubG9hZEhhbmRsZXIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gU3VwcG9ydDogSUUgOCAtIDExKywgRWRnZSAxMiAtIDE4KywgQ2hyb21lIDw9MTYgLSAyNSBvbmx5LCBGaXJlZm94IDw9My42IC0gMzEgb25seSwKICAgICAgLy8gU2FmYXJpIDQgLSA1IG9ubHksIE9wZXJhIDw9MTEuNiAtIDEyLnggb25seQogICAgICAvLyBJRS9FZGdlICYgb2xkZXIgYnJvd3NlcnMgZG9uJ3Qgc3VwcG9ydCB0aGUgOnNjb3BlIHBzZXVkby1jbGFzcy4KICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDYuMCBvbmx5CiAgICAgIC8vIFNhZmFyaSA2LjAgc3VwcG9ydHMgOnNjb3BlIGJ1dCBpdCdzIGFuIGFsaWFzIG9mIDpyb290IHRoZXJlLgogICAgICBzdXBwb3J0LnNjb3BlID0gYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoZWwpLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKICAgICAgICByZXR1cm4gdHlwZW9mIGVsLnF1ZXJ5U2VsZWN0b3JBbGwgIT09ICJ1bmRlZmluZWQiICYmICFlbC5xdWVyeVNlbGVjdG9yQWxsKCI6c2NvcGUgZmllbGRzZXQgZGl2IikubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSAxMDUrLCBGaXJlZm94IDEwNCssIFNhZmFyaSAxNS40KwogICAgICAvLyBNYWtlIHN1cmUgZm9yZ2l2aW5nIG1vZGUgaXMgbm90IHVzZWQgaW4gYENTUy5zdXBwb3J0cyggInNlbGVjdG9yKC4uLikiIClgLgogICAgICAvLwogICAgICAvLyBgOmlzKClgIHVzZXMgYSBmb3JnaXZpbmcgc2VsZWN0b3IgbGlzdCBhcyBhbiBhcmd1bWVudCBhbmQgaXMgd2lkZWx5CiAgICAgIC8vIGltcGxlbWVudGVkLCBzbyBpdCdzIGEgZ29vZCBvbmUgdG8gdGVzdCBhZ2FpbnN0LgogICAgICBzdXBwb3J0LmNzc1N1cHBvcnRzU2VsZWN0b3IgPSBhc3NlcnQoZnVuY3Rpb24gKCkgewogICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLXVuZGVmICovCgogICAgICAgIHJldHVybiBDU1Muc3VwcG9ydHMoInNlbGVjdG9yKCopIikgJiYKICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDc4LTgxIG9ubHkKICAgICAgICAvLyBJbiBvbGQgRmlyZWZveCwgYDppcygpYCBkaWRuJ3QgdXNlIGZvcmdpdmluZyBwYXJzaW5nLiBJbiB0aGF0IGNhc2UsCiAgICAgICAgLy8gZmFpbCB0aGlzIHRlc3QgYXMgdGhlcmUncyBubyBzZWxlY3RvciB0byB0ZXN0IGFnYWluc3QgdGhhdC4KICAgICAgICAvLyBgQ1NTLnN1cHBvcnRzYCB1c2VzIHVuZm9yZ2l2aW5nIHBhcnNpbmcKICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCI6aXMoOmpxZmFrZSkiKSAmJgogICAgICAgIC8vIGAqYCBpcyBuZWVkZWQgYXMgU2FmYXJpICYgbmV3ZXIgQ2hyb21lIGltcGxlbWVudGVkIHNvbWV0aGluZyBpbiBiZXR3ZWVuCiAgICAgICAgLy8gZm9yIGA6aGFzKClgIC0gaXQgdGhyb3dzIGluIGBxU0FgIGlmIGl0IG9ubHkgY29udGFpbnMgYW4gdW5zdXBwb3J0ZWQKICAgICAgICAvLyBhcmd1bWVudCBidXQgbXVsdGlwbGUgb25lcywgb25lIG9mIHdoaWNoIGlzIHN1cHBvcnRlZCwgYXJlIGZpbmUuCiAgICAgICAgLy8gV2Ugd2FudCB0byBwbGF5IHNhZmUgaW4gY2FzZSBgOmlzKClgIGdldHMgdGhlIHNhbWUgdHJlYXRtZW50LgogICAgICAgICFDU1Muc3VwcG9ydHMoInNlbGVjdG9yKDppcygqLDpqcWZha2UpKSIpOwoKICAgICAgICAvKiBlc2xpbnQtZW5hYmxlICovCiAgICAgIH0pOwoKICAgICAgLyogQXR0cmlidXRlcwogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgogICAgICAvLyBTdXBwb3J0OiBJRTw4CiAgICAgIC8vIFZlcmlmeSB0aGF0IGdldEF0dHJpYnV0ZSByZWFsbHkgcmV0dXJucyBhdHRyaWJ1dGVzIGFuZCBub3QgcHJvcGVydGllcwogICAgICAvLyAoZXhjZXB0aW5nIElFOCBib29sZWFucykKICAgICAgc3VwcG9ydC5hdHRyaWJ1dGVzID0gYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgIGVsLmNsYXNzTmFtZSA9ICJpIjsKICAgICAgICByZXR1cm4gIWVsLmdldEF0dHJpYnV0ZSgiY2xhc3NOYW1lIik7CiAgICAgIH0pOwoKICAgICAgLyogZ2V0RWxlbWVudChzKUJ5KgogICAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovCgogICAgICAvLyBDaGVjayBpZiBnZXRFbGVtZW50c0J5VGFnTmFtZSgiKiIpIHJldHVybnMgb25seSBlbGVtZW50cwogICAgICBzdXBwb3J0LmdldEVsZW1lbnRzQnlUYWdOYW1lID0gYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgIGVsLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpKTsKICAgICAgICByZXR1cm4gIWVsLmdldEVsZW1lbnRzQnlUYWdOYW1lKCIqIikubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgICAgc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gcm5hdGl2ZS50ZXN0KGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUpOwoKICAgICAgLy8gU3VwcG9ydDogSUU8MTAKICAgICAgLy8gQ2hlY2sgaWYgZ2V0RWxlbWVudEJ5SWQgcmV0dXJucyBlbGVtZW50cyBieSBuYW1lCiAgICAgIC8vIFRoZSBicm9rZW4gZ2V0RWxlbWVudEJ5SWQgbWV0aG9kcyBkb24ndCBwaWNrIHVwIHByb2dyYW1tYXRpY2FsbHktc2V0IG5hbWVzLAogICAgICAvLyBzbyB1c2UgYSByb3VuZGFib3V0IGdldEVsZW1lbnRzQnlOYW1lIHRlc3QKICAgICAgc3VwcG9ydC5nZXRCeUlkID0gYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoZWwpLmlkID0gZXhwYW5kbzsKICAgICAgICByZXR1cm4gIWRvY3VtZW50LmdldEVsZW1lbnRzQnlOYW1lIHx8ICFkb2N1bWVudC5nZXRFbGVtZW50c0J5TmFtZShleHBhbmRvKS5sZW5ndGg7CiAgICAgIH0pOwoKICAgICAgLy8gSUQgZmlsdGVyIGFuZCBmaW5kCiAgICAgIGlmIChzdXBwb3J0LmdldEJ5SWQpIHsKICAgICAgICBFeHByLmZpbHRlclsiSUQiXSA9IGZ1bmN0aW9uIChpZCkgewogICAgICAgICAgdmFyIGF0dHJJZCA9IGlkLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZSgiaWQiKSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwogICAgICAgIEV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uIChpZCwgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgZWxlbSA9IGNvbnRleHQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogICAgICAgICAgICByZXR1cm4gZWxlbSA/IFtlbGVtXSA6IFtdOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgRXhwci5maWx0ZXJbIklEIl0gPSBmdW5jdGlvbiAoaWQpIHsKICAgICAgICAgIHZhciBhdHRySWQgPSBpZC5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgbm9kZSA9IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZU5vZGUgIT09ICJ1bmRlZmluZWQiICYmIGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKICAgICAgICAgICAgcmV0dXJuIG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gYXR0cklkOwogICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgICAvLyBTdXBwb3J0OiBJRSA2IC0gNyBvbmx5CiAgICAgICAgLy8gZ2V0RWxlbWVudEJ5SWQgaXMgbm90IHJlbGlhYmxlIGFzIGEgZmluZCBzaG9ydGN1dAogICAgICAgIEV4cHIuZmluZFsiSUQiXSA9IGZ1bmN0aW9uIChpZCwgY29udGV4dCkgewogICAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRCeUlkICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudElzSFRNTCkgewogICAgICAgICAgICB2YXIgbm9kZSwKICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgIGVsZW1zLAogICAgICAgICAgICAgIGVsZW0gPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKGlkKTsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAvLyBWZXJpZnkgdGhlIGlkIGF0dHJpYnV0ZQogICAgICAgICAgICAgIG5vZGUgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUoImlkIik7CiAgICAgICAgICAgICAgaWYgKG5vZGUgJiYgbm9kZS52YWx1ZSA9PT0gaWQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBbZWxlbV07CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBGYWxsIGJhY2sgb24gZ2V0RWxlbWVudHNCeU5hbWUKICAgICAgICAgICAgICBlbGVtcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeU5hbWUoaWQpOwogICAgICAgICAgICAgIGkgPSAwOwogICAgICAgICAgICAgIHdoaWxlIChlbGVtID0gZWxlbXNbaSsrXSkgewogICAgICAgICAgICAgICAgbm9kZSA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZSgiaWQiKTsKICAgICAgICAgICAgICAgIGlmIChub2RlICYmIG5vZGUudmFsdWUgPT09IGlkKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBbZWxlbV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CgogICAgICAvLyBUYWcKICAgICAgRXhwci5maW5kWyJUQUciXSA9IHN1cHBvcnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUgPyBmdW5jdGlvbiAodGFnLCBjb250ZXh0KSB7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgcmV0dXJuIGNvbnRleHQuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKCiAgICAgICAgICAvLyBEb2N1bWVudEZyYWdtZW50IG5vZGVzIGRvbid0IGhhdmUgZ0VCVE4KICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnQucXNhKSB7CiAgICAgICAgICByZXR1cm4gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHRhZyk7CiAgICAgICAgfQogICAgICB9IDogZnVuY3Rpb24gKHRhZywgY29udGV4dCkgewogICAgICAgIHZhciBlbGVtLAogICAgICAgICAgdG1wID0gW10sCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIC8vIEJ5IGhhcHB5IGNvaW5jaWRlbmNlLCBhIChicm9rZW4pIGdFQlROIGFwcGVhcnMgb24gRG9jdW1lbnRGcmFnbWVudCBub2RlcyB0b28KICAgICAgICAgIHJlc3VsdHMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgogICAgICAgIC8vIEZpbHRlciBvdXQgcG9zc2libGUgY29tbWVudHMKICAgICAgICBpZiAodGFnID09PSAiKiIpIHsKICAgICAgICAgIHdoaWxlIChlbGVtID0gcmVzdWx0c1tpKytdKSB7CiAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgdG1wLnB1c2goZWxlbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0bXA7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHRzOwogICAgICB9OwoKICAgICAgLy8gQ2xhc3MKICAgICAgRXhwci5maW5kWyJDTEFTUyJdID0gc3VwcG9ydC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmIGZ1bmN0aW9uIChjbGFzc05hbWUsIGNvbnRleHQpIHsKICAgICAgICBpZiAodHlwZW9mIGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnRJc0hUTUwpIHsKICAgICAgICAgIHJldHVybiBjb250ZXh0LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICAvKiBRU0EvbWF0Y2hlc1NlbGVjdG9yCiAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCiAgICAgIC8vIFFTQSBhbmQgbWF0Y2hlc1NlbGVjdG9yIHN1cHBvcnQKCiAgICAgIC8vIG1hdGNoZXNTZWxlY3Rvcig6YWN0aXZlKSByZXBvcnRzIGZhbHNlIHdoZW4gdHJ1ZSAoSUU5L09wZXJhIDExLjUpCiAgICAgIHJidWdneU1hdGNoZXMgPSBbXTsKCiAgICAgIC8vIHFTYSg6Zm9jdXMpIHJlcG9ydHMgZmFsc2Ugd2hlbiB0cnVlIChDaHJvbWUgMjEpCiAgICAgIC8vIFdlIGFsbG93IHRoaXMgYmVjYXVzZSBvZiBhIGJ1ZyBpbiBJRTgvOSB0aGF0IHRocm93cyBhbiBlcnJvcgogICAgICAvLyB3aGVuZXZlciBgZG9jdW1lbnQuYWN0aXZlRWxlbWVudGAgaXMgYWNjZXNzZWQgb24gYW4gaWZyYW1lCiAgICAgIC8vIFNvLCB3ZSBhbGxvdyA6Zm9jdXMgdG8gcGFzcyB0aHJvdWdoIFFTQSBhbGwgdGhlIHRpbWUgdG8gYXZvaWQgdGhlIElFIGVycm9yCiAgICAgIC8vIFNlZSBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTMzNzgKICAgICAgcmJ1Z2d5UVNBID0gW107CiAgICAgIGlmIChzdXBwb3J0LnFzYSA9IHJuYXRpdmUudGVzdChkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKSkgewogICAgICAgIC8vIEJ1aWxkIFFTQSByZWdleAogICAgICAgIC8vIFJlZ2V4IHN0cmF0ZWd5IGFkb3B0ZWQgZnJvbSBEaWVnbyBQZXJpbmkKICAgICAgICBhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgICAgICB2YXIgaW5wdXQ7CgogICAgICAgICAgLy8gU2VsZWN0IGlzIHNldCB0byBlbXB0eSBzdHJpbmcgb24gcHVycG9zZQogICAgICAgICAgLy8gVGhpcyBpcyB0byB0ZXN0IElFJ3MgdHJlYXRtZW50IG9mIG5vdCBleHBsaWNpdGx5CiAgICAgICAgICAvLyBzZXR0aW5nIGEgYm9vbGVhbiBjb250ZW50IGF0dHJpYnV0ZSwKICAgICAgICAgIC8vIHNpbmNlIGl0cyBwcmVzZW5jZSBzaG91bGQgYmUgZW5vdWdoCiAgICAgICAgICAvLyBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTIzNTkKICAgICAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoZWwpLmlubmVySFRNTCA9ICI8YSBpZD0nIiArIGV4cGFuZG8gKyAiJz48L2E+IiArICI8c2VsZWN0IGlkPSciICsgZXhwYW5kbyArICItXHJcXCcgbXNhbGxvd2NhcHR1cmU9Jyc+IiArICI8b3B0aW9uIHNlbGVjdGVkPScnPjwvb3B0aW9uPjwvc2VsZWN0PiI7CgogICAgICAgICAgLy8gU3VwcG9ydDogSUU4LCBPcGVyYSAxMS0xMi4xNgogICAgICAgICAgLy8gTm90aGluZyBzaG91bGQgYmUgc2VsZWN0ZWQgd2hlbiBlbXB0eSBzdHJpbmdzIGZvbGxvdyBePSBvciAkPSBvciAqPQogICAgICAgICAgLy8gVGhlIHRlc3QgYXR0cmlidXRlIG11c3QgYmUgdW5rbm93biBpbiBPcGVyYSBidXQgInNhZmUiIGZvciBXaW5SVAogICAgICAgICAgLy8gaHR0cHM6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9oaDQ2NTM4OC5hc3B4I2F0dHJpYnV0ZV9zZWN0aW9uCiAgICAgICAgICBpZiAoZWwucXVlcnlTZWxlY3RvckFsbCgiW21zYWxsb3djYXB0dXJlXj0nJ10iKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIlsqXiRdPSIgKyB3aGl0ZXNwYWNlICsgIiooPzonJ3xcIlwiKSIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gQm9vbGVhbiBhdHRyaWJ1dGVzIGFuZCAidmFsdWUiIGFyZSBub3QgdHJlYXRlZCBjb3JyZWN0bHkKICAgICAgICAgIGlmICghZWwucXVlcnlTZWxlY3RvckFsbCgiW3NlbGVjdGVkXSIpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiXFxbIiArIHdoaXRlc3BhY2UgKyAiKig/OnZhbHVlfCIgKyBib29sZWFucyArICIpIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lPDI5LCBBbmRyb2lkPDQuNCwgU2FmYXJpPDcuMCssIGlPUzw3LjArLCBQaGFudG9tSlM8MS45LjgrCiAgICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltpZH49IiArIGV4cGFuZG8gKyAiLV0iKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIn49Iik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE1IC0gMTgrCiAgICAgICAgICAvLyBJRSAxMS9FZGdlIGRvbid0IGZpbmQgZWxlbWVudHMgb24gYSBgW25hbWU9JyddYCBxdWVyeSBpbiBzb21lIGNhc2VzLgogICAgICAgICAgLy8gQWRkaW5nIGEgdGVtcG9yYXJ5IGF0dHJpYnV0ZSB0byB0aGUgZG9jdW1lbnQgYmVmb3JlIHRoZSBzZWxlY3Rpb24gd29ya3MKICAgICAgICAgIC8vIGFyb3VuZCB0aGUgaXNzdWUuCiAgICAgICAgICAvLyBJbnRlcmVzdGluZ2x5LCBJRSAxMCAmIG9sZGVyIGRvbid0IHNlZW0gdG8gaGF2ZSB0aGUgaXNzdWUuCiAgICAgICAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAiIik7CiAgICAgICAgICBlbC5hcHBlbmRDaGlsZChpbnB1dCk7CiAgICAgICAgICBpZiAoIWVsLnF1ZXJ5U2VsZWN0b3JBbGwoIltuYW1lPScnXSIpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiXFxbIiArIHdoaXRlc3BhY2UgKyAiKm5hbWUiICsgd2hpdGVzcGFjZSArICIqPSIgKyB3aGl0ZXNwYWNlICsgIiooPzonJ3xcIlwiKSIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFdlYmtpdC9PcGVyYSAtIDpjaGVja2VkIHNob3VsZCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9uIGVsZW1lbnRzCiAgICAgICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi8yMDExL1JFQy1jc3MzLXNlbGVjdG9ycy0yMDExMDkyOS8jY2hlY2tlZAogICAgICAgICAgLy8gSUU4IHRocm93cyBlcnJvciBoZXJlIGFuZCB3aWxsIG5vdCBzZWUgbGF0ZXIgdGVzdHMKICAgICAgICAgIGlmICghZWwucXVlcnlTZWxlY3RvckFsbCgiOmNoZWNrZWQiKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIjpjaGVja2VkIik7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogU2FmYXJpIDgrLCBpT1MgOCsKICAgICAgICAgIC8vIGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0xMzY4NTEKICAgICAgICAgIC8vIEluLXBhZ2UgYHNlbGVjdG9yI2lkIHNpYmxpbmctY29tYmluYXRvciBzZWxlY3RvcmAgZmFpbHMKICAgICAgICAgIGlmICghZWwucXVlcnlTZWxlY3RvckFsbCgiYSMiICsgZXhwYW5kbyArICIrKiIpLmxlbmd0aCkgewogICAgICAgICAgICByYnVnZ3lRU0EucHVzaCgiLiMuK1srfl0iKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDw9My42IC0gNSBvbmx5CiAgICAgICAgICAvLyBPbGQgRmlyZWZveCBkb2Vzbid0IHRocm93IG9uIGEgYmFkbHktZXNjYXBlZCBpZGVudGlmaWVyLgogICAgICAgICAgZWwucXVlcnlTZWxlY3RvckFsbCgiXFxcZiIpOwogICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIltcXHJcXG5cXGZdIik7CiAgICAgICAgfSk7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgZWwuaW5uZXJIVE1MID0gIjxhIGhyZWY9JycgZGlzYWJsZWQ9J2Rpc2FibGVkJz48L2E+IiArICI8c2VsZWN0IGRpc2FibGVkPSdkaXNhYmxlZCc+PG9wdGlvbi8+PC9zZWxlY3Q+IjsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBXaW5kb3dzIDggTmF0aXZlIEFwcHMKICAgICAgICAgIC8vIFRoZSB0eXBlIGFuZCBuYW1lIGF0dHJpYnV0ZXMgYXJlIHJlc3RyaWN0ZWQgZHVyaW5nIC5pbm5lckhUTUwgYXNzaWdubWVudAogICAgICAgICAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgICAgICAgIGlucHV0LnNldEF0dHJpYnV0ZSgidHlwZSIsICJoaWRkZW4iKTsKICAgICAgICAgIGVsLmFwcGVuZENoaWxkKGlucHV0KS5zZXRBdHRyaWJ1dGUoIm5hbWUiLCAiRCIpOwoKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFOAogICAgICAgICAgLy8gRW5mb3JjZSBjYXNlLXNlbnNpdGl2aXR5IG9mIG5hbWUgYXR0cmlidXRlCiAgICAgICAgICBpZiAoZWwucXVlcnlTZWxlY3RvckFsbCgiW25hbWU9ZF0iKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIm5hbWUiICsgd2hpdGVzcGFjZSArICIqWypeJHwhfl0/PSIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIEZGIDMuNSAtIDplbmFibGVkLzpkaXNhYmxlZCBhbmQgaGlkZGVuIGVsZW1lbnRzIChoaWRkZW4gZWxlbWVudHMgYXJlIHN0aWxsIGVuYWJsZWQpCiAgICAgICAgICAvLyBJRTggdGhyb3dzIGVycm9yIGhlcmUgYW5kIHdpbGwgbm90IHNlZSBsYXRlciB0ZXN0cwogICAgICAgICAgaWYgKGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIjplbmFibGVkIikubGVuZ3RoICE9PSAyKSB7CiAgICAgICAgICAgIHJidWdneVFTQS5wdXNoKCI6ZW5hYmxlZCIsICI6ZGlzYWJsZWQiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRTktMTErCiAgICAgICAgICAvLyBJRSdzIDpkaXNhYmxlZCBzZWxlY3RvciBkb2VzIG5vdCBwaWNrIHVwIHRoZSBjaGlsZHJlbiBvZiBkaXNhYmxlZCBmaWVsZHNldHMKICAgICAgICAgIGRvY0VsZW0uYXBwZW5kQ2hpbGQoZWwpLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgIGlmIChlbC5xdWVyeVNlbGVjdG9yQWxsKCI6ZGlzYWJsZWQiKS5sZW5ndGggIT09IDIpIHsKICAgICAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIjplbmFibGVkIiwgIjpkaXNhYmxlZCIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFN1cHBvcnQ6IE9wZXJhIDEwIC0gMTEgb25seQogICAgICAgICAgLy8gT3BlcmEgMTAtMTEgZG9lcyBub3QgdGhyb3cgb24gcG9zdC1jb21tYSBpbnZhbGlkIHBzZXVkb3MKICAgICAgICAgIGVsLnF1ZXJ5U2VsZWN0b3JBbGwoIiosOngiKTsKICAgICAgICAgIHJidWdneVFTQS5wdXNoKCIsLio6Iik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yID0gcm5hdGl2ZS50ZXN0KG1hdGNoZXMgPSBkb2NFbGVtLm1hdGNoZXMgfHwgZG9jRWxlbS53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5tb3pNYXRjaGVzU2VsZWN0b3IgfHwgZG9jRWxlbS5vTWF0Y2hlc1NlbGVjdG9yIHx8IGRvY0VsZW0ubXNNYXRjaGVzU2VsZWN0b3IpKSB7CiAgICAgICAgYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIGl0J3MgcG9zc2libGUgdG8gZG8gbWF0Y2hlc1NlbGVjdG9yCiAgICAgICAgICAvLyBvbiBhIGRpc2Nvbm5lY3RlZCBub2RlIChJRSA5KQogICAgICAgICAgc3VwcG9ydC5kaXNjb25uZWN0ZWRNYXRjaCA9IG1hdGNoZXMuY2FsbChlbCwgIioiKTsKCiAgICAgICAgICAvLyBUaGlzIHNob3VsZCBmYWlsIHdpdGggYW4gZXhjZXB0aW9uCiAgICAgICAgICAvLyBHZWNrbyBkb2VzIG5vdCBlcnJvciwgcmV0dXJucyBmYWxzZSBpbnN0ZWFkCiAgICAgICAgICBtYXRjaGVzLmNhbGwoZWwsICJbcyE9JyddOngiKTsKICAgICAgICAgIHJidWdneU1hdGNoZXMucHVzaCgiIT0iLCBwc2V1ZG9zKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoIXN1cHBvcnQuY3NzU3VwcG9ydHNTZWxlY3RvcikgewogICAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSAxMDUrLCBTYWZhcmkgMTUuNCsKICAgICAgICAvLyBgOmhhcygpYCB1c2VzIGEgZm9yZ2l2aW5nIHNlbGVjdG9yIGxpc3QgYXMgYW4gYXJndW1lbnQgc28gb3VyIHJlZ3VsYXIKICAgICAgICAvLyBgdHJ5LWNhdGNoYCBtZWNoYW5pc20gZmFpbHMgdG8gY2F0Y2ggYDpoYXMoKWAgd2l0aCBhcmd1bWVudHMgbm90IHN1cHBvcnRlZAogICAgICAgIC8vIG5hdGl2ZWx5IGxpa2UgYDpoYXMoOmNvbnRhaW5zKCJGb28iKSlgLiBXaGVyZSBzdXBwb3J0ZWQgJiBzcGVjLWNvbXBsaWFudCwKICAgICAgICAvLyB3ZSBub3cgdXNlIGBDU1Muc3VwcG9ydHMoInNlbGVjdG9yKFNFTEVDVE9SX1RPX0JFX1RFU1RFRCkiKWAgYnV0IG91dHNpZGUKICAgICAgICAvLyB0aGF0LCBsZXQncyBtYXJrIGA6aGFzYCBhcyBidWdneSB0byBhbHdheXMgdXNlIGpRdWVyeSB0cmF2ZXJzYWwgZm9yCiAgICAgICAgLy8gYDpoYXMoKWAuCiAgICAgICAgcmJ1Z2d5UVNBLnB1c2goIjpoYXMiKTsKICAgICAgfQogICAgICByYnVnZ3lRU0EgPSByYnVnZ3lRU0EubGVuZ3RoICYmIG5ldyBSZWdFeHAocmJ1Z2d5UVNBLmpvaW4oInwiKSk7CiAgICAgIHJidWdneU1hdGNoZXMgPSByYnVnZ3lNYXRjaGVzLmxlbmd0aCAmJiBuZXcgUmVnRXhwKHJidWdneU1hdGNoZXMuam9pbigifCIpKTsKCiAgICAgIC8qIENvbnRhaW5zCiAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KICAgICAgaGFzQ29tcGFyZSA9IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKTsKCiAgICAgIC8vIEVsZW1lbnQgY29udGFpbnMgYW5vdGhlcgogICAgICAvLyBQdXJwb3NlZnVsbHkgc2VsZi1leGNsdXNpdmUKICAgICAgLy8gQXMgaW4sIGFuIGVsZW1lbnQgZG9lcyBub3QgY29udGFpbiBpdHNlbGYKICAgICAgY29udGFpbnMgPSBoYXNDb21wYXJlIHx8IHJuYXRpdmUudGVzdChkb2NFbGVtLmNvbnRhaW5zKSA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgLy8gU3VwcG9ydDogSUUgPDkgb25seQogICAgICAgIC8vIElFIGRvZXNuJ3QgaGF2ZSBgY29udGFpbnNgIG9uIGBkb2N1bWVudGAgc28gd2UgbmVlZCB0byBjaGVjayBmb3IKICAgICAgICAvLyBgZG9jdW1lbnRFbGVtZW50YCBwcmVzZW5jZS4KICAgICAgICAvLyBXZSBuZWVkIHRvIGZhbGwgYmFjayB0byBgYWAgd2hlbiBgZG9jdW1lbnRFbGVtZW50YCBpcyBtaXNzaW5nCiAgICAgICAgLy8gYXMgYG93bmVyRG9jdW1lbnRgIG9mIGVsZW1lbnRzIHdpdGhpbiBgPHRlbXBsYXRlLz5gIG1heSBoYXZlCiAgICAgICAgLy8gYSBudWxsIG9uZSAtIGEgZGVmYXVsdCBiZWhhdmlvciBvZiBhbGwgbW9kZXJuIGJyb3dzZXJzLgogICAgICAgIHZhciBhZG93biA9IGEubm9kZVR5cGUgPT09IDkgJiYgYS5kb2N1bWVudEVsZW1lbnQgfHwgYSwKICAgICAgICAgIGJ1cCA9IGIgJiYgYi5wYXJlbnROb2RlOwogICAgICAgIHJldHVybiBhID09PSBidXAgfHwgISEoYnVwICYmIGJ1cC5ub2RlVHlwZSA9PT0gMSAmJiAoYWRvd24uY29udGFpbnMgPyBhZG93bi5jb250YWlucyhidXApIDogYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiAmJiBhLmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKGJ1cCkgJiAxNikpOwogICAgICB9IDogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYikgewogICAgICAgICAgd2hpbGUgKGIgPSBiLnBhcmVudE5vZGUpIHsKICAgICAgICAgICAgaWYgKGIgPT09IGEpIHsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CgogICAgICAvKiBTb3J0aW5nCiAgICAgIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi8KCiAgICAgIC8vIERvY3VtZW50IG9yZGVyIHNvcnRpbmcKICAgICAgc29ydE9yZGVyID0gaGFzQ29tcGFyZSA/IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgLy8gRmxhZyBmb3IgZHVwbGljYXRlIHJlbW92YWwKICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgLy8gU29ydCBvbiBtZXRob2QgZXhpc3RlbmNlIGlmIG9ubHkgb25lIGlucHV0IGhhcyBjb21wYXJlRG9jdW1lbnRQb3NpdGlvbgogICAgICAgIHZhciBjb21wYXJlID0gIWEuY29tcGFyZURvY3VtZW50UG9zaXRpb24gLSAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbjsKICAgICAgICBpZiAoY29tcGFyZSkgewogICAgICAgICAgcmV0dXJuIGNvbXBhcmU7CiAgICAgICAgfQoKICAgICAgICAvLyBDYWxjdWxhdGUgcG9zaXRpb24gaWYgYm90aCBpbnB1dHMgYmVsb25nIHRvIHRoZSBzYW1lIGRvY3VtZW50CiAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgY29tcGFyZSA9IChhLm93bmVyRG9jdW1lbnQgfHwgYSkgPT0gKGIub3duZXJEb2N1bWVudCB8fCBiKSA/IGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgOgogICAgICAgIC8vIE90aGVyd2lzZSB3ZSBrbm93IHRoZXkgYXJlIGRpc2Nvbm5lY3RlZAogICAgICAgIDE7CgogICAgICAgIC8vIERpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgIGlmIChjb21wYXJlICYgMSB8fCAhc3VwcG9ydC5zb3J0RGV0YWNoZWQgJiYgYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihhKSA9PT0gY29tcGFyZSkgewogICAgICAgICAgLy8gQ2hvb3NlIHRoZSBmaXJzdCBlbGVtZW50IHRoYXQgaXMgcmVsYXRlZCB0byBvdXIgcHJlZmVycmVkIGRvY3VtZW50CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgICAgIGlmIChhID09IGRvY3VtZW50IHx8IGEub3duZXJEb2N1bWVudCA9PSBwcmVmZXJyZWREb2MgJiYgY29udGFpbnMocHJlZmVycmVkRG9jLCBhKSkgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgICAgICBpZiAoYiA9PSBkb2N1bWVudCB8fCBiLm93bmVyRG9jdW1lbnQgPT0gcHJlZmVycmVkRG9jICYmIGNvbnRhaW5zKHByZWZlcnJlZERvYywgYikpIHsKICAgICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTWFpbnRhaW4gb3JpZ2luYWwgb3JkZXIKICAgICAgICAgIHJldHVybiBzb3J0SW5wdXQgPyBpbmRleE9mKHNvcnRJbnB1dCwgYSkgLSBpbmRleE9mKHNvcnRJbnB1dCwgYikgOiAwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gY29tcGFyZSAmIDQgPyAtMSA6IDE7CiAgICAgIH0gOiBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIC8vIEV4aXQgZWFybHkgaWYgdGhlIG5vZGVzIGFyZSBpZGVudGljYWwKICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgaGFzRHVwbGljYXRlID0gdHJ1ZTsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgICB2YXIgY3VyLAogICAgICAgICAgaSA9IDAsCiAgICAgICAgICBhdXAgPSBhLnBhcmVudE5vZGUsCiAgICAgICAgICBidXAgPSBiLnBhcmVudE5vZGUsCiAgICAgICAgICBhcCA9IFthXSwKICAgICAgICAgIGJwID0gW2JdOwoKICAgICAgICAvLyBQYXJlbnRsZXNzIG5vZGVzIGFyZSBlaXRoZXIgZG9jdW1lbnRzIG9yIGRpc2Nvbm5lY3RlZAogICAgICAgIGlmICghYXVwIHx8ICFidXApIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgZXFlcWVxICovCiAgICAgICAgICByZXR1cm4gYSA9PSBkb2N1bWVudCA/IC0xIDogYiA9PSBkb2N1bWVudCA/IDEgOiAvKiBlc2xpbnQtZW5hYmxlIGVxZXFlcSAqLwogICAgICAgICAgYXVwID8gLTEgOiBidXAgPyAxIDogc29ydElucHV0ID8gaW5kZXhPZihzb3J0SW5wdXQsIGEpIC0gaW5kZXhPZihzb3J0SW5wdXQsIGIpIDogMDsKCiAgICAgICAgICAvLyBJZiB0aGUgbm9kZXMgYXJlIHNpYmxpbmdzLCB3ZSBjYW4gZG8gYSBxdWljayBjaGVjawogICAgICAgIH0gZWxzZSBpZiAoYXVwID09PSBidXApIHsKICAgICAgICAgIHJldHVybiBzaWJsaW5nQ2hlY2soYSwgYik7CiAgICAgICAgfQoKICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbmVlZCBmdWxsIGxpc3RzIG9mIHRoZWlyIGFuY2VzdG9ycyBmb3IgY29tcGFyaXNvbgogICAgICAgIGN1ciA9IGE7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBhcC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQogICAgICAgIGN1ciA9IGI7CiAgICAgICAgd2hpbGUgKGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICBicC51bnNoaWZ0KGN1cik7CiAgICAgICAgfQoKICAgICAgICAvLyBXYWxrIGRvd24gdGhlIHRyZWUgbG9va2luZyBmb3IgYSBkaXNjcmVwYW5jeQogICAgICAgIHdoaWxlIChhcFtpXSA9PT0gYnBbaV0pIHsKICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGkgPwogICAgICAgIC8vIERvIGEgc2libGluZyBjaGVjayBpZiB0aGUgbm9kZXMgaGF2ZSBhIGNvbW1vbiBhbmNlc3RvcgogICAgICAgIHNpYmxpbmdDaGVjayhhcFtpXSwgYnBbaV0pIDoKICAgICAgICAvLyBPdGhlcndpc2Ugbm9kZXMgaW4gb3VyIGRvY3VtZW50IHNvcnQgZmlyc3QKICAgICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAgIC8qIGVzbGludC1kaXNhYmxlIGVxZXFlcSAqLwogICAgICAgIGFwW2ldID09IHByZWZlcnJlZERvYyA/IC0xIDogYnBbaV0gPT0gcHJlZmVycmVkRG9jID8gMSA6IC8qIGVzbGludC1lbmFibGUgZXFlcWVxICovCiAgICAgICAgMDsKICAgICAgfTsKICAgICAgcmV0dXJuIGRvY3VtZW50OwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzID0gZnVuY3Rpb24gKGV4cHIsIGVsZW1lbnRzKSB7CiAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgbnVsbCwgbnVsbCwgZWxlbWVudHMpOwogICAgfTsKICAgIFNpenpsZS5tYXRjaGVzU2VsZWN0b3IgPSBmdW5jdGlvbiAoZWxlbSwgZXhwcikgewogICAgICBzZXREb2N1bWVudChlbGVtKTsKICAgICAgaWYgKHN1cHBvcnQubWF0Y2hlc1NlbGVjdG9yICYmIGRvY3VtZW50SXNIVE1MICYmICFub25uYXRpdmVTZWxlY3RvckNhY2hlW2V4cHIgKyAiICJdICYmICghcmJ1Z2d5TWF0Y2hlcyB8fCAhcmJ1Z2d5TWF0Y2hlcy50ZXN0KGV4cHIpKSAmJiAoIXJidWdneVFTQSB8fCAhcmJ1Z2d5UVNBLnRlc3QoZXhwcikpKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHZhciByZXQgPSBtYXRjaGVzLmNhbGwoZWxlbSwgZXhwcik7CgogICAgICAgICAgLy8gSUUgOSdzIG1hdGNoZXNTZWxlY3RvciByZXR1cm5zIGZhbHNlIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogICAgICAgICAgaWYgKHJldCB8fCBzdXBwb3J0LmRpc2Nvbm5lY3RlZE1hdGNoIHx8CiAgICAgICAgICAvLyBBcyB3ZWxsLCBkaXNjb25uZWN0ZWQgbm9kZXMgYXJlIHNhaWQgdG8gYmUgaW4gYSBkb2N1bWVudAogICAgICAgICAgLy8gZnJhZ21lbnQgaW4gSUUgOQogICAgICAgICAgZWxlbS5kb2N1bWVudCAmJiBlbGVtLmRvY3VtZW50Lm5vZGVUeXBlICE9PSAxMSkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIG5vbm5hdGl2ZVNlbGVjdG9yQ2FjaGUoZXhwciwgdHJ1ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBTaXp6bGUoZXhwciwgZG9jdW1lbnQsIG51bGwsIFtlbGVtXSkubGVuZ3RoID4gMDsKICAgIH07CiAgICBTaXp6bGUuY29udGFpbnMgPSBmdW5jdGlvbiAoY29udGV4dCwgZWxlbSkgewogICAgICAvLyBTZXQgZG9jdW1lbnQgdmFycyBpZiBuZWVkZWQKICAgICAgLy8gU3VwcG9ydDogSUUgMTErLCBFZGdlIDE3IC0gMTgrCiAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgLy8gdHdvIGRvY3VtZW50czsgc2hhbGxvdyBjb21wYXJpc29ucyB3b3JrLgogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZXFlcWVxCiAgICAgIGlmICgoY29udGV4dC5vd25lckRvY3VtZW50IHx8IGNvbnRleHQpICE9IGRvY3VtZW50KSB7CiAgICAgICAgc2V0RG9jdW1lbnQoY29udGV4dCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGNvbnRhaW5zKGNvbnRleHQsIGVsZW0pOwogICAgfTsKICAgIFNpenpsZS5hdHRyID0gZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgLy8gU2V0IGRvY3VtZW50IHZhcnMgaWYgbmVlZGVkCiAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAvLyBJRS9FZGdlIHNvbWV0aW1lcyB0aHJvdyBhICJQZXJtaXNzaW9uIGRlbmllZCIgZXJyb3Igd2hlbiBzdHJpY3QtY29tcGFyaW5nCiAgICAgIC8vIHR3byBkb2N1bWVudHM7IHNoYWxsb3cgY29tcGFyaXNvbnMgd29yay4KICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICBpZiAoKGVsZW0ub3duZXJEb2N1bWVudCB8fCBlbGVtKSAhPSBkb2N1bWVudCkgewogICAgICAgIHNldERvY3VtZW50KGVsZW0pOwogICAgICB9CiAgICAgIHZhciBmbiA9IEV4cHIuYXR0ckhhbmRsZVtuYW1lLnRvTG93ZXJDYXNlKCldLAogICAgICAgIC8vIERvbid0IGdldCBmb29sZWQgYnkgT2JqZWN0LnByb3RvdHlwZSBwcm9wZXJ0aWVzIChqUXVlcnkgIzEzODA3KQogICAgICAgIHZhbCA9IGZuICYmIGhhc093bi5jYWxsKEV4cHIuYXR0ckhhbmRsZSwgbmFtZS50b0xvd2VyQ2FzZSgpKSA/IGZuKGVsZW0sIG5hbWUsICFkb2N1bWVudElzSFRNTCkgOiB1bmRlZmluZWQ7CiAgICAgIHJldHVybiB2YWwgIT09IHVuZGVmaW5lZCA/IHZhbCA6IHN1cHBvcnQuYXR0cmlidXRlcyB8fCAhZG9jdW1lbnRJc0hUTUwgPyBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKSA6ICh2YWwgPSBlbGVtLmdldEF0dHJpYnV0ZU5vZGUobmFtZSkpICYmIHZhbC5zcGVjaWZpZWQgPyB2YWwudmFsdWUgOiBudWxsOwogICAgfTsKICAgIFNpenpsZS5lc2NhcGUgPSBmdW5jdGlvbiAoc2VsKSB7CiAgICAgIHJldHVybiAoc2VsICsgIiIpLnJlcGxhY2UocmNzc2VzY2FwZSwgZmNzc2VzY2FwZSk7CiAgICB9OwogICAgU2l6emxlLmVycm9yID0gZnVuY3Rpb24gKG1zZykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlN5bnRheCBlcnJvciwgdW5yZWNvZ25pemVkIGV4cHJlc3Npb246ICIgKyBtc2cpOwogICAgfTsKCiAgICAvKioKICAgICAqIERvY3VtZW50IHNvcnRpbmcgYW5kIHJlbW92aW5nIGR1cGxpY2F0ZXMKICAgICAqIEBwYXJhbSB7QXJyYXlMaWtlfSByZXN1bHRzCiAgICAgKi8KICAgIFNpenpsZS51bmlxdWVTb3J0ID0gZnVuY3Rpb24gKHJlc3VsdHMpIHsKICAgICAgdmFyIGVsZW0sCiAgICAgICAgZHVwbGljYXRlcyA9IFtdLAogICAgICAgIGogPSAwLAogICAgICAgIGkgPSAwOwoKICAgICAgLy8gVW5sZXNzIHdlICprbm93KiB3ZSBjYW4gZGV0ZWN0IGR1cGxpY2F0ZXMsIGFzc3VtZSB0aGVpciBwcmVzZW5jZQogICAgICBoYXNEdXBsaWNhdGUgPSAhc3VwcG9ydC5kZXRlY3REdXBsaWNhdGVzOwogICAgICBzb3J0SW5wdXQgPSAhc3VwcG9ydC5zb3J0U3RhYmxlICYmIHJlc3VsdHMuc2xpY2UoMCk7CiAgICAgIHJlc3VsdHMuc29ydChzb3J0T3JkZXIpOwogICAgICBpZiAoaGFzRHVwbGljYXRlKSB7CiAgICAgICAgd2hpbGUgKGVsZW0gPSByZXN1bHRzW2krK10pIHsKICAgICAgICAgIGlmIChlbGVtID09PSByZXN1bHRzW2ldKSB7CiAgICAgICAgICAgIGogPSBkdXBsaWNhdGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHdoaWxlIChqLS0pIHsKICAgICAgICAgIHJlc3VsdHMuc3BsaWNlKGR1cGxpY2F0ZXNbal0sIDEpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ2xlYXIgaW5wdXQgYWZ0ZXIgc29ydGluZyB0byByZWxlYXNlIG9iamVjdHMKICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvc2l6emxlL3B1bGwvMjI1CiAgICAgIHNvcnRJbnB1dCA9IG51bGw7CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfTsKCiAgICAvKioKICAgICAqIFV0aWxpdHkgZnVuY3Rpb24gZm9yIHJldHJpZXZpbmcgdGhlIHRleHQgdmFsdWUgb2YgYW4gYXJyYXkgb2YgRE9NIG5vZGVzCiAgICAgKiBAcGFyYW0ge0FycmF5fEVsZW1lbnR9IGVsZW0KICAgICAqLwogICAgZ2V0VGV4dCA9IFNpenpsZS5nZXRUZXh0ID0gZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgdmFyIG5vZGUsCiAgICAgICAgcmV0ID0gIiIsCiAgICAgICAgaSA9IDAsCiAgICAgICAgbm9kZVR5cGUgPSBlbGVtLm5vZGVUeXBlOwogICAgICBpZiAoIW5vZGVUeXBlKSB7CiAgICAgICAgLy8gSWYgbm8gbm9kZVR5cGUsIHRoaXMgaXMgZXhwZWN0ZWQgdG8gYmUgYW4gYXJyYXkKICAgICAgICB3aGlsZSAobm9kZSA9IGVsZW1baSsrXSkgewogICAgICAgICAgLy8gRG8gbm90IHRyYXZlcnNlIGNvbW1lbnQgbm9kZXMKICAgICAgICAgIHJldCArPSBnZXRUZXh0KG5vZGUpOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChub2RlVHlwZSA9PT0gMSB8fCBub2RlVHlwZSA9PT0gOSB8fCBub2RlVHlwZSA9PT0gMTEpIHsKICAgICAgICAvLyBVc2UgdGV4dENvbnRlbnQgZm9yIGVsZW1lbnRzCiAgICAgICAgLy8gaW5uZXJUZXh0IHVzYWdlIHJlbW92ZWQgZm9yIGNvbnNpc3RlbmN5IG9mIG5ldyBsaW5lcyAoalF1ZXJ5ICMxMTE1MykKICAgICAgICBpZiAodHlwZW9mIGVsZW0udGV4dENvbnRlbnQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS50ZXh0Q29udGVudDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gVHJhdmVyc2UgaXRzIGNoaWxkcmVuCiAgICAgICAgICBmb3IgKGVsZW0gPSBlbGVtLmZpcnN0Q2hpbGQ7IGVsZW07IGVsZW0gPSBlbGVtLm5leHRTaWJsaW5nKSB7CiAgICAgICAgICAgIHJldCArPSBnZXRUZXh0KGVsZW0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChub2RlVHlwZSA9PT0gMyB8fCBub2RlVHlwZSA9PT0gNCkgewogICAgICAgIHJldHVybiBlbGVtLm5vZGVWYWx1ZTsKICAgICAgfQoKICAgICAgLy8gRG8gbm90IGluY2x1ZGUgY29tbWVudCBvciBwcm9jZXNzaW5nIGluc3RydWN0aW9uIG5vZGVzCgogICAgICByZXR1cm4gcmV0OwogICAgfTsKICAgIEV4cHIgPSBTaXp6bGUuc2VsZWN0b3JzID0gewogICAgICAvLyBDYW4gYmUgYWRqdXN0ZWQgYnkgdGhlIHVzZXIKICAgICAgY2FjaGVMZW5ndGg6IDUwLAogICAgICBjcmVhdGVQc2V1ZG86IG1hcmtGdW5jdGlvbiwKICAgICAgbWF0Y2g6IG1hdGNoRXhwciwKICAgICAgYXR0ckhhbmRsZToge30sCiAgICAgIGZpbmQ6IHt9LAogICAgICByZWxhdGl2ZTogewogICAgICAgICI+IjogewogICAgICAgICAgZGlyOiAicGFyZW50Tm9kZSIsCiAgICAgICAgICBmaXJzdDogdHJ1ZQogICAgICAgIH0sCiAgICAgICAgIiAiOiB7CiAgICAgICAgICBkaXI6ICJwYXJlbnROb2RlIgogICAgICAgIH0sCiAgICAgICAgIisiOiB7CiAgICAgICAgICBkaXI6ICJwcmV2aW91c1NpYmxpbmciLAogICAgICAgICAgZmlyc3Q6IHRydWUKICAgICAgICB9LAogICAgICAgICJ+IjogewogICAgICAgICAgZGlyOiAicHJldmlvdXNTaWJsaW5nIgogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJlRmlsdGVyOiB7CiAgICAgICAgIkFUVFIiOiBmdW5jdGlvbiAobWF0Y2gpIHsKICAgICAgICAgIG1hdGNoWzFdID0gbWF0Y2hbMV0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSk7CgogICAgICAgICAgLy8gTW92ZSB0aGUgZ2l2ZW4gdmFsdWUgdG8gbWF0Y2hbM10gd2hldGhlciBxdW90ZWQgb3IgdW5xdW90ZWQKICAgICAgICAgIG1hdGNoWzNdID0gKG1hdGNoWzNdIHx8IG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiKS5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKTsKICAgICAgICAgIGlmIChtYXRjaFsyXSA9PT0gIn49IikgewogICAgICAgICAgICBtYXRjaFszXSA9ICIgIiArIG1hdGNoWzNdICsgIiAiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIG1hdGNoLnNsaWNlKDAsIDQpOwogICAgICAgIH0sCiAgICAgICAgIkNISUxEIjogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICAvKiBtYXRjaGVzIGZyb20gbWF0Y2hFeHByWyJDSElMRCJdCiAgICAgICAgICAJMSB0eXBlIChvbmx5fG50aHwuLi4pCiAgICAgICAgICAJMiB3aGF0IChjaGlsZHxvZi10eXBlKQogICAgICAgICAgCTMgYXJndW1lbnQgKGV2ZW58b2RkfFxkKnxcZCpuKFsrLV1cZCspP3wuLi4pCiAgICAgICAgICAJNCB4bi1jb21wb25lbnQgb2YgeG4reSBhcmd1bWVudCAoWystXT9cZCpufCkKICAgICAgICAgIAk1IHNpZ24gb2YgeG4tY29tcG9uZW50CiAgICAgICAgICAJNiB4IG9mIHhuLWNvbXBvbmVudAogICAgICAgICAgCTcgc2lnbiBvZiB5LWNvbXBvbmVudAogICAgICAgICAgCTggeSBvZiB5LWNvbXBvbmVudAogICAgICAgICAgKi8KICAgICAgICAgIG1hdGNoWzFdID0gbWF0Y2hbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgIGlmIChtYXRjaFsxXS5zbGljZSgwLCAzKSA9PT0gIm50aCIpIHsKICAgICAgICAgICAgLy8gbnRoLSogcmVxdWlyZXMgYXJndW1lbnQKICAgICAgICAgICAgaWYgKCFtYXRjaFszXSkgewogICAgICAgICAgICAgIFNpenpsZS5lcnJvcihtYXRjaFswXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIG51bWVyaWMgeCBhbmQgeSBwYXJhbWV0ZXJzIGZvciBFeHByLmZpbHRlci5DSElMRAogICAgICAgICAgICAvLyByZW1lbWJlciB0aGF0IGZhbHNlL3RydWUgY2FzdCByZXNwZWN0aXZlbHkgdG8gMC8xCiAgICAgICAgICAgIG1hdGNoWzRdID0gKyhtYXRjaFs0XSA/IG1hdGNoWzVdICsgKG1hdGNoWzZdIHx8IDEpIDogMiAqIChtYXRjaFszXSA9PT0gImV2ZW4iIHx8IG1hdGNoWzNdID09PSAib2RkIikpOwogICAgICAgICAgICBtYXRjaFs1XSA9ICsobWF0Y2hbN10gKyBtYXRjaFs4XSB8fCBtYXRjaFszXSA9PT0gIm9kZCIpOwoKICAgICAgICAgICAgLy8gb3RoZXIgdHlwZXMgcHJvaGliaXQgYXJndW1lbnRzCiAgICAgICAgICB9IGVsc2UgaWYgKG1hdGNoWzNdKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcihtYXRjaFswXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2g7CiAgICAgICAgfSwKICAgICAgICAiUFNFVURPIjogZnVuY3Rpb24gKG1hdGNoKSB7CiAgICAgICAgICB2YXIgZXhjZXNzLAogICAgICAgICAgICB1bnF1b3RlZCA9ICFtYXRjaFs2XSAmJiBtYXRjaFsyXTsKICAgICAgICAgIGlmIChtYXRjaEV4cHJbIkNISUxEIl0udGVzdChtYXRjaFswXSkpIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQWNjZXB0IHF1b3RlZCBhcmd1bWVudHMgYXMtaXMKICAgICAgICAgIGlmIChtYXRjaFszXSkgewogICAgICAgICAgICBtYXRjaFsyXSA9IG1hdGNoWzRdIHx8IG1hdGNoWzVdIHx8ICIiOwoKICAgICAgICAgICAgLy8gU3RyaXAgZXhjZXNzIGNoYXJhY3RlcnMgZnJvbSB1bnF1b3RlZCBhcmd1bWVudHMKICAgICAgICAgIH0gZWxzZSBpZiAodW5xdW90ZWQgJiYgcnBzZXVkby50ZXN0KHVucXVvdGVkKSAmJiAoCiAgICAgICAgICAvLyBHZXQgZXhjZXNzIGZyb20gdG9rZW5pemUgKHJlY3Vyc2l2ZWx5KQogICAgICAgICAgZXhjZXNzID0gdG9rZW5pemUodW5xdW90ZWQsIHRydWUpKSAmJiAoCiAgICAgICAgICAvLyBhZHZhbmNlIHRvIHRoZSBuZXh0IGNsb3NpbmcgcGFyZW50aGVzaXMKICAgICAgICAgIGV4Y2VzcyA9IHVucXVvdGVkLmluZGV4T2YoIikiLCB1bnF1b3RlZC5sZW5ndGggLSBleGNlc3MpIC0gdW5xdW90ZWQubGVuZ3RoKSkgewogICAgICAgICAgICAvLyBleGNlc3MgaXMgYSBuZWdhdGl2ZSBpbmRleAogICAgICAgICAgICBtYXRjaFswXSA9IG1hdGNoWzBdLnNsaWNlKDAsIGV4Y2Vzcyk7CiAgICAgICAgICAgIG1hdGNoWzJdID0gdW5xdW90ZWQuc2xpY2UoMCwgZXhjZXNzKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZXR1cm4gb25seSBjYXB0dXJlcyBuZWVkZWQgYnkgdGhlIHBzZXVkbyBmaWx0ZXIgbWV0aG9kICh0eXBlIGFuZCBhcmd1bWVudCkKICAgICAgICAgIHJldHVybiBtYXRjaC5zbGljZSgwLCAzKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIGZpbHRlcjogewogICAgICAgICJUQUciOiBmdW5jdGlvbiAobm9kZU5hbWVTZWxlY3RvcikgewogICAgICAgICAgdmFyIG5vZGVOYW1lID0gbm9kZU5hbWVTZWxlY3Rvci5yZXBsYWNlKHJ1bmVzY2FwZSwgZnVuZXNjYXBlKS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgcmV0dXJuIG5vZGVOYW1lU2VsZWN0b3IgPT09ICIqIiA/IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9IDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIGVsZW0ubm9kZU5hbWUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSBub2RlTmFtZTsKICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAiQ0xBU1MiOiBmdW5jdGlvbiAoY2xhc3NOYW1lKSB7CiAgICAgICAgICB2YXIgcGF0dGVybiA9IGNsYXNzQ2FjaGVbY2xhc3NOYW1lICsgIiAiXTsKICAgICAgICAgIHJldHVybiBwYXR0ZXJuIHx8IChwYXR0ZXJuID0gbmV3IFJlZ0V4cCgiKF58IiArIHdoaXRlc3BhY2UgKyAiKSIgKyBjbGFzc05hbWUgKyAiKCIgKyB3aGl0ZXNwYWNlICsgInwkKSIpKSAmJiBjbGFzc0NhY2hlKGNsYXNzTmFtZSwgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgICAgcmV0dXJuIHBhdHRlcm4udGVzdCh0eXBlb2YgZWxlbS5jbGFzc05hbWUgPT09ICJzdHJpbmciICYmIGVsZW0uY2xhc3NOYW1lIHx8IHR5cGVvZiBlbGVtLmdldEF0dHJpYnV0ZSAhPT0gInVuZGVmaW5lZCIgJiYgZWxlbS5nZXRBdHRyaWJ1dGUoImNsYXNzIikgfHwgIiIpOwogICAgICAgICAgfSk7CiAgICAgICAgfSwKICAgICAgICAiQVRUUiI6IGZ1bmN0aW9uIChuYW1lLCBvcGVyYXRvciwgY2hlY2spIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gU2l6emxlLmF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgICAgIGlmIChyZXN1bHQgPT0gbnVsbCkgewogICAgICAgICAgICAgIHJldHVybiBvcGVyYXRvciA9PT0gIiE9IjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIW9wZXJhdG9yKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzdWx0ICs9ICIiOwoKICAgICAgICAgICAgLyogZXNsaW50LWRpc2FibGUgbWF4LWxlbiAqLwoKICAgICAgICAgICAgcmV0dXJuIG9wZXJhdG9yID09PSAiPSIgPyByZXN1bHQgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICIhPSIgPyByZXN1bHQgIT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICJePSIgPyBjaGVjayAmJiByZXN1bHQuaW5kZXhPZihjaGVjaykgPT09IDAgOiBvcGVyYXRvciA9PT0gIio9IiA/IGNoZWNrICYmIHJlc3VsdC5pbmRleE9mKGNoZWNrKSA+IC0xIDogb3BlcmF0b3IgPT09ICIkPSIgPyBjaGVjayAmJiByZXN1bHQuc2xpY2UoLWNoZWNrLmxlbmd0aCkgPT09IGNoZWNrIDogb3BlcmF0b3IgPT09ICJ+PSIgPyAoIiAiICsgcmVzdWx0LnJlcGxhY2UocndoaXRlc3BhY2UsICIgIikgKyAiICIpLmluZGV4T2YoY2hlY2spID4gLTEgOiBvcGVyYXRvciA9PT0gInw9IiA/IHJlc3VsdCA9PT0gY2hlY2sgfHwgcmVzdWx0LnNsaWNlKDAsIGNoZWNrLmxlbmd0aCArIDEpID09PSBjaGVjayArICItIiA6IGZhbHNlOwogICAgICAgICAgICAvKiBlc2xpbnQtZW5hYmxlIG1heC1sZW4gKi8KICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgIkNISUxEIjogZnVuY3Rpb24gKHR5cGUsIHdoYXQsIF9hcmd1bWVudCwgZmlyc3QsIGxhc3QpIHsKICAgICAgICAgIHZhciBzaW1wbGUgPSB0eXBlLnNsaWNlKDAsIDMpICE9PSAibnRoIiwKICAgICAgICAgICAgZm9yd2FyZCA9IHR5cGUuc2xpY2UoLTQpICE9PSAibGFzdCIsCiAgICAgICAgICAgIG9mVHlwZSA9IHdoYXQgPT09ICJvZi10eXBlIjsKICAgICAgICAgIHJldHVybiBmaXJzdCA9PT0gMSAmJiBsYXN0ID09PSAwID8KICAgICAgICAgIC8vIFNob3J0Y3V0IGZvciA6bnRoLSoobikKICAgICAgICAgIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAhIWVsZW0ucGFyZW50Tm9kZTsKICAgICAgICAgIH0gOiBmdW5jdGlvbiAoZWxlbSwgX2NvbnRleHQsIHhtbCkgewogICAgICAgICAgICB2YXIgY2FjaGUsCiAgICAgICAgICAgICAgdW5pcXVlQ2FjaGUsCiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSwKICAgICAgICAgICAgICBub2RlLAogICAgICAgICAgICAgIG5vZGVJbmRleCwKICAgICAgICAgICAgICBzdGFydCwKICAgICAgICAgICAgICBkaXIgPSBzaW1wbGUgIT09IGZvcndhcmQgPyAibmV4dFNpYmxpbmciIDogInByZXZpb3VzU2libGluZyIsCiAgICAgICAgICAgICAgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlLAogICAgICAgICAgICAgIG5hbWUgPSBvZlR5cGUgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAogICAgICAgICAgICAgIHVzZUNhY2hlID0gIXhtbCAmJiAhb2ZUeXBlLAogICAgICAgICAgICAgIGRpZmYgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHBhcmVudCkgewogICAgICAgICAgICAgIC8vIDooZmlyc3R8bGFzdHxvbmx5KS0oY2hpbGR8b2YtdHlwZSkKICAgICAgICAgICAgICBpZiAoc2ltcGxlKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAoZGlyKSB7CiAgICAgICAgICAgICAgICAgIG5vZGUgPSBlbGVtOwogICAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9IG5vZGVbZGlyXSkgewogICAgICAgICAgICAgICAgICAgIGlmIChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAvLyBSZXZlcnNlIGRpcmVjdGlvbiBmb3IgOm9ubHktKiAoaWYgd2UgaGF2ZW4ndCB5ZXQgZG9uZSBzbykKICAgICAgICAgICAgICAgICAgc3RhcnQgPSBkaXIgPSB0eXBlID09PSAib25seSIgJiYgIXN0YXJ0ICYmICJuZXh0U2libGluZyI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgc3RhcnQgPSBbZm9yd2FyZCA/IHBhcmVudC5maXJzdENoaWxkIDogcGFyZW50Lmxhc3RDaGlsZF07CgogICAgICAgICAgICAgIC8vIG5vbi14bWwgOm50aC1jaGlsZCguLi4pIHN0b3JlcyBjYWNoZSBkYXRhIG9uIGBwYXJlbnRgCiAgICAgICAgICAgICAgaWYgKGZvcndhcmQgJiYgdXNlQ2FjaGUpIHsKICAgICAgICAgICAgICAgIC8vIFNlZWsgYGVsZW1gIGZyb20gYSBwcmV2aW91c2x5LWNhY2hlZCBpbmRleAoKICAgICAgICAgICAgICAgIC8vIC4uLmluIGEgZ3ppcC1mcmllbmRseSB3YXkKICAgICAgICAgICAgICAgIG5vZGUgPSBwYXJlbnQ7CiAgICAgICAgICAgICAgICBvdXRlckNhY2hlID0gbm9kZVtleHBhbmRvXSB8fCAobm9kZVtleHBhbmRvXSA9IHt9KTsKCiAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8OSBvbmx5CiAgICAgICAgICAgICAgICAvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkKICAgICAgICAgICAgICAgIHVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSB8fCAob3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSA9IHt9KTsKICAgICAgICAgICAgICAgIGNhY2hlID0gdW5pcXVlQ2FjaGVbdHlwZV0gfHwgW107CiAgICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICAgIGRpZmYgPSBub2RlSW5kZXggJiYgY2FjaGVbMl07CiAgICAgICAgICAgICAgICBub2RlID0gbm9kZUluZGV4ICYmIHBhcmVudC5jaGlsZE5vZGVzW25vZGVJbmRleF07CiAgICAgICAgICAgICAgICB3aGlsZSAobm9kZSA9ICsrbm9kZUluZGV4ICYmIG5vZGUgJiYgbm9kZVtkaXJdIHx8ICgKICAgICAgICAgICAgICAgIC8vIEZhbGxiYWNrIHRvIHNlZWtpbmcgYGVsZW1gIGZyb20gdGhlIHN0YXJ0CiAgICAgICAgICAgICAgICBkaWZmID0gbm9kZUluZGV4ID0gMCkgfHwgc3RhcnQucG9wKCkpIHsKICAgICAgICAgICAgICAgICAgLy8gV2hlbiBmb3VuZCwgY2FjaGUgaW5kZXhlcyBvbiBgcGFyZW50YCBhbmQgYnJlYWsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEgJiYgKytkaWZmICYmIG5vZGUgPT09IGVsZW0pIHsKICAgICAgICAgICAgICAgICAgICB1bmlxdWVDYWNoZVt0eXBlXSA9IFtkaXJydW5zLCBub2RlSW5kZXgsIGRpZmZdOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFVzZSBwcmV2aW91c2x5LWNhY2hlZCBlbGVtZW50IGluZGV4IGlmIGF2YWlsYWJsZQogICAgICAgICAgICAgICAgaWYgKHVzZUNhY2hlKSB7CiAgICAgICAgICAgICAgICAgIC8vIC4uLmluIGEgZ3ppcC1mcmllbmRseSB3YXkKICAgICAgICAgICAgICAgICAgbm9kZSA9IGVsZW07CiAgICAgICAgICAgICAgICAgIG91dGVyQ2FjaGUgPSBub2RlW2V4cGFuZG9dIHx8IChub2RlW2V4cGFuZG9dID0ge30pOwoKICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPDkgb25seQogICAgICAgICAgICAgICAgICAvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkKICAgICAgICAgICAgICAgICAgdW5pcXVlQ2FjaGUgPSBvdXRlckNhY2hlW25vZGUudW5pcXVlSURdIHx8IChvdXRlckNhY2hlW25vZGUudW5pcXVlSURdID0ge30pOwogICAgICAgICAgICAgICAgICBjYWNoZSA9IHVuaXF1ZUNhY2hlW3R5cGVdIHx8IFtdOwogICAgICAgICAgICAgICAgICBub2RlSW5kZXggPSBjYWNoZVswXSA9PT0gZGlycnVucyAmJiBjYWNoZVsxXTsKICAgICAgICAgICAgICAgICAgZGlmZiA9IG5vZGVJbmRleDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyB4bWwgOm50aC1jaGlsZCguLi4pCiAgICAgICAgICAgICAgICAvLyBvciA6bnRoLWxhc3QtY2hpbGQoLi4uKSBvciA6bnRoKC1sYXN0KT8tb2YtdHlwZSguLi4pCiAgICAgICAgICAgICAgICBpZiAoZGlmZiA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgLy8gVXNlIHRoZSBzYW1lIGxvb3AgYXMgYWJvdmUgdG8gc2VlayBgZWxlbWAgZnJvbSB0aGUgc3RhcnQKICAgICAgICAgICAgICAgICAgd2hpbGUgKG5vZGUgPSArK25vZGVJbmRleCAmJiBub2RlICYmIG5vZGVbZGlyXSB8fCAoZGlmZiA9IG5vZGVJbmRleCA9IDApIHx8IHN0YXJ0LnBvcCgpKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKChvZlR5cGUgPyBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUgOiBub2RlLm5vZGVUeXBlID09PSAxKSAmJiArK2RpZmYpIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIENhY2hlIHRoZSBpbmRleCBvZiBlYWNoIGVuY291bnRlcmVkIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgIGlmICh1c2VDYWNoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBvdXRlckNhY2hlID0gbm9kZVtleHBhbmRvXSB8fCAobm9kZVtleHBhbmRvXSA9IHt9KTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmZW5kIGFnYWluc3QgY2xvbmVkIGF0dHJvcGVydGllcyAoalF1ZXJ5IGdoLTE3MDkpCiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZUNhY2hlID0gb3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSB8fCAob3V0ZXJDYWNoZVtub2RlLnVuaXF1ZUlEXSA9IHt9KTsKICAgICAgICAgICAgICAgICAgICAgICAgdW5pcXVlQ2FjaGVbdHlwZV0gPSBbZGlycnVucywgZGlmZl07CiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZSA9PT0gZWxlbSkgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIEluY29ycG9yYXRlIHRoZSBvZmZzZXQsIHRoZW4gY2hlY2sgYWdhaW5zdCBjeWNsZSBzaXplCiAgICAgICAgICAgICAgZGlmZiAtPSBsYXN0OwogICAgICAgICAgICAgIHJldHVybiBkaWZmID09PSBmaXJzdCB8fCBkaWZmICUgZmlyc3QgPT09IDAgJiYgZGlmZiAvIGZpcnN0ID49IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgIH07CiAgICAgICAgfSwKICAgICAgICAiUFNFVURPIjogZnVuY3Rpb24gKHBzZXVkbywgYXJndW1lbnQpIHsKICAgICAgICAgIC8vIHBzZXVkby1jbGFzcyBuYW1lcyBhcmUgY2FzZS1pbnNlbnNpdGl2ZQogICAgICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzLyNwc2V1ZG8tY2xhc3NlcwogICAgICAgICAgLy8gUHJpb3JpdGl6ZSBieSBjYXNlIHNlbnNpdGl2aXR5IGluIGNhc2UgY3VzdG9tIHBzZXVkb3MgYXJlIGFkZGVkIHdpdGggdXBwZXJjYXNlIGxldHRlcnMKICAgICAgICAgIC8vIFJlbWVtYmVyIHRoYXQgc2V0RmlsdGVycyBpbmhlcml0cyBmcm9tIHBzZXVkb3MKICAgICAgICAgIHZhciBhcmdzLAogICAgICAgICAgICBmbiA9IEV4cHIucHNldWRvc1twc2V1ZG9dIHx8IEV4cHIuc2V0RmlsdGVyc1twc2V1ZG8udG9Mb3dlckNhc2UoKV0gfHwgU2l6emxlLmVycm9yKCJ1bnN1cHBvcnRlZCBwc2V1ZG86ICIgKyBwc2V1ZG8pOwoKICAgICAgICAgIC8vIFRoZSB1c2VyIG1heSB1c2UgY3JlYXRlUHNldWRvIHRvIGluZGljYXRlIHRoYXQKICAgICAgICAgIC8vIGFyZ3VtZW50cyBhcmUgbmVlZGVkIHRvIGNyZWF0ZSB0aGUgZmlsdGVyIGZ1bmN0aW9uCiAgICAgICAgICAvLyBqdXN0IGFzIFNpenpsZSBkb2VzCiAgICAgICAgICBpZiAoZm5bZXhwYW5kb10pIHsKICAgICAgICAgICAgcmV0dXJuIGZuKGFyZ3VtZW50KTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBCdXQgbWFpbnRhaW4gc3VwcG9ydCBmb3Igb2xkIHNpZ25hdHVyZXMKICAgICAgICAgIGlmIChmbi5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGFyZ3MgPSBbcHNldWRvLCBwc2V1ZG8sICIiLCBhcmd1bWVudF07CiAgICAgICAgICAgIHJldHVybiBFeHByLnNldEZpbHRlcnMuaGFzT3duUHJvcGVydHkocHNldWRvLnRvTG93ZXJDYXNlKCkpID8gbWFya0Z1bmN0aW9uKGZ1bmN0aW9uIChzZWVkLCBtYXRjaGVzKSB7CiAgICAgICAgICAgICAgdmFyIGlkeCwKICAgICAgICAgICAgICAgIG1hdGNoZWQgPSBmbihzZWVkLCBhcmd1bWVudCksCiAgICAgICAgICAgICAgICBpID0gbWF0Y2hlZC5sZW5ndGg7CiAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgaWR4ID0gaW5kZXhPZihzZWVkLCBtYXRjaGVkW2ldKTsKICAgICAgICAgICAgICAgIHNlZWRbaWR4XSA9ICEobWF0Y2hlc1tpZHhdID0gbWF0Y2hlZFtpXSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KSA6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZuKGVsZW0sIDAsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGZuOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHNldWRvczogewogICAgICAgIC8vIFBvdGVudGlhbGx5IGNvbXBsZXggcHNldWRvcwogICAgICAgICJub3QiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgICAgICAvLyBUcmltIHRoZSBzZWxlY3RvciBwYXNzZWQgdG8gY29tcGlsZQogICAgICAgICAgLy8gdG8gYXZvaWQgdHJlYXRpbmcgbGVhZGluZyBhbmQgdHJhaWxpbmcKICAgICAgICAgIC8vIHNwYWNlcyBhcyBjb21iaW5hdG9ycwogICAgICAgICAgdmFyIGlucHV0ID0gW10sCiAgICAgICAgICAgIHJlc3VsdHMgPSBbXSwKICAgICAgICAgICAgbWF0Y2hlciA9IGNvbXBpbGUoc2VsZWN0b3IucmVwbGFjZShydHJpbSwgIiQxIikpOwogICAgICAgICAgcmV0dXJuIG1hdGNoZXJbZXhwYW5kb10gPyBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHNlZWQsIG1hdGNoZXMsIF9jb250ZXh0LCB4bWwpIHsKICAgICAgICAgICAgdmFyIGVsZW0sCiAgICAgICAgICAgICAgdW5tYXRjaGVkID0gbWF0Y2hlcihzZWVkLCBudWxsLCB4bWwsIFtdKSwKICAgICAgICAgICAgICBpID0gc2VlZC5sZW5ndGg7CgogICAgICAgICAgICAvLyBNYXRjaCBlbGVtZW50cyB1bm1hdGNoZWQgYnkgYG1hdGNoZXJgCiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgICAgICAgc2VlZFtpXSA9ICEobWF0Y2hlc1tpXSA9IGVsZW0pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSkgOiBmdW5jdGlvbiAoZWxlbSwgX2NvbnRleHQsIHhtbCkgewogICAgICAgICAgICBpbnB1dFswXSA9IGVsZW07CiAgICAgICAgICAgIG1hdGNoZXIoaW5wdXQsIG51bGwsIHhtbCwgcmVzdWx0cyk7CgogICAgICAgICAgICAvLyBEb24ndCBrZWVwIHRoZSBlbGVtZW50IChpc3N1ZSAjMjk5KQogICAgICAgICAgICBpbnB1dFswXSA9IG51bGw7CiAgICAgICAgICAgIHJldHVybiAhcmVzdWx0cy5wb3AoKTsKICAgICAgICAgIH07CiAgICAgICAgfSksCiAgICAgICAgImhhcyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICByZXR1cm4gU2l6emxlKHNlbGVjdG9yLCBlbGVtKS5sZW5ndGggPiAwOwogICAgICAgICAgfTsKICAgICAgICB9KSwKICAgICAgICAiY29udGFpbnMiOiBtYXJrRnVuY3Rpb24oZnVuY3Rpb24gKHRleHQpIHsKICAgICAgICAgIHRleHQgPSB0ZXh0LnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpOwogICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAgIHJldHVybiAoZWxlbS50ZXh0Q29udGVudCB8fCBnZXRUZXh0KGVsZW0pKS5pbmRleE9mKHRleHQpID4gLTE7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vICJXaGV0aGVyIGFuIGVsZW1lbnQgaXMgcmVwcmVzZW50ZWQgYnkgYSA6bGFuZygpIHNlbGVjdG9yCiAgICAgICAgLy8gaXMgYmFzZWQgc29sZWx5IG9uIHRoZSBlbGVtZW50J3MgbGFuZ3VhZ2UgdmFsdWUKICAgICAgICAvLyBiZWluZyBlcXVhbCB0byB0aGUgaWRlbnRpZmllciBDLAogICAgICAgIC8vIG9yIGJlZ2lubmluZyB3aXRoIHRoZSBpZGVudGlmaWVyIEMgaW1tZWRpYXRlbHkgZm9sbG93ZWQgYnkgIi0iLgogICAgICAgIC8vIFRoZSBtYXRjaGluZyBvZiBDIGFnYWluc3QgdGhlIGVsZW1lbnQncyBsYW5ndWFnZSB2YWx1ZSBpcyBwZXJmb3JtZWQgY2FzZS1pbnNlbnNpdGl2ZWx5LgogICAgICAgIC8vIFRoZSBpZGVudGlmaWVyIEMgZG9lcyBub3QgaGF2ZSB0byBiZSBhIHZhbGlkIGxhbmd1YWdlIG5hbWUuIgogICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jbGFuZy1wc2V1ZG8KICAgICAgICAibGFuZyI6IG1hcmtGdW5jdGlvbihmdW5jdGlvbiAobGFuZykgewogICAgICAgICAgLy8gbGFuZyB2YWx1ZSBtdXN0IGJlIGEgdmFsaWQgaWRlbnRpZmllcgogICAgICAgICAgaWYgKCFyaWRlbnRpZmllci50ZXN0KGxhbmcgfHwgIiIpKSB7CiAgICAgICAgICAgIFNpenpsZS5lcnJvcigidW5zdXBwb3J0ZWQgbGFuZzogIiArIGxhbmcpOwogICAgICAgICAgfQogICAgICAgICAgbGFuZyA9IGxhbmcucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSkudG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgICB2YXIgZWxlbUxhbmc7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICBpZiAoZWxlbUxhbmcgPSBkb2N1bWVudElzSFRNTCA/IGVsZW0ubGFuZyA6IGVsZW0uZ2V0QXR0cmlidXRlKCJ4bWw6bGFuZyIpIHx8IGVsZW0uZ2V0QXR0cmlidXRlKCJsYW5nIikpIHsKICAgICAgICAgICAgICAgIGVsZW1MYW5nID0gZWxlbUxhbmcudG9Mb3dlckNhc2UoKTsKICAgICAgICAgICAgICAgIHJldHVybiBlbGVtTGFuZyA9PT0gbGFuZyB8fCBlbGVtTGFuZy5pbmRleE9mKGxhbmcgKyAiLSIpID09PSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAoKGVsZW0gPSBlbGVtLnBhcmVudE5vZGUpICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9OwogICAgICAgIH0pLAogICAgICAgIC8vIE1pc2NlbGxhbmVvdXMKICAgICAgICAidGFyZ2V0IjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHZhciBoYXNoID0gd2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgcmV0dXJuIGhhc2ggJiYgaGFzaC5zbGljZSgxKSA9PT0gZWxlbS5pZDsKICAgICAgICB9LAogICAgICAgICJyb290IjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2NFbGVtOwogICAgICAgIH0sCiAgICAgICAgImZvY3VzIjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiBlbGVtID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICYmICghZG9jdW1lbnQuaGFzRm9jdXMgfHwgZG9jdW1lbnQuaGFzRm9jdXMoKSkgJiYgISEoZWxlbS50eXBlIHx8IGVsZW0uaHJlZiB8fCB+ZWxlbS50YWJJbmRleCk7CiAgICAgICAgfSwKICAgICAgICAvLyBCb29sZWFuIHByb3BlcnRpZXMKICAgICAgICAiZW5hYmxlZCI6IGNyZWF0ZURpc2FibGVkUHNldWRvKGZhbHNlKSwKICAgICAgICAiZGlzYWJsZWQiOiBjcmVhdGVEaXNhYmxlZFBzZXVkbyh0cnVlKSwKICAgICAgICAiY2hlY2tlZCI6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBJbiBDU1MzLCA6Y2hlY2tlZCBzaG91bGQgcmV0dXJuIGJvdGggY2hlY2tlZCBhbmQgc2VsZWN0ZWQgZWxlbWVudHMKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSLzIwMTEvUkVDLWNzczMtc2VsZWN0b3JzLTIwMTEwOTI5LyNjaGVja2VkCiAgICAgICAgICB2YXIgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbm9kZU5hbWUgPT09ICJpbnB1dCIgJiYgISFlbGVtLmNoZWNrZWQgfHwgbm9kZU5hbWUgPT09ICJvcHRpb24iICYmICEhZWxlbS5zZWxlY3RlZDsKICAgICAgICB9LAogICAgICAgICJzZWxlY3RlZCI6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICAvLyBBY2Nlc3NpbmcgdGhpcyBwcm9wZXJ0eSBtYWtlcyBzZWxlY3RlZC1ieS1kZWZhdWx0CiAgICAgICAgICAvLyBvcHRpb25zIGluIFNhZmFyaSB3b3JrIHByb3Blcmx5CiAgICAgICAgICBpZiAoZWxlbS5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtZXhwcmVzc2lvbnMKICAgICAgICAgICAgZWxlbS5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gZWxlbS5zZWxlY3RlZCA9PT0gdHJ1ZTsKICAgICAgICB9LAogICAgICAgIC8vIENvbnRlbnRzCiAgICAgICAgImVtcHR5IjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIC8vIGh0dHA6Ly93d3cudzMub3JnL1RSL3NlbGVjdG9ycy8jZW1wdHktcHNldWRvCiAgICAgICAgICAvLyA6ZW1wdHkgaXMgbmVnYXRlZCBieSBlbGVtZW50ICgxKSBvciBjb250ZW50IG5vZGVzICh0ZXh0OiAzOyBjZGF0YTogNDsgZW50aXR5IHJlZjogNSksCiAgICAgICAgICAvLyAgIGJ1dCBub3QgYnkgb3RoZXJzIChjb21tZW50OiA4OyBwcm9jZXNzaW5nIGluc3RydWN0aW9uOiA3OyBldGMuKQogICAgICAgICAgLy8gbm9kZVR5cGUgPCA2IHdvcmtzIGJlY2F1c2UgYXR0cmlidXRlcyAoMikgZG8gbm90IGFwcGVhciBhcyBjaGlsZHJlbgogICAgICAgICAgZm9yIChlbGVtID0gZWxlbS5maXJzdENoaWxkOyBlbGVtOyBlbGVtID0gZWxlbS5uZXh0U2libGluZykgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA8IDYpIHsKICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgInBhcmVudCI6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gIUV4cHIucHNldWRvc1siZW1wdHkiXShlbGVtKTsKICAgICAgICB9LAogICAgICAgIC8vIEVsZW1lbnQvaW5wdXQgdHlwZXMKICAgICAgICAiaGVhZGVyIjogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAgIHJldHVybiByaGVhZGVyLnRlc3QoZWxlbS5ub2RlTmFtZSk7CiAgICAgICAgfSwKICAgICAgICAiaW5wdXQiOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIHJpbnB1dHMudGVzdChlbGVtLm5vZGVOYW1lKTsKICAgICAgICB9LAogICAgICAgICJidXR0b24iOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIG5hbWUgPSBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICByZXR1cm4gbmFtZSA9PT0gImlucHV0IiAmJiBlbGVtLnR5cGUgPT09ICJidXR0b24iIHx8IG5hbWUgPT09ICJidXR0b24iOwogICAgICAgIH0sCiAgICAgICAgInRleHQiOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIGF0dHI7CiAgICAgICAgICByZXR1cm4gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiICYmIGVsZW0udHlwZSA9PT0gInRleHQiICYmICgKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDwxMCBvbmx5CiAgICAgICAgICAvLyBOZXcgSFRNTDUgYXR0cmlidXRlIHZhbHVlcyAoZS5nLiwgInNlYXJjaCIpIGFwcGVhciB3aXRoIGVsZW0udHlwZSA9PT0gInRleHQiCiAgICAgICAgICAoYXR0ciA9IGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikpID09IG51bGwgfHwgYXR0ci50b0xvd2VyQ2FzZSgpID09PSAidGV4dCIpOwogICAgICAgIH0sCiAgICAgICAgLy8gUG9zaXRpb24taW4tY29sbGVjdGlvbgogICAgICAgICJmaXJzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFswXTsKICAgICAgICB9KSwKICAgICAgICAibGFzdCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKF9tYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIFtsZW5ndGggLSAxXTsKICAgICAgICB9KSwKICAgICAgICAiZXEiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChfbWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICByZXR1cm4gW2FyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnRdOwogICAgICAgIH0pLAogICAgICAgICJldmVuIjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgpIHsKICAgICAgICAgIHZhciBpID0gMDsKICAgICAgICAgIGZvciAoOyBpIDwgbGVuZ3RoOyBpICs9IDIpIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICJvZGQiOiBjcmVhdGVQb3NpdGlvbmFsUHNldWRvKGZ1bmN0aW9uIChtYXRjaEluZGV4ZXMsIGxlbmd0aCkgewogICAgICAgICAgdmFyIGkgPSAxOwogICAgICAgICAgZm9yICg7IGkgPCBsZW5ndGg7IGkgKz0gMikgewogICAgICAgICAgICBtYXRjaEluZGV4ZXMucHVzaChpKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBtYXRjaEluZGV4ZXM7CiAgICAgICAgfSksCiAgICAgICAgImx0IjogY3JlYXRlUG9zaXRpb25hbFBzZXVkbyhmdW5jdGlvbiAobWF0Y2hJbmRleGVzLCBsZW5ndGgsIGFyZ3VtZW50KSB7CiAgICAgICAgICB2YXIgaSA9IGFyZ3VtZW50IDwgMCA/IGFyZ3VtZW50ICsgbGVuZ3RoIDogYXJndW1lbnQgPiBsZW5ndGggPyBsZW5ndGggOiBhcmd1bWVudDsKICAgICAgICAgIGZvciAoOyAtLWkgPj0gMDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pLAogICAgICAgICJndCI6IGNyZWF0ZVBvc2l0aW9uYWxQc2V1ZG8oZnVuY3Rpb24gKG1hdGNoSW5kZXhlcywgbGVuZ3RoLCBhcmd1bWVudCkgewogICAgICAgICAgdmFyIGkgPSBhcmd1bWVudCA8IDAgPyBhcmd1bWVudCArIGxlbmd0aCA6IGFyZ3VtZW50OwogICAgICAgICAgZm9yICg7ICsraSA8IGxlbmd0aDspIHsKICAgICAgICAgICAgbWF0Y2hJbmRleGVzLnB1c2goaSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWF0Y2hJbmRleGVzOwogICAgICAgIH0pCiAgICAgIH0KICAgIH07CiAgICBFeHByLnBzZXVkb3NbIm50aCJdID0gRXhwci5wc2V1ZG9zWyJlcSJdOwoKICAgIC8vIEFkZCBidXR0b24vaW5wdXQgdHlwZSBwc2V1ZG9zCiAgICBmb3IgKGkgaW4gewogICAgICByYWRpbzogdHJ1ZSwKICAgICAgY2hlY2tib3g6IHRydWUsCiAgICAgIGZpbGU6IHRydWUsCiAgICAgIHBhc3N3b3JkOiB0cnVlLAogICAgICBpbWFnZTogdHJ1ZQogICAgfSkgewogICAgICBFeHByLnBzZXVkb3NbaV0gPSBjcmVhdGVJbnB1dFBzZXVkbyhpKTsKICAgIH0KICAgIGZvciAoaSBpbiB7CiAgICAgIHN1Ym1pdDogdHJ1ZSwKICAgICAgcmVzZXQ6IHRydWUKICAgIH0pIHsKICAgICAgRXhwci5wc2V1ZG9zW2ldID0gY3JlYXRlQnV0dG9uUHNldWRvKGkpOwogICAgfQoKICAgIC8vIEVhc3kgQVBJIGZvciBjcmVhdGluZyBuZXcgc2V0RmlsdGVycwogICAgZnVuY3Rpb24gc2V0RmlsdGVycygpIHt9CiAgICBzZXRGaWx0ZXJzLnByb3RvdHlwZSA9IEV4cHIuZmlsdGVycyA9IEV4cHIucHNldWRvczsKICAgIEV4cHIuc2V0RmlsdGVycyA9IG5ldyBzZXRGaWx0ZXJzKCk7CiAgICB0b2tlbml6ZSA9IFNpenpsZS50b2tlbml6ZSA9IGZ1bmN0aW9uIChzZWxlY3RvciwgcGFyc2VPbmx5KSB7CiAgICAgIHZhciBtYXRjaGVkLAogICAgICAgIG1hdGNoLAogICAgICAgIHRva2VucywKICAgICAgICB0eXBlLAogICAgICAgIHNvRmFyLAogICAgICAgIGdyb3VwcywKICAgICAgICBwcmVGaWx0ZXJzLAogICAgICAgIGNhY2hlZCA9IHRva2VuQ2FjaGVbc2VsZWN0b3IgKyAiICJdOwogICAgICBpZiAoY2FjaGVkKSB7CiAgICAgICAgcmV0dXJuIHBhcnNlT25seSA/IDAgOiBjYWNoZWQuc2xpY2UoMCk7CiAgICAgIH0KICAgICAgc29GYXIgPSBzZWxlY3RvcjsKICAgICAgZ3JvdXBzID0gW107CiAgICAgIHByZUZpbHRlcnMgPSBFeHByLnByZUZpbHRlcjsKICAgICAgd2hpbGUgKHNvRmFyKSB7CiAgICAgICAgLy8gQ29tbWEgYW5kIGZpcnN0IHJ1bgogICAgICAgIGlmICghbWF0Y2hlZCB8fCAobWF0Y2ggPSByY29tbWEuZXhlYyhzb0ZhcikpKSB7CiAgICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgLy8gRG9uJ3QgY29uc3VtZSB0cmFpbGluZyBjb21tYXMgYXMgdmFsaWQKICAgICAgICAgICAgc29GYXIgPSBzb0Zhci5zbGljZShtYXRjaFswXS5sZW5ndGgpIHx8IHNvRmFyOwogICAgICAgICAgfQogICAgICAgICAgZ3JvdXBzLnB1c2godG9rZW5zID0gW10pOwogICAgICAgIH0KICAgICAgICBtYXRjaGVkID0gZmFsc2U7CgogICAgICAgIC8vIENvbWJpbmF0b3JzCiAgICAgICAgaWYgKG1hdGNoID0gcmNvbWJpbmF0b3JzLmV4ZWMoc29GYXIpKSB7CiAgICAgICAgICBtYXRjaGVkID0gbWF0Y2guc2hpZnQoKTsKICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgdmFsdWU6IG1hdGNoZWQsCiAgICAgICAgICAgIC8vIENhc3QgZGVzY2VuZGFudCBjb21iaW5hdG9ycyB0byBzcGFjZQogICAgICAgICAgICB0eXBlOiBtYXRjaFswXS5yZXBsYWNlKHJ0cmltLCAiICIpCiAgICAgICAgICB9KTsKICAgICAgICAgIHNvRmFyID0gc29GYXIuc2xpY2UobWF0Y2hlZC5sZW5ndGgpOwogICAgICAgIH0KCiAgICAgICAgLy8gRmlsdGVycwogICAgICAgIGZvciAodHlwZSBpbiBFeHByLmZpbHRlcikgewogICAgICAgICAgaWYgKChtYXRjaCA9IG1hdGNoRXhwclt0eXBlXS5leGVjKHNvRmFyKSkgJiYgKCFwcmVGaWx0ZXJzW3R5cGVdIHx8IChtYXRjaCA9IHByZUZpbHRlcnNbdHlwZV0obWF0Y2gpKSkpIHsKICAgICAgICAgICAgbWF0Y2hlZCA9IG1hdGNoLnNoaWZ0KCk7CiAgICAgICAgICAgIHRva2Vucy5wdXNoKHsKICAgICAgICAgICAgICB2YWx1ZTogbWF0Y2hlZCwKICAgICAgICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgICAgICAgIG1hdGNoZXM6IG1hdGNoCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBzb0ZhciA9IHNvRmFyLnNsaWNlKG1hdGNoZWQubGVuZ3RoKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFtYXRjaGVkKSB7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiB0aGUgbGVuZ3RoIG9mIHRoZSBpbnZhbGlkIGV4Y2VzcwogICAgICAvLyBpZiB3ZSdyZSBqdXN0IHBhcnNpbmcKICAgICAgLy8gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvciBvciByZXR1cm4gdG9rZW5zCiAgICAgIHJldHVybiBwYXJzZU9ubHkgPyBzb0Zhci5sZW5ndGggOiBzb0ZhciA/IFNpenpsZS5lcnJvcihzZWxlY3RvcikgOgogICAgICAvLyBDYWNoZSB0aGUgdG9rZW5zCiAgICAgIHRva2VuQ2FjaGUoc2VsZWN0b3IsIGdyb3Vwcykuc2xpY2UoMCk7CiAgICB9OwogICAgZnVuY3Rpb24gdG9TZWxlY3Rvcih0b2tlbnMpIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgIGxlbiA9IHRva2Vucy5sZW5ndGgsCiAgICAgICAgc2VsZWN0b3IgPSAiIjsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIHNlbGVjdG9yICs9IHRva2Vuc1tpXS52YWx1ZTsKICAgICAgfQogICAgICByZXR1cm4gc2VsZWN0b3I7CiAgICB9CiAgICBmdW5jdGlvbiBhZGRDb21iaW5hdG9yKG1hdGNoZXIsIGNvbWJpbmF0b3IsIGJhc2UpIHsKICAgICAgdmFyIGRpciA9IGNvbWJpbmF0b3IuZGlyLAogICAgICAgIHNraXAgPSBjb21iaW5hdG9yLm5leHQsCiAgICAgICAga2V5ID0gc2tpcCB8fCBkaXIsCiAgICAgICAgY2hlY2tOb25FbGVtZW50cyA9IGJhc2UgJiYga2V5ID09PSAicGFyZW50Tm9kZSIsCiAgICAgICAgZG9uZU5hbWUgPSBkb25lKys7CiAgICAgIHJldHVybiBjb21iaW5hdG9yLmZpcnN0ID8KICAgICAgLy8gQ2hlY2sgYWdhaW5zdCBjbG9zZXN0IGFuY2VzdG9yL3ByZWNlZGluZyBlbGVtZW50CiAgICAgIGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICByZXR1cm4gbWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0gOgogICAgICAvLyBDaGVjayBhZ2FpbnN0IGFsbCBhbmNlc3Rvci9wcmVjZWRpbmcgZWxlbWVudHMKICAgICAgZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgIHZhciBvbGRDYWNoZSwKICAgICAgICAgIHVuaXF1ZUNhY2hlLAogICAgICAgICAgb3V0ZXJDYWNoZSwKICAgICAgICAgIG5ld0NhY2hlID0gW2RpcnJ1bnMsIGRvbmVOYW1lXTsKCiAgICAgICAgLy8gV2UgY2FuJ3Qgc2V0IGFyYml0cmFyeSBkYXRhIG9uIFhNTCBub2Rlcywgc28gdGhleSBkb24ndCBiZW5lZml0IGZyb20gY29tYmluYXRvciBjYWNoaW5nCiAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgd2hpbGUgKGVsZW0gPSBlbGVtW2Rpcl0pIHsKICAgICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEgfHwgY2hlY2tOb25FbGVtZW50cykgewogICAgICAgICAgICAgIGlmIChtYXRjaGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aGlsZSAoZWxlbSA9IGVsZW1bZGlyXSkgewogICAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBjaGVja05vbkVsZW1lbnRzKSB7CiAgICAgICAgICAgICAgb3V0ZXJDYWNoZSA9IGVsZW1bZXhwYW5kb10gfHwgKGVsZW1bZXhwYW5kb10gPSB7fSk7CgogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw5IG9ubHkKICAgICAgICAgICAgICAvLyBEZWZlbmQgYWdhaW5zdCBjbG9uZWQgYXR0cm9wZXJ0aWVzIChqUXVlcnkgZ2gtMTcwOSkKICAgICAgICAgICAgICB1bmlxdWVDYWNoZSA9IG91dGVyQ2FjaGVbZWxlbS51bmlxdWVJRF0gfHwgKG91dGVyQ2FjaGVbZWxlbS51bmlxdWVJRF0gPSB7fSk7CiAgICAgICAgICAgICAgaWYgKHNraXAgJiYgc2tpcCA9PT0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICBlbGVtID0gZWxlbVtkaXJdIHx8IGVsZW07CiAgICAgICAgICAgICAgfSBlbHNlIGlmICgob2xkQ2FjaGUgPSB1bmlxdWVDYWNoZVtrZXldKSAmJiBvbGRDYWNoZVswXSA9PT0gZGlycnVucyAmJiBvbGRDYWNoZVsxXSA9PT0gZG9uZU5hbWUpIHsKICAgICAgICAgICAgICAgIC8vIEFzc2lnbiB0byBuZXdDYWNoZSBzbyByZXN1bHRzIGJhY2stcHJvcGFnYXRlIHRvIHByZXZpb3VzIGVsZW1lbnRzCiAgICAgICAgICAgICAgICByZXR1cm4gbmV3Q2FjaGVbMl0gPSBvbGRDYWNoZVsyXTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUmV1c2UgbmV3Y2FjaGUgc28gcmVzdWx0cyBiYWNrLXByb3BhZ2F0ZSB0byBwcmV2aW91cyBlbGVtZW50cwogICAgICAgICAgICAgICAgdW5pcXVlQ2FjaGVba2V5XSA9IG5ld0NhY2hlOwoKICAgICAgICAgICAgICAgIC8vIEEgbWF0Y2ggbWVhbnMgd2UncmUgZG9uZTsgYSBmYWlsIG1lYW5zIHdlIGhhdmUgdG8ga2VlcCBjaGVja2luZwogICAgICAgICAgICAgICAgaWYgKG5ld0NhY2hlWzJdID0gbWF0Y2hlcihlbGVtLCBjb250ZXh0LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH07CiAgICB9CiAgICBmdW5jdGlvbiBlbGVtZW50TWF0Y2hlcihtYXRjaGVycykgewogICAgICByZXR1cm4gbWF0Y2hlcnMubGVuZ3RoID4gMSA/IGZ1bmN0aW9uIChlbGVtLCBjb250ZXh0LCB4bWwpIHsKICAgICAgICB2YXIgaSA9IG1hdGNoZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBpZiAoIW1hdGNoZXJzW2ldKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSA6IG1hdGNoZXJzWzBdOwogICAgfQogICAgZnVuY3Rpb24gbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciwgY29udGV4dHMsIHJlc3VsdHMpIHsKICAgICAgdmFyIGkgPSAwLAogICAgICAgIGxlbiA9IGNvbnRleHRzLmxlbmd0aDsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIFNpenpsZShzZWxlY3RvciwgY29udGV4dHNbaV0sIHJlc3VsdHMpOwogICAgICB9CiAgICAgIHJldHVybiByZXN1bHRzOwogICAgfQogICAgZnVuY3Rpb24gY29uZGVuc2UodW5tYXRjaGVkLCBtYXAsIGZpbHRlciwgY29udGV4dCwgeG1sKSB7CiAgICAgIHZhciBlbGVtLAogICAgICAgIG5ld1VubWF0Y2hlZCA9IFtdLAogICAgICAgIGkgPSAwLAogICAgICAgIGxlbiA9IHVubWF0Y2hlZC5sZW5ndGgsCiAgICAgICAgbWFwcGVkID0gbWFwICE9IG51bGw7CiAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICBpZiAoZWxlbSA9IHVubWF0Y2hlZFtpXSkgewogICAgICAgICAgaWYgKCFmaWx0ZXIgfHwgZmlsdGVyKGVsZW0sIGNvbnRleHQsIHhtbCkpIHsKICAgICAgICAgICAgbmV3VW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgIGlmIChtYXBwZWQpIHsKICAgICAgICAgICAgICBtYXAucHVzaChpKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gbmV3VW5tYXRjaGVkOwogICAgfQogICAgZnVuY3Rpb24gc2V0TWF0Y2hlcihwcmVGaWx0ZXIsIHNlbGVjdG9yLCBtYXRjaGVyLCBwb3N0RmlsdGVyLCBwb3N0RmluZGVyLCBwb3N0U2VsZWN0b3IpIHsKICAgICAgaWYgKHBvc3RGaWx0ZXIgJiYgIXBvc3RGaWx0ZXJbZXhwYW5kb10pIHsKICAgICAgICBwb3N0RmlsdGVyID0gc2V0TWF0Y2hlcihwb3N0RmlsdGVyKTsKICAgICAgfQogICAgICBpZiAocG9zdEZpbmRlciAmJiAhcG9zdEZpbmRlcltleHBhbmRvXSkgewogICAgICAgIHBvc3RGaW5kZXIgPSBzZXRNYXRjaGVyKHBvc3RGaW5kZXIsIHBvc3RTZWxlY3Rvcik7CiAgICAgIH0KICAgICAgcmV0dXJuIG1hcmtGdW5jdGlvbihmdW5jdGlvbiAoc2VlZCwgcmVzdWx0cywgY29udGV4dCwgeG1sKSB7CiAgICAgICAgdmFyIHRlbXAsCiAgICAgICAgICBpLAogICAgICAgICAgZWxlbSwKICAgICAgICAgIHByZU1hcCA9IFtdLAogICAgICAgICAgcG9zdE1hcCA9IFtdLAogICAgICAgICAgcHJlZXhpc3RpbmcgPSByZXN1bHRzLmxlbmd0aCwKICAgICAgICAgIC8vIEdldCBpbml0aWFsIGVsZW1lbnRzIGZyb20gc2VlZCBvciBjb250ZXh0CiAgICAgICAgICBlbGVtcyA9IHNlZWQgfHwgbXVsdGlwbGVDb250ZXh0cyhzZWxlY3RvciB8fCAiKiIsIGNvbnRleHQubm9kZVR5cGUgPyBbY29udGV4dF0gOiBjb250ZXh0LCBbXSksCiAgICAgICAgICAvLyBQcmVmaWx0ZXIgdG8gZ2V0IG1hdGNoZXIgaW5wdXQsIHByZXNlcnZpbmcgYSBtYXAgZm9yIHNlZWQtcmVzdWx0cyBzeW5jaHJvbml6YXRpb24KICAgICAgICAgIG1hdGNoZXJJbiA9IHByZUZpbHRlciAmJiAoc2VlZCB8fCAhc2VsZWN0b3IpID8gY29uZGVuc2UoZWxlbXMsIHByZU1hcCwgcHJlRmlsdGVyLCBjb250ZXh0LCB4bWwpIDogZWxlbXMsCiAgICAgICAgICBtYXRjaGVyT3V0ID0gbWF0Y2hlciA/CiAgICAgICAgICAvLyBJZiB3ZSBoYXZlIGEgcG9zdEZpbmRlciwgb3IgZmlsdGVyZWQgc2VlZCwgb3Igbm9uLXNlZWQgcG9zdEZpbHRlciBvciBwcmVleGlzdGluZyByZXN1bHRzLAogICAgICAgICAgcG9zdEZpbmRlciB8fCAoc2VlZCA/IHByZUZpbHRlciA6IHByZWV4aXN0aW5nIHx8IHBvc3RGaWx0ZXIpID8KICAgICAgICAgIC8vIC4uLmludGVybWVkaWF0ZSBwcm9jZXNzaW5nIGlzIG5lY2Vzc2FyeQogICAgICAgICAgW10gOgogICAgICAgICAgLy8gLi4ub3RoZXJ3aXNlIHVzZSByZXN1bHRzIGRpcmVjdGx5CiAgICAgICAgICByZXN1bHRzIDogbWF0Y2hlckluOwoKICAgICAgICAvLyBGaW5kIHByaW1hcnkgbWF0Y2hlcwogICAgICAgIGlmIChtYXRjaGVyKSB7CiAgICAgICAgICBtYXRjaGVyKG1hdGNoZXJJbiwgbWF0Y2hlck91dCwgY29udGV4dCwgeG1sKTsKICAgICAgICB9CgogICAgICAgIC8vIEFwcGx5IHBvc3RGaWx0ZXIKICAgICAgICBpZiAocG9zdEZpbHRlcikgewogICAgICAgICAgdGVtcCA9IGNvbmRlbnNlKG1hdGNoZXJPdXQsIHBvc3RNYXApOwogICAgICAgICAgcG9zdEZpbHRlcih0ZW1wLCBbXSwgY29udGV4dCwgeG1sKTsKCiAgICAgICAgICAvLyBVbi1tYXRjaCBmYWlsaW5nIGVsZW1lbnRzIGJ5IG1vdmluZyB0aGVtIGJhY2sgdG8gbWF0Y2hlckluCiAgICAgICAgICBpID0gdGVtcC5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIGlmIChlbGVtID0gdGVtcFtpXSkgewogICAgICAgICAgICAgIG1hdGNoZXJPdXRbcG9zdE1hcFtpXV0gPSAhKG1hdGNoZXJJbltwb3N0TWFwW2ldXSA9IGVsZW0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzZWVkKSB7CiAgICAgICAgICBpZiAocG9zdEZpbmRlciB8fCBwcmVGaWx0ZXIpIHsKICAgICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIGZpbmFsIG1hdGNoZXJPdXQgYnkgY29uZGVuc2luZyB0aGlzIGludGVybWVkaWF0ZSBpbnRvIHBvc3RGaW5kZXIgY29udGV4dHMKICAgICAgICAgICAgICB0ZW1wID0gW107CiAgICAgICAgICAgICAgaSA9IG1hdGNoZXJPdXQubGVuZ3RoOwogICAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChlbGVtID0gbWF0Y2hlck91dFtpXSkgewogICAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIG1hdGNoZXJJbiBzaW5jZSBlbGVtIGlzIG5vdCB5ZXQgYSBmaW5hbCBtYXRjaAogICAgICAgICAgICAgICAgICB0ZW1wLnB1c2gobWF0Y2hlckluW2ldID0gZWxlbSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHBvc3RGaW5kZXIobnVsbCwgbWF0Y2hlck91dCA9IFtdLCB0ZW1wLCB4bWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb3ZlIG1hdGNoZWQgZWxlbWVudHMgZnJvbSBzZWVkIHRvIHJlc3VsdHMgdG8ga2VlcCB0aGVtIHN5bmNocm9uaXplZAogICAgICAgICAgICBpID0gbWF0Y2hlck91dC5sZW5ndGg7CiAgICAgICAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICAgICAgICBpZiAoKGVsZW0gPSBtYXRjaGVyT3V0W2ldKSAmJiAodGVtcCA9IHBvc3RGaW5kZXIgPyBpbmRleE9mKHNlZWQsIGVsZW0pIDogcHJlTWFwW2ldKSA+IC0xKSB7CiAgICAgICAgICAgICAgICBzZWVkW3RlbXBdID0gIShyZXN1bHRzW3RlbXBdID0gZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQWRkIGVsZW1lbnRzIHRvIHJlc3VsdHMsIHRocm91Z2ggcG9zdEZpbmRlciBpZiBkZWZpbmVkCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXJPdXQgPSBjb25kZW5zZShtYXRjaGVyT3V0ID09PSByZXN1bHRzID8gbWF0Y2hlck91dC5zcGxpY2UocHJlZXhpc3RpbmcsIG1hdGNoZXJPdXQubGVuZ3RoKSA6IG1hdGNoZXJPdXQpOwogICAgICAgICAgaWYgKHBvc3RGaW5kZXIpIHsKICAgICAgICAgICAgcG9zdEZpbmRlcihudWxsLCByZXN1bHRzLCBtYXRjaGVyT3V0LCB4bWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcHVzaC5hcHBseShyZXN1bHRzLCBtYXRjaGVyT3V0KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogICAgZnVuY3Rpb24gbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zKSB7CiAgICAgIHZhciBjaGVja0NvbnRleHQsCiAgICAgICAgbWF0Y2hlciwKICAgICAgICBqLAogICAgICAgIGxlbiA9IHRva2Vucy5sZW5ndGgsCiAgICAgICAgbGVhZGluZ1JlbGF0aXZlID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbMF0udHlwZV0sCiAgICAgICAgaW1wbGljaXRSZWxhdGl2ZSA9IGxlYWRpbmdSZWxhdGl2ZSB8fCBFeHByLnJlbGF0aXZlWyIgIl0sCiAgICAgICAgaSA9IGxlYWRpbmdSZWxhdGl2ZSA/IDEgOiAwLAogICAgICAgIC8vIFRoZSBmb3VuZGF0aW9uYWwgbWF0Y2hlciBlbnN1cmVzIHRoYXQgZWxlbWVudHMgYXJlIHJlYWNoYWJsZSBmcm9tIHRvcC1sZXZlbCBjb250ZXh0KHMpCiAgICAgICAgbWF0Y2hDb250ZXh0ID0gYWRkQ29tYmluYXRvcihmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgcmV0dXJuIGVsZW0gPT09IGNoZWNrQ29udGV4dDsKICAgICAgICB9LCBpbXBsaWNpdFJlbGF0aXZlLCB0cnVlKSwKICAgICAgICBtYXRjaEFueUNvbnRleHQgPSBhZGRDb21iaW5hdG9yKGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICByZXR1cm4gaW5kZXhPZihjaGVja0NvbnRleHQsIGVsZW0pID4gLTE7CiAgICAgICAgfSwgaW1wbGljaXRSZWxhdGl2ZSwgdHJ1ZSksCiAgICAgICAgbWF0Y2hlcnMgPSBbZnVuY3Rpb24gKGVsZW0sIGNvbnRleHQsIHhtbCkgewogICAgICAgICAgdmFyIHJldCA9ICFsZWFkaW5nUmVsYXRpdmUgJiYgKHhtbCB8fCBjb250ZXh0ICE9PSBvdXRlcm1vc3RDb250ZXh0KSB8fCAoKGNoZWNrQ29udGV4dCA9IGNvbnRleHQpLm5vZGVUeXBlID8gbWF0Y2hDb250ZXh0KGVsZW0sIGNvbnRleHQsIHhtbCkgOiBtYXRjaEFueUNvbnRleHQoZWxlbSwgY29udGV4dCwgeG1sKSk7CgogICAgICAgICAgLy8gQXZvaWQgaGFuZ2luZyBvbnRvIGVsZW1lbnQgKGlzc3VlICMyOTkpCiAgICAgICAgICBjaGVja0NvbnRleHQgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9XTsKICAgICAgZm9yICg7IGkgPCBsZW47IGkrKykgewogICAgICAgIGlmIChtYXRjaGVyID0gRXhwci5yZWxhdGl2ZVt0b2tlbnNbaV0udHlwZV0pIHsKICAgICAgICAgIG1hdGNoZXJzID0gW2FkZENvbWJpbmF0b3IoZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpLCBtYXRjaGVyKV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1hdGNoZXIgPSBFeHByLmZpbHRlclt0b2tlbnNbaV0udHlwZV0uYXBwbHkobnVsbCwgdG9rZW5zW2ldLm1hdGNoZXMpOwoKICAgICAgICAgIC8vIFJldHVybiBzcGVjaWFsIHVwb24gc2VlaW5nIGEgcG9zaXRpb25hbCBtYXRjaGVyCiAgICAgICAgICBpZiAobWF0Y2hlcltleHBhbmRvXSkgewogICAgICAgICAgICAvLyBGaW5kIHRoZSBuZXh0IHJlbGF0aXZlIG9wZXJhdG9yIChpZiBhbnkpIGZvciBwcm9wZXIgaGFuZGxpbmcKICAgICAgICAgICAgaiA9ICsraTsKICAgICAgICAgICAgZm9yICg7IGogPCBsZW47IGorKykgewogICAgICAgICAgICAgIGlmIChFeHByLnJlbGF0aXZlW3Rva2Vuc1tqXS50eXBlXSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZXRNYXRjaGVyKGkgPiAxICYmIGVsZW1lbnRNYXRjaGVyKG1hdGNoZXJzKSwgaSA+IDEgJiYgdG9TZWxlY3RvcigKICAgICAgICAgICAgLy8gSWYgdGhlIHByZWNlZGluZyB0b2tlbiB3YXMgYSBkZXNjZW5kYW50IGNvbWJpbmF0b3IsIGluc2VydCBhbiBpbXBsaWNpdCBhbnktZWxlbWVudCBgKmAKICAgICAgICAgICAgdG9rZW5zLnNsaWNlKDAsIGkgLSAxKS5jb25jYXQoewogICAgICAgICAgICAgIHZhbHVlOiB0b2tlbnNbaSAtIDJdLnR5cGUgPT09ICIgIiA/ICIqIiA6ICIiCiAgICAgICAgICAgIH0pKS5yZXBsYWNlKHJ0cmltLCAiJDEiKSwgbWF0Y2hlciwgaSA8IGogJiYgbWF0Y2hlckZyb21Ub2tlbnModG9rZW5zLnNsaWNlKGksIGopKSwgaiA8IGxlbiAmJiBtYXRjaGVyRnJvbVRva2Vucyh0b2tlbnMgPSB0b2tlbnMuc2xpY2UoaikpLCBqIDwgbGVuICYmIHRvU2VsZWN0b3IodG9rZW5zKSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYXRjaGVycy5wdXNoKG1hdGNoZXIpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZWxlbWVudE1hdGNoZXIobWF0Y2hlcnMpOwogICAgfQogICAgZnVuY3Rpb24gbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMpIHsKICAgICAgdmFyIGJ5U2V0ID0gc2V0TWF0Y2hlcnMubGVuZ3RoID4gMCwKICAgICAgICBieUVsZW1lbnQgPSBlbGVtZW50TWF0Y2hlcnMubGVuZ3RoID4gMCwKICAgICAgICBzdXBlck1hdGNoZXIgPSBmdW5jdGlvbiAoc2VlZCwgY29udGV4dCwgeG1sLCByZXN1bHRzLCBvdXRlcm1vc3QpIHsKICAgICAgICAgIHZhciBlbGVtLAogICAgICAgICAgICBqLAogICAgICAgICAgICBtYXRjaGVyLAogICAgICAgICAgICBtYXRjaGVkQ291bnQgPSAwLAogICAgICAgICAgICBpID0gIjAiLAogICAgICAgICAgICB1bm1hdGNoZWQgPSBzZWVkICYmIFtdLAogICAgICAgICAgICBzZXRNYXRjaGVkID0gW10sCiAgICAgICAgICAgIGNvbnRleHRCYWNrdXAgPSBvdXRlcm1vc3RDb250ZXh0LAogICAgICAgICAgICAvLyBXZSBtdXN0IGFsd2F5cyBoYXZlIGVpdGhlciBzZWVkIGVsZW1lbnRzIG9yIG91dGVybW9zdCBjb250ZXh0CiAgICAgICAgICAgIGVsZW1zID0gc2VlZCB8fCBieUVsZW1lbnQgJiYgRXhwci5maW5kWyJUQUciXSgiKiIsIG91dGVybW9zdCksCiAgICAgICAgICAgIC8vIFVzZSBpbnRlZ2VyIGRpcnJ1bnMgaWZmIHRoaXMgaXMgdGhlIG91dGVybW9zdCBtYXRjaGVyCiAgICAgICAgICAgIGRpcnJ1bnNVbmlxdWUgPSBkaXJydW5zICs9IGNvbnRleHRCYWNrdXAgPT0gbnVsbCA/IDEgOiBNYXRoLnJhbmRvbSgpIHx8IDAuMSwKICAgICAgICAgICAgbGVuID0gZWxlbXMubGVuZ3RoOwogICAgICAgICAgaWYgKG91dGVybW9zdCkgewogICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSAxMSssIEVkZ2UgMTcgLSAxOCsKICAgICAgICAgICAgLy8gSUUvRWRnZSBzb21ldGltZXMgdGhyb3cgYSAiUGVybWlzc2lvbiBkZW5pZWQiIGVycm9yIHdoZW4gc3RyaWN0LWNvbXBhcmluZwogICAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBlcWVxZXEKICAgICAgICAgICAgb3V0ZXJtb3N0Q29udGV4dCA9IGNvbnRleHQgPT0gZG9jdW1lbnQgfHwgY29udGV4dCB8fCBvdXRlcm1vc3Q7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQWRkIGVsZW1lbnRzIHBhc3NpbmcgZWxlbWVudE1hdGNoZXJzIGRpcmVjdGx5IHRvIHJlc3VsdHMKICAgICAgICAgIC8vIFN1cHBvcnQ6IElFPDksIFNhZmFyaQogICAgICAgICAgLy8gVG9sZXJhdGUgTm9kZUxpc3QgcHJvcGVydGllcyAoSUU6ICJsZW5ndGgiOyBTYWZhcmk6IDxudW1iZXI+KSBtYXRjaGluZyBlbGVtZW50cyBieSBpZAogICAgICAgICAgZm9yICg7IGkgIT09IGxlbiAmJiAoZWxlbSA9IGVsZW1zW2ldKSAhPSBudWxsOyBpKyspIHsKICAgICAgICAgICAgaWYgKGJ5RWxlbWVudCAmJiBlbGVtKSB7CiAgICAgICAgICAgICAgaiA9IDA7CgogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDExKywgRWRnZSAxNyAtIDE4KwogICAgICAgICAgICAgIC8vIElFL0VkZ2Ugc29tZXRpbWVzIHRocm93IGEgIlBlcm1pc3Npb24gZGVuaWVkIiBlcnJvciB3aGVuIHN0cmljdC1jb21wYXJpbmcKICAgICAgICAgICAgICAvLyB0d28gZG9jdW1lbnRzOyBzaGFsbG93IGNvbXBhcmlzb25zIHdvcmsuCiAgICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGVxZXFlcQogICAgICAgICAgICAgIGlmICghY29udGV4dCAmJiBlbGVtLm93bmVyRG9jdW1lbnQgIT0gZG9jdW1lbnQpIHsKICAgICAgICAgICAgICAgIHNldERvY3VtZW50KGVsZW0pOwogICAgICAgICAgICAgICAgeG1sID0gIWRvY3VtZW50SXNIVE1MOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IGVsZW1lbnRNYXRjaGVyc1tqKytdKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlcihlbGVtLCBjb250ZXh0IHx8IGRvY3VtZW50LCB4bWwpKSB7CiAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaChlbGVtKTsKICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmIChvdXRlcm1vc3QpIHsKICAgICAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gVHJhY2sgdW5tYXRjaGVkIGVsZW1lbnRzIGZvciBzZXQgZmlsdGVycwogICAgICAgICAgICBpZiAoYnlTZXQpIHsKICAgICAgICAgICAgICAvLyBUaGV5IHdpbGwgaGF2ZSBnb25lIHRocm91Z2ggYWxsIHBvc3NpYmxlIG1hdGNoZXJzCiAgICAgICAgICAgICAgaWYgKGVsZW0gPSAhbWF0Y2hlciAmJiBlbGVtKSB7CiAgICAgICAgICAgICAgICBtYXRjaGVkQ291bnQtLTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIExlbmd0aGVuIHRoZSBhcnJheSBmb3IgZXZlcnkgZWxlbWVudCwgbWF0Y2hlZCBvciBub3QKICAgICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgICAgdW5tYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gYGlgIGlzIG5vdyB0aGUgY291bnQgb2YgZWxlbWVudHMgdmlzaXRlZCBhYm92ZSwgYW5kIGFkZGluZyBpdCB0byBgbWF0Y2hlZENvdW50YAogICAgICAgICAgLy8gbWFrZXMgdGhlIGxhdHRlciBub25uZWdhdGl2ZS4KICAgICAgICAgIG1hdGNoZWRDb3VudCArPSBpOwoKICAgICAgICAgIC8vIEFwcGx5IHNldCBmaWx0ZXJzIHRvIHVubWF0Y2hlZCBlbGVtZW50cwogICAgICAgICAgLy8gTk9URTogVGhpcyBjYW4gYmUgc2tpcHBlZCBpZiB0aGVyZSBhcmUgbm8gdW5tYXRjaGVkIGVsZW1lbnRzIChpLmUuLCBgbWF0Y2hlZENvdW50YAogICAgICAgICAgLy8gZXF1YWxzIGBpYCksIHVubGVzcyB3ZSBkaWRuJ3QgdmlzaXQgX2FueV8gZWxlbWVudHMgaW4gdGhlIGFib3ZlIGxvb3AgYmVjYXVzZSB3ZSBoYXZlCiAgICAgICAgICAvLyBubyBlbGVtZW50IG1hdGNoZXJzIGFuZCBubyBzZWVkLgogICAgICAgICAgLy8gSW5jcmVtZW50aW5nIGFuIGluaXRpYWxseS1zdHJpbmcgIjAiIGBpYCBhbGxvd3MgYGlgIHRvIHJlbWFpbiBhIHN0cmluZyBvbmx5IGluIHRoYXQKICAgICAgICAgIC8vIGNhc2UsIHdoaWNoIHdpbGwgcmVzdWx0IGluIGEgIjAwIiBgbWF0Y2hlZENvdW50YCB0aGF0IGRpZmZlcnMgZnJvbSBgaWAgYnV0IGlzIGFsc28KICAgICAgICAgIC8vIG51bWVyaWNhbGx5IHplcm8uCiAgICAgICAgICBpZiAoYnlTZXQgJiYgaSAhPT0gbWF0Y2hlZENvdW50KSB7CiAgICAgICAgICAgIGogPSAwOwogICAgICAgICAgICB3aGlsZSAobWF0Y2hlciA9IHNldE1hdGNoZXJzW2orK10pIHsKICAgICAgICAgICAgICBtYXRjaGVyKHVubWF0Y2hlZCwgc2V0TWF0Y2hlZCwgY29udGV4dCwgeG1sKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoc2VlZCkgewogICAgICAgICAgICAgIC8vIFJlaW50ZWdyYXRlIGVsZW1lbnQgbWF0Y2hlcyB0byBlbGltaW5hdGUgdGhlIG5lZWQgZm9yIHNvcnRpbmcKICAgICAgICAgICAgICBpZiAobWF0Y2hlZENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgICAgICAgICBpZiAoISh1bm1hdGNoZWRbaV0gfHwgc2V0TWF0Y2hlZFtpXSkpIHsKICAgICAgICAgICAgICAgICAgICBzZXRNYXRjaGVkW2ldID0gcG9wLmNhbGwocmVzdWx0cyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIC8vIERpc2NhcmQgaW5kZXggcGxhY2Vob2xkZXIgdmFsdWVzIHRvIGdldCBvbmx5IGFjdHVhbCBtYXRjaGVzCiAgICAgICAgICAgICAgc2V0TWF0Y2hlZCA9IGNvbmRlbnNlKHNldE1hdGNoZWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBZGQgbWF0Y2hlcyB0byByZXN1bHRzCiAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2V0TWF0Y2hlZCk7CgogICAgICAgICAgICAvLyBTZWVkbGVzcyBzZXQgbWF0Y2hlcyBzdWNjZWVkaW5nIG11bHRpcGxlIHN1Y2Nlc3NmdWwgbWF0Y2hlcnMgc3RpcHVsYXRlIHNvcnRpbmcKICAgICAgICAgICAgaWYgKG91dGVybW9zdCAmJiAhc2VlZCAmJiBzZXRNYXRjaGVkLmxlbmd0aCA+IDAgJiYgbWF0Y2hlZENvdW50ICsgc2V0TWF0Y2hlcnMubGVuZ3RoID4gMSkgewogICAgICAgICAgICAgIFNpenpsZS51bmlxdWVTb3J0KHJlc3VsdHMpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgLy8gT3ZlcnJpZGUgbWFuaXB1bGF0aW9uIG9mIGdsb2JhbHMgYnkgbmVzdGVkIG1hdGNoZXJzCiAgICAgICAgICBpZiAob3V0ZXJtb3N0KSB7CiAgICAgICAgICAgIGRpcnJ1bnMgPSBkaXJydW5zVW5pcXVlOwogICAgICAgICAgICBvdXRlcm1vc3RDb250ZXh0ID0gY29udGV4dEJhY2t1cDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1bm1hdGNoZWQ7CiAgICAgICAgfTsKICAgICAgcmV0dXJuIGJ5U2V0ID8gbWFya0Z1bmN0aW9uKHN1cGVyTWF0Y2hlcikgOiBzdXBlck1hdGNoZXI7CiAgICB9CiAgICBjb21waWxlID0gU2l6emxlLmNvbXBpbGUgPSBmdW5jdGlvbiAoc2VsZWN0b3IsIG1hdGNoIC8qIEludGVybmFsIFVzZSBPbmx5ICovKSB7CiAgICAgIHZhciBpLAogICAgICAgIHNldE1hdGNoZXJzID0gW10sCiAgICAgICAgZWxlbWVudE1hdGNoZXJzID0gW10sCiAgICAgICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZVtzZWxlY3RvciArICIgIl07CiAgICAgIGlmICghY2FjaGVkKSB7CiAgICAgICAgLy8gR2VuZXJhdGUgYSBmdW5jdGlvbiBvZiByZWN1cnNpdmUgZnVuY3Rpb25zIHRoYXQgY2FuIGJlIHVzZWQgdG8gY2hlY2sgZWFjaCBlbGVtZW50CiAgICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgICAgbWF0Y2ggPSB0b2tlbml6ZShzZWxlY3Rvcik7CiAgICAgICAgfQogICAgICAgIGkgPSBtYXRjaC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKGktLSkgewogICAgICAgICAgY2FjaGVkID0gbWF0Y2hlckZyb21Ub2tlbnMobWF0Y2hbaV0pOwogICAgICAgICAgaWYgKGNhY2hlZFtleHBhbmRvXSkgewogICAgICAgICAgICBzZXRNYXRjaGVycy5wdXNoKGNhY2hlZCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBlbGVtZW50TWF0Y2hlcnMucHVzaChjYWNoZWQpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gQ2FjaGUgdGhlIGNvbXBpbGVkIGZ1bmN0aW9uCiAgICAgICAgY2FjaGVkID0gY29tcGlsZXJDYWNoZShzZWxlY3RvciwgbWF0Y2hlckZyb21Hcm91cE1hdGNoZXJzKGVsZW1lbnRNYXRjaGVycywgc2V0TWF0Y2hlcnMpKTsKCiAgICAgICAgLy8gU2F2ZSBzZWxlY3RvciBhbmQgdG9rZW5pemF0aW9uCiAgICAgICAgY2FjaGVkLnNlbGVjdG9yID0gc2VsZWN0b3I7CiAgICAgIH0KICAgICAgcmV0dXJuIGNhY2hlZDsKICAgIH07CgogICAgLyoqCiAgICAgKiBBIGxvdy1sZXZlbCBzZWxlY3Rpb24gZnVuY3Rpb24gdGhhdCB3b3JrcyB3aXRoIFNpenpsZSdzIGNvbXBpbGVkCiAgICAgKiAgc2VsZWN0b3IgZnVuY3Rpb25zCiAgICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gc2VsZWN0b3IgQSBzZWxlY3RvciBvciBhIHByZS1jb21waWxlZAogICAgICogIHNlbGVjdG9yIGZ1bmN0aW9uIGJ1aWx0IHdpdGggU2l6emxlLmNvbXBpbGUKICAgICAqIEBwYXJhbSB7RWxlbWVudH0gY29udGV4dAogICAgICogQHBhcmFtIHtBcnJheX0gW3Jlc3VsdHNdCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbc2VlZF0gQSBzZXQgb2YgZWxlbWVudHMgdG8gbWF0Y2ggYWdhaW5zdAogICAgICovCiAgICBzZWxlY3QgPSBTaXp6bGUuc2VsZWN0ID0gZnVuY3Rpb24gKHNlbGVjdG9yLCBjb250ZXh0LCByZXN1bHRzLCBzZWVkKSB7CiAgICAgIHZhciBpLAogICAgICAgIHRva2VucywKICAgICAgICB0b2tlbiwKICAgICAgICB0eXBlLAogICAgICAgIGZpbmQsCiAgICAgICAgY29tcGlsZWQgPSB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIgJiYgc2VsZWN0b3IsCiAgICAgICAgbWF0Y2ggPSAhc2VlZCAmJiB0b2tlbml6ZShzZWxlY3RvciA9IGNvbXBpbGVkLnNlbGVjdG9yIHx8IHNlbGVjdG9yKTsKICAgICAgcmVzdWx0cyA9IHJlc3VsdHMgfHwgW107CgogICAgICAvLyBUcnkgdG8gbWluaW1pemUgb3BlcmF0aW9ucyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBzZWxlY3RvciBpbiB0aGUgbGlzdCBhbmQgbm8gc2VlZAogICAgICAvLyAodGhlIGxhdHRlciBvZiB3aGljaCBndWFyYW50ZWVzIHVzIGNvbnRleHQpCiAgICAgIGlmIChtYXRjaC5sZW5ndGggPT09IDEpIHsKICAgICAgICAvLyBSZWR1Y2UgY29udGV4dCBpZiB0aGUgbGVhZGluZyBjb21wb3VuZCBzZWxlY3RvciBpcyBhbiBJRAogICAgICAgIHRva2VucyA9IG1hdGNoWzBdID0gbWF0Y2hbMF0uc2xpY2UoMCk7CiAgICAgICAgaWYgKHRva2Vucy5sZW5ndGggPiAyICYmICh0b2tlbiA9IHRva2Vuc1swXSkudHlwZSA9PT0gIklEIiAmJiBjb250ZXh0Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50SXNIVE1MICYmIEV4cHIucmVsYXRpdmVbdG9rZW5zWzFdLnR5cGVdKSB7CiAgICAgICAgICBjb250ZXh0ID0gKEV4cHIuZmluZFsiSUQiXSh0b2tlbi5tYXRjaGVzWzBdLnJlcGxhY2UocnVuZXNjYXBlLCBmdW5lc2NhcGUpLCBjb250ZXh0KSB8fCBbXSlbMF07CiAgICAgICAgICBpZiAoIWNvbnRleHQpIHsKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdHM7CgogICAgICAgICAgICAvLyBQcmVjb21waWxlZCBtYXRjaGVycyB3aWxsIHN0aWxsIHZlcmlmeSBhbmNlc3RyeSwgc28gc3RlcCB1cCBhIGxldmVsCiAgICAgICAgICB9IGVsc2UgaWYgKGNvbXBpbGVkKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0LnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICBzZWxlY3RvciA9IHNlbGVjdG9yLnNsaWNlKHRva2Vucy5zaGlmdCgpLnZhbHVlLmxlbmd0aCk7CiAgICAgICAgfQoKICAgICAgICAvLyBGZXRjaCBhIHNlZWQgc2V0IGZvciByaWdodC10by1sZWZ0IG1hdGNoaW5nCiAgICAgICAgaSA9IG1hdGNoRXhwclsibmVlZHNDb250ZXh0Il0udGVzdChzZWxlY3RvcikgPyAwIDogdG9rZW5zLmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICB0b2tlbiA9IHRva2Vuc1tpXTsKCiAgICAgICAgICAvLyBBYm9ydCBpZiB3ZSBoaXQgYSBjb21iaW5hdG9yCiAgICAgICAgICBpZiAoRXhwci5yZWxhdGl2ZVt0eXBlID0gdG9rZW4udHlwZV0pIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoZmluZCA9IEV4cHIuZmluZFt0eXBlXSkgewogICAgICAgICAgICAvLyBTZWFyY2gsIGV4cGFuZGluZyBjb250ZXh0IGZvciBsZWFkaW5nIHNpYmxpbmcgY29tYmluYXRvcnMKICAgICAgICAgICAgaWYgKHNlZWQgPSBmaW5kKHRva2VuLm1hdGNoZXNbMF0ucmVwbGFjZShydW5lc2NhcGUsIGZ1bmVzY2FwZSksIHJzaWJsaW5nLnRlc3QodG9rZW5zWzBdLnR5cGUpICYmIHRlc3RDb250ZXh0KGNvbnRleHQucGFyZW50Tm9kZSkgfHwgY29udGV4dCkpIHsKICAgICAgICAgICAgICAvLyBJZiBzZWVkIGlzIGVtcHR5IG9yIG5vIHRva2VucyByZW1haW4sIHdlIGNhbiByZXR1cm4gZWFybHkKICAgICAgICAgICAgICB0b2tlbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgIHNlbGVjdG9yID0gc2VlZC5sZW5ndGggJiYgdG9TZWxlY3Rvcih0b2tlbnMpOwogICAgICAgICAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICAgICAgICAgIHB1c2guYXBwbHkocmVzdWx0cywgc2VlZCk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0czsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENvbXBpbGUgYW5kIGV4ZWN1dGUgYSBmaWx0ZXJpbmcgZnVuY3Rpb24gaWYgb25lIGlzIG5vdCBwcm92aWRlZAogICAgICAvLyBQcm92aWRlIGBtYXRjaGAgdG8gYXZvaWQgcmV0b2tlbml6YXRpb24gaWYgd2UgbW9kaWZpZWQgdGhlIHNlbGVjdG9yIGFib3ZlCiAgICAgIChjb21waWxlZCB8fCBjb21waWxlKHNlbGVjdG9yLCBtYXRjaCkpKHNlZWQsIGNvbnRleHQsICFkb2N1bWVudElzSFRNTCwgcmVzdWx0cywgIWNvbnRleHQgfHwgcnNpYmxpbmcudGVzdChzZWxlY3RvcikgJiYgdGVzdENvbnRleHQoY29udGV4dC5wYXJlbnROb2RlKSB8fCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHJlc3VsdHM7CiAgICB9OwoKICAgIC8vIE9uZS10aW1lIGFzc2lnbm1lbnRzCgogICAgLy8gU29ydCBzdGFiaWxpdHkKICAgIHN1cHBvcnQuc29ydFN0YWJsZSA9IGV4cGFuZG8uc3BsaXQoIiIpLnNvcnQoc29ydE9yZGVyKS5qb2luKCIiKSA9PT0gZXhwYW5kbzsKCiAgICAvLyBTdXBwb3J0OiBDaHJvbWUgMTQtMzUrCiAgICAvLyBBbHdheXMgYXNzdW1lIGR1cGxpY2F0ZXMgaWYgdGhleSBhcmVuJ3QgcGFzc2VkIHRvIHRoZSBjb21wYXJpc29uIGZ1bmN0aW9uCiAgICBzdXBwb3J0LmRldGVjdER1cGxpY2F0ZXMgPSAhIWhhc0R1cGxpY2F0ZTsKCiAgICAvLyBJbml0aWFsaXplIGFnYWluc3QgdGhlIGRlZmF1bHQgZG9jdW1lbnQKICAgIHNldERvY3VtZW50KCk7CgogICAgLy8gU3VwcG9ydDogV2Via2l0PDUzNy4zMiAtIFNhZmFyaSA2LjAuMy9DaHJvbWUgMjUgKGZpeGVkIGluIENocm9tZSAyNykKICAgIC8vIERldGFjaGVkIG5vZGVzIGNvbmZvdW5kaW5nbHkgZm9sbG93ICplYWNoIG90aGVyKgogICAgc3VwcG9ydC5zb3J0RGV0YWNoZWQgPSBhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgIC8vIFNob3VsZCByZXR1cm4gMSwgYnV0IHJldHVybnMgNCAoZm9sbG93aW5nKQogICAgICByZXR1cm4gZWwuY29tcGFyZURvY3VtZW50UG9zaXRpb24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZmllbGRzZXQiKSkgJiAxOwogICAgfSk7CgogICAgLy8gU3VwcG9ydDogSUU8OAogICAgLy8gUHJldmVudCBhdHRyaWJ1dGUvcHJvcGVydHkgImludGVycG9sYXRpb24iCiAgICAvLyBodHRwczovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L21zNTM2NDI5JTI4VlMuODUlMjkuYXNweAogICAgaWYgKCFhc3NlcnQoZnVuY3Rpb24gKGVsKSB7CiAgICAgIGVsLmlubmVySFRNTCA9ICI8YSBocmVmPScjJz48L2E+IjsKICAgICAgcmV0dXJuIGVsLmZpcnN0Q2hpbGQuZ2V0QXR0cmlidXRlKCJocmVmIikgPT09ICIjIjsKICAgIH0pKSB7CiAgICAgIGFkZEhhbmRsZSgidHlwZXxocmVmfGhlaWdodHx3aWR0aCIsIGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBpc1hNTCkgewogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtLmdldEF0dHJpYnV0ZShuYW1lLCBuYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJ0eXBlIiA/IDEgOiAyKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFPDkKICAgIC8vIFVzZSBkZWZhdWx0VmFsdWUgaW4gcGxhY2Ugb2YgZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpCiAgICBpZiAoIXN1cHBvcnQuYXR0cmlidXRlcyB8fCAhYXNzZXJ0KGZ1bmN0aW9uIChlbCkgewogICAgICBlbC5pbm5lckhUTUwgPSAiPGlucHV0Lz4iOwogICAgICBlbC5maXJzdENoaWxkLnNldEF0dHJpYnV0ZSgidmFsdWUiLCAiIik7CiAgICAgIHJldHVybiBlbC5maXJzdENoaWxkLmdldEF0dHJpYnV0ZSgidmFsdWUiKSA9PT0gIiI7CiAgICB9KSkgewogICAgICBhZGRIYW5kbGUoInZhbHVlIiwgZnVuY3Rpb24gKGVsZW0sIF9uYW1lLCBpc1hNTCkgewogICAgICAgIGlmICghaXNYTUwgJiYgZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAiaW5wdXQiKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5kZWZhdWx0VmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRTw5CiAgICAvLyBVc2UgZ2V0QXR0cmlidXRlTm9kZSB0byBmZXRjaCBib29sZWFucyB3aGVuIGdldEF0dHJpYnV0ZSBsaWVzCiAgICBpZiAoIWFzc2VydChmdW5jdGlvbiAoZWwpIHsKICAgICAgcmV0dXJuIGVsLmdldEF0dHJpYnV0ZSgiZGlzYWJsZWQiKSA9PSBudWxsOwogICAgfSkpIHsKICAgICAgYWRkSGFuZGxlKGJvb2xlYW5zLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICghaXNYTUwpIHsKICAgICAgICAgIHJldHVybiBlbGVtW25hbWVdID09PSB0cnVlID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogKHZhbCA9IGVsZW0uZ2V0QXR0cmlidXRlTm9kZShuYW1lKSkgJiYgdmFsLnNwZWNpZmllZCA/IHZhbC52YWx1ZSA6IG51bGw7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBTaXp6bGU7CiAgfSh3aW5kb3cpOwogIGpRdWVyeS5maW5kID0gU2l6emxlOwogIGpRdWVyeS5leHByID0gU2l6emxlLnNlbGVjdG9yczsKCiAgLy8gRGVwcmVjYXRlZAogIGpRdWVyeS5leHByWyI6Il0gPSBqUXVlcnkuZXhwci5wc2V1ZG9zOwogIGpRdWVyeS51bmlxdWVTb3J0ID0galF1ZXJ5LnVuaXF1ZSA9IFNpenpsZS51bmlxdWVTb3J0OwogIGpRdWVyeS50ZXh0ID0gU2l6emxlLmdldFRleHQ7CiAgalF1ZXJ5LmlzWE1MRG9jID0gU2l6emxlLmlzWE1MOwogIGpRdWVyeS5jb250YWlucyA9IFNpenpsZS5jb250YWluczsKICBqUXVlcnkuZXNjYXBlU2VsZWN0b3IgPSBTaXp6bGUuZXNjYXBlOwogIHZhciBkaXIgPSBmdW5jdGlvbiAoZWxlbSwgZGlyLCB1bnRpbCkgewogICAgdmFyIG1hdGNoZWQgPSBbXSwKICAgICAgdHJ1bmNhdGUgPSB1bnRpbCAhPT0gdW5kZWZpbmVkOwogICAgd2hpbGUgKChlbGVtID0gZWxlbVtkaXJdKSAmJiBlbGVtLm5vZGVUeXBlICE9PSA5KSB7CiAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgaWYgKHRydW5jYXRlICYmIGpRdWVyeShlbGVtKS5pcyh1bnRpbCkpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgICBtYXRjaGVkLnB1c2goZWxlbSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXRjaGVkOwogIH07CiAgdmFyIHNpYmxpbmdzID0gZnVuY3Rpb24gKG4sIGVsZW0pIHsKICAgIHZhciBtYXRjaGVkID0gW107CiAgICBmb3IgKDsgbjsgbiA9IG4ubmV4dFNpYmxpbmcpIHsKICAgICAgaWYgKG4ubm9kZVR5cGUgPT09IDEgJiYgbiAhPT0gZWxlbSkgewogICAgICAgIG1hdGNoZWQucHVzaChuKTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG1hdGNoZWQ7CiAgfTsKICB2YXIgcm5lZWRzQ29udGV4dCA9IGpRdWVyeS5leHByLm1hdGNoLm5lZWRzQ29udGV4dDsKICBmdW5jdGlvbiBub2RlTmFtZShlbGVtLCBuYW1lKSB7CiAgICByZXR1cm4gZWxlbS5ub2RlTmFtZSAmJiBlbGVtLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5hbWUudG9Mb3dlckNhc2UoKTsKICB9CiAgdmFyIHJzaW5nbGVUYWcgPSAvXjwoW2Etel1bXlwvXDA+Olx4MjBcdFxyXG5cZl0qKVtceDIwXHRcclxuXGZdKlwvPz4oPzo8XC9cMT58KSQvaTsKCiAgLy8gSW1wbGVtZW50IHRoZSBpZGVudGljYWwgZnVuY3Rpb25hbGl0eSBmb3IgZmlsdGVyIGFuZCBub3QKICBmdW5jdGlvbiB3aW5ub3coZWxlbWVudHMsIHF1YWxpZmllciwgbm90KSB7CiAgICBpZiAoaXNGdW5jdGlvbihxdWFsaWZpZXIpKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ3JlcChlbGVtZW50cywgZnVuY3Rpb24gKGVsZW0sIGkpIHsKICAgICAgICByZXR1cm4gISFxdWFsaWZpZXIuY2FsbChlbGVtLCBpLCBlbGVtKSAhPT0gbm90OwogICAgICB9KTsKICAgIH0KCiAgICAvLyBTaW5nbGUgZWxlbWVudAogICAgaWYgKHF1YWxpZmllci5ub2RlVHlwZSkgewogICAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGVsZW0gPT09IHF1YWxpZmllciAhPT0gbm90OwogICAgICB9KTsKICAgIH0KCiAgICAvLyBBcnJheWxpa2Ugb2YgZWxlbWVudHMgKGpRdWVyeSwgYXJndW1lbnRzLCBBcnJheSkKICAgIGlmICh0eXBlb2YgcXVhbGlmaWVyICE9PSAic3RyaW5nIikgewogICAgICByZXR1cm4galF1ZXJ5LmdyZXAoZWxlbWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChxdWFsaWZpZXIsIGVsZW0pID4gLTEgIT09IG5vdDsKICAgICAgfSk7CiAgICB9CgogICAgLy8gRmlsdGVyZWQgZGlyZWN0bHkgZm9yIGJvdGggc2ltcGxlIGFuZCBjb21wbGV4IHNlbGVjdG9ycwogICAgcmV0dXJuIGpRdWVyeS5maWx0ZXIocXVhbGlmaWVyLCBlbGVtZW50cywgbm90KTsKICB9CiAgalF1ZXJ5LmZpbHRlciA9IGZ1bmN0aW9uIChleHByLCBlbGVtcywgbm90KSB7CiAgICB2YXIgZWxlbSA9IGVsZW1zWzBdOwogICAgaWYgKG5vdCkgewogICAgICBleHByID0gIjpub3QoIiArIGV4cHIgKyAiKSI7CiAgICB9CiAgICBpZiAoZWxlbXMubGVuZ3RoID09PSAxICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3RvcihlbGVtLCBleHByKSA/IFtlbGVtXSA6IFtdOwogICAgfQogICAgcmV0dXJuIGpRdWVyeS5maW5kLm1hdGNoZXMoZXhwciwgalF1ZXJ5LmdyZXAoZWxlbXMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBlbGVtLm5vZGVUeXBlID09PSAxOwogICAgfSkpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBmaW5kOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGksCiAgICAgICAgcmV0LAogICAgICAgIGxlbiA9IHRoaXMubGVuZ3RoLAogICAgICAgIHNlbGYgPSB0aGlzOwogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIikgewogICAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayhqUXVlcnkoc2VsZWN0b3IpLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyhzZWxmW2ldLCB0aGlzKSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSkpOwogICAgICB9CiAgICAgIHJldCA9IHRoaXMucHVzaFN0YWNrKFtdKTsKICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgalF1ZXJ5LmZpbmQoc2VsZWN0b3IsIHNlbGZbaV0sIHJldCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlbiA+IDEgPyBqUXVlcnkudW5pcXVlU29ydChyZXQpIDogcmV0OwogICAgfSwKICAgIGZpbHRlcjogZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiB0aGlzLnB1c2hTdGFjayh3aW5ub3codGhpcywgc2VsZWN0b3IgfHwgW10sIGZhbHNlKSk7CiAgICB9LAogICAgbm90OiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHdpbm5vdyh0aGlzLCBzZWxlY3RvciB8fCBbXSwgdHJ1ZSkpOwogICAgfSwKICAgIGlzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgcmV0dXJuICEhd2lubm93KHRoaXMsCiAgICAgIC8vIElmIHRoaXMgaXMgYSBwb3NpdGlvbmFsL3JlbGF0aXZlIHNlbGVjdG9yLCBjaGVjayBtZW1iZXJzaGlwIGluIHRoZSByZXR1cm5lZCBzZXQKICAgICAgLy8gc28gJCgicDpmaXJzdCIpLmlzKCJwOmxhc3QiKSB3b24ndCByZXR1cm4gdHJ1ZSBmb3IgYSBkb2Mgd2l0aCB0d28gInAiLgogICAgICB0eXBlb2Ygc2VsZWN0b3IgPT09ICJzdHJpbmciICYmIHJuZWVkc0NvbnRleHQudGVzdChzZWxlY3RvcikgPyBqUXVlcnkoc2VsZWN0b3IpIDogc2VsZWN0b3IgfHwgW10sIGZhbHNlKS5sZW5ndGg7CiAgICB9CiAgfSk7CgogIC8vIEluaXRpYWxpemUgYSBqUXVlcnkgb2JqZWN0CgogIC8vIEEgY2VudHJhbCByZWZlcmVuY2UgdG8gdGhlIHJvb3QgalF1ZXJ5KGRvY3VtZW50KQogIHZhciByb290alF1ZXJ5LAogICAgLy8gQSBzaW1wbGUgd2F5IHRvIGNoZWNrIGZvciBIVE1MIHN0cmluZ3MKICAgIC8vIFByaW9yaXRpemUgI2lkIG92ZXIgPHRhZz4gdG8gYXZvaWQgWFNTIHZpYSBsb2NhdGlvbi5oYXNoICh0cmFjLTk1MjEpCiAgICAvLyBTdHJpY3QgSFRNTCByZWNvZ25pdGlvbiAodHJhYy0xMTI5MDogbXVzdCBzdGFydCB3aXRoIDwpCiAgICAvLyBTaG9ydGN1dCBzaW1wbGUgI2lkIGNhc2UgZm9yIHNwZWVkCiAgICBycXVpY2tFeHByID0gL14oPzpccyooPFtcd1xXXSs+KVtePl0qfCMoW1x3LV0rKSkkLywKICAgIGluaXQgPSBqUXVlcnkuZm4uaW5pdCA9IGZ1bmN0aW9uIChzZWxlY3RvciwgY29udGV4dCwgcm9vdCkgewogICAgICB2YXIgbWF0Y2gsIGVsZW07CgogICAgICAvLyBIQU5ETEU6ICQoIiIpLCAkKG51bGwpLCAkKHVuZGVmaW5lZCksICQoZmFsc2UpCiAgICAgIGlmICghc2VsZWN0b3IpIHsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgfQoKICAgICAgLy8gTWV0aG9kIGluaXQoKSBhY2NlcHRzIGFuIGFsdGVybmF0ZSByb290alF1ZXJ5CiAgICAgIC8vIHNvIG1pZ3JhdGUgY2FuIHN1cHBvcnQgalF1ZXJ5LnN1YiAoZ2gtMjEwMSkKICAgICAgcm9vdCA9IHJvb3QgfHwgcm9vdGpRdWVyeTsKCiAgICAgIC8vIEhhbmRsZSBIVE1MIHN0cmluZ3MKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICBpZiAoc2VsZWN0b3JbMF0gPT09ICI8IiAmJiBzZWxlY3RvcltzZWxlY3Rvci5sZW5ndGggLSAxXSA9PT0gIj4iICYmIHNlbGVjdG9yLmxlbmd0aCA+PSAzKSB7CiAgICAgICAgICAvLyBBc3N1bWUgdGhhdCBzdHJpbmdzIHRoYXQgc3RhcnQgYW5kIGVuZCB3aXRoIDw+IGFyZSBIVE1MIGFuZCBza2lwIHRoZSByZWdleCBjaGVjawogICAgICAgICAgbWF0Y2ggPSBbbnVsbCwgc2VsZWN0b3IsIG51bGxdOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtYXRjaCA9IHJxdWlja0V4cHIuZXhlYyhzZWxlY3Rvcik7CiAgICAgICAgfQoKICAgICAgICAvLyBNYXRjaCBodG1sIG9yIG1ha2Ugc3VyZSBubyBjb250ZXh0IGlzIHNwZWNpZmllZCBmb3IgI2lkCiAgICAgICAgaWYgKG1hdGNoICYmIChtYXRjaFsxXSB8fCAhY29udGV4dCkpIHsKICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sKSAtPiAkKGFycmF5KQogICAgICAgICAgaWYgKG1hdGNoWzFdKSB7CiAgICAgICAgICAgIGNvbnRleHQgPSBjb250ZXh0IGluc3RhbmNlb2YgalF1ZXJ5ID8gY29udGV4dFswXSA6IGNvbnRleHQ7CgogICAgICAgICAgICAvLyBPcHRpb24gdG8gcnVuIHNjcmlwdHMgaXMgdHJ1ZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgICAgLy8gSW50ZW50aW9uYWxseSBsZXQgdGhlIGVycm9yIGJlIHRocm93biBpZiBwYXJzZUhUTUwgaXMgbm90IHByZXNlbnQKICAgICAgICAgICAgalF1ZXJ5Lm1lcmdlKHRoaXMsIGpRdWVyeS5wYXJzZUhUTUwobWF0Y2hbMV0sIGNvbnRleHQgJiYgY29udGV4dC5ub2RlVHlwZSA/IGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0IDogZG9jdW1lbnQsIHRydWUpKTsKCiAgICAgICAgICAgIC8vIEhBTkRMRTogJChodG1sLCBwcm9wcykKICAgICAgICAgICAgaWYgKHJzaW5nbGVUYWcudGVzdChtYXRjaFsxXSkgJiYgalF1ZXJ5LmlzUGxhaW5PYmplY3QoY29udGV4dCkpIHsKICAgICAgICAgICAgICBmb3IgKG1hdGNoIGluIGNvbnRleHQpIHsKICAgICAgICAgICAgICAgIC8vIFByb3BlcnRpZXMgb2YgY29udGV4dCBhcmUgY2FsbGVkIGFzIG1ldGhvZHMgaWYgcG9zc2libGUKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoaXNbbWF0Y2hdKSkgewogICAgICAgICAgICAgICAgICB0aGlzW21hdGNoXShjb250ZXh0W21hdGNoXSk7CgogICAgICAgICAgICAgICAgICAvLyAuLi5hbmQgb3RoZXJ3aXNlIHNldCBhcyBhdHRyaWJ1dGVzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICB0aGlzLmF0dHIobWF0Y2gsIGNvbnRleHRbbWF0Y2hdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgICAgICAgICAvLyBIQU5ETEU6ICQoI2lkKQogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKG1hdGNoWzJdKTsKICAgICAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgICAgICAvLyBJbmplY3QgdGhlIGVsZW1lbnQgZGlyZWN0bHkgaW50byB0aGUgalF1ZXJ5IG9iamVjdAogICAgICAgICAgICAgIHRoaXNbMF0gPSBlbGVtOwogICAgICAgICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBIQU5ETEU6ICQoZXhwciwgJCguLi4pKQogICAgICAgIH0gZWxzZSBpZiAoIWNvbnRleHQgfHwgY29udGV4dC5qcXVlcnkpIHsKICAgICAgICAgIHJldHVybiAoY29udGV4dCB8fCByb290KS5maW5kKHNlbGVjdG9yKTsKCiAgICAgICAgICAvLyBIQU5ETEU6ICQoZXhwciwgY29udGV4dCkKICAgICAgICAgIC8vICh3aGljaCBpcyBqdXN0IGVxdWl2YWxlbnQgdG86ICQoY29udGV4dCkuZmluZChleHByKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3Rvcihjb250ZXh0KS5maW5kKHNlbGVjdG9yKTsKICAgICAgICB9CgogICAgICAgIC8vIEhBTkRMRTogJChET01FbGVtZW50KQogICAgICB9IGVsc2UgaWYgKHNlbGVjdG9yLm5vZGVUeXBlKSB7CiAgICAgICAgdGhpc1swXSA9IHNlbGVjdG9yOwogICAgICAgIHRoaXMubGVuZ3RoID0gMTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICAgICAgLy8gSEFORExFOiAkKGZ1bmN0aW9uKQogICAgICAgIC8vIFNob3J0Y3V0IGZvciBkb2N1bWVudCByZWFkeQogICAgICB9IGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSB7CiAgICAgICAgcmV0dXJuIHJvb3QucmVhZHkgIT09IHVuZGVmaW5lZCA/IHJvb3QucmVhZHkoc2VsZWN0b3IpIDoKICAgICAgICAvLyBFeGVjdXRlIGltbWVkaWF0ZWx5IGlmIHJlYWR5IGlzIG5vdCBwcmVzZW50CiAgICAgICAgc2VsZWN0b3IoalF1ZXJ5KTsKICAgICAgfQogICAgICByZXR1cm4galF1ZXJ5Lm1ha2VBcnJheShzZWxlY3RvciwgdGhpcyk7CiAgICB9OwoKICAvLyBHaXZlIHRoZSBpbml0IGZ1bmN0aW9uIHRoZSBqUXVlcnkgcHJvdG90eXBlIGZvciBsYXRlciBpbnN0YW50aWF0aW9uCiAgaW5pdC5wcm90b3R5cGUgPSBqUXVlcnkuZm47CgogIC8vIEluaXRpYWxpemUgY2VudHJhbCByZWZlcmVuY2UKICByb290alF1ZXJ5ID0galF1ZXJ5KGRvY3VtZW50KTsKICB2YXIgcnBhcmVudHNwcmV2ID0gL14oPzpwYXJlbnRzfHByZXYoPzpVbnRpbHxBbGwpKS8sCiAgICAvLyBNZXRob2RzIGd1YXJhbnRlZWQgdG8gcHJvZHVjZSBhIHVuaXF1ZSBzZXQgd2hlbiBzdGFydGluZyBmcm9tIGEgdW5pcXVlIHNldAogICAgZ3VhcmFudGVlZFVuaXF1ZSA9IHsKICAgICAgY2hpbGRyZW46IHRydWUsCiAgICAgIGNvbnRlbnRzOiB0cnVlLAogICAgICBuZXh0OiB0cnVlLAogICAgICBwcmV2OiB0cnVlCiAgICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgaGFzOiBmdW5jdGlvbiAodGFyZ2V0KSB7CiAgICAgIHZhciB0YXJnZXRzID0galF1ZXJ5KHRhcmdldCwgdGhpcyksCiAgICAgICAgbCA9IHRhcmdldHMubGVuZ3RoOwogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBpID0gMDsKICAgICAgICBmb3IgKDsgaSA8IGw7IGkrKykgewogICAgICAgICAgaWYgKGpRdWVyeS5jb250YWlucyh0aGlzLCB0YXJnZXRzW2ldKSkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGNsb3Nlc3Q6IGZ1bmN0aW9uIChzZWxlY3RvcnMsIGNvbnRleHQpIHsKICAgICAgdmFyIGN1ciwKICAgICAgICBpID0gMCwKICAgICAgICBsID0gdGhpcy5sZW5ndGgsCiAgICAgICAgbWF0Y2hlZCA9IFtdLAogICAgICAgIHRhcmdldHMgPSB0eXBlb2Ygc2VsZWN0b3JzICE9PSAic3RyaW5nIiAmJiBqUXVlcnkoc2VsZWN0b3JzKTsKCiAgICAgIC8vIFBvc2l0aW9uYWwgc2VsZWN0b3JzIG5ldmVyIG1hdGNoLCBzaW5jZSB0aGVyZSdzIG5vIF9zZWxlY3Rpb25fIGNvbnRleHQKICAgICAgaWYgKCFybmVlZHNDb250ZXh0LnRlc3Qoc2VsZWN0b3JzKSkgewogICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICBmb3IgKGN1ciA9IHRoaXNbaV07IGN1ciAmJiBjdXIgIT09IGNvbnRleHQ7IGN1ciA9IGN1ci5wYXJlbnROb2RlKSB7CiAgICAgICAgICAgIC8vIEFsd2F5cyBza2lwIGRvY3VtZW50IGZyYWdtZW50cwogICAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlIDwgMTEgJiYgKHRhcmdldHMgPyB0YXJnZXRzLmluZGV4KGN1cikgPiAtMSA6CiAgICAgICAgICAgIC8vIERvbid0IHBhc3Mgbm9uLWVsZW1lbnRzIHRvIFNpenpsZQogICAgICAgICAgICBjdXIubm9kZVR5cGUgPT09IDEgJiYgalF1ZXJ5LmZpbmQubWF0Y2hlc1NlbGVjdG9yKGN1ciwgc2VsZWN0b3JzKSkpIHsKICAgICAgICAgICAgICBtYXRjaGVkLnB1c2goY3VyKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGhpcy5wdXNoU3RhY2sobWF0Y2hlZC5sZW5ndGggPiAxID8galF1ZXJ5LnVuaXF1ZVNvcnQobWF0Y2hlZCkgOiBtYXRjaGVkKTsKICAgIH0sCiAgICAvLyBEZXRlcm1pbmUgdGhlIHBvc2l0aW9uIG9mIGFuIGVsZW1lbnQgd2l0aGluIHRoZSBzZXQKICAgIGluZGV4OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAvLyBObyBhcmd1bWVudCwgcmV0dXJuIGluZGV4IGluIHBhcmVudAogICAgICBpZiAoIWVsZW0pIHsKICAgICAgICByZXR1cm4gdGhpc1swXSAmJiB0aGlzWzBdLnBhcmVudE5vZGUgPyB0aGlzLmZpcnN0KCkucHJldkFsbCgpLmxlbmd0aCA6IC0xOwogICAgICB9CgogICAgICAvLyBJbmRleCBpbiBzZWxlY3RvcgogICAgICBpZiAodHlwZW9mIGVsZW0gPT09ICJzdHJpbmciKSB7CiAgICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbChqUXVlcnkoZWxlbSksIHRoaXNbMF0pOwogICAgICB9CgogICAgICAvLyBMb2NhdGUgdGhlIHBvc2l0aW9uIG9mIHRoZSBkZXNpcmVkIGVsZW1lbnQKICAgICAgcmV0dXJuIGluZGV4T2YuY2FsbCh0aGlzLAogICAgICAvLyBJZiBpdCByZWNlaXZlcyBhIGpRdWVyeSBvYmplY3QsIHRoZSBmaXJzdCBlbGVtZW50IGlzIHVzZWQKICAgICAgZWxlbS5qcXVlcnkgPyBlbGVtWzBdIDogZWxlbSk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiAoc2VsZWN0b3IsIGNvbnRleHQpIHsKICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKGpRdWVyeS51bmlxdWVTb3J0KGpRdWVyeS5tZXJnZSh0aGlzLmdldCgpLCBqUXVlcnkoc2VsZWN0b3IsIGNvbnRleHQpKSkpOwogICAgfSwKICAgIGFkZEJhY2s6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy5hZGQoc2VsZWN0b3IgPT0gbnVsbCA/IHRoaXMucHJldk9iamVjdCA6IHRoaXMucHJldk9iamVjdC5maWx0ZXIoc2VsZWN0b3IpKTsKICAgIH0KICB9KTsKICBmdW5jdGlvbiBzaWJsaW5nKGN1ciwgZGlyKSB7CiAgICB3aGlsZSAoKGN1ciA9IGN1cltkaXJdKSAmJiBjdXIubm9kZVR5cGUgIT09IDEpIHt9CiAgICByZXR1cm4gY3VyOwogIH0KICBqUXVlcnkuZWFjaCh7CiAgICBwYXJlbnQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHZhciBwYXJlbnQgPSBlbGVtLnBhcmVudE5vZGU7CiAgICAgIHJldHVybiBwYXJlbnQgJiYgcGFyZW50Lm5vZGVUeXBlICE9PSAxMSA/IHBhcmVudCA6IG51bGw7CiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgcmV0dXJuIGRpcihlbGVtLCAicGFyZW50Tm9kZSIpOwogICAgfSwKICAgIHBhcmVudHNVbnRpbDogZnVuY3Rpb24gKGVsZW0sIF9pLCB1bnRpbCkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJwYXJlbnROb2RlIiwgdW50aWwpOwogICAgfSwKICAgIG5leHQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5nKGVsZW0sICJwcmV2aW91c1NpYmxpbmciKTsKICAgIH0sCiAgICBuZXh0QWxsOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJuZXh0U2libGluZyIpOwogICAgfSwKICAgIHByZXZBbGw6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBkaXIoZWxlbSwgInByZXZpb3VzU2libGluZyIpOwogICAgfSwKICAgIG5leHRVbnRpbDogZnVuY3Rpb24gKGVsZW0sIF9pLCB1bnRpbCkgewogICAgICByZXR1cm4gZGlyKGVsZW0sICJuZXh0U2libGluZyIsIHVudGlsKTsKICAgIH0sCiAgICBwcmV2VW50aWw6IGZ1bmN0aW9uIChlbGVtLCBfaSwgdW50aWwpIHsKICAgICAgcmV0dXJuIGRpcihlbGVtLCAicHJldmlvdXNTaWJsaW5nIiwgdW50aWwpOwogICAgfSwKICAgIHNpYmxpbmdzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gc2libGluZ3MoKGVsZW0ucGFyZW50Tm9kZSB8fCB7fSkuZmlyc3RDaGlsZCwgZWxlbSk7CiAgICB9LAogICAgY2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBzaWJsaW5ncyhlbGVtLmZpcnN0Q2hpbGQpOwogICAgfSwKICAgIGNvbnRlbnRzOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICBpZiAoZWxlbS5jb250ZW50RG9jdW1lbnQgIT0gbnVsbCAmJgogICAgICAvLyBTdXBwb3J0OiBJRSAxMSsKICAgICAgLy8gPG9iamVjdD4gZWxlbWVudHMgd2l0aCBubyBgZGF0YWAgYXR0cmlidXRlIGhhcyBhbiBvYmplY3QKICAgICAgLy8gYGNvbnRlbnREb2N1bWVudGAgd2l0aCBhIGBudWxsYCBwcm90b3R5cGUuCiAgICAgIGdldFByb3RvKGVsZW0uY29udGVudERvY3VtZW50KSkgewogICAgICAgIHJldHVybiBlbGVtLmNvbnRlbnREb2N1bWVudDsKICAgICAgfQoKICAgICAgLy8gU3VwcG9ydDogSUUgOSAtIDExIG9ubHksIGlPUyA3IG9ubHksIEFuZHJvaWQgQnJvd3NlciA8PTQuMyBvbmx5CiAgICAgIC8vIFRyZWF0IHRoZSB0ZW1wbGF0ZSBlbGVtZW50IGFzIGEgcmVndWxhciBvbmUgaW4gYnJvd3NlcnMgdGhhdAogICAgICAvLyBkb24ndCBzdXBwb3J0IGl0LgogICAgICBpZiAobm9kZU5hbWUoZWxlbSwgInRlbXBsYXRlIikpIHsKICAgICAgICBlbGVtID0gZWxlbS5jb250ZW50IHx8IGVsZW07CiAgICAgIH0KICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbXSwgZWxlbS5jaGlsZE5vZGVzKTsKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgZm4pIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uICh1bnRpbCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIG1hdGNoZWQgPSBqUXVlcnkubWFwKHRoaXMsIGZuLCB1bnRpbCk7CiAgICAgIGlmIChuYW1lLnNsaWNlKC01KSAhPT0gIlVudGlsIikgewogICAgICAgIHNlbGVjdG9yID0gdW50aWw7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yICYmIHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICBtYXRjaGVkID0galF1ZXJ5LmZpbHRlcihzZWxlY3RvciwgbWF0Y2hlZCk7CiAgICAgIH0KICAgICAgaWYgKHRoaXMubGVuZ3RoID4gMSkgewogICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzCiAgICAgICAgaWYgKCFndWFyYW50ZWVkVW5pcXVlW25hbWVdKSB7CiAgICAgICAgICBqUXVlcnkudW5pcXVlU29ydChtYXRjaGVkKTsKICAgICAgICB9CgogICAgICAgIC8vIFJldmVyc2Ugb3JkZXIgZm9yIHBhcmVudHMqIGFuZCBwcmV2LWRlcml2YXRpdmVzCiAgICAgICAgaWYgKHJwYXJlbnRzcHJldi50ZXN0KG5hbWUpKSB7CiAgICAgICAgICBtYXRjaGVkLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKG1hdGNoZWQpOwogICAgfTsKICB9KTsKICB2YXIgcm5vdGh0bWx3aGl0ZSA9IC9bXlx4MjBcdFxyXG5cZl0rL2c7CgogIC8vIENvbnZlcnQgU3RyaW5nLWZvcm1hdHRlZCBvcHRpb25zIGludG8gT2JqZWN0LWZvcm1hdHRlZCBvbmVzCiAgZnVuY3Rpb24gY3JlYXRlT3B0aW9ucyhvcHRpb25zKSB7CiAgICB2YXIgb2JqZWN0ID0ge307CiAgICBqUXVlcnkuZWFjaChvcHRpb25zLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdLCBmdW5jdGlvbiAoXywgZmxhZykgewogICAgICBvYmplY3RbZmxhZ10gPSB0cnVlOwogICAgfSk7CiAgICByZXR1cm4gb2JqZWN0OwogIH0KCiAgLyoKICAgKiBDcmVhdGUgYSBjYWxsYmFjayBsaXN0IHVzaW5nIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVyczoKICAgKgogICAqCW9wdGlvbnM6IGFuIG9wdGlvbmFsIGxpc3Qgb2Ygc3BhY2Utc2VwYXJhdGVkIG9wdGlvbnMgdGhhdCB3aWxsIGNoYW5nZSBob3cKICAgKgkJCXRoZSBjYWxsYmFjayBsaXN0IGJlaGF2ZXMgb3IgYSBtb3JlIHRyYWRpdGlvbmFsIG9wdGlvbiBvYmplY3QKICAgKgogICAqIEJ5IGRlZmF1bHQgYSBjYWxsYmFjayBsaXN0IHdpbGwgYWN0IGxpa2UgYW4gZXZlbnQgY2FsbGJhY2sgbGlzdCBhbmQgY2FuIGJlCiAgICogImZpcmVkIiBtdWx0aXBsZSB0aW1lcy4KICAgKgogICAqIFBvc3NpYmxlIG9wdGlvbnM6CiAgICoKICAgKglvbmNlOgkJCXdpbGwgZW5zdXJlIHRoZSBjYWxsYmFjayBsaXN0IGNhbiBvbmx5IGJlIGZpcmVkIG9uY2UgKGxpa2UgYSBEZWZlcnJlZCkKICAgKgogICAqCW1lbW9yeToJCQl3aWxsIGtlZXAgdHJhY2sgb2YgcHJldmlvdXMgdmFsdWVzIGFuZCB3aWxsIGNhbGwgYW55IGNhbGxiYWNrIGFkZGVkCiAgICoJCQkJCWFmdGVyIHRoZSBsaXN0IGhhcyBiZWVuIGZpcmVkIHJpZ2h0IGF3YXkgd2l0aCB0aGUgbGF0ZXN0ICJtZW1vcml6ZWQiCiAgICoJCQkJCXZhbHVlcyAobGlrZSBhIERlZmVycmVkKQogICAqCiAgICoJdW5pcXVlOgkJCXdpbGwgZW5zdXJlIGEgY2FsbGJhY2sgY2FuIG9ubHkgYmUgYWRkZWQgb25jZSAobm8gZHVwbGljYXRlIGluIHRoZSBsaXN0KQogICAqCiAgICoJc3RvcE9uRmFsc2U6CWludGVycnVwdCBjYWxsaW5ncyB3aGVuIGEgY2FsbGJhY2sgcmV0dXJucyBmYWxzZQogICAqCiAgICovCiAgalF1ZXJ5LkNhbGxiYWNrcyA9IGZ1bmN0aW9uIChvcHRpb25zKSB7CiAgICAvLyBDb252ZXJ0IG9wdGlvbnMgZnJvbSBTdHJpbmctZm9ybWF0dGVkIHRvIE9iamVjdC1mb3JtYXR0ZWQgaWYgbmVlZGVkCiAgICAvLyAod2UgY2hlY2sgaW4gY2FjaGUgZmlyc3QpCiAgICBvcHRpb25zID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciID8gY3JlYXRlT3B0aW9ucyhvcHRpb25zKSA6IGpRdWVyeS5leHRlbmQoe30sIG9wdGlvbnMpOwogICAgdmFyCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IGlzIGN1cnJlbnRseSBmaXJpbmcKICAgICAgZmlyaW5nLAogICAgICAvLyBMYXN0IGZpcmUgdmFsdWUgZm9yIG5vbi1mb3JnZXR0YWJsZSBsaXN0cwogICAgICBtZW1vcnksCiAgICAgIC8vIEZsYWcgdG8ga25vdyBpZiBsaXN0IHdhcyBhbHJlYWR5IGZpcmVkCiAgICAgIGZpcmVkLAogICAgICAvLyBGbGFnIHRvIHByZXZlbnQgZmlyaW5nCiAgICAgIGxvY2tlZCwKICAgICAgLy8gQWN0dWFsIGNhbGxiYWNrIGxpc3QKICAgICAgbGlzdCA9IFtdLAogICAgICAvLyBRdWV1ZSBvZiBleGVjdXRpb24gZGF0YSBmb3IgcmVwZWF0YWJsZSBsaXN0cwogICAgICBxdWV1ZSA9IFtdLAogICAgICAvLyBJbmRleCBvZiBjdXJyZW50bHkgZmlyaW5nIGNhbGxiYWNrIChtb2RpZmllZCBieSBhZGQvcmVtb3ZlIGFzIG5lZWRlZCkKICAgICAgZmlyaW5nSW5kZXggPSAtMSwKICAgICAgLy8gRmlyZSBjYWxsYmFja3MKICAgICAgZmlyZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBFbmZvcmNlIHNpbmdsZS1maXJpbmcKICAgICAgICBsb2NrZWQgPSBsb2NrZWQgfHwgb3B0aW9ucy5vbmNlOwoKICAgICAgICAvLyBFeGVjdXRlIGNhbGxiYWNrcyBmb3IgYWxsIHBlbmRpbmcgZXhlY3V0aW9ucywKICAgICAgICAvLyByZXNwZWN0aW5nIGZpcmluZ0luZGV4IG92ZXJyaWRlcyBhbmQgcnVudGltZSBjaGFuZ2VzCiAgICAgICAgZmlyZWQgPSBmaXJpbmcgPSB0cnVlOwogICAgICAgIGZvciAoOyBxdWV1ZS5sZW5ndGg7IGZpcmluZ0luZGV4ID0gLTEpIHsKICAgICAgICAgIG1lbW9yeSA9IHF1ZXVlLnNoaWZ0KCk7CiAgICAgICAgICB3aGlsZSAoKytmaXJpbmdJbmRleCA8IGxpc3QubGVuZ3RoKSB7CiAgICAgICAgICAgIC8vIFJ1biBjYWxsYmFjayBhbmQgY2hlY2sgZm9yIGVhcmx5IHRlcm1pbmF0aW9uCiAgICAgICAgICAgIGlmIChsaXN0W2ZpcmluZ0luZGV4XS5hcHBseShtZW1vcnlbMF0sIG1lbW9yeVsxXSkgPT09IGZhbHNlICYmIG9wdGlvbnMuc3RvcE9uRmFsc2UpIHsKICAgICAgICAgICAgICAvLyBKdW1wIHRvIGVuZCBhbmQgZm9yZ2V0IHRoZSBkYXRhIHNvIC5hZGQgZG9lc24ndCByZS1maXJlCiAgICAgICAgICAgICAgZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aDsKICAgICAgICAgICAgICBtZW1vcnkgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gRm9yZ2V0IHRoZSBkYXRhIGlmIHdlJ3JlIGRvbmUgd2l0aCBpdAogICAgICAgIGlmICghb3B0aW9ucy5tZW1vcnkpIHsKICAgICAgICAgIG1lbW9yeSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBmaXJpbmcgPSBmYWxzZTsKCiAgICAgICAgLy8gQ2xlYW4gdXAgaWYgd2UncmUgZG9uZSBmaXJpbmcgZm9yIGdvb2QKICAgICAgICBpZiAobG9ja2VkKSB7CiAgICAgICAgICAvLyBLZWVwIGFuIGVtcHR5IGxpc3QgaWYgd2UgaGF2ZSBkYXRhIGZvciBmdXR1cmUgYWRkIGNhbGxzCiAgICAgICAgICBpZiAobWVtb3J5KSB7CiAgICAgICAgICAgIGxpc3QgPSBbXTsKCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgdGhpcyBvYmplY3QgaXMgc3BlbnQKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGxpc3QgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sCiAgICAgIC8vIEFjdHVhbCBDYWxsYmFja3Mgb2JqZWN0CiAgICAgIHNlbGYgPSB7CiAgICAgICAgLy8gQWRkIGEgY2FsbGJhY2sgb3IgYSBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrcyB0byB0aGUgbGlzdAogICAgICAgIGFkZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKGxpc3QpIHsKICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBtZW1vcnkgZnJvbSBhIHBhc3QgcnVuLCB3ZSBzaG91bGQgZmlyZSBhZnRlciBhZGRpbmcKICAgICAgICAgICAgaWYgKG1lbW9yeSAmJiAhZmlyaW5nKSB7CiAgICAgICAgICAgICAgZmlyaW5nSW5kZXggPSBsaXN0Lmxlbmd0aCAtIDE7CiAgICAgICAgICAgICAgcXVldWUucHVzaChtZW1vcnkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIChmdW5jdGlvbiBhZGQoYXJncykgewogICAgICAgICAgICAgIGpRdWVyeS5lYWNoKGFyZ3MsIGZ1bmN0aW9uIChfLCBhcmcpIHsKICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKGFyZykpIHsKICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLnVuaXF1ZSB8fCAhc2VsZi5oYXMoYXJnKSkgewogICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChhcmcpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFyZyAmJiBhcmcubGVuZ3RoICYmIHRvVHlwZShhcmcpICE9PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAvLyBJbnNwZWN0IHJlY3Vyc2l2ZWx5CiAgICAgICAgICAgICAgICAgIGFkZChhcmcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KShhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAobWVtb3J5ICYmICFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gUmVtb3ZlIGEgY2FsbGJhY2sgZnJvbSB0aGUgbGlzdAogICAgICAgIHJlbW92ZTogZnVuY3Rpb24gKCkgewogICAgICAgICAgalF1ZXJ5LmVhY2goYXJndW1lbnRzLCBmdW5jdGlvbiAoXywgYXJnKSB7CiAgICAgICAgICAgIHZhciBpbmRleDsKICAgICAgICAgICAgd2hpbGUgKChpbmRleCA9IGpRdWVyeS5pbkFycmF5KGFyZywgbGlzdCwgaW5kZXgpKSA+IC0xKSB7CiAgICAgICAgICAgICAgbGlzdC5zcGxpY2UoaW5kZXgsIDEpOwoKICAgICAgICAgICAgICAvLyBIYW5kbGUgZmlyaW5nIGluZGV4ZXMKICAgICAgICAgICAgICBpZiAoaW5kZXggPD0gZmlyaW5nSW5kZXgpIHsKICAgICAgICAgICAgICAgIGZpcmluZ0luZGV4LS07CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2hlY2sgaWYgYSBnaXZlbiBjYWxsYmFjayBpcyBpbiB0aGUgbGlzdC4KICAgICAgICAvLyBJZiBubyBhcmd1bWVudCBpcyBnaXZlbiwgcmV0dXJuIHdoZXRoZXIgb3Igbm90IGxpc3QgaGFzIGNhbGxiYWNrcyBhdHRhY2hlZC4KICAgICAgICBoYXM6IGZ1bmN0aW9uIChmbikgewogICAgICAgICAgcmV0dXJuIGZuID8galF1ZXJ5LmluQXJyYXkoZm4sIGxpc3QpID4gLTEgOiBsaXN0Lmxlbmd0aCA+IDA7CiAgICAgICAgfSwKICAgICAgICAvLyBSZW1vdmUgYWxsIGNhbGxiYWNrcyBmcm9tIHRoZSBsaXN0CiAgICAgICAgZW1wdHk6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChsaXN0KSB7CiAgICAgICAgICAgIGxpc3QgPSBbXTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gRGlzYWJsZSAuZmlyZSBhbmQgLmFkZAogICAgICAgIC8vIEFib3J0IGFueSBjdXJyZW50L3BlbmRpbmcgZXhlY3V0aW9ucwogICAgICAgIC8vIENsZWFyIGFsbCBjYWxsYmFja3MgYW5kIHZhbHVlcwogICAgICAgIGRpc2FibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGxvY2tlZCA9IHF1ZXVlID0gW107CiAgICAgICAgICBsaXN0ID0gbWVtb3J5ID0gIiI7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIGRpc2FibGVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gIWxpc3Q7CiAgICAgICAgfSwKICAgICAgICAvLyBEaXNhYmxlIC5maXJlCiAgICAgICAgLy8gQWxzbyBkaXNhYmxlIC5hZGQgdW5sZXNzIHdlIGhhdmUgbWVtb3J5IChzaW5jZSBpdCB3b3VsZCBoYXZlIG5vIGVmZmVjdCkKICAgICAgICAvLyBBYm9ydCBhbnkgcGVuZGluZyBleGVjdXRpb25zCiAgICAgICAgbG9jazogZnVuY3Rpb24gKCkgewogICAgICAgICAgbG9ja2VkID0gcXVldWUgPSBbXTsKICAgICAgICAgIGlmICghbWVtb3J5ICYmICFmaXJpbmcpIHsKICAgICAgICAgICAgbGlzdCA9IG1lbW9yeSA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfSwKICAgICAgICBsb2NrZWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHJldHVybiAhIWxvY2tlZDsKICAgICAgICB9LAogICAgICAgIC8vIENhbGwgYWxsIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBjb250ZXh0IGFuZCBhcmd1bWVudHMKICAgICAgICBmaXJlV2l0aDogZnVuY3Rpb24gKGNvbnRleHQsIGFyZ3MpIHsKICAgICAgICAgIGlmICghbG9ja2VkKSB7CiAgICAgICAgICAgIGFyZ3MgPSBhcmdzIHx8IFtdOwogICAgICAgICAgICBhcmdzID0gW2NvbnRleHQsIGFyZ3Muc2xpY2UgPyBhcmdzLnNsaWNlKCkgOiBhcmdzXTsKICAgICAgICAgICAgcXVldWUucHVzaChhcmdzKTsKICAgICAgICAgICAgaWYgKCFmaXJpbmcpIHsKICAgICAgICAgICAgICBmaXJlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0sCiAgICAgICAgLy8gQ2FsbCBhbGwgdGhlIGNhbGxiYWNrcyB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMKICAgICAgICBmaXJlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBzZWxmLmZpcmVXaXRoKHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9LAogICAgICAgIC8vIFRvIGtub3cgaWYgdGhlIGNhbGxiYWNrcyBoYXZlIGFscmVhZHkgYmVlbiBjYWxsZWQgYXQgbGVhc3Qgb25jZQogICAgICAgIGZpcmVkOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gISFmaXJlZDsKICAgICAgICB9CiAgICAgIH07CiAgICByZXR1cm4gc2VsZjsKICB9OwogIGZ1bmN0aW9uIElkZW50aXR5KHYpIHsKICAgIHJldHVybiB2OwogIH0KICBmdW5jdGlvbiBUaHJvd2VyKGV4KSB7CiAgICB0aHJvdyBleDsKICB9CiAgZnVuY3Rpb24gYWRvcHRWYWx1ZSh2YWx1ZSwgcmVzb2x2ZSwgcmVqZWN0LCBub1ZhbHVlKSB7CiAgICB2YXIgbWV0aG9kOwogICAgdHJ5IHsKICAgICAgLy8gQ2hlY2sgZm9yIHByb21pc2UgYXNwZWN0IGZpcnN0IHRvIHByaXZpbGVnZSBzeW5jaHJvbm91cyBiZWhhdmlvcgogICAgICBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbihtZXRob2QgPSB2YWx1ZS5wcm9taXNlKSkgewogICAgICAgIG1ldGhvZC5jYWxsKHZhbHVlKS5kb25lKHJlc29sdmUpLmZhaWwocmVqZWN0KTsKCiAgICAgICAgLy8gT3RoZXIgdGhlbmFibGVzCiAgICAgIH0gZWxzZSBpZiAodmFsdWUgJiYgaXNGdW5jdGlvbihtZXRob2QgPSB2YWx1ZS50aGVuKSkgewogICAgICAgIG1ldGhvZC5jYWxsKHZhbHVlLCByZXNvbHZlLCByZWplY3QpOwoKICAgICAgICAvLyBPdGhlciBub24tdGhlbmFibGVzCiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gQ29udHJvbCBgcmVzb2x2ZWAgYXJndW1lbnRzIGJ5IGxldHRpbmcgQXJyYXkjc2xpY2UgY2FzdCBib29sZWFuIGBub1ZhbHVlYCB0byBpbnRlZ2VyOgogICAgICAgIC8vICogZmFsc2U6IFsgdmFsdWUgXS5zbGljZSggMCApID0+IHJlc29sdmUoIHZhbHVlICkKICAgICAgICAvLyAqIHRydWU6IFsgdmFsdWUgXS5zbGljZSggMSApID0+IHJlc29sdmUoKQogICAgICAgIHJlc29sdmUuYXBwbHkodW5kZWZpbmVkLCBbdmFsdWVdLnNsaWNlKG5vVmFsdWUpKTsKICAgICAgfQoKICAgICAgLy8gRm9yIFByb21pc2VzL0ErLCBjb252ZXJ0IGV4Y2VwdGlvbnMgaW50byByZWplY3Rpb25zCiAgICAgIC8vIFNpbmNlIGpRdWVyeS53aGVuIGRvZXNuJ3QgdW53cmFwIHRoZW5hYmxlcywgd2UgY2FuIHNraXAgdGhlIGV4dHJhIGNoZWNrcyBhcHBlYXJpbmcgaW4KICAgICAgLy8gRGVmZXJyZWQjdGhlbiB0byBjb25kaXRpb25hbGx5IHN1cHByZXNzIHJlamVjdGlvbi4KICAgIH0gY2F0Y2ggKHZhbHVlKSB7CiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIG9ubHkKICAgICAgLy8gU3RyaWN0IG1vZGUgZnVuY3Rpb25zIGludm9rZWQgd2l0aG91dCAuY2FsbC8uYXBwbHkgZ2V0IGdsb2JhbC1vYmplY3QgY29udGV4dAogICAgICByZWplY3QuYXBwbHkodW5kZWZpbmVkLCBbdmFsdWVdKTsKICAgIH0KICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBEZWZlcnJlZDogZnVuY3Rpb24gKGZ1bmMpIHsKICAgICAgdmFyIHR1cGxlcyA9IFsKICAgICAgICAvLyBhY3Rpb24sIGFkZCBsaXN0ZW5lciwgY2FsbGJhY2tzLAogICAgICAgIC8vIC4uLiAudGhlbiBoYW5kbGVycywgYXJndW1lbnQgaW5kZXgsIFtmaW5hbCBzdGF0ZV0KICAgICAgICBbIm5vdGlmeSIsICJwcm9ncmVzcyIsIGpRdWVyeS5DYWxsYmFja3MoIm1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJtZW1vcnkiKSwgMl0sIFsicmVzb2x2ZSIsICJkb25lIiwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKSwgMCwgInJlc29sdmVkIl0sIFsicmVqZWN0IiwgImZhaWwiLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCBqUXVlcnkuQ2FsbGJhY2tzKCJvbmNlIG1lbW9yeSIpLCAxLCAicmVqZWN0ZWQiXV0sCiAgICAgICAgc3RhdGUgPSAicGVuZGluZyIsCiAgICAgICAgcHJvbWlzZSA9IHsKICAgICAgICAgIHN0YXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIHJldHVybiBzdGF0ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBhbHdheXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgZGVmZXJyZWQuZG9uZShhcmd1bWVudHMpLmZhaWwoYXJndW1lbnRzKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9LAogICAgICAgICAgImNhdGNoIjogZnVuY3Rpb24gKGZuKSB7CiAgICAgICAgICAgIHJldHVybiBwcm9taXNlLnRoZW4obnVsbCwgZm4pOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEtlZXAgcGlwZSBmb3IgYmFjay1jb21wYXQKICAgICAgICAgIHBpcGU6IGZ1bmN0aW9uIC8qIGZuRG9uZSwgZm5GYWlsLCBmblByb2dyZXNzICovCiAgICAgICAgICAoKSB7CiAgICAgICAgICAgIHZhciBmbnMgPSBhcmd1bWVudHM7CiAgICAgICAgICAgIHJldHVybiBqUXVlcnkuRGVmZXJyZWQoZnVuY3Rpb24gKG5ld0RlZmVyKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmVhY2godHVwbGVzLCBmdW5jdGlvbiAoX2ksIHR1cGxlKSB7CiAgICAgICAgICAgICAgICAvLyBNYXAgdHVwbGVzIChwcm9ncmVzcywgZG9uZSwgZmFpbCkgdG8gYXJndW1lbnRzIChkb25lLCBmYWlsLCBwcm9ncmVzcykKICAgICAgICAgICAgICAgIHZhciBmbiA9IGlzRnVuY3Rpb24oZm5zW3R1cGxlWzRdXSkgJiYgZm5zW3R1cGxlWzRdXTsKCiAgICAgICAgICAgICAgICAvLyBkZWZlcnJlZC5wcm9ncmVzcyhmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5ub3RpZnkgfSkKICAgICAgICAgICAgICAgIC8vIGRlZmVycmVkLmRvbmUoZnVuY3Rpb24oKSB7IGJpbmQgdG8gbmV3RGVmZXIgb3IgbmV3RGVmZXIucmVzb2x2ZSB9KQogICAgICAgICAgICAgICAgLy8gZGVmZXJyZWQuZmFpbChmdW5jdGlvbigpIHsgYmluZCB0byBuZXdEZWZlciBvciBuZXdEZWZlci5yZWplY3QgfSkKICAgICAgICAgICAgICAgIGRlZmVycmVkW3R1cGxlWzFdXShmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCA9IGZuICYmIGZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIGlmIChyZXR1cm5lZCAmJiBpc0Z1bmN0aW9uKHJldHVybmVkLnByb21pc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuZWQucHJvbWlzZSgpLnByb2dyZXNzKG5ld0RlZmVyLm5vdGlmeSkuZG9uZShuZXdEZWZlci5yZXNvbHZlKS5mYWlsKG5ld0RlZmVyLnJlamVjdCk7CiAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbmV3RGVmZXJbdHVwbGVbMF0gKyAiV2l0aCJdKHRoaXMsIGZuID8gW3JldHVybmVkXSA6IGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIGZucyA9IG51bGw7CiAgICAgICAgICAgIH0pLnByb21pc2UoKTsKICAgICAgICAgIH0sCiAgICAgICAgICB0aGVuOiBmdW5jdGlvbiAob25GdWxmaWxsZWQsIG9uUmVqZWN0ZWQsIG9uUHJvZ3Jlc3MpIHsKICAgICAgICAgICAgdmFyIG1heERlcHRoID0gMDsKICAgICAgICAgICAgZnVuY3Rpb24gcmVzb2x2ZShkZXB0aCwgZGVmZXJyZWQsIGhhbmRsZXIsIHNwZWNpYWwpIHsKICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzLAogICAgICAgICAgICAgICAgICBhcmdzID0gYXJndW1lbnRzLAogICAgICAgICAgICAgICAgICBtaWdodFRocm93ID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXR1cm5lZCwgdGhlbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjMKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC01OQogICAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBkb3VibGUtcmVzb2x1dGlvbiBhdHRlbXB0cwogICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCA8IG1heERlcHRoKSB7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybmVkID0gaGFuZGxlci5hcHBseSh0aGF0LCBhcmdzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMQogICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTQ4CiAgICAgICAgICAgICAgICAgICAgaWYgKHJldHVybmVkID09PSBkZWZlcnJlZC5wcm9taXNlKCkpIHsKICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIlRoZW5hYmxlIHNlbGYtcmVzb2x1dGlvbiIpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbnMgMi4zLjMuMSwgMy41CiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cHM6Ly9wcm9taXNlc2FwbHVzLmNvbS8jcG9pbnQtNTQKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC03NQogICAgICAgICAgICAgICAgICAgIC8vIFJldHJpZXZlIGB0aGVuYCBvbmx5IG9uY2UKICAgICAgICAgICAgICAgICAgICB0aGVuID0gcmV0dXJuZWQgJiYgKAogICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjQKICAgICAgICAgICAgICAgICAgICAvLyBodHRwczovL3Byb21pc2VzYXBsdXMuY29tLyNwb2ludC02NAogICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgY2hlY2sgb2JqZWN0cyBhbmQgZnVuY3Rpb25zIGZvciB0aGVuYWJpbGl0eQogICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXR1cm5lZCA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHJldHVybmVkID09PSAiZnVuY3Rpb24iKSAmJiByZXR1cm5lZC50aGVuOwoKICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgYSByZXR1cm5lZCB0aGVuYWJsZQogICAgICAgICAgICAgICAgICAgIGlmIChpc0Z1bmN0aW9uKHRoZW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAvLyBTcGVjaWFsIHByb2Nlc3NvcnMgKG5vdGlmeSkganVzdCB3YWl0IGZvciByZXNvbHV0aW9uCiAgICAgICAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGVuLmNhbGwocmV0dXJuZWQsIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBUaHJvd2VyLCBzcGVjaWFsKSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBOb3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgYWxzbyBob29rIGludG8gcHJvZ3Jlc3MKICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIC4uLmFuZCBkaXNyZWdhcmQgb2xkZXIgcmVzb2x1dGlvbiB2YWx1ZXMKICAgICAgICAgICAgICAgICAgICAgICAgbWF4RGVwdGgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgdGhlbi5jYWxsKHJldHVybmVkLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgSWRlbnRpdHksIHNwZWNpYWwpLCByZXNvbHZlKG1heERlcHRoLCBkZWZlcnJlZCwgVGhyb3dlciwgc3BlY2lhbCksIHJlc29sdmUobWF4RGVwdGgsIGRlZmVycmVkLCBJZGVudGl0eSwgZGVmZXJyZWQubm90aWZ5V2l0aCkpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSBhbGwgb3RoZXIgcmV0dXJuZWQgdmFsdWVzCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgIC8vIE9ubHkgc3Vic3RpdHV0ZSBoYW5kbGVycyBwYXNzIG9uIGNvbnRleHQKICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCBtdWx0aXBsZSB2YWx1ZXMgKG5vbi1zcGVjIGJlaGF2aW9yKQogICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IElkZW50aXR5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbcmV0dXJuZWRdOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIFByb2Nlc3MgdGhlIHZhbHVlKHMpCiAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZhdWx0IHByb2Nlc3MgaXMgcmVzb2x2ZQogICAgICAgICAgICAgICAgICAgICAgKHNwZWNpYWwgfHwgZGVmZXJyZWQucmVzb2x2ZVdpdGgpKHRoYXQsIGFyZ3MpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgLy8gT25seSBub3JtYWwgcHJvY2Vzc29ycyAocmVzb2x2ZSkgY2F0Y2ggYW5kIHJlamVjdCBleGNlcHRpb25zCiAgICAgICAgICAgICAgICAgIHByb2Nlc3MgPSBzcGVjaWFsID8gbWlnaHRUaHJvdyA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgbWlnaHRUaHJvdygpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgIGlmIChqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vaykgewogICAgICAgICAgICAgICAgICAgICAgICBqUXVlcnkuRGVmZXJyZWQuZXhjZXB0aW9uSG9vayhlLCBwcm9jZXNzLnN0YWNrVHJhY2UpOwogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IFByb21pc2VzL0ErIHNlY3Rpb24gMi4zLjMuMy40LjEKICAgICAgICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTYxCiAgICAgICAgICAgICAgICAgICAgICAvLyBJZ25vcmUgcG9zdC1yZXNvbHV0aW9uIGV4Y2VwdGlvbnMKICAgICAgICAgICAgICAgICAgICAgIGlmIChkZXB0aCArIDEgPj0gbWF4RGVwdGgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT25seSBzdWJzdGl0dXRlIGhhbmRsZXJzIHBhc3Mgb24gY29udGV4dAogICAgICAgICAgICAgICAgICAgICAgICAvLyBhbmQgbXVsdGlwbGUgdmFsdWVzIChub24tc3BlYyBiZWhhdmlvcikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGhhbmRsZXIgIT09IFRocm93ZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB0aGF0ID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBbZV07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aCh0aGF0LCBhcmdzKTsKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gU3VwcG9ydDogUHJvbWlzZXMvQSsgc2VjdGlvbiAyLjMuMy4zLjEKICAgICAgICAgICAgICAgIC8vIGh0dHBzOi8vcHJvbWlzZXNhcGx1cy5jb20vI3BvaW50LTU3CiAgICAgICAgICAgICAgICAvLyBSZS1yZXNvbHZlIHByb21pc2VzIGltbWVkaWF0ZWx5IHRvIGRvZGdlIGZhbHNlIHJlamVjdGlvbiBmcm9tCiAgICAgICAgICAgICAgICAvLyBzdWJzZXF1ZW50IGVycm9ycwogICAgICAgICAgICAgICAgaWYgKGRlcHRoKSB7CiAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIC8vIENhbGwgYW4gb3B0aW9uYWwgaG9vayB0byByZWNvcmQgdGhlIHN0YWNrLCBpbiBjYXNlIG9mIGV4Y2VwdGlvbgogICAgICAgICAgICAgICAgICAvLyBzaW5jZSBpdCdzIG90aGVyd2lzZSBsb3N0IHdoZW4gZXhlY3V0aW9uIGdvZXMgYXN5bmMKICAgICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5EZWZlcnJlZC5nZXRTdGFja0hvb2spIHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnN0YWNrVHJhY2UgPSBqUXVlcnkuRGVmZXJyZWQuZ2V0U3RhY2tIb29rKCk7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQocHJvY2Vzcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4galF1ZXJ5LkRlZmVycmVkKGZ1bmN0aW9uIChuZXdEZWZlcikgewogICAgICAgICAgICAgIC8vIHByb2dyZXNzX2hhbmRsZXJzLmFkZCggLi4uICkKICAgICAgICAgICAgICB0dXBsZXNbMF1bM10uYWRkKHJlc29sdmUoMCwgbmV3RGVmZXIsIGlzRnVuY3Rpb24ob25Qcm9ncmVzcykgPyBvblByb2dyZXNzIDogSWRlbnRpdHksIG5ld0RlZmVyLm5vdGlmeVdpdGgpKTsKCiAgICAgICAgICAgICAgLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmFkZCggLi4uICkKICAgICAgICAgICAgICB0dXBsZXNbMV1bM10uYWRkKHJlc29sdmUoMCwgbmV3RGVmZXIsIGlzRnVuY3Rpb24ob25GdWxmaWxsZWQpID8gb25GdWxmaWxsZWQgOiBJZGVudGl0eSkpOwoKICAgICAgICAgICAgICAvLyByZWplY3RlZF9oYW5kbGVycy5hZGQoIC4uLiApCiAgICAgICAgICAgICAgdHVwbGVzWzJdWzNdLmFkZChyZXNvbHZlKDAsIG5ld0RlZmVyLCBpc0Z1bmN0aW9uKG9uUmVqZWN0ZWQpID8gb25SZWplY3RlZCA6IFRocm93ZXIpKTsKICAgICAgICAgICAgfSkucHJvbWlzZSgpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIEdldCBhIHByb21pc2UgZm9yIHRoaXMgZGVmZXJyZWQKICAgICAgICAgIC8vIElmIG9iaiBpcyBwcm92aWRlZCwgdGhlIHByb21pc2UgYXNwZWN0IGlzIGFkZGVkIHRvIHRoZSBvYmplY3QKICAgICAgICAgIHByb21pc2U6IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgcmV0dXJuIG9iaiAhPSBudWxsID8galF1ZXJ5LmV4dGVuZChvYmosIHByb21pc2UpIDogcHJvbWlzZTsKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGRlZmVycmVkID0ge307CgogICAgICAvLyBBZGQgbGlzdC1zcGVjaWZpYyBtZXRob2RzCiAgICAgIGpRdWVyeS5lYWNoKHR1cGxlcywgZnVuY3Rpb24gKGksIHR1cGxlKSB7CiAgICAgICAgdmFyIGxpc3QgPSB0dXBsZVsyXSwKICAgICAgICAgIHN0YXRlU3RyaW5nID0gdHVwbGVbNV07CgogICAgICAgIC8vIHByb21pc2UucHJvZ3Jlc3MgPSBsaXN0LmFkZAogICAgICAgIC8vIHByb21pc2UuZG9uZSA9IGxpc3QuYWRkCiAgICAgICAgLy8gcHJvbWlzZS5mYWlsID0gbGlzdC5hZGQKICAgICAgICBwcm9taXNlW3R1cGxlWzFdXSA9IGxpc3QuYWRkOwoKICAgICAgICAvLyBIYW5kbGUgc3RhdGUKICAgICAgICBpZiAoc3RhdGVTdHJpbmcpIHsKICAgICAgICAgIGxpc3QuYWRkKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgLy8gc3RhdGUgPSAicmVzb2x2ZWQiIChpLmUuLCBmdWxmaWxsZWQpCiAgICAgICAgICAgIC8vIHN0YXRlID0gInJlamVjdGVkIgogICAgICAgICAgICBzdGF0ZSA9IHN0YXRlU3RyaW5nOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIHJlamVjdGVkX2NhbGxiYWNrcy5kaXNhYmxlCiAgICAgICAgICAvLyBmdWxmaWxsZWRfY2FsbGJhY2tzLmRpc2FibGUKICAgICAgICAgIHR1cGxlc1szIC0gaV1bMl0uZGlzYWJsZSwKICAgICAgICAgIC8vIHJlamVjdGVkX2hhbmRsZXJzLmRpc2FibGUKICAgICAgICAgIC8vIGZ1bGZpbGxlZF9oYW5kbGVycy5kaXNhYmxlCiAgICAgICAgICB0dXBsZXNbMyAtIGldWzNdLmRpc2FibGUsCiAgICAgICAgICAvLyBwcm9ncmVzc19jYWxsYmFja3MubG9jawogICAgICAgICAgdHVwbGVzWzBdWzJdLmxvY2ssCiAgICAgICAgICAvLyBwcm9ncmVzc19oYW5kbGVycy5sb2NrCiAgICAgICAgICB0dXBsZXNbMF1bM10ubG9jayk7CiAgICAgICAgfQoKICAgICAgICAvLyBwcm9ncmVzc19oYW5kbGVycy5maXJlCiAgICAgICAgLy8gZnVsZmlsbGVkX2hhbmRsZXJzLmZpcmUKICAgICAgICAvLyByZWplY3RlZF9oYW5kbGVycy5maXJlCiAgICAgICAgbGlzdC5hZGQodHVwbGVbM10uZmlyZSk7CgogICAgICAgIC8vIGRlZmVycmVkLm5vdGlmeSA9IGZ1bmN0aW9uKCkgeyBkZWZlcnJlZC5ub3RpZnlXaXRoKC4uLikgfQogICAgICAgIC8vIGRlZmVycmVkLnJlc29sdmUgPSBmdW5jdGlvbigpIHsgZGVmZXJyZWQucmVzb2x2ZVdpdGgoLi4uKSB9CiAgICAgICAgLy8gZGVmZXJyZWQucmVqZWN0ID0gZnVuY3Rpb24oKSB7IGRlZmVycmVkLnJlamVjdFdpdGgoLi4uKSB9CiAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF1dID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgZGVmZXJyZWRbdHVwbGVbMF0gKyAiV2l0aCJdKHRoaXMgPT09IGRlZmVycmVkID8gdW5kZWZpbmVkIDogdGhpcywgYXJndW1lbnRzKTsKICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH07CgogICAgICAgIC8vIGRlZmVycmVkLm5vdGlmeVdpdGggPSBsaXN0LmZpcmVXaXRoCiAgICAgICAgLy8gZGVmZXJyZWQucmVzb2x2ZVdpdGggPSBsaXN0LmZpcmVXaXRoCiAgICAgICAgLy8gZGVmZXJyZWQucmVqZWN0V2l0aCA9IGxpc3QuZmlyZVdpdGgKICAgICAgICBkZWZlcnJlZFt0dXBsZVswXSArICJXaXRoIl0gPSBsaXN0LmZpcmVXaXRoOwogICAgICB9KTsKCiAgICAgIC8vIE1ha2UgdGhlIGRlZmVycmVkIGEgcHJvbWlzZQogICAgICBwcm9taXNlLnByb21pc2UoZGVmZXJyZWQpOwoKICAgICAgLy8gQ2FsbCBnaXZlbiBmdW5jIGlmIGFueQogICAgICBpZiAoZnVuYykgewogICAgICAgIGZ1bmMuY2FsbChkZWZlcnJlZCwgZGVmZXJyZWQpOwogICAgICB9CgogICAgICAvLyBBbGwgZG9uZSEKICAgICAgcmV0dXJuIGRlZmVycmVkOwogICAgfSwKICAgIC8vIERlZmVycmVkIGhlbHBlcgogICAgd2hlbjogZnVuY3Rpb24gKHNpbmdsZVZhbHVlKSB7CiAgICAgIHZhcgogICAgICAgIC8vIGNvdW50IG9mIHVuY29tcGxldGVkIHN1Ym9yZGluYXRlcwogICAgICAgIHJlbWFpbmluZyA9IGFyZ3VtZW50cy5sZW5ndGgsCiAgICAgICAgLy8gY291bnQgb2YgdW5wcm9jZXNzZWQgYXJndW1lbnRzCiAgICAgICAgaSA9IHJlbWFpbmluZywKICAgICAgICAvLyBzdWJvcmRpbmF0ZSBmdWxmaWxsbWVudCBkYXRhCiAgICAgICAgcmVzb2x2ZUNvbnRleHRzID0gQXJyYXkoaSksCiAgICAgICAgcmVzb2x2ZVZhbHVlcyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKSwKICAgICAgICAvLyB0aGUgcHJpbWFyeSBEZWZlcnJlZAogICAgICAgIHByaW1hcnkgPSBqUXVlcnkuRGVmZXJyZWQoKSwKICAgICAgICAvLyBzdWJvcmRpbmF0ZSBjYWxsYmFjayBmYWN0b3J5CiAgICAgICAgdXBkYXRlRnVuYyA9IGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJlc29sdmVDb250ZXh0c1tpXSA9IHRoaXM7CiAgICAgICAgICAgIHJlc29sdmVWYWx1ZXNbaV0gPSBhcmd1bWVudHMubGVuZ3RoID4gMSA/IHNsaWNlLmNhbGwoYXJndW1lbnRzKSA6IHZhbHVlOwogICAgICAgICAgICBpZiAoISAtLXJlbWFpbmluZykgewogICAgICAgICAgICAgIHByaW1hcnkucmVzb2x2ZVdpdGgocmVzb2x2ZUNvbnRleHRzLCByZXNvbHZlVmFsdWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfTsKICAgICAgICB9OwoKICAgICAgLy8gU2luZ2xlLSBhbmQgZW1wdHkgYXJndW1lbnRzIGFyZSBhZG9wdGVkIGxpa2UgUHJvbWlzZS5yZXNvbHZlCiAgICAgIGlmIChyZW1haW5pbmcgPD0gMSkgewogICAgICAgIGFkb3B0VmFsdWUoc2luZ2xlVmFsdWUsIHByaW1hcnkuZG9uZSh1cGRhdGVGdW5jKGkpKS5yZXNvbHZlLCBwcmltYXJ5LnJlamVjdCwgIXJlbWFpbmluZyk7CgogICAgICAgIC8vIFVzZSAudGhlbigpIHRvIHVud3JhcCBzZWNvbmRhcnkgdGhlbmFibGVzIChjZi4gZ2gtMzAwMCkKICAgICAgICBpZiAocHJpbWFyeS5zdGF0ZSgpID09PSAicGVuZGluZyIgfHwgaXNGdW5jdGlvbihyZXNvbHZlVmFsdWVzW2ldICYmIHJlc29sdmVWYWx1ZXNbaV0udGhlbikpIHsKICAgICAgICAgIHJldHVybiBwcmltYXJ5LnRoZW4oKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE11bHRpcGxlIGFyZ3VtZW50cyBhcmUgYWdncmVnYXRlZCBsaWtlIFByb21pc2UuYWxsIGFycmF5IGVsZW1lbnRzCiAgICAgIHdoaWxlIChpLS0pIHsKICAgICAgICBhZG9wdFZhbHVlKHJlc29sdmVWYWx1ZXNbaV0sIHVwZGF0ZUZ1bmMoaSksIHByaW1hcnkucmVqZWN0KTsKICAgICAgfQogICAgICByZXR1cm4gcHJpbWFyeS5wcm9taXNlKCk7CiAgICB9CiAgfSk7CgogIC8vIFRoZXNlIHVzdWFsbHkgaW5kaWNhdGUgYSBwcm9ncmFtbWVyIG1pc3Rha2UgZHVyaW5nIGRldmVsb3BtZW50LAogIC8vIHdhcm4gYWJvdXQgdGhlbSBBU0FQIHJhdGhlciB0aGFuIHN3YWxsb3dpbmcgdGhlbSBieSBkZWZhdWx0LgogIHZhciByZXJyb3JOYW1lcyA9IC9eKEV2YWx8SW50ZXJuYWx8UmFuZ2V8UmVmZXJlbmNlfFN5bnRheHxUeXBlfFVSSSlFcnJvciQvOwogIGpRdWVyeS5EZWZlcnJlZC5leGNlcHRpb25Ib29rID0gZnVuY3Rpb24gKGVycm9yLCBzdGFjaykgewogICAgLy8gU3VwcG9ydDogSUUgOCAtIDkgb25seQogICAgLy8gQ29uc29sZSBleGlzdHMgd2hlbiBkZXYgdG9vbHMgYXJlIG9wZW4sIHdoaWNoIGNhbiBoYXBwZW4gYXQgYW55IHRpbWUKICAgIGlmICh3aW5kb3cuY29uc29sZSAmJiB3aW5kb3cuY29uc29sZS53YXJuICYmIGVycm9yICYmIHJlcnJvck5hbWVzLnRlc3QoZXJyb3IubmFtZSkpIHsKICAgICAgd2luZG93LmNvbnNvbGUud2FybigialF1ZXJ5LkRlZmVycmVkIGV4Y2VwdGlvbjogIiArIGVycm9yLm1lc3NhZ2UsIGVycm9yLnN0YWNrLCBzdGFjayk7CiAgICB9CiAgfTsKICBqUXVlcnkucmVhZHlFeGNlcHRpb24gPSBmdW5jdGlvbiAoZXJyb3IpIHsKICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdGhyb3cgZXJyb3I7CiAgICB9KTsKICB9OwoKICAvLyBUaGUgZGVmZXJyZWQgdXNlZCBvbiBET00gcmVhZHkKICB2YXIgcmVhZHlMaXN0ID0galF1ZXJ5LkRlZmVycmVkKCk7CiAgalF1ZXJ5LmZuLnJlYWR5ID0gZnVuY3Rpb24gKGZuKSB7CiAgICByZWFkeUxpc3QudGhlbihmbikKCiAgICAvLyBXcmFwIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbiBpbiBhIGZ1bmN0aW9uIHNvIHRoYXQgdGhlIGxvb2t1cAogICAgLy8gaGFwcGVucyBhdCB0aGUgdGltZSBvZiBlcnJvciBoYW5kbGluZyBpbnN0ZWFkIG9mIGNhbGxiYWNrCiAgICAvLyByZWdpc3RyYXRpb24uCiAgICAuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7CiAgICAgIGpRdWVyeS5yZWFkeUV4Y2VwdGlvbihlcnJvcik7CiAgICB9KTsKICAgIHJldHVybiB0aGlzOwogIH07CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICAvLyBJcyB0aGUgRE9NIHJlYWR5IHRvIGJlIHVzZWQ/IFNldCB0byB0cnVlIG9uY2UgaXQgb2NjdXJzLgogICAgaXNSZWFkeTogZmFsc2UsCiAgICAvLyBBIGNvdW50ZXIgdG8gdHJhY2sgaG93IG1hbnkgaXRlbXMgdG8gd2FpdCBmb3IgYmVmb3JlCiAgICAvLyB0aGUgcmVhZHkgZXZlbnQgZmlyZXMuIFNlZSB0cmFjLTY3ODEKICAgIHJlYWR5V2FpdDogMSwKICAgIC8vIEhhbmRsZSB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIHJlYWR5OiBmdW5jdGlvbiAod2FpdCkgewogICAgICAvLyBBYm9ydCBpZiB0aGVyZSBhcmUgcGVuZGluZyBob2xkcyBvciB3ZSdyZSBhbHJlYWR5IHJlYWR5CiAgICAgIGlmICh3YWl0ID09PSB0cnVlID8gLS1qUXVlcnkucmVhZHlXYWl0IDogalF1ZXJ5LmlzUmVhZHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIFJlbWVtYmVyIHRoYXQgdGhlIERPTSBpcyByZWFkeQogICAgICBqUXVlcnkuaXNSZWFkeSA9IHRydWU7CgogICAgICAvLyBJZiBhIG5vcm1hbCBET00gUmVhZHkgZXZlbnQgZmlyZWQsIGRlY3JlbWVudCwgYW5kIHdhaXQgaWYgbmVlZCBiZQogICAgICBpZiAod2FpdCAhPT0gdHJ1ZSAmJiAtLWpRdWVyeS5yZWFkeVdhaXQgPiAwKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBJZiB0aGVyZSBhcmUgZnVuY3Rpb25zIGJvdW5kLCB0byBleGVjdXRlCiAgICAgIHJlYWR5TGlzdC5yZXNvbHZlV2l0aChkb2N1bWVudCwgW2pRdWVyeV0pOwogICAgfQogIH0pOwogIGpRdWVyeS5yZWFkeS50aGVuID0gcmVhZHlMaXN0LnRoZW47CgogIC8vIFRoZSByZWFkeSBldmVudCBoYW5kbGVyIGFuZCBzZWxmIGNsZWFudXAgbWV0aG9kCiAgZnVuY3Rpb24gY29tcGxldGVkKCkgewogICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGNvbXBsZXRlZCk7CiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigibG9hZCIsIGNvbXBsZXRlZCk7CiAgICBqUXVlcnkucmVhZHkoKTsKICB9CgogIC8vIENhdGNoIGNhc2VzIHdoZXJlICQoZG9jdW1lbnQpLnJlYWR5KCkgaXMgY2FsbGVkCiAgLy8gYWZ0ZXIgdGhlIGJyb3dzZXIgZXZlbnQgaGFzIGFscmVhZHkgb2NjdXJyZWQuCiAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTAgb25seQogIC8vIE9sZGVyIElFIHNvbWV0aW1lcyBzaWduYWxzICJpbnRlcmFjdGl2ZSIgdG9vIHNvb24KICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAibG9hZGluZyIgJiYgIWRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCkgewogICAgLy8gSGFuZGxlIGl0IGFzeW5jaHJvbm91c2x5IHRvIGFsbG93IHNjcmlwdHMgdGhlIG9wcG9ydHVuaXR5IHRvIGRlbGF5IHJlYWR5CiAgICB3aW5kb3cuc2V0VGltZW91dChqUXVlcnkucmVhZHkpOwogIH0gZWxzZSB7CiAgICAvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgY29tcGxldGVkKTsKCiAgICAvLyBBIGZhbGxiYWNrIHRvIHdpbmRvdy5vbmxvYWQsIHRoYXQgd2lsbCBhbHdheXMgd29yawogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBjb21wbGV0ZWQpOwogIH0KCiAgLy8gTXVsdGlmdW5jdGlvbmFsIG1ldGhvZCB0byBnZXQgYW5kIHNldCB2YWx1ZXMgb2YgYSBjb2xsZWN0aW9uCiAgLy8gVGhlIHZhbHVlL3MgY2FuIG9wdGlvbmFsbHkgYmUgZXhlY3V0ZWQgaWYgaXQncyBhIGZ1bmN0aW9uCiAgdmFyIGFjY2VzcyA9IGZ1bmN0aW9uIChlbGVtcywgZm4sIGtleSwgdmFsdWUsIGNoYWluYWJsZSwgZW1wdHlHZXQsIHJhdykgewogICAgdmFyIGkgPSAwLAogICAgICBsZW4gPSBlbGVtcy5sZW5ndGgsCiAgICAgIGJ1bGsgPSBrZXkgPT0gbnVsbDsKCiAgICAvLyBTZXRzIG1hbnkgdmFsdWVzCiAgICBpZiAodG9UeXBlKGtleSkgPT09ICJvYmplY3QiKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGZvciAoaSBpbiBrZXkpIHsKICAgICAgICBhY2Nlc3MoZWxlbXMsIGZuLCBpLCBrZXlbaV0sIHRydWUsIGVtcHR5R2V0LCByYXcpOwogICAgICB9CgogICAgICAvLyBTZXRzIG9uZSB2YWx1ZQogICAgfSBlbHNlIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIGNoYWluYWJsZSA9IHRydWU7CiAgICAgIGlmICghaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByYXcgPSB0cnVlOwogICAgICB9CiAgICAgIGlmIChidWxrKSB7CiAgICAgICAgLy8gQnVsayBvcGVyYXRpb25zIHJ1biBhZ2FpbnN0IHRoZSBlbnRpcmUgc2V0CiAgICAgICAgaWYgKHJhdykgewogICAgICAgICAgZm4uY2FsbChlbGVtcywgdmFsdWUpOwogICAgICAgICAgZm4gPSBudWxsOwoKICAgICAgICAgIC8vIC4uLmV4Y2VwdCB3aGVuIGV4ZWN1dGluZyBmdW5jdGlvbiB2YWx1ZXMKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYnVsayA9IGZuOwogICAgICAgICAgZm4gPSBmdW5jdGlvbiAoZWxlbSwgX2tleSwgdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuIGJ1bGsuY2FsbChqUXVlcnkoZWxlbSksIHZhbHVlKTsKICAgICAgICAgIH07CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIGZvciAoOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgIGZuKGVsZW1zW2ldLCBrZXksIHJhdyA/IHZhbHVlIDogdmFsdWUuY2FsbChlbGVtc1tpXSwgaSwgZm4oZWxlbXNbaV0sIGtleSkpKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIGlmIChjaGFpbmFibGUpIHsKICAgICAgcmV0dXJuIGVsZW1zOwogICAgfQoKICAgIC8vIEdldHMKICAgIGlmIChidWxrKSB7CiAgICAgIHJldHVybiBmbi5jYWxsKGVsZW1zKTsKICAgIH0KICAgIHJldHVybiBsZW4gPyBmbihlbGVtc1swXSwga2V5KSA6IGVtcHR5R2V0OwogIH07CgogIC8vIE1hdGNoZXMgZGFzaGVkIHN0cmluZyBmb3IgY2FtZWxpemluZwogIHZhciBybXNQcmVmaXggPSAvXi1tcy0vLAogICAgcmRhc2hBbHBoYSA9IC8tKFthLXpdKS9nOwoKICAvLyBVc2VkIGJ5IGNhbWVsQ2FzZSBhcyBjYWxsYmFjayB0byByZXBsYWNlKCkKICBmdW5jdGlvbiBmY2FtZWxDYXNlKF9hbGwsIGxldHRlcikgewogICAgcmV0dXJuIGxldHRlci50b1VwcGVyQ2FzZSgpOwogIH0KCiAgLy8gQ29udmVydCBkYXNoZWQgdG8gY2FtZWxDYXNlOyB1c2VkIGJ5IHRoZSBjc3MgYW5kIGRhdGEgbW9kdWxlcwogIC8vIFN1cHBvcnQ6IElFIDw9OSAtIDExLCBFZGdlIDEyIC0gMTUKICAvLyBNaWNyb3NvZnQgZm9yZ290IHRvIGh1bXAgdGhlaXIgdmVuZG9yIHByZWZpeCAodHJhYy05NTcyKQogIGZ1bmN0aW9uIGNhbWVsQ2FzZShzdHJpbmcpIHsKICAgIHJldHVybiBzdHJpbmcucmVwbGFjZShybXNQcmVmaXgsICJtcy0iKS5yZXBsYWNlKHJkYXNoQWxwaGEsIGZjYW1lbENhc2UpOwogIH0KICB2YXIgYWNjZXB0RGF0YSA9IGZ1bmN0aW9uIChvd25lcikgewogICAgLy8gQWNjZXB0cyBvbmx5OgogICAgLy8gIC0gTm9kZQogICAgLy8gICAgLSBOb2RlLkVMRU1FTlRfTk9ERQogICAgLy8gICAgLSBOb2RlLkRPQ1VNRU5UX05PREUKICAgIC8vICAtIE9iamVjdAogICAgLy8gICAgLSBBbnkKICAgIHJldHVybiBvd25lci5ub2RlVHlwZSA9PT0gMSB8fCBvd25lci5ub2RlVHlwZSA9PT0gOSB8fCAhK293bmVyLm5vZGVUeXBlOwogIH07CiAgZnVuY3Rpb24gRGF0YSgpIHsKICAgIHRoaXMuZXhwYW5kbyA9IGpRdWVyeS5leHBhbmRvICsgRGF0YS51aWQrKzsKICB9CiAgRGF0YS51aWQgPSAxOwogIERhdGEucHJvdG90eXBlID0gewogICAgY2FjaGU6IGZ1bmN0aW9uIChvd25lcikgewogICAgICAvLyBDaGVjayBpZiB0aGUgb3duZXIgb2JqZWN0IGFscmVhZHkgaGFzIGEgY2FjaGUKICAgICAgdmFyIHZhbHVlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKCiAgICAgIC8vIElmIG5vdCwgY3JlYXRlIG9uZQogICAgICBpZiAoIXZhbHVlKSB7CiAgICAgICAgdmFsdWUgPSB7fTsKCiAgICAgICAgLy8gV2UgY2FuIGFjY2VwdCBkYXRhIGZvciBub24tZWxlbWVudCBub2RlcyBpbiBtb2Rlcm4gYnJvd3NlcnMsCiAgICAgICAgLy8gYnV0IHdlIHNob3VsZCBub3QsIHNlZSB0cmFjLTgzMzUuCiAgICAgICAgLy8gQWx3YXlzIHJldHVybiBhbiBlbXB0eSBvYmplY3QuCiAgICAgICAgaWYgKGFjY2VwdERhdGEob3duZXIpKSB7CiAgICAgICAgICAvLyBJZiBpdCBpcyBhIG5vZGUgdW5saWtlbHkgdG8gYmUgc3RyaW5naWZ5LWVkIG9yIGxvb3BlZCBvdmVyCiAgICAgICAgICAvLyB1c2UgcGxhaW4gYXNzaWdubWVudAogICAgICAgICAgaWYgKG93bmVyLm5vZGVUeXBlKSB7CiAgICAgICAgICAgIG93bmVyW3RoaXMuZXhwYW5kb10gPSB2YWx1ZTsKCiAgICAgICAgICAgIC8vIE90aGVyd2lzZSBzZWN1cmUgaXQgaW4gYSBub24tZW51bWVyYWJsZSBwcm9wZXJ0eQogICAgICAgICAgICAvLyBjb25maWd1cmFibGUgbXVzdCBiZSB0cnVlIHRvIGFsbG93IHRoZSBwcm9wZXJ0eSB0byBiZQogICAgICAgICAgICAvLyBkZWxldGVkIHdoZW4gZGF0YSBpcyByZW1vdmVkCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob3duZXIsIHRoaXMuZXhwYW5kbywgewogICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIChvd25lciwgZGF0YSwgdmFsdWUpIHsKICAgICAgdmFyIHByb3AsCiAgICAgICAgY2FjaGUgPSB0aGlzLmNhY2hlKG93bmVyKTsKCiAgICAgIC8vIEhhbmRsZTogWyBvd25lciwga2V5LCB2YWx1ZSBdIGFyZ3MKICAgICAgLy8gQWx3YXlzIHVzZSBjYW1lbENhc2Uga2V5IChnaC0yMjU3KQogICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY2FjaGVbY2FtZWxDYXNlKGRhdGEpXSA9IHZhbHVlOwoKICAgICAgICAvLyBIYW5kbGU6IFsgb3duZXIsIHsgcHJvcGVydGllcyB9IF0gYXJncwogICAgICB9IGVsc2UgewogICAgICAgIC8vIENvcHkgdGhlIHByb3BlcnRpZXMgb25lLWJ5LW9uZSB0byB0aGUgY2FjaGUgb2JqZWN0CiAgICAgICAgZm9yIChwcm9wIGluIGRhdGEpIHsKICAgICAgICAgIGNhY2hlW2NhbWVsQ2FzZShwcm9wKV0gPSBkYXRhW3Byb3BdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gY2FjaGU7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiAob3duZXIsIGtleSkgewogICAgICByZXR1cm4ga2V5ID09PSB1bmRlZmluZWQgPyB0aGlzLmNhY2hlKG93bmVyKSA6CiAgICAgIC8vIEFsd2F5cyB1c2UgY2FtZWxDYXNlIGtleSAoZ2gtMjI1NykKICAgICAgb3duZXJbdGhpcy5leHBhbmRvXSAmJiBvd25lclt0aGlzLmV4cGFuZG9dW2NhbWVsQ2FzZShrZXkpXTsKICAgIH0sCiAgICBhY2Nlc3M6IGZ1bmN0aW9uIChvd25lciwga2V5LCB2YWx1ZSkgewogICAgICAvLyBJbiBjYXNlcyB3aGVyZSBlaXRoZXI6CiAgICAgIC8vCiAgICAgIC8vICAgMS4gTm8ga2V5IHdhcyBzcGVjaWZpZWQKICAgICAgLy8gICAyLiBBIHN0cmluZyBrZXkgd2FzIHNwZWNpZmllZCwgYnV0IG5vIHZhbHVlIHByb3ZpZGVkCiAgICAgIC8vCiAgICAgIC8vIFRha2UgdGhlICJyZWFkIiBwYXRoIGFuZCBhbGxvdyB0aGUgZ2V0IG1ldGhvZCB0byBkZXRlcm1pbmUKICAgICAgLy8gd2hpY2ggdmFsdWUgdG8gcmV0dXJuLCByZXNwZWN0aXZlbHkgZWl0aGVyOgogICAgICAvLwogICAgICAvLyAgIDEuIFRoZSBlbnRpcmUgY2FjaGUgb2JqZWN0CiAgICAgIC8vICAgMi4gVGhlIGRhdGEgc3RvcmVkIGF0IHRoZSBrZXkKICAgICAgLy8KICAgICAgaWYgKGtleSA9PT0gdW5kZWZpbmVkIHx8IGtleSAmJiB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiAmJiB2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0KG93bmVyLCBrZXkpOwogICAgICB9CgogICAgICAvLyBXaGVuIHRoZSBrZXkgaXMgbm90IGEgc3RyaW5nLCBvciBib3RoIGEga2V5IGFuZCB2YWx1ZQogICAgICAvLyBhcmUgc3BlY2lmaWVkLCBzZXQgb3IgZXh0ZW5kIChleGlzdGluZyBvYmplY3RzKSB3aXRoIGVpdGhlcjoKICAgICAgLy8KICAgICAgLy8gICAxLiBBbiBvYmplY3Qgb2YgcHJvcGVydGllcwogICAgICAvLyAgIDIuIEEga2V5IGFuZCB2YWx1ZQogICAgICAvLwogICAgICB0aGlzLnNldChvd25lciwga2V5LCB2YWx1ZSk7CgogICAgICAvLyBTaW5jZSB0aGUgInNldCIgcGF0aCBjYW4gaGF2ZSB0d28gcG9zc2libGUgZW50cnkgcG9pbnRzCiAgICAgIC8vIHJldHVybiB0aGUgZXhwZWN0ZWQgZGF0YSBiYXNlZCBvbiB3aGljaCBwYXRoIHdhcyB0YWtlblsqXQogICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDoga2V5OwogICAgfSwKICAgIHJlbW92ZTogZnVuY3Rpb24gKG93bmVyLCBrZXkpIHsKICAgICAgdmFyIGksCiAgICAgICAgY2FjaGUgPSBvd25lclt0aGlzLmV4cGFuZG9dOwogICAgICBpZiAoY2FjaGUgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICBpZiAoa2V5ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyBTdXBwb3J0IGFycmF5IG9yIHNwYWNlIHNlcGFyYXRlZCBzdHJpbmcgb2Yga2V5cwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGtleSkpIHsKICAgICAgICAgIC8vIElmIGtleSBpcyBhbiBhcnJheSBvZiBrZXlzLi4uCiAgICAgICAgICAvLyBXZSBhbHdheXMgc2V0IGNhbWVsQ2FzZSBrZXlzLCBzbyByZW1vdmUgdGhhdC4KICAgICAgICAgIGtleSA9IGtleS5tYXAoY2FtZWxDYXNlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAga2V5ID0gY2FtZWxDYXNlKGtleSk7CgogICAgICAgICAgLy8gSWYgYSBrZXkgd2l0aCB0aGUgc3BhY2VzIGV4aXN0cywgdXNlIGl0LgogICAgICAgICAgLy8gT3RoZXJ3aXNlLCBjcmVhdGUgYW4gYXJyYXkgYnkgbWF0Y2hpbmcgbm9uLXdoaXRlc3BhY2UKICAgICAgICAgIGtleSA9IGtleSBpbiBjYWNoZSA/IFtrZXldIDoga2V5Lm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdOwogICAgICAgIH0KICAgICAgICBpID0ga2V5Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICBkZWxldGUgY2FjaGVba2V5W2ldXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSB0aGUgZXhwYW5kbyBpZiB0aGVyZSdzIG5vIG1vcmUgZGF0YQogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQgfHwgalF1ZXJ5LmlzRW1wdHlPYmplY3QoY2FjaGUpKSB7CiAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NQogICAgICAgIC8vIFdlYmtpdCAmIEJsaW5rIHBlcmZvcm1hbmNlIHN1ZmZlcnMgd2hlbiBkZWxldGluZyBwcm9wZXJ0aWVzCiAgICAgICAgLy8gZnJvbSBET00gbm9kZXMsIHNvIHNldCB0byB1bmRlZmluZWQgaW5zdGVhZAogICAgICAgIC8vIGh0dHBzOi8vYnVncy5jaHJvbWl1bS5vcmcvcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTM3ODYwNyAoYnVnIHJlc3RyaWN0ZWQpCiAgICAgICAgaWYgKG93bmVyLm5vZGVUeXBlKSB7CiAgICAgICAgICBvd25lclt0aGlzLmV4cGFuZG9dID0gdW5kZWZpbmVkOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWxldGUgb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBoYXNEYXRhOiBmdW5jdGlvbiAob3duZXIpIHsKICAgICAgdmFyIGNhY2hlID0gb3duZXJbdGhpcy5leHBhbmRvXTsKICAgICAgcmV0dXJuIGNhY2hlICE9PSB1bmRlZmluZWQgJiYgIWpRdWVyeS5pc0VtcHR5T2JqZWN0KGNhY2hlKTsKICAgIH0KICB9OwogIHZhciBkYXRhUHJpdiA9IG5ldyBEYXRhKCk7CiAgdmFyIGRhdGFVc2VyID0gbmV3IERhdGEoKTsKCiAgLy8JSW1wbGVtZW50YXRpb24gU3VtbWFyeQogIC8vCiAgLy8JMS4gRW5mb3JjZSBBUEkgc3VyZmFjZSBhbmQgc2VtYW50aWMgY29tcGF0aWJpbGl0eSB3aXRoIDEuOS54IGJyYW5jaAogIC8vCTIuIEltcHJvdmUgdGhlIG1vZHVsZSdzIG1haW50YWluYWJpbGl0eSBieSByZWR1Y2luZyB0aGUgc3RvcmFnZQogIC8vCQlwYXRocyB0byBhIHNpbmdsZSBtZWNoYW5pc20uCiAgLy8JMy4gVXNlIHRoZSBzYW1lIHNpbmdsZSBtZWNoYW5pc20gdG8gc3VwcG9ydCAicHJpdmF0ZSIgYW5kICJ1c2VyIiBkYXRhLgogIC8vCTQuIF9OZXZlcl8gZXhwb3NlICJwcml2YXRlIiBkYXRhIHRvIHVzZXIgY29kZSAoVE9ETzogRHJvcCBfZGF0YSwgX3JlbW92ZURhdGEpCiAgLy8JNS4gQXZvaWQgZXhwb3NpbmcgaW1wbGVtZW50YXRpb24gZGV0YWlscyBvbiB1c2VyIG9iamVjdHMgKGVnLiBleHBhbmRvIHByb3BlcnRpZXMpCiAgLy8JNi4gUHJvdmlkZSBhIGNsZWFyIHBhdGggZm9yIGltcGxlbWVudGF0aW9uIHVwZ3JhZGUgdG8gV2Vha01hcCBpbiAyMDE0CgogIHZhciByYnJhY2UgPSAvXig/Olx7W1x3XFddKlx9fFxbW1x3XFddKlxdKSQvLAogICAgcm11bHRpRGFzaCA9IC9bQS1aXS9nOwogIGZ1bmN0aW9uIGdldERhdGEoZGF0YSkgewogICAgaWYgKGRhdGEgPT09ICJ0cnVlIikgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAiZmFsc2UiKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGlmIChkYXRhID09PSAibnVsbCIpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gT25seSBjb252ZXJ0IHRvIGEgbnVtYmVyIGlmIGl0IGRvZXNuJ3QgY2hhbmdlIHRoZSBzdHJpbmcKICAgIGlmIChkYXRhID09PSArZGF0YSArICIiKSB7CiAgICAgIHJldHVybiArZGF0YTsKICAgIH0KICAgIGlmIChyYnJhY2UudGVzdChkYXRhKSkgewogICAgICByZXR1cm4gSlNPTi5wYXJzZShkYXRhKTsKICAgIH0KICAgIHJldHVybiBkYXRhOwogIH0KICBmdW5jdGlvbiBkYXRhQXR0cihlbGVtLCBrZXksIGRhdGEpIHsKICAgIHZhciBuYW1lOwoKICAgIC8vIElmIG5vdGhpbmcgd2FzIGZvdW5kIGludGVybmFsbHksIHRyeSB0byBmZXRjaCBhbnkKICAgIC8vIGRhdGEgZnJvbSB0aGUgSFRNTDUgZGF0YS0qIGF0dHJpYnV0ZQogICAgaWYgKGRhdGEgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgIG5hbWUgPSAiZGF0YS0iICsga2V5LnJlcGxhY2Uocm11bHRpRGFzaCwgIi0kJiIpLnRvTG93ZXJDYXNlKCk7CiAgICAgIGRhdGEgPSBlbGVtLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgaWYgKHR5cGVvZiBkYXRhID09PSAic3RyaW5nIikgewogICAgICAgIHRyeSB7CiAgICAgICAgICBkYXRhID0gZ2V0RGF0YShkYXRhKTsKICAgICAgICB9IGNhdGNoIChlKSB7fQoKICAgICAgICAvLyBNYWtlIHN1cmUgd2Ugc2V0IHRoZSBkYXRhIHNvIGl0IGlzbid0IGNoYW5nZWQgbGF0ZXIKICAgICAgICBkYXRhVXNlci5zZXQoZWxlbSwga2V5LCBkYXRhKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZGF0YTsKICB9CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICBoYXNEYXRhOiBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4gZGF0YVVzZXIuaGFzRGF0YShlbGVtKSB8fCBkYXRhUHJpdi5oYXNEYXRhKGVsZW0pOwogICAgfSwKICAgIGRhdGE6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCBkYXRhKSB7CiAgICAgIHJldHVybiBkYXRhVXNlci5hY2Nlc3MoZWxlbSwgbmFtZSwgZGF0YSk7CiAgICB9LAogICAgcmVtb3ZlRGF0YTogZnVuY3Rpb24gKGVsZW0sIG5hbWUpIHsKICAgICAgZGF0YVVzZXIucmVtb3ZlKGVsZW0sIG5hbWUpOwogICAgfSwKICAgIC8vIFRPRE86IE5vdyB0aGF0IGFsbCBjYWxscyB0byBfZGF0YSBhbmQgX3JlbW92ZURhdGEgaGF2ZSBiZWVuIHJlcGxhY2VkCiAgICAvLyB3aXRoIGRpcmVjdCBjYWxscyB0byBkYXRhUHJpdiBtZXRob2RzLCB0aGVzZSBjYW4gYmUgZGVwcmVjYXRlZC4KICAgIF9kYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZGF0YSkgewogICAgICByZXR1cm4gZGF0YVByaXYuYWNjZXNzKGVsZW0sIG5hbWUsIGRhdGEpOwogICAgfSwKICAgIF9yZW1vdmVEYXRhOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSkgewogICAgICBkYXRhUHJpdi5yZW1vdmUoZWxlbSwgbmFtZSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkYXRhOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSkgewogICAgICB2YXIgaSwKICAgICAgICBuYW1lLAogICAgICAgIGRhdGEsCiAgICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgYXR0cnMgPSBlbGVtICYmIGVsZW0uYXR0cmlidXRlczsKCiAgICAgIC8vIEdldHMgYWxsIHZhbHVlcwogICAgICBpZiAoa2V5ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAodGhpcy5sZW5ndGgpIHsKICAgICAgICAgIGRhdGEgPSBkYXRhVXNlci5nZXQoZWxlbSk7CiAgICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAhZGF0YVByaXYuZ2V0KGVsZW0sICJoYXNEYXRhQXR0cnMiKSkgewogICAgICAgICAgICBpID0gYXR0cnMubGVuZ3RoOwogICAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgMTEgb25seQogICAgICAgICAgICAgIC8vIFRoZSBhdHRycyBlbGVtZW50cyBjYW4gYmUgbnVsbCAodHJhYy0xNDg5NCkKICAgICAgICAgICAgICBpZiAoYXR0cnNbaV0pIHsKICAgICAgICAgICAgICAgIG5hbWUgPSBhdHRyc1tpXS5uYW1lOwogICAgICAgICAgICAgICAgaWYgKG5hbWUuaW5kZXhPZigiZGF0YS0iKSA9PT0gMCkgewogICAgICAgICAgICAgICAgICBuYW1lID0gY2FtZWxDYXNlKG5hbWUuc2xpY2UoNSkpOwogICAgICAgICAgICAgICAgICBkYXRhQXR0cihlbGVtLCBuYW1lLCBkYXRhW25hbWVdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGF0YVByaXYuc2V0KGVsZW0sICJoYXNEYXRhQXR0cnMiLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgIH0KCiAgICAgIC8vIFNldHMgbXVsdGlwbGUgdmFsdWVzCiAgICAgIGlmICh0eXBlb2Yga2V5ID09PSAib2JqZWN0IikgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVVzZXIuc2V0KHRoaXMsIGtleSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZGF0YTsKCiAgICAgICAgLy8gVGhlIGNhbGxpbmcgalF1ZXJ5IG9iamVjdCAoZWxlbWVudCBtYXRjaGVzKSBpcyBub3QgZW1wdHkKICAgICAgICAvLyAoYW5kIHRoZXJlZm9yZSBoYXMgYW4gZWxlbWVudCBhcHBlYXJzIGF0IHRoaXNbIDAgXSkgYW5kIHRoZQogICAgICAgIC8vIGB2YWx1ZWAgcGFyYW1ldGVyIHdhcyBub3QgdW5kZWZpbmVkLiBBbiBlbXB0eSBqUXVlcnkgb2JqZWN0CiAgICAgICAgLy8gd2lsbCByZXN1bHQgaW4gYHVuZGVmaW5lZGAgZm9yIGVsZW0gPSB0aGlzWyAwIF0gd2hpY2ggd2lsbAogICAgICAgIC8vIHRocm93IGFuIGV4Y2VwdGlvbiBpZiBhbiBhdHRlbXB0IHRvIHJlYWQgYSBkYXRhIGNhY2hlIGlzIG1hZGUuCiAgICAgICAgaWYgKGVsZW0gJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgLy8gQXR0ZW1wdCB0byBnZXQgZGF0YSBmcm9tIHRoZSBjYWNoZQogICAgICAgICAgLy8gVGhlIGtleSB3aWxsIGFsd2F5cyBiZSBjYW1lbENhc2VkIGluIERhdGEKICAgICAgICAgIGRhdGEgPSBkYXRhVXNlci5nZXQoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQXR0ZW1wdCB0byAiZGlzY292ZXIiIHRoZSBkYXRhIGluCiAgICAgICAgICAvLyBIVE1MNSBjdXN0b20gZGF0YS0qIGF0dHJzCiAgICAgICAgICBkYXRhID0gZGF0YUF0dHIoZWxlbSwga2V5KTsKICAgICAgICAgIGlmIChkYXRhICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgcmV0dXJuIGRhdGE7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gV2UgdHJpZWQgcmVhbGx5IGhhcmQsIGJ1dCB0aGUgZGF0YSBkb2Vzbid0IGV4aXN0LgogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gU2V0IHRoZSBkYXRhLi4uCiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIFdlIGFsd2F5cyBzdG9yZSB0aGUgY2FtZWxDYXNlZCBrZXkKICAgICAgICAgIGRhdGFVc2VyLnNldCh0aGlzLCBrZXksIHZhbHVlKTsKICAgICAgICB9KTsKICAgICAgfSwgbnVsbCwgdmFsdWUsIGFyZ3VtZW50cy5sZW5ndGggPiAxLCBudWxsLCB0cnVlKTsKICAgIH0sCiAgICByZW1vdmVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGRhdGFVc2VyLnJlbW92ZSh0aGlzLCBrZXkpOwogICAgICB9KTsKICAgIH0KICB9KTsKICBqUXVlcnkuZXh0ZW5kKHsKICAgIHF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgZGF0YSkgewogICAgICB2YXIgcXVldWU7CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgdHlwZSA9ICh0eXBlIHx8ICJmeCIpICsgInF1ZXVlIjsKICAgICAgICBxdWV1ZSA9IGRhdGFQcml2LmdldChlbGVtLCB0eXBlKTsKCiAgICAgICAgLy8gU3BlZWQgdXAgZGVxdWV1ZSBieSBnZXR0aW5nIG91dCBxdWlja2x5IGlmIHRoaXMgaXMganVzdCBhIGxvb2t1cAogICAgICAgIGlmIChkYXRhKSB7CiAgICAgICAgICBpZiAoIXF1ZXVlIHx8IEFycmF5LmlzQXJyYXkoZGF0YSkpIHsKICAgICAgICAgICAgcXVldWUgPSBkYXRhUHJpdi5hY2Nlc3MoZWxlbSwgdHlwZSwgalF1ZXJ5Lm1ha2VBcnJheShkYXRhKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBxdWV1ZS5wdXNoKGRhdGEpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcXVldWUgfHwgW107CiAgICAgIH0KICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB2YXIgcXVldWUgPSBqUXVlcnkucXVldWUoZWxlbSwgdHlwZSksCiAgICAgICAgc3RhcnRMZW5ndGggPSBxdWV1ZS5sZW5ndGgsCiAgICAgICAgZm4gPSBxdWV1ZS5zaGlmdCgpLAogICAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sIHR5cGUpLAogICAgICAgIG5leHQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBqUXVlcnkuZGVxdWV1ZShlbGVtLCB0eXBlKTsKICAgICAgICB9OwoKICAgICAgLy8gSWYgdGhlIGZ4IHF1ZXVlIGlzIGRlcXVldWVkLCBhbHdheXMgcmVtb3ZlIHRoZSBwcm9ncmVzcyBzZW50aW5lbAogICAgICBpZiAoZm4gPT09ICJpbnByb2dyZXNzIikgewogICAgICAgIGZuID0gcXVldWUuc2hpZnQoKTsKICAgICAgICBzdGFydExlbmd0aC0tOwogICAgICB9CiAgICAgIGlmIChmbikgewogICAgICAgIC8vIEFkZCBhIHByb2dyZXNzIHNlbnRpbmVsIHRvIHByZXZlbnQgdGhlIGZ4IHF1ZXVlIGZyb20gYmVpbmcKICAgICAgICAvLyBhdXRvbWF0aWNhbGx5IGRlcXVldWVkCiAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIpIHsKICAgICAgICAgIHF1ZXVlLnVuc2hpZnQoImlucHJvZ3Jlc3MiKTsKICAgICAgICB9CgogICAgICAgIC8vIENsZWFyIHVwIHRoZSBsYXN0IHF1ZXVlIHN0b3AgZnVuY3Rpb24KICAgICAgICBkZWxldGUgaG9va3Muc3RvcDsKICAgICAgICBmbi5jYWxsKGVsZW0sIG5leHQsIGhvb2tzKTsKICAgICAgfQogICAgICBpZiAoIXN0YXJ0TGVuZ3RoICYmIGhvb2tzKSB7CiAgICAgICAgaG9va3MuZW1wdHkuZmlyZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gTm90IHB1YmxpYyAtIGdlbmVyYXRlIGEgcXVldWVIb29rcyBvYmplY3QsIG9yIHJldHVybiB0aGUgY3VycmVudCBvbmUKICAgIF9xdWV1ZUhvb2tzOiBmdW5jdGlvbiAoZWxlbSwgdHlwZSkgewogICAgICB2YXIga2V5ID0gdHlwZSArICJxdWV1ZUhvb2tzIjsKICAgICAgcmV0dXJuIGRhdGFQcml2LmdldChlbGVtLCBrZXkpIHx8IGRhdGFQcml2LmFjY2VzcyhlbGVtLCBrZXksIHsKICAgICAgICBlbXB0eTogalF1ZXJ5LkNhbGxiYWNrcygib25jZSBtZW1vcnkiKS5hZGQoZnVuY3Rpb24gKCkgewogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sIFt0eXBlICsgInF1ZXVlIiwga2V5XSk7CiAgICAgICAgfSkKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBxdWV1ZTogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgdmFyIHNldHRlciA9IDI7CiAgICAgIGlmICh0eXBlb2YgdHlwZSAhPT0gInN0cmluZyIpIHsKICAgICAgICBkYXRhID0gdHlwZTsKICAgICAgICB0eXBlID0gImZ4IjsKICAgICAgICBzZXR0ZXItLTsKICAgICAgfQogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA8IHNldHRlcikgewogICAgICAgIHJldHVybiBqUXVlcnkucXVldWUodGhpc1swXSwgdHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRhdGEgPT09IHVuZGVmaW5lZCA/IHRoaXMgOiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBxdWV1ZSA9IGpRdWVyeS5xdWV1ZSh0aGlzLCB0eXBlLCBkYXRhKTsKCiAgICAgICAgLy8gRW5zdXJlIGEgaG9va3MgZm9yIHRoaXMgcXVldWUKICAgICAgICBqUXVlcnkuX3F1ZXVlSG9va3ModGhpcywgdHlwZSk7CiAgICAgICAgaWYgKHR5cGUgPT09ICJmeCIgJiYgcXVldWVbMF0gIT09ICJpbnByb2dyZXNzIikgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBkZXF1ZXVlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCB0eXBlKTsKICAgICAgfSk7CiAgICB9LAogICAgY2xlYXJRdWV1ZTogZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSB8fCAiZngiLCBbXSk7CiAgICB9LAogICAgLy8gR2V0IGEgcHJvbWlzZSByZXNvbHZlZCB3aGVuIHF1ZXVlcyBvZiBhIGNlcnRhaW4gdHlwZQogICAgLy8gYXJlIGVtcHRpZWQgKGZ4IGlzIHRoZSB0eXBlIGJ5IGRlZmF1bHQpCiAgICBwcm9taXNlOiBmdW5jdGlvbiAodHlwZSwgb2JqKSB7CiAgICAgIHZhciB0bXAsCiAgICAgICAgY291bnQgPSAxLAogICAgICAgIGRlZmVyID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgZWxlbWVudHMgPSB0aGlzLAogICAgICAgIGkgPSB0aGlzLmxlbmd0aCwKICAgICAgICByZXNvbHZlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCEgLS1jb3VudCkgewogICAgICAgICAgICBkZWZlci5yZXNvbHZlV2l0aChlbGVtZW50cywgW2VsZW1lbnRzXSk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIG9iaiA9IHR5cGU7CiAgICAgICAgdHlwZSA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgdG1wID0gZGF0YVByaXYuZ2V0KGVsZW1lbnRzW2ldLCB0eXBlICsgInF1ZXVlSG9va3MiKTsKICAgICAgICBpZiAodG1wICYmIHRtcC5lbXB0eSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICAgIHRtcC5lbXB0eS5hZGQocmVzb2x2ZSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJlc29sdmUoKTsKICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2Uob2JqKTsKICAgIH0KICB9KTsKICB2YXIgcG51bSA9IC9bKy1dPyg/OlxkKlwufClcZCsoPzpbZUVdWystXT9cZCt8KS8uc291cmNlOwogIHZhciByY3NzTnVtID0gbmV3IFJlZ0V4cCgiXig/OihbKy1dKT18KSgiICsgcG51bSArICIpKFthLXolXSopJCIsICJpIik7CiAgdmFyIGNzc0V4cGFuZCA9IFsiVG9wIiwgIlJpZ2h0IiwgIkJvdHRvbSIsICJMZWZ0Il07CiAgdmFyIGRvY3VtZW50RWxlbWVudCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKICB2YXIgaXNBdHRhY2hlZCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgIHJldHVybiBqUXVlcnkuY29udGFpbnMoZWxlbS5vd25lckRvY3VtZW50LCBlbGVtKTsKICAgIH0sCiAgICBjb21wb3NlZCA9IHsKICAgICAgY29tcG9zZWQ6IHRydWUKICAgIH07CgogIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSssIEVkZ2UgMTIgLSAxOCssIGlPUyAxMC4wIC0gMTAuMiBvbmx5CiAgLy8gQ2hlY2sgYXR0YWNobWVudCBhY3Jvc3Mgc2hhZG93IERPTSBib3VuZGFyaWVzIHdoZW4gcG9zc2libGUgKGdoLTM1MDQpCiAgLy8gU3VwcG9ydDogaU9TIDEwLjAtMTAuMiBvbmx5CiAgLy8gRWFybHkgaU9TIDEwIHZlcnNpb25zIHN1cHBvcnQgYGF0dGFjaFNoYWRvd2AgYnV0IG5vdCBgZ2V0Um9vdE5vZGVgLAogIC8vIGxlYWRpbmcgdG8gZXJyb3JzLiBXZSBuZWVkIHRvIGNoZWNrIGZvciBgZ2V0Um9vdE5vZGVgLgogIGlmIChkb2N1bWVudEVsZW1lbnQuZ2V0Um9vdE5vZGUpIHsKICAgIGlzQXR0YWNoZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgICByZXR1cm4galF1ZXJ5LmNvbnRhaW5zKGVsZW0ub3duZXJEb2N1bWVudCwgZWxlbSkgfHwgZWxlbS5nZXRSb290Tm9kZShjb21wb3NlZCkgPT09IGVsZW0ub3duZXJEb2N1bWVudDsKICAgIH07CiAgfQogIHZhciBpc0hpZGRlbldpdGhpblRyZWUgPSBmdW5jdGlvbiAoZWxlbSwgZWwpIHsKICAgIC8vIGlzSGlkZGVuV2l0aGluVHJlZSBtaWdodCBiZSBjYWxsZWQgZnJvbSBqUXVlcnkjZmlsdGVyIGZ1bmN0aW9uOwogICAgLy8gaW4gdGhhdCBjYXNlLCBlbGVtZW50IHdpbGwgYmUgc2Vjb25kIGFyZ3VtZW50CiAgICBlbGVtID0gZWwgfHwgZWxlbTsKCiAgICAvLyBJbmxpbmUgc3R5bGUgdHJ1bXBzIGFsbAogICAgcmV0dXJuIGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIm5vbmUiIHx8IGVsZW0uc3R5bGUuZGlzcGxheSA9PT0gIiIgJiYKICAgIC8vIE90aGVyd2lzZSwgY2hlY2sgY29tcHV0ZWQgc3R5bGUKICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00MyAtIDQ1CiAgICAvLyBEaXNjb25uZWN0ZWQgZWxlbWVudHMgY2FuIGhhdmUgY29tcHV0ZWQgZGlzcGxheTogbm9uZSwgc28gZmlyc3QgY29uZmlybSB0aGF0IGVsZW0gaXMKICAgIC8vIGluIHRoZSBkb2N1bWVudC4KICAgIGlzQXR0YWNoZWQoZWxlbSkgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIpID09PSAibm9uZSI7CiAgfTsKICBmdW5jdGlvbiBhZGp1c3RDU1MoZWxlbSwgcHJvcCwgdmFsdWVQYXJ0cywgdHdlZW4pIHsKICAgIHZhciBhZGp1c3RlZCwKICAgICAgc2NhbGUsCiAgICAgIG1heEl0ZXJhdGlvbnMgPSAyMCwKICAgICAgY3VycmVudFZhbHVlID0gdHdlZW4gPyBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHR3ZWVuLmN1cigpOwogICAgICB9IDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBqUXVlcnkuY3NzKGVsZW0sIHByb3AsICIiKTsKICAgICAgfSwKICAgICAgaW5pdGlhbCA9IGN1cnJlbnRWYWx1ZSgpLAogICAgICB1bml0ID0gdmFsdWVQYXJ0cyAmJiB2YWx1ZVBhcnRzWzNdIHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gIiIgOiAicHgiKSwKICAgICAgLy8gU3RhcnRpbmcgdmFsdWUgY29tcHV0YXRpb24gaXMgcmVxdWlyZWQgZm9yIHBvdGVudGlhbCB1bml0IG1pc21hdGNoZXMKICAgICAgaW5pdGlhbEluVW5pdCA9IGVsZW0ubm9kZVR5cGUgJiYgKGpRdWVyeS5jc3NOdW1iZXJbcHJvcF0gfHwgdW5pdCAhPT0gInB4IiAmJiAraW5pdGlhbCkgJiYgcmNzc051bS5leGVjKGpRdWVyeS5jc3MoZWxlbSwgcHJvcCkpOwogICAgaWYgKGluaXRpYWxJblVuaXQgJiYgaW5pdGlhbEluVW5pdFszXSAhPT0gdW5pdCkgewogICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDw9NTQKICAgICAgLy8gSGFsdmUgdGhlIGl0ZXJhdGlvbiB0YXJnZXQgdmFsdWUgdG8gcHJldmVudCBpbnRlcmZlcmVuY2UgZnJvbSBDU1MgdXBwZXIgYm91bmRzIChnaC0yMTQ0KQogICAgICBpbml0aWFsID0gaW5pdGlhbCAvIDI7CgogICAgICAvLyBUcnVzdCB1bml0cyByZXBvcnRlZCBieSBqUXVlcnkuY3NzCiAgICAgIHVuaXQgPSB1bml0IHx8IGluaXRpYWxJblVuaXRbM107CgogICAgICAvLyBJdGVyYXRpdmVseSBhcHByb3hpbWF0ZSBmcm9tIGEgbm9uemVybyBzdGFydGluZyBwb2ludAogICAgICBpbml0aWFsSW5Vbml0ID0gK2luaXRpYWwgfHwgMTsKICAgICAgd2hpbGUgKG1heEl0ZXJhdGlvbnMtLSkgewogICAgICAgIC8vIEV2YWx1YXRlIGFuZCB1cGRhdGUgb3VyIGJlc3QgZ3Vlc3MgKGRvdWJsaW5nIGd1ZXNzZXMgdGhhdCB6ZXJvIG91dCkuCiAgICAgICAgLy8gRmluaXNoIGlmIHRoZSBzY2FsZSBlcXVhbHMgb3IgY3Jvc3NlcyAxIChtYWtpbmcgdGhlIG9sZCpuZXcgcHJvZHVjdCBub24tcG9zaXRpdmUpLgogICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBpbml0aWFsSW5Vbml0ICsgdW5pdCk7CiAgICAgICAgaWYgKCgxIC0gc2NhbGUpICogKDEgLSAoc2NhbGUgPSBjdXJyZW50VmFsdWUoKSAvIGluaXRpYWwgfHwgMC41KSkgPD0gMCkgewogICAgICAgICAgbWF4SXRlcmF0aW9ucyA9IDA7CiAgICAgICAgfQogICAgICAgIGluaXRpYWxJblVuaXQgPSBpbml0aWFsSW5Vbml0IC8gc2NhbGU7CiAgICAgIH0KICAgICAgaW5pdGlhbEluVW5pdCA9IGluaXRpYWxJblVuaXQgKiAyOwogICAgICBqUXVlcnkuc3R5bGUoZWxlbSwgcHJvcCwgaW5pdGlhbEluVW5pdCArIHVuaXQpOwoKICAgICAgLy8gTWFrZSBzdXJlIHdlIHVwZGF0ZSB0aGUgdHdlZW4gcHJvcGVydGllcyBsYXRlciBvbgogICAgICB2YWx1ZVBhcnRzID0gdmFsdWVQYXJ0cyB8fCBbXTsKICAgIH0KICAgIGlmICh2YWx1ZVBhcnRzKSB7CiAgICAgIGluaXRpYWxJblVuaXQgPSAraW5pdGlhbEluVW5pdCB8fCAraW5pdGlhbCB8fCAwOwoKICAgICAgLy8gQXBwbHkgcmVsYXRpdmUgb2Zmc2V0ICgrPS8tPSkgaWYgc3BlY2lmaWVkCiAgICAgIGFkanVzdGVkID0gdmFsdWVQYXJ0c1sxXSA/IGluaXRpYWxJblVuaXQgKyAodmFsdWVQYXJ0c1sxXSArIDEpICogdmFsdWVQYXJ0c1syXSA6ICt2YWx1ZVBhcnRzWzJdOwogICAgICBpZiAodHdlZW4pIHsKICAgICAgICB0d2Vlbi51bml0ID0gdW5pdDsKICAgICAgICB0d2Vlbi5zdGFydCA9IGluaXRpYWxJblVuaXQ7CiAgICAgICAgdHdlZW4uZW5kID0gYWRqdXN0ZWQ7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBhZGp1c3RlZDsKICB9CiAgdmFyIGRlZmF1bHREaXNwbGF5TWFwID0ge307CiAgZnVuY3Rpb24gZ2V0RGVmYXVsdERpc3BsYXkoZWxlbSkgewogICAgdmFyIHRlbXAsCiAgICAgIGRvYyA9IGVsZW0ub3duZXJEb2N1bWVudCwKICAgICAgbm9kZU5hbWUgPSBlbGVtLm5vZGVOYW1lLAogICAgICBkaXNwbGF5ID0gZGVmYXVsdERpc3BsYXlNYXBbbm9kZU5hbWVdOwogICAgaWYgKGRpc3BsYXkpIHsKICAgICAgcmV0dXJuIGRpc3BsYXk7CiAgICB9CiAgICB0ZW1wID0gZG9jLmJvZHkuYXBwZW5kQ2hpbGQoZG9jLmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpKTsKICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKHRlbXAsICJkaXNwbGF5Iik7CiAgICB0ZW1wLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGVtcCk7CiAgICBpZiAoZGlzcGxheSA9PT0gIm5vbmUiKSB7CiAgICAgIGRpc3BsYXkgPSAiYmxvY2siOwogICAgfQogICAgZGVmYXVsdERpc3BsYXlNYXBbbm9kZU5hbWVdID0gZGlzcGxheTsKICAgIHJldHVybiBkaXNwbGF5OwogIH0KICBmdW5jdGlvbiBzaG93SGlkZShlbGVtZW50cywgc2hvdykgewogICAgdmFyIGRpc3BsYXksCiAgICAgIGVsZW0sCiAgICAgIHZhbHVlcyA9IFtdLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IGVsZW1lbnRzLmxlbmd0aDsKCiAgICAvLyBEZXRlcm1pbmUgbmV3IGRpc3BsYXkgdmFsdWUgZm9yIGVsZW1lbnRzIHRoYXQgbmVlZCB0byBjaGFuZ2UKICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBlbGVtID0gZWxlbWVudHNbaW5kZXhdOwogICAgICBpZiAoIWVsZW0uc3R5bGUpIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQogICAgICBkaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5OwogICAgICBpZiAoc2hvdykgewogICAgICAgIC8vIFNpbmNlIHdlIGZvcmNlIHZpc2liaWxpdHkgdXBvbiBjYXNjYWRlLWhpZGRlbiBlbGVtZW50cywgYW4gaW1tZWRpYXRlIChhbmQgc2xvdykKICAgICAgICAvLyBjaGVjayBpcyByZXF1aXJlZCBpbiB0aGlzIGZpcnN0IGxvb3AgdW5sZXNzIHdlIGhhdmUgYSBub25lbXB0eSBkaXNwbGF5IHZhbHVlIChlaXRoZXIKICAgICAgICAvLyBpbmxpbmUgb3IgYWJvdXQtdG8tYmUtcmVzdG9yZWQpCiAgICAgICAgaWYgKGRpc3BsYXkgPT09ICJub25lIikgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGRhdGFQcml2LmdldChlbGVtLCAiZGlzcGxheSIpIHx8IG51bGw7CiAgICAgICAgICBpZiAoIXZhbHVlc1tpbmRleF0pIHsKICAgICAgICAgICAgZWxlbS5zdHlsZS5kaXNwbGF5ID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtLnN0eWxlLmRpc3BsYXkgPT09ICIiICYmIGlzSGlkZGVuV2l0aGluVHJlZShlbGVtKSkgewogICAgICAgICAgdmFsdWVzW2luZGV4XSA9IGdldERlZmF1bHREaXNwbGF5KGVsZW0pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoZGlzcGxheSAhPT0gIm5vbmUiKSB7CiAgICAgICAgICB2YWx1ZXNbaW5kZXhdID0gIm5vbmUiOwoKICAgICAgICAgIC8vIFJlbWVtYmVyIHdoYXQgd2UncmUgb3ZlcndyaXRpbmcKICAgICAgICAgIGRhdGFQcml2LnNldChlbGVtLCAiZGlzcGxheSIsIGRpc3BsYXkpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIFNldCB0aGUgZGlzcGxheSBvZiB0aGUgZWxlbWVudHMgaW4gYSBzZWNvbmQgbG9vcCB0byBhdm9pZCBjb25zdGFudCByZWZsb3cKICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICBpZiAodmFsdWVzW2luZGV4XSAhPSBudWxsKSB7CiAgICAgICAgZWxlbWVudHNbaW5kZXhdLnN0eWxlLmRpc3BsYXkgPSB2YWx1ZXNbaW5kZXhdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gZWxlbWVudHM7CiAgfQogIGpRdWVyeS5mbi5leHRlbmQoewogICAgc2hvdzogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2hvd0hpZGUodGhpcywgdHJ1ZSk7CiAgICB9LAogICAgaGlkZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gc2hvd0hpZGUodGhpcyk7CiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgICAgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gImJvb2xlYW4iKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoaXNIaWRkZW5XaXRoaW5UcmVlKHRoaXMpKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuc2hvdygpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBqUXVlcnkodGhpcykuaGlkZSgpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgdmFyIHJjaGVja2FibGVUeXBlID0gL14oPzpjaGVja2JveHxyYWRpbykkL2k7CiAgdmFyIHJ0YWdOYW1lID0gLzwoW2Etel1bXlwvXDA+XHgyMFx0XHJcblxmXSopL2k7CiAgdmFyIHJzY3JpcHRUeXBlID0gL14kfF5tb2R1bGUkfFwvKD86amF2YXxlY21hKXNjcmlwdC9pOwogIChmdW5jdGlvbiAoKSB7CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgIGRpdiA9IGZyYWdtZW50LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpKSwKICAgICAgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHkKICAgIC8vIENoZWNrIHN0YXRlIGxvc3QgaWYgdGhlIG5hbWUgaXMgc2V0ICh0cmFjLTExMjE3KQogICAgLy8gU3VwcG9ydDogV2luZG93cyBXZWIgQXBwcyAoV1dBKQogICAgLy8gYG5hbWVgIGFuZCBgdHlwZWAgbXVzdCB1c2UgLnNldEF0dHJpYnV0ZSBmb3IgV1dBICh0cmFjLTE0OTAxKQogICAgaW5wdXQuc2V0QXR0cmlidXRlKCJ0eXBlIiwgInJhZGlvIik7CiAgICBpbnB1dC5zZXRBdHRyaWJ1dGUoImNoZWNrZWQiLCAiY2hlY2tlZCIpOwogICAgaW5wdXQuc2V0QXR0cmlidXRlKCJuYW1lIiwgInQiKTsKICAgIGRpdi5hcHBlbmRDaGlsZChpbnB1dCk7CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMSBvbmx5CiAgICAvLyBPbGRlciBXZWJLaXQgZG9lc24ndCBjbG9uZSBjaGVja2VkIHN0YXRlIGNvcnJlY3RseSBpbiBmcmFnbWVudHMKICAgIHN1cHBvcnQuY2hlY2tDbG9uZSA9IGRpdi5jbG9uZU5vZGUodHJ1ZSkuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5jaGVja2VkOwoKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogICAgLy8gTWFrZSBzdXJlIHRleHRhcmVhIChhbmQgY2hlY2tib3gpIGRlZmF1bHRWYWx1ZSBpcyBwcm9wZXJseSBjbG9uZWQKICAgIGRpdi5pbm5lckhUTUwgPSAiPHRleHRhcmVhPng8L3RleHRhcmVhPiI7CiAgICBzdXBwb3J0Lm5vQ2xvbmVDaGVja2VkID0gISFkaXYuY2xvbmVOb2RlKHRydWUpLmxhc3RDaGlsZC5kZWZhdWx0VmFsdWU7CgogICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgIC8vIElFIDw9OSByZXBsYWNlcyA8b3B0aW9uPiB0YWdzIHdpdGggdGhlaXIgY29udGVudHMgd2hlbiBpbnNlcnRlZCBvdXRzaWRlIG9mCiAgICAvLyB0aGUgc2VsZWN0IGVsZW1lbnQuCiAgICBkaXYuaW5uZXJIVE1MID0gIjxvcHRpb24+PC9vcHRpb24+IjsKICAgIHN1cHBvcnQub3B0aW9uID0gISFkaXYubGFzdENoaWxkOwogIH0pKCk7CgogIC8vIFdlIGhhdmUgdG8gY2xvc2UgdGhlc2UgdGFncyB0byBzdXBwb3J0IFhIVE1MICh0cmFjLTEzMjAwKQogIHZhciB3cmFwTWFwID0gewogICAgLy8gWEhUTUwgcGFyc2VycyBkbyBub3QgbWFnaWNhbGx5IGluc2VydCBlbGVtZW50cyBpbiB0aGUKICAgIC8vIHNhbWUgd2F5IHRoYXQgdGFnIHNvdXAgcGFyc2VycyBkby4gU28gd2UgY2Fubm90IHNob3J0ZW4KICAgIC8vIHRoaXMgYnkgb21pdHRpbmcgPHRib2R5PiBvciBvdGhlciByZXF1aXJlZCBlbGVtZW50cy4KICAgIHRoZWFkOiBbMSwgIjx0YWJsZT4iLCAiPC90YWJsZT4iXSwKICAgIGNvbDogWzIsICI8dGFibGU+PGNvbGdyb3VwPiIsICI8L2NvbGdyb3VwPjwvdGFibGU+Il0sCiAgICB0cjogWzIsICI8dGFibGU+PHRib2R5PiIsICI8L3Rib2R5PjwvdGFibGU+Il0sCiAgICB0ZDogWzMsICI8dGFibGU+PHRib2R5Pjx0cj4iLCAiPC90cj48L3Rib2R5PjwvdGFibGU+Il0sCiAgICBfZGVmYXVsdDogWzAsICIiLCAiIl0KICB9OwogIHdyYXBNYXAudGJvZHkgPSB3cmFwTWFwLnRmb290ID0gd3JhcE1hcC5jb2xncm91cCA9IHdyYXBNYXAuY2FwdGlvbiA9IHdyYXBNYXAudGhlYWQ7CiAgd3JhcE1hcC50aCA9IHdyYXBNYXAudGQ7CgogIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgaWYgKCFzdXBwb3J0Lm9wdGlvbikgewogICAgd3JhcE1hcC5vcHRncm91cCA9IHdyYXBNYXAub3B0aW9uID0gWzEsICI8c2VsZWN0IG11bHRpcGxlPSdtdWx0aXBsZSc+IiwgIjwvc2VsZWN0PiJdOwogIH0KICBmdW5jdGlvbiBnZXRBbGwoY29udGV4dCwgdGFnKSB7CiAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSBvbmx5CiAgICAvLyBVc2UgdHlwZW9mIHRvIGF2b2lkIHplcm8tYXJndW1lbnQgbWV0aG9kIGludm9jYXRpb24gb24gaG9zdCBvYmplY3RzICh0cmFjLTE1MTUxKQogICAgdmFyIHJldDsKICAgIGlmICh0eXBlb2YgY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcgfHwgIioiKTsKICAgIH0gZWxzZSBpZiAodHlwZW9mIGNvbnRleHQucXVlcnlTZWxlY3RvckFsbCAhPT0gInVuZGVmaW5lZCIpIHsKICAgICAgcmV0ID0gY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKHRhZyB8fCAiKiIpOwogICAgfSBlbHNlIHsKICAgICAgcmV0ID0gW107CiAgICB9CiAgICBpZiAodGFnID09PSB1bmRlZmluZWQgfHwgdGFnICYmIG5vZGVOYW1lKGNvbnRleHQsIHRhZykpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbY29udGV4dF0sIHJldCk7CiAgICB9CiAgICByZXR1cm4gcmV0OwogIH0KCiAgLy8gTWFyayBzY3JpcHRzIGFzIGhhdmluZyBhbHJlYWR5IGJlZW4gZXZhbHVhdGVkCiAgZnVuY3Rpb24gc2V0R2xvYmFsRXZhbChlbGVtcywgcmVmRWxlbWVudHMpIHsKICAgIHZhciBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGRhdGFQcml2LnNldChlbGVtc1tpXSwgImdsb2JhbEV2YWwiLCAhcmVmRWxlbWVudHMgfHwgZGF0YVByaXYuZ2V0KHJlZkVsZW1lbnRzW2ldLCAiZ2xvYmFsRXZhbCIpKTsKICAgIH0KICB9CiAgdmFyIHJodG1sID0gLzx8JiM/XHcrOy87CiAgZnVuY3Rpb24gYnVpbGRGcmFnbWVudChlbGVtcywgY29udGV4dCwgc2NyaXB0cywgc2VsZWN0aW9uLCBpZ25vcmVkKSB7CiAgICB2YXIgZWxlbSwKICAgICAgdG1wLAogICAgICB0YWcsCiAgICAgIHdyYXAsCiAgICAgIGF0dGFjaGVkLAogICAgICBqLAogICAgICBmcmFnbWVudCA9IGNvbnRleHQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICBub2RlcyA9IFtdLAogICAgICBpID0gMCwKICAgICAgbCA9IGVsZW1zLmxlbmd0aDsKICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgIGVsZW0gPSBlbGVtc1tpXTsKICAgICAgaWYgKGVsZW0gfHwgZWxlbSA9PT0gMCkgewogICAgICAgIC8vIEFkZCBub2RlcyBkaXJlY3RseQogICAgICAgIGlmICh0b1R5cGUoZWxlbSkgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHksIFBoYW50b21KUyAxIG9ubHkKICAgICAgICAgIC8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgICAgICAgIGpRdWVyeS5tZXJnZShub2RlcywgZWxlbS5ub2RlVHlwZSA/IFtlbGVtXSA6IGVsZW0pOwoKICAgICAgICAgIC8vIENvbnZlcnQgbm9uLWh0bWwgaW50byBhIHRleHQgbm9kZQogICAgICAgIH0gZWxzZSBpZiAoIXJodG1sLnRlc3QoZWxlbSkpIHsKICAgICAgICAgIG5vZGVzLnB1c2goY29udGV4dC5jcmVhdGVUZXh0Tm9kZShlbGVtKSk7CgogICAgICAgICAgLy8gQ29udmVydCBodG1sIGludG8gRE9NIG5vZGVzCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRtcCA9IHRtcCB8fCBmcmFnbWVudC5hcHBlbmRDaGlsZChjb250ZXh0LmNyZWF0ZUVsZW1lbnQoImRpdiIpKTsKCiAgICAgICAgICAvLyBEZXNlcmlhbGl6ZSBhIHN0YW5kYXJkIHJlcHJlc2VudGF0aW9uCiAgICAgICAgICB0YWcgPSAocnRhZ05hbWUuZXhlYyhlbGVtKSB8fCBbIiIsICIiXSlbMV0udG9Mb3dlckNhc2UoKTsKICAgICAgICAgIHdyYXAgPSB3cmFwTWFwW3RhZ10gfHwgd3JhcE1hcC5fZGVmYXVsdDsKICAgICAgICAgIHRtcC5pbm5lckhUTUwgPSB3cmFwWzFdICsgalF1ZXJ5Lmh0bWxQcmVmaWx0ZXIoZWxlbSkgKyB3cmFwWzJdOwoKICAgICAgICAgIC8vIERlc2NlbmQgdGhyb3VnaCB3cmFwcGVycyB0byB0aGUgcmlnaHQgY29udGVudAogICAgICAgICAgaiA9IHdyYXBbMF07CiAgICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICAgIHRtcCA9IHRtcC5sYXN0Q2hpbGQ7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAgICAgICAvLyBwdXNoLmFwcGx5KF8sIGFycmF5bGlrZSkgdGhyb3dzIG9uIGFuY2llbnQgV2ViS2l0CiAgICAgICAgICBqUXVlcnkubWVyZ2Uobm9kZXMsIHRtcC5jaGlsZE5vZGVzKTsKCiAgICAgICAgICAvLyBSZW1lbWJlciB0aGUgdG9wLWxldmVsIGNvbnRhaW5lcgogICAgICAgICAgdG1wID0gZnJhZ21lbnQuZmlyc3RDaGlsZDsKCiAgICAgICAgICAvLyBFbnN1cmUgdGhlIGNyZWF0ZWQgbm9kZXMgYXJlIG9ycGhhbmVkICh0cmFjLTEyMzkyKQogICAgICAgICAgdG1wLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gUmVtb3ZlIHdyYXBwZXIgZnJvbSBmcmFnbWVudAogICAgZnJhZ21lbnQudGV4dENvbnRlbnQgPSAiIjsKICAgIGkgPSAwOwogICAgd2hpbGUgKGVsZW0gPSBub2Rlc1tpKytdKSB7CiAgICAgIC8vIFNraXAgZWxlbWVudHMgYWxyZWFkeSBpbiB0aGUgY29udGV4dCBjb2xsZWN0aW9uICh0cmFjLTQwODcpCiAgICAgIGlmIChzZWxlY3Rpb24gJiYgalF1ZXJ5LmluQXJyYXkoZWxlbSwgc2VsZWN0aW9uKSA+IC0xKSB7CiAgICAgICAgaWYgKGlnbm9yZWQpIHsKICAgICAgICAgIGlnbm9yZWQucHVzaChlbGVtKTsKICAgICAgICB9CiAgICAgICAgY29udGludWU7CiAgICAgIH0KICAgICAgYXR0YWNoZWQgPSBpc0F0dGFjaGVkKGVsZW0pOwoKICAgICAgLy8gQXBwZW5kIHRvIGZyYWdtZW50CiAgICAgIHRtcCA9IGdldEFsbChmcmFnbWVudC5hcHBlbmRDaGlsZChlbGVtKSwgInNjcmlwdCIpOwoKICAgICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgICBpZiAoYXR0YWNoZWQpIHsKICAgICAgICBzZXRHbG9iYWxFdmFsKHRtcCk7CiAgICAgIH0KCiAgICAgIC8vIENhcHR1cmUgZXhlY3V0YWJsZXMKICAgICAgaWYgKHNjcmlwdHMpIHsKICAgICAgICBqID0gMDsKICAgICAgICB3aGlsZSAoZWxlbSA9IHRtcFtqKytdKSB7CiAgICAgICAgICBpZiAocnNjcmlwdFR5cGUudGVzdChlbGVtLnR5cGUgfHwgIiIpKSB7CiAgICAgICAgICAgIHNjcmlwdHMucHVzaChlbGVtKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBmcmFnbWVudDsKICB9CiAgdmFyIHJ0eXBlbmFtZXNwYWNlID0gL14oW14uXSopKD86XC4oLispfCkvOwogIGZ1bmN0aW9uIHJldHVyblRydWUoKSB7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgZnVuY3Rpb24gcmV0dXJuRmFsc2UoKSB7CiAgICByZXR1cm4gZmFsc2U7CiAgfQoKICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKICAvLyBmb2N1cygpIGFuZCBibHVyKCkgYXJlIGFzeW5jaHJvbm91cywgZXhjZXB0IHdoZW4gdGhleSBhcmUgbm8tb3AuCiAgLy8gU28gZXhwZWN0IGZvY3VzIHRvIGJlIHN5bmNocm9ub3VzIHdoZW4gdGhlIGVsZW1lbnQgaXMgYWxyZWFkeSBhY3RpdmUsCiAgLy8gYW5kIGJsdXIgdG8gYmUgc3luY2hyb25vdXMgd2hlbiB0aGUgZWxlbWVudCBpcyBub3QgYWxyZWFkeSBhY3RpdmUuCiAgLy8gKGZvY3VzIGFuZCBibHVyIGFyZSBhbHdheXMgc3luY2hyb25vdXMgaW4gb3RoZXIgc3VwcG9ydGVkIGJyb3dzZXJzLAogIC8vIHRoaXMganVzdCBkZWZpbmVzIHdoZW4gd2UgY2FuIGNvdW50IG9uIGl0KS4KICBmdW5jdGlvbiBleHBlY3RTeW5jKGVsZW0sIHR5cGUpIHsKICAgIHJldHVybiBlbGVtID09PSBzYWZlQWN0aXZlRWxlbWVudCgpID09PSAodHlwZSA9PT0gImZvY3VzIik7CiAgfQoKICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogIC8vIEFjY2Vzc2luZyBkb2N1bWVudC5hY3RpdmVFbGVtZW50IGNhbiB0aHJvdyB1bmV4cGVjdGVkbHkKICAvLyBodHRwczovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvMTMzOTMKICBmdW5jdGlvbiBzYWZlQWN0aXZlRWxlbWVudCgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgfSBjYXRjaCAoZXJyKSB7fQogIH0KICBmdW5jdGlvbiBvbihlbGVtLCB0eXBlcywgc2VsZWN0b3IsIGRhdGEsIGZuLCBvbmUpIHsKICAgIHZhciBvcmlnRm4sIHR5cGU7CgogICAgLy8gVHlwZXMgY2FuIGJlIGEgbWFwIG9mIHR5cGVzL2hhbmRsZXJzCiAgICBpZiAodHlwZW9mIHR5cGVzID09PSAib2JqZWN0IikgewogICAgICAvLyAoIHR5cGVzLU9iamVjdCwgc2VsZWN0b3IsIGRhdGEgKQogICAgICBpZiAodHlwZW9mIHNlbGVjdG9yICE9PSAic3RyaW5nIikgewogICAgICAgIC8vICggdHlwZXMtT2JqZWN0LCBkYXRhICkKICAgICAgICBkYXRhID0gZGF0YSB8fCBzZWxlY3RvcjsKICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBmb3IgKHR5cGUgaW4gdHlwZXMpIHsKICAgICAgICBvbihlbGVtLCB0eXBlLCBzZWxlY3RvciwgZGF0YSwgdHlwZXNbdHlwZV0sIG9uZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW07CiAgICB9CiAgICBpZiAoZGF0YSA9PSBudWxsICYmIGZuID09IG51bGwpIHsKICAgICAgLy8gKCB0eXBlcywgZm4gKQogICAgICBmbiA9IHNlbGVjdG9yOwogICAgICBkYXRhID0gc2VsZWN0b3IgPSB1bmRlZmluZWQ7CiAgICB9IGVsc2UgaWYgKGZuID09IG51bGwpIHsKICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciA9PT0gInN0cmluZyIpIHsKICAgICAgICAvLyAoIHR5cGVzLCBzZWxlY3RvciwgZm4gKQogICAgICAgIGZuID0gZGF0YTsKICAgICAgICBkYXRhID0gdW5kZWZpbmVkOwogICAgICB9IGVsc2UgewogICAgICAgIC8vICggdHlwZXMsIGRhdGEsIGZuICkKICAgICAgICBmbiA9IGRhdGE7CiAgICAgICAgZGF0YSA9IHNlbGVjdG9yOwogICAgICAgIHNlbGVjdG9yID0gdW5kZWZpbmVkOwogICAgICB9CiAgICB9CiAgICBpZiAoZm4gPT09IGZhbHNlKSB7CiAgICAgIGZuID0gcmV0dXJuRmFsc2U7CiAgICB9IGVsc2UgaWYgKCFmbikgewogICAgICByZXR1cm4gZWxlbTsKICAgIH0KICAgIGlmIChvbmUgPT09IDEpIHsKICAgICAgb3JpZ0ZuID0gZm47CiAgICAgIGZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgLy8gQ2FuIHVzZSBhbiBlbXB0eSBzZXQsIHNpbmNlIGV2ZW50IGNvbnRhaW5zIHRoZSBpbmZvCiAgICAgICAgalF1ZXJ5KCkub2ZmKGV2ZW50KTsKICAgICAgICByZXR1cm4gb3JpZ0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CgogICAgICAvLyBVc2Ugc2FtZSBndWlkIHNvIGNhbGxlciBjYW4gcmVtb3ZlIHVzaW5nIG9yaWdGbgogICAgICBmbi5ndWlkID0gb3JpZ0ZuLmd1aWQgfHwgKG9yaWdGbi5ndWlkID0galF1ZXJ5Lmd1aWQrKyk7CiAgICB9CiAgICByZXR1cm4gZWxlbS5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgalF1ZXJ5LmV2ZW50LmFkZCh0aGlzLCB0eXBlcywgZm4sIGRhdGEsIHNlbGVjdG9yKTsKICAgIH0pOwogIH0KCiAgLyoKICAgKiBIZWxwZXIgZnVuY3Rpb25zIGZvciBtYW5hZ2luZyBldmVudHMgLS0gbm90IHBhcnQgb2YgdGhlIHB1YmxpYyBpbnRlcmZhY2UuCiAgICogUHJvcHMgdG8gRGVhbiBFZHdhcmRzJyBhZGRFdmVudCBsaWJyYXJ5IGZvciBtYW55IG9mIHRoZSBpZGVhcy4KICAgKi8KICBqUXVlcnkuZXZlbnQgPSB7CiAgICBnbG9iYWw6IHt9LAogICAgYWRkOiBmdW5jdGlvbiAoZWxlbSwgdHlwZXMsIGhhbmRsZXIsIGRhdGEsIHNlbGVjdG9yKSB7CiAgICAgIHZhciBoYW5kbGVPYmpJbiwKICAgICAgICBldmVudEhhbmRsZSwKICAgICAgICB0bXAsCiAgICAgICAgZXZlbnRzLAogICAgICAgIHQsCiAgICAgICAgaGFuZGxlT2JqLAogICAgICAgIHNwZWNpYWwsCiAgICAgICAgaGFuZGxlcnMsCiAgICAgICAgdHlwZSwKICAgICAgICBuYW1lc3BhY2VzLAogICAgICAgIG9yaWdUeXBlLAogICAgICAgIGVsZW1EYXRhID0gZGF0YVByaXYuZ2V0KGVsZW0pOwoKICAgICAgLy8gT25seSBhdHRhY2ggZXZlbnRzIHRvIG9iamVjdHMgdGhhdCBhY2NlcHQgZGF0YQogICAgICBpZiAoIWFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIENhbGxlciBjYW4gcGFzcyBpbiBhbiBvYmplY3Qgb2YgY3VzdG9tIGRhdGEgaW4gbGlldSBvZiB0aGUgaGFuZGxlcgogICAgICBpZiAoaGFuZGxlci5oYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlT2JqSW4gPSBoYW5kbGVyOwogICAgICAgIGhhbmRsZXIgPSBoYW5kbGVPYmpJbi5oYW5kbGVyOwogICAgICAgIHNlbGVjdG9yID0gaGFuZGxlT2JqSW4uc2VsZWN0b3I7CiAgICAgIH0KCiAgICAgIC8vIEVuc3VyZSB0aGF0IGludmFsaWQgc2VsZWN0b3JzIHRocm93IGV4Y2VwdGlvbnMgYXQgYXR0YWNoIHRpbWUKICAgICAgLy8gRXZhbHVhdGUgYWdhaW5zdCBkb2N1bWVudEVsZW1lbnQgaW4gY2FzZSBlbGVtIGlzIGEgbm9uLWVsZW1lbnQgbm9kZSAoZS5nLiwgZG9jdW1lbnQpCiAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgIGpRdWVyeS5maW5kLm1hdGNoZXNTZWxlY3Rvcihkb2N1bWVudEVsZW1lbnQsIHNlbGVjdG9yKTsKICAgICAgfQoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGhhbmRsZXIgaGFzIGEgdW5pcXVlIElELCB1c2VkIHRvIGZpbmQvcmVtb3ZlIGl0IGxhdGVyCiAgICAgIGlmICghaGFuZGxlci5ndWlkKSB7CiAgICAgICAgaGFuZGxlci5ndWlkID0galF1ZXJ5Lmd1aWQrKzsKICAgICAgfQoKICAgICAgLy8gSW5pdCB0aGUgZWxlbWVudCdzIGV2ZW50IHN0cnVjdHVyZSBhbmQgbWFpbiBoYW5kbGVyLCBpZiB0aGlzIGlzIHRoZSBmaXJzdAogICAgICBpZiAoIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZWxlbURhdGEuZXZlbnRzID0gT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgfQogICAgICBpZiAoIShldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSkpIHsKICAgICAgICBldmVudEhhbmRsZSA9IGVsZW1EYXRhLmhhbmRsZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAvLyBEaXNjYXJkIHRoZSBzZWNvbmQgZXZlbnQgb2YgYSBqUXVlcnkuZXZlbnQudHJpZ2dlcigpIGFuZAogICAgICAgICAgLy8gd2hlbiBhbiBldmVudCBpcyBjYWxsZWQgYWZ0ZXIgYSBwYWdlIGhhcyB1bmxvYWRlZAogICAgICAgICAgcmV0dXJuIHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiICYmIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgIT09IGUudHlwZSA/IGpRdWVyeS5ldmVudC5kaXNwYXRjaC5hcHBseShlbGVtLCBhcmd1bWVudHMpIDogdW5kZWZpbmVkOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIEhhbmRsZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IGEgc3BhY2UKICAgICAgdHlwZXMgPSAodHlwZXMgfHwgIiIpLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFsiIl07CiAgICAgIHQgPSB0eXBlcy5sZW5ndGg7CiAgICAgIHdoaWxlICh0LS0pIHsKICAgICAgICB0bXAgPSBydHlwZW5hbWVzcGFjZS5leGVjKHR5cGVzW3RdKSB8fCBbXTsKICAgICAgICB0eXBlID0gb3JpZ1R5cGUgPSB0bXBbMV07CiAgICAgICAgbmFtZXNwYWNlcyA9ICh0bXBbMl0gfHwgIiIpLnNwbGl0KCIuIikuc29ydCgpOwoKICAgICAgICAvLyBUaGVyZSAqbXVzdCogYmUgYSB0eXBlLCBubyBhdHRhY2hpbmcgbmFtZXNwYWNlLW9ubHkgaGFuZGxlcnMKICAgICAgICBpZiAoIXR5cGUpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgZXZlbnQgY2hhbmdlcyBpdHMgdHlwZSwgdXNlIHRoZSBzcGVjaWFsIGV2ZW50IGhhbmRsZXJzIGZvciB0aGUgY2hhbmdlZCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwoKICAgICAgICAvLyBJZiBzZWxlY3RvciBkZWZpbmVkLCBkZXRlcm1pbmUgc3BlY2lhbCBldmVudCBhcGkgdHlwZSwgb3RoZXJ3aXNlIGdpdmVuIHR5cGUKICAgICAgICB0eXBlID0gKHNlbGVjdG9yID8gc3BlY2lhbC5kZWxlZ2F0ZVR5cGUgOiBzcGVjaWFsLmJpbmRUeXBlKSB8fCB0eXBlOwoKICAgICAgICAvLyBVcGRhdGUgc3BlY2lhbCBiYXNlZCBvbiBuZXdseSByZXNldCB0eXBlCiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwoKICAgICAgICAvLyBoYW5kbGVPYmogaXMgcGFzc2VkIHRvIGFsbCBldmVudCBoYW5kbGVycwogICAgICAgIGhhbmRsZU9iaiA9IGpRdWVyeS5leHRlbmQoewogICAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICAgIG9yaWdUeXBlOiBvcmlnVHlwZSwKICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICBoYW5kbGVyOiBoYW5kbGVyLAogICAgICAgICAgZ3VpZDogaGFuZGxlci5ndWlkLAogICAgICAgICAgc2VsZWN0b3I6IHNlbGVjdG9yLAogICAgICAgICAgbmVlZHNDb250ZXh0OiBzZWxlY3RvciAmJiBqUXVlcnkuZXhwci5tYXRjaC5uZWVkc0NvbnRleHQudGVzdChzZWxlY3RvciksCiAgICAgICAgICBuYW1lc3BhY2U6IG5hbWVzcGFjZXMuam9pbigiLiIpCiAgICAgICAgfSwgaGFuZGxlT2JqSW4pOwoKICAgICAgICAvLyBJbml0IHRoZSBldmVudCBoYW5kbGVyIHF1ZXVlIGlmIHdlJ3JlIHRoZSBmaXJzdAogICAgICAgIGlmICghKGhhbmRsZXJzID0gZXZlbnRzW3R5cGVdKSkgewogICAgICAgICAgaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gPSBbXTsKICAgICAgICAgIGhhbmRsZXJzLmRlbGVnYXRlQ291bnQgPSAwOwoKICAgICAgICAgIC8vIE9ubHkgdXNlIGFkZEV2ZW50TGlzdGVuZXIgaWYgdGhlIHNwZWNpYWwgZXZlbnRzIGhhbmRsZXIgcmV0dXJucyBmYWxzZQogICAgICAgICAgaWYgKCFzcGVjaWFsLnNldHVwIHx8IHNwZWNpYWwuc2V0dXAuY2FsbChlbGVtLCBkYXRhLCBuYW1lc3BhY2VzLCBldmVudEhhbmRsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGlmIChlbGVtLmFkZEV2ZW50TGlzdGVuZXIpIHsKICAgICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgZXZlbnRIYW5kbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChzcGVjaWFsLmFkZCkgewogICAgICAgICAgc3BlY2lhbC5hZGQuY2FsbChlbGVtLCBoYW5kbGVPYmopOwogICAgICAgICAgaWYgKCFoYW5kbGVPYmouaGFuZGxlci5ndWlkKSB7CiAgICAgICAgICAgIGhhbmRsZU9iai5oYW5kbGVyLmd1aWQgPSBoYW5kbGVyLmd1aWQ7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgdG8gdGhlIGVsZW1lbnQncyBoYW5kbGVyIGxpc3QsIGRlbGVnYXRlcyBpbiBmcm9udAogICAgICAgIGlmIChzZWxlY3RvcikgewogICAgICAgICAgaGFuZGxlcnMuc3BsaWNlKGhhbmRsZXJzLmRlbGVnYXRlQ291bnQrKywgMCwgaGFuZGxlT2JqKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGFuZGxlcnMucHVzaChoYW5kbGVPYmopOwogICAgICAgIH0KCiAgICAgICAgLy8gS2VlcCB0cmFjayBvZiB3aGljaCBldmVudHMgaGF2ZSBldmVyIGJlZW4gdXNlZCwgZm9yIGV2ZW50IG9wdGltaXphdGlvbgogICAgICAgIGpRdWVyeS5ldmVudC5nbG9iYWxbdHlwZV0gPSB0cnVlOwogICAgICB9CiAgICB9LAogICAgLy8gRGV0YWNoIGFuIGV2ZW50IG9yIHNldCBvZiBldmVudHMgZnJvbSBhbiBlbGVtZW50CiAgICByZW1vdmU6IGZ1bmN0aW9uIChlbGVtLCB0eXBlcywgaGFuZGxlciwgc2VsZWN0b3IsIG1hcHBlZFR5cGVzKSB7CiAgICAgIHZhciBqLAogICAgICAgIG9yaWdDb3VudCwKICAgICAgICB0bXAsCiAgICAgICAgZXZlbnRzLAogICAgICAgIHQsCiAgICAgICAgaGFuZGxlT2JqLAogICAgICAgIHNwZWNpYWwsCiAgICAgICAgaGFuZGxlcnMsCiAgICAgICAgdHlwZSwKICAgICAgICBuYW1lc3BhY2VzLAogICAgICAgIG9yaWdUeXBlLAogICAgICAgIGVsZW1EYXRhID0gZGF0YVByaXYuaGFzRGF0YShlbGVtKSAmJiBkYXRhUHJpdi5nZXQoZWxlbSk7CiAgICAgIGlmICghZWxlbURhdGEgfHwgIShldmVudHMgPSBlbGVtRGF0YS5ldmVudHMpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBPbmNlIGZvciBlYWNoIHR5cGUubmFtZXNwYWNlIGluIHR5cGVzOyB0eXBlIG1heSBiZSBvbWl0dGVkCiAgICAgIHR5cGVzID0gKHR5cGVzIHx8ICIiKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbIiJdOwogICAgICB0ID0gdHlwZXMubGVuZ3RoOwogICAgICB3aGlsZSAodC0tKSB7CiAgICAgICAgdG1wID0gcnR5cGVuYW1lc3BhY2UuZXhlYyh0eXBlc1t0XSkgfHwgW107CiAgICAgICAgdHlwZSA9IG9yaWdUeXBlID0gdG1wWzFdOwogICAgICAgIG5hbWVzcGFjZXMgPSAodG1wWzJdIHx8ICIiKS5zcGxpdCgiLiIpLnNvcnQoKTsKCiAgICAgICAgLy8gVW5iaW5kIGFsbCBldmVudHMgKG9uIHRoaXMgbmFtZXNwYWNlLCBpZiBwcm92aWRlZCkgZm9yIHRoZSBlbGVtZW50CiAgICAgICAgaWYgKCF0eXBlKSB7CiAgICAgICAgICBmb3IgKHR5cGUgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5yZW1vdmUoZWxlbSwgdHlwZSArIHR5cGVzW3RdLCBoYW5kbGVyLCBzZWxlY3RvciwgdHJ1ZSk7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgc3BlY2lhbCA9IGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdIHx8IHt9OwogICAgICAgIHR5cGUgPSAoc2VsZWN0b3IgPyBzcGVjaWFsLmRlbGVnYXRlVHlwZSA6IHNwZWNpYWwuYmluZFR5cGUpIHx8IHR5cGU7CiAgICAgICAgaGFuZGxlcnMgPSBldmVudHNbdHlwZV0gfHwgW107CiAgICAgICAgdG1wID0gdG1wWzJdICYmIG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpOwoKICAgICAgICAvLyBSZW1vdmUgbWF0Y2hpbmcgZXZlbnRzCiAgICAgICAgb3JpZ0NvdW50ID0gaiA9IGhhbmRsZXJzLmxlbmd0aDsKICAgICAgICB3aGlsZSAoai0tKSB7CiAgICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1tqXTsKICAgICAgICAgIGlmICgobWFwcGVkVHlwZXMgfHwgb3JpZ1R5cGUgPT09IGhhbmRsZU9iai5vcmlnVHlwZSkgJiYgKCFoYW5kbGVyIHx8IGhhbmRsZXIuZ3VpZCA9PT0gaGFuZGxlT2JqLmd1aWQpICYmICghdG1wIHx8IHRtcC50ZXN0KGhhbmRsZU9iai5uYW1lc3BhY2UpKSAmJiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBoYW5kbGVPYmouc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09ICIqKiIgJiYgaGFuZGxlT2JqLnNlbGVjdG9yKSkgewogICAgICAgICAgICBoYW5kbGVycy5zcGxpY2UoaiwgMSk7CiAgICAgICAgICAgIGlmIChoYW5kbGVPYmouc2VsZWN0b3IpIHsKICAgICAgICAgICAgICBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LS07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHNwZWNpYWwucmVtb3ZlKSB7CiAgICAgICAgICAgICAgc3BlY2lhbC5yZW1vdmUuY2FsbChlbGVtLCBoYW5kbGVPYmopOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBSZW1vdmUgZ2VuZXJpYyBldmVudCBoYW5kbGVyIGlmIHdlIHJlbW92ZWQgc29tZXRoaW5nIGFuZCBubyBtb3JlIGhhbmRsZXJzIGV4aXN0CiAgICAgICAgLy8gKGF2b2lkcyBwb3RlbnRpYWwgZm9yIGVuZGxlc3MgcmVjdXJzaW9uIGR1cmluZyByZW1vdmFsIG9mIHNwZWNpYWwgZXZlbnQgaGFuZGxlcnMpCiAgICAgICAgaWYgKG9yaWdDb3VudCAmJiAhaGFuZGxlcnMubGVuZ3RoKSB7CiAgICAgICAgICBpZiAoIXNwZWNpYWwudGVhcmRvd24gfHwgc3BlY2lhbC50ZWFyZG93bi5jYWxsKGVsZW0sIG5hbWVzcGFjZXMsIGVsZW1EYXRhLmhhbmRsZSkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGpRdWVyeS5yZW1vdmVFdmVudChlbGVtLCB0eXBlLCBlbGVtRGF0YS5oYW5kbGUpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIGV2ZW50c1t0eXBlXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFJlbW92ZSBkYXRhIGFuZCB0aGUgZXhwYW5kbyBpZiBpdCdzIG5vIGxvbmdlciB1c2VkCiAgICAgIGlmIChqUXVlcnkuaXNFbXB0eU9iamVjdChldmVudHMpKSB7CiAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sICJoYW5kbGUgZXZlbnRzIik7CiAgICAgIH0KICAgIH0sCiAgICBkaXNwYXRjaDogZnVuY3Rpb24gKG5hdGl2ZUV2ZW50KSB7CiAgICAgIHZhciBpLAogICAgICAgIGosCiAgICAgICAgcmV0LAogICAgICAgIG1hdGNoZWQsCiAgICAgICAgaGFuZGxlT2JqLAogICAgICAgIGhhbmRsZXJRdWV1ZSwKICAgICAgICBhcmdzID0gbmV3IEFycmF5KGFyZ3VtZW50cy5sZW5ndGgpLAogICAgICAgIC8vIE1ha2UgYSB3cml0YWJsZSBqUXVlcnkuRXZlbnQgZnJvbSB0aGUgbmF0aXZlIGV2ZW50IG9iamVjdAogICAgICAgIGV2ZW50ID0galF1ZXJ5LmV2ZW50LmZpeChuYXRpdmVFdmVudCksCiAgICAgICAgaGFuZGxlcnMgPSAoZGF0YVByaXYuZ2V0KHRoaXMsICJldmVudHMiKSB8fCBPYmplY3QuY3JlYXRlKG51bGwpKVtldmVudC50eXBlXSB8fCBbXSwKICAgICAgICBzcGVjaWFsID0galF1ZXJ5LmV2ZW50LnNwZWNpYWxbZXZlbnQudHlwZV0gfHwge307CgogICAgICAvLyBVc2UgdGhlIGZpeC1lZCBqUXVlcnkuRXZlbnQgcmF0aGVyIHRoYW4gdGhlIChyZWFkLW9ubHkpIG5hdGl2ZSBldmVudAogICAgICBhcmdzWzBdID0gZXZlbnQ7CiAgICAgIGZvciAoaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKICAgICAgICBhcmdzW2ldID0gYXJndW1lbnRzW2ldOwogICAgICB9CiAgICAgIGV2ZW50LmRlbGVnYXRlVGFyZ2V0ID0gdGhpczsKCiAgICAgIC8vIENhbGwgdGhlIHByZURpc3BhdGNoIGhvb2sgZm9yIHRoZSBtYXBwZWQgdHlwZSwgYW5kIGxldCBpdCBiYWlsIGlmIGRlc2lyZWQKICAgICAgaWYgKHNwZWNpYWwucHJlRGlzcGF0Y2ggJiYgc3BlY2lhbC5wcmVEaXNwYXRjaC5jYWxsKHRoaXMsIGV2ZW50KSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBoYW5kbGVycwogICAgICBoYW5kbGVyUXVldWUgPSBqUXVlcnkuZXZlbnQuaGFuZGxlcnMuY2FsbCh0aGlzLCBldmVudCwgaGFuZGxlcnMpOwoKICAgICAgLy8gUnVuIGRlbGVnYXRlcyBmaXJzdDsgdGhleSBtYXkgd2FudCB0byBzdG9wIHByb3BhZ2F0aW9uIGJlbmVhdGggdXMKICAgICAgaSA9IDA7CiAgICAgIHdoaWxlICgobWF0Y2hlZCA9IGhhbmRsZXJRdWV1ZVtpKytdKSAmJiAhZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgIGV2ZW50LmN1cnJlbnRUYXJnZXQgPSBtYXRjaGVkLmVsZW07CiAgICAgICAgaiA9IDA7CiAgICAgICAgd2hpbGUgKChoYW5kbGVPYmogPSBtYXRjaGVkLmhhbmRsZXJzW2orK10pICYmICFldmVudC5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCgpKSB7CiAgICAgICAgICAvLyBJZiB0aGUgZXZlbnQgaXMgbmFtZXNwYWNlZCwgdGhlbiBlYWNoIGhhbmRsZXIgaXMgb25seSBpbnZva2VkIGlmIGl0IGlzCiAgICAgICAgICAvLyBzcGVjaWFsbHkgdW5pdmVyc2FsIG9yIGl0cyBuYW1lc3BhY2VzIGFyZSBhIHN1cGVyc2V0IG9mIHRoZSBldmVudCdzLgogICAgICAgICAgaWYgKCFldmVudC5ybmFtZXNwYWNlIHx8IGhhbmRsZU9iai5uYW1lc3BhY2UgPT09IGZhbHNlIHx8IGV2ZW50LnJuYW1lc3BhY2UudGVzdChoYW5kbGVPYmoubmFtZXNwYWNlKSkgewogICAgICAgICAgICBldmVudC5oYW5kbGVPYmogPSBoYW5kbGVPYmo7CiAgICAgICAgICAgIGV2ZW50LmRhdGEgPSBoYW5kbGVPYmouZGF0YTsKICAgICAgICAgICAgcmV0ID0gKChqUXVlcnkuZXZlbnQuc3BlY2lhbFtoYW5kbGVPYmoub3JpZ1R5cGVdIHx8IHt9KS5oYW5kbGUgfHwgaGFuZGxlT2JqLmhhbmRsZXIpLmFwcGx5KG1hdGNoZWQuZWxlbSwgYXJncyk7CiAgICAgICAgICAgIGlmIChyZXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgIGlmICgoZXZlbnQucmVzdWx0ID0gcmV0KSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENhbGwgdGhlIHBvc3REaXNwYXRjaCBob29rIGZvciB0aGUgbWFwcGVkIHR5cGUKICAgICAgaWYgKHNwZWNpYWwucG9zdERpc3BhdGNoKSB7CiAgICAgICAgc3BlY2lhbC5wb3N0RGlzcGF0Y2guY2FsbCh0aGlzLCBldmVudCk7CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50LnJlc3VsdDsKICAgIH0sCiAgICBoYW5kbGVyczogZnVuY3Rpb24gKGV2ZW50LCBoYW5kbGVycykgewogICAgICB2YXIgaSwKICAgICAgICBoYW5kbGVPYmosCiAgICAgICAgc2VsLAogICAgICAgIG1hdGNoZWRIYW5kbGVycywKICAgICAgICBtYXRjaGVkU2VsZWN0b3JzLAogICAgICAgIGhhbmRsZXJRdWV1ZSA9IFtdLAogICAgICAgIGRlbGVnYXRlQ291bnQgPSBoYW5kbGVycy5kZWxlZ2F0ZUNvdW50LAogICAgICAgIGN1ciA9IGV2ZW50LnRhcmdldDsKCiAgICAgIC8vIEZpbmQgZGVsZWdhdGUgaGFuZGxlcnMKICAgICAgaWYgKGRlbGVnYXRlQ291bnQgJiYKICAgICAgLy8gU3VwcG9ydDogSUUgPD05CiAgICAgIC8vIEJsYWNrLWhvbGUgU1ZHIDx1c2U+IGluc3RhbmNlIHRyZWVzICh0cmFjLTEzMTgwKQogICAgICBjdXIubm9kZVR5cGUgJiYKICAgICAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTQyCiAgICAgIC8vIFN1cHByZXNzIHNwZWMtdmlvbGF0aW5nIGNsaWNrcyBpbmRpY2F0aW5nIGEgbm9uLXByaW1hcnkgcG9pbnRlciBidXR0b24gKHRyYWMtMzg2MSkKICAgICAgLy8gaHR0cHM6Ly93d3cudzMub3JnL1RSL0RPTS1MZXZlbC0zLUV2ZW50cy8jZXZlbnQtdHlwZS1jbGljawogICAgICAvLyBTdXBwb3J0OiBJRSAxMSBvbmx5CiAgICAgIC8vIC4uLmJ1dCBub3QgYXJyb3cga2V5ICJjbGlja3MiIG9mIHJhZGlvIGlucHV0cywgd2hpY2ggY2FuIGhhdmUgYGJ1dHRvbmAgLTEgKGdoLTIzNDMpCiAgICAgICEoZXZlbnQudHlwZSA9PT0gImNsaWNrIiAmJiBldmVudC5idXR0b24gPj0gMSkpIHsKICAgICAgICBmb3IgKDsgY3VyICE9PSB0aGlzOyBjdXIgPSBjdXIucGFyZW50Tm9kZSB8fCB0aGlzKSB7CiAgICAgICAgICAvLyBEb24ndCBjaGVjayBub24tZWxlbWVudHMgKHRyYWMtMTMyMDgpCiAgICAgICAgICAvLyBEb24ndCBwcm9jZXNzIGNsaWNrcyBvbiBkaXNhYmxlZCBlbGVtZW50cyAodHJhYy02OTExLCB0cmFjLTgxNjUsIHRyYWMtMTEzODIsIHRyYWMtMTE3NjQpCiAgICAgICAgICBpZiAoY3VyLm5vZGVUeXBlID09PSAxICYmICEoZXZlbnQudHlwZSA9PT0gImNsaWNrIiAmJiBjdXIuZGlzYWJsZWQgPT09IHRydWUpKSB7CiAgICAgICAgICAgIG1hdGNoZWRIYW5kbGVycyA9IFtdOwogICAgICAgICAgICBtYXRjaGVkU2VsZWN0b3JzID0ge307CiAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBkZWxlZ2F0ZUNvdW50OyBpKyspIHsKICAgICAgICAgICAgICBoYW5kbGVPYmogPSBoYW5kbGVyc1tpXTsKCiAgICAgICAgICAgICAgLy8gRG9uJ3QgY29uZmxpY3Qgd2l0aCBPYmplY3QucHJvdG90eXBlIHByb3BlcnRpZXMgKHRyYWMtMTMyMDMpCiAgICAgICAgICAgICAgc2VsID0gaGFuZGxlT2JqLnNlbGVjdG9yICsgIiAiOwogICAgICAgICAgICAgIGlmIChtYXRjaGVkU2VsZWN0b3JzW3NlbF0gPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgbWF0Y2hlZFNlbGVjdG9yc1tzZWxdID0gaGFuZGxlT2JqLm5lZWRzQ29udGV4dCA/IGpRdWVyeShzZWwsIHRoaXMpLmluZGV4KGN1cikgPiAtMSA6IGpRdWVyeS5maW5kKHNlbCwgdGhpcywgbnVsbCwgW2N1cl0pLmxlbmd0aDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKG1hdGNoZWRTZWxlY3RvcnNbc2VsXSkgewogICAgICAgICAgICAgICAgbWF0Y2hlZEhhbmRsZXJzLnB1c2goaGFuZGxlT2JqKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG1hdGNoZWRIYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICBoYW5kbGVyUXVldWUucHVzaCh7CiAgICAgICAgICAgICAgICBlbGVtOiBjdXIsCiAgICAgICAgICAgICAgICBoYW5kbGVyczogbWF0Y2hlZEhhbmRsZXJzCiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIEFkZCB0aGUgcmVtYWluaW5nIChkaXJlY3RseS1ib3VuZCkgaGFuZGxlcnMKICAgICAgY3VyID0gdGhpczsKICAgICAgaWYgKGRlbGVnYXRlQ291bnQgPCBoYW5kbGVycy5sZW5ndGgpIHsKICAgICAgICBoYW5kbGVyUXVldWUucHVzaCh7CiAgICAgICAgICBlbGVtOiBjdXIsCiAgICAgICAgICBoYW5kbGVyczogaGFuZGxlcnMuc2xpY2UoZGVsZWdhdGVDb3VudCkKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gaGFuZGxlclF1ZXVlOwogICAgfSwKICAgIGFkZFByb3A6IGZ1bmN0aW9uIChuYW1lLCBob29rKSB7CiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShqUXVlcnkuRXZlbnQucHJvdG90eXBlLCBuYW1lLCB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgZ2V0OiBpc0Z1bmN0aW9uKGhvb2spID8gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMub3JpZ2luYWxFdmVudCkgewogICAgICAgICAgICByZXR1cm4gaG9vayh0aGlzLm9yaWdpbmFsRXZlbnQpOwogICAgICAgICAgfQogICAgICAgIH0gOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAodGhpcy5vcmlnaW5hbEV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLm9yaWdpbmFsRXZlbnRbbmFtZV07CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMsIG5hbWUsIHsKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICAgICAgdmFsdWU6IHZhbHVlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGZpeDogZnVuY3Rpb24gKG9yaWdpbmFsRXZlbnQpIHsKICAgICAgcmV0dXJuIG9yaWdpbmFsRXZlbnRbalF1ZXJ5LmV4cGFuZG9dID8gb3JpZ2luYWxFdmVudCA6IG5ldyBqUXVlcnkuRXZlbnQob3JpZ2luYWxFdmVudCk7CiAgICB9LAogICAgc3BlY2lhbDogewogICAgICBsb2FkOiB7CiAgICAgICAgLy8gUHJldmVudCB0cmlnZ2VyZWQgaW1hZ2UubG9hZCBldmVudHMgZnJvbSBidWJibGluZyB0byB3aW5kb3cubG9hZAogICAgICAgIG5vQnViYmxlOiB0cnVlCiAgICAgIH0sCiAgICAgIGNsaWNrOiB7CiAgICAgICAgLy8gVXRpbGl6ZSBuYXRpdmUgZXZlbnQgdG8gZW5zdXJlIGNvcnJlY3Qgc3RhdGUgZm9yIGNoZWNrYWJsZSBpbnB1dHMKICAgICAgICBzZXR1cDogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIC8vIEZvciBtdXR1YWwgY29tcHJlc3NpYmlsaXR5IHdpdGggX2RlZmF1bHQsIHJlcGxhY2UgYHRoaXNgIGFjY2VzcyB3aXRoIGEgbG9jYWwgdmFyLgogICAgICAgICAgLy8gYHx8IGRhdGFgIGlzIGRlYWQgY29kZSBtZWFudCBvbmx5IHRvIHByZXNlcnZlIHRoZSB2YXJpYWJsZSB0aHJvdWdoIG1pbmlmaWNhdGlvbi4KICAgICAgICAgIHZhciBlbCA9IHRoaXMgfHwgZGF0YTsKCiAgICAgICAgICAvLyBDbGFpbSB0aGUgZmlyc3QgaGFuZGxlcgogICAgICAgICAgaWYgKHJjaGVja2FibGVUeXBlLnRlc3QoZWwudHlwZSkgJiYgZWwuY2xpY2sgJiYgbm9kZU5hbWUoZWwsICJpbnB1dCIpKSB7CiAgICAgICAgICAgIC8vIGRhdGFQcml2LnNldCggZWwsICJjbGljayIsIC4uLiApCiAgICAgICAgICAgIGxldmVyYWdlTmF0aXZlKGVsLCAiY2xpY2siLCByZXR1cm5UcnVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBSZXR1cm4gZmFsc2UgdG8gYWxsb3cgbm9ybWFsIHByb2Nlc3NpbmcgaW4gdGhlIGNhbGxlcgogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCiAgICAgICAgdHJpZ2dlcjogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgIC8vIEZvciBtdXR1YWwgY29tcHJlc3NpYmlsaXR5IHdpdGggX2RlZmF1bHQsIHJlcGxhY2UgYHRoaXNgIGFjY2VzcyB3aXRoIGEgbG9jYWwgdmFyLgogICAgICAgICAgLy8gYHx8IGRhdGFgIGlzIGRlYWQgY29kZSBtZWFudCBvbmx5IHRvIHByZXNlcnZlIHRoZSB2YXJpYWJsZSB0aHJvdWdoIG1pbmlmaWNhdGlvbi4KICAgICAgICAgIHZhciBlbCA9IHRoaXMgfHwgZGF0YTsKCiAgICAgICAgICAvLyBGb3JjZSBzZXR1cCBiZWZvcmUgdHJpZ2dlcmluZyBhIGNsaWNrCiAgICAgICAgICBpZiAocmNoZWNrYWJsZVR5cGUudGVzdChlbC50eXBlKSAmJiBlbC5jbGljayAmJiBub2RlTmFtZShlbCwgImlucHV0IikpIHsKICAgICAgICAgICAgbGV2ZXJhZ2VOYXRpdmUoZWwsICJjbGljayIpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJldHVybiBub24tZmFsc2UgdG8gYWxsb3cgbm9ybWFsIGV2ZW50LXBhdGggcHJvcGFnYXRpb24KICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCiAgICAgICAgLy8gRm9yIGNyb3NzLWJyb3dzZXIgY29uc2lzdGVuY3ksIHN1cHByZXNzIG5hdGl2ZSAuY2xpY2soKSBvbiBsaW5rcwogICAgICAgIC8vIEFsc28gcHJldmVudCBpdCBpZiB3ZSdyZSBjdXJyZW50bHkgaW5zaWRlIGEgbGV2ZXJhZ2VkIG5hdGl2ZS1ldmVudCBzdGFjawogICAgICAgIF9kZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7CiAgICAgICAgICByZXR1cm4gcmNoZWNrYWJsZVR5cGUudGVzdCh0YXJnZXQudHlwZSkgJiYgdGFyZ2V0LmNsaWNrICYmIG5vZGVOYW1lKHRhcmdldCwgImlucHV0IikgJiYgZGF0YVByaXYuZ2V0KHRhcmdldCwgImNsaWNrIikgfHwgbm9kZU5hbWUodGFyZ2V0LCAiYSIpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgYmVmb3JldW5sb2FkOiB7CiAgICAgICAgcG9zdERpc3BhdGNoOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggMjArCiAgICAgICAgICAvLyBGaXJlZm94IGRvZXNuJ3QgYWxlcnQgaWYgdGhlIHJldHVyblZhbHVlIGZpZWxkIGlzIG5vdCBzZXQuCiAgICAgICAgICBpZiAoZXZlbnQucmVzdWx0ICE9PSB1bmRlZmluZWQgJiYgZXZlbnQub3JpZ2luYWxFdmVudCkgewogICAgICAgICAgICBldmVudC5vcmlnaW5hbEV2ZW50LnJldHVyblZhbHVlID0gZXZlbnQucmVzdWx0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIC8vIEVuc3VyZSB0aGUgcHJlc2VuY2Ugb2YgYW4gZXZlbnQgbGlzdGVuZXIgdGhhdCBoYW5kbGVzIG1hbnVhbGx5LXRyaWdnZXJlZAogIC8vIHN5bnRoZXRpYyBldmVudHMgYnkgaW50ZXJydXB0aW5nIHByb2dyZXNzIHVudGlsIHJlaW52b2tlZCBpbiByZXNwb25zZSB0bwogIC8vICpuYXRpdmUqIGV2ZW50cyB0aGF0IGl0IGZpcmVzIGRpcmVjdGx5LCBlbnN1cmluZyB0aGF0IHN0YXRlIGNoYW5nZXMgaGF2ZQogIC8vIGFscmVhZHkgb2NjdXJyZWQgYmVmb3JlIG90aGVyIGxpc3RlbmVycyBhcmUgaW52b2tlZC4KICBmdW5jdGlvbiBsZXZlcmFnZU5hdGl2ZShlbCwgdHlwZSwgZXhwZWN0U3luYykgewogICAgLy8gTWlzc2luZyBleHBlY3RTeW5jIGluZGljYXRlcyBhIHRyaWdnZXIgY2FsbCwgd2hpY2ggbXVzdCBmb3JjZSBzZXR1cCB0aHJvdWdoIGpRdWVyeS5ldmVudC5hZGQKICAgIGlmICghZXhwZWN0U3luYykgewogICAgICBpZiAoZGF0YVByaXYuZ2V0KGVsLCB0eXBlKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LmFkZChlbCwgdHlwZSwgcmV0dXJuVHJ1ZSk7CiAgICAgIH0KICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIFJlZ2lzdGVyIHRoZSBjb250cm9sbGVyIGFzIGEgc3BlY2lhbCB1bml2ZXJzYWwgaGFuZGxlciBmb3IgYWxsIGV2ZW50IG5hbWVzcGFjZXMKICAgIGRhdGFQcml2LnNldChlbCwgdHlwZSwgZmFsc2UpOwogICAgalF1ZXJ5LmV2ZW50LmFkZChlbCwgdHlwZSwgewogICAgICBuYW1lc3BhY2U6IGZhbHNlLAogICAgICBoYW5kbGVyOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgbm90QXN5bmMsCiAgICAgICAgICByZXN1bHQsCiAgICAgICAgICBzYXZlZCA9IGRhdGFQcml2LmdldCh0aGlzLCB0eXBlKTsKICAgICAgICBpZiAoZXZlbnQuaXNUcmlnZ2VyICYgMSAmJiB0aGlzW3R5cGVdKSB7CiAgICAgICAgICAvLyBJbnRlcnJ1cHQgcHJvY2Vzc2luZyBvZiB0aGUgb3V0ZXIgc3ludGhldGljIC50cmlnZ2VyKCllZCBldmVudAogICAgICAgICAgLy8gU2F2ZWQgZGF0YSBzaG91bGQgYmUgZmFsc2UgaW4gc3VjaCBjYXNlcywgYnV0IG1pZ2h0IGJlIGEgbGVmdG92ZXIgY2FwdHVyZSBvYmplY3QKICAgICAgICAgIC8vIGZyb20gYW4gYXN5bmMgbmF0aXZlIGhhbmRsZXIgKGdoLTQzNTApCiAgICAgICAgICBpZiAoIXNhdmVkLmxlbmd0aCkgewogICAgICAgICAgICAvLyBTdG9yZSBhcmd1bWVudHMgZm9yIHVzZSB3aGVuIGhhbmRsaW5nIHRoZSBpbm5lciBuYXRpdmUgZXZlbnQKICAgICAgICAgICAgLy8gVGhlcmUgd2lsbCBhbHdheXMgYmUgYXQgbGVhc3Qgb25lIGFyZ3VtZW50IChhbiBldmVudCBvYmplY3QpLCBzbyB0aGlzIGFycmF5CiAgICAgICAgICAgIC8vIHdpbGwgbm90IGJlIGNvbmZ1c2VkIHdpdGggYSBsZWZ0b3ZlciBjYXB0dXJlIG9iamVjdC4KICAgICAgICAgICAgc2F2ZWQgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCB0eXBlLCBzYXZlZCk7CgogICAgICAgICAgICAvLyBUcmlnZ2VyIHRoZSBuYXRpdmUgZXZlbnQgYW5kIGNhcHR1cmUgaXRzIHJlc3VsdAogICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKICAgICAgICAgICAgLy8gZm9jdXMoKSBhbmQgYmx1cigpIGFyZSBhc3luY2hyb25vdXMKICAgICAgICAgICAgbm90QXN5bmMgPSBleHBlY3RTeW5jKHRoaXMsIHR5cGUpOwogICAgICAgICAgICB0aGlzW3R5cGVdKCk7CiAgICAgICAgICAgIHJlc3VsdCA9IGRhdGFQcml2LmdldCh0aGlzLCB0eXBlKTsKICAgICAgICAgICAgaWYgKHNhdmVkICE9PSByZXN1bHQgfHwgbm90QXN5bmMpIHsKICAgICAgICAgICAgICBkYXRhUHJpdi5zZXQodGhpcywgdHlwZSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHJlc3VsdCA9IHt9OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChzYXZlZCAhPT0gcmVzdWx0KSB7CiAgICAgICAgICAgICAgLy8gQ2FuY2VsIHRoZSBvdXRlciBzeW50aGV0aWMgZXZlbnQKICAgICAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgODYrCiAgICAgICAgICAgICAgLy8gSW4gQ2hyb21lLCBpZiBhbiBlbGVtZW50IGhhdmluZyBhIGZvY3Vzb3V0IGhhbmRsZXIgaXMgYmx1cnJlZCBieQogICAgICAgICAgICAgIC8vIGNsaWNraW5nIG91dHNpZGUgb2YgaXQsIGl0IGludm9rZXMgdGhlIGhhbmRsZXIgc3luY2hyb25vdXNseS4gSWYKICAgICAgICAgICAgICAvLyB0aGF0IGhhbmRsZXIgY2FsbHMgYC5yZW1vdmUoKWAgb24gdGhlIGVsZW1lbnQsIHRoZSBkYXRhIGlzIGNsZWFyZWQsCiAgICAgICAgICAgICAgLy8gbGVhdmluZyBgcmVzdWx0YCB1bmRlZmluZWQuIFdlIG5lZWQgdG8gZ3VhcmQgYWdhaW5zdCB0aGlzLgogICAgICAgICAgICAgIHJldHVybiByZXN1bHQgJiYgcmVzdWx0LnZhbHVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB0aGlzIGlzIGFuIGlubmVyIHN5bnRoZXRpYyBldmVudCBmb3IgYW4gZXZlbnQgd2l0aCBhIGJ1YmJsaW5nIHN1cnJvZ2F0ZQogICAgICAgICAgICAvLyAoZm9jdXMgb3IgYmx1ciksIGFzc3VtZSB0aGF0IHRoZSBzdXJyb2dhdGUgYWxyZWFkeSBwcm9wYWdhdGVkIGZyb20gdHJpZ2dlcmluZyB0aGUKICAgICAgICAgICAgLy8gbmF0aXZlIGV2ZW50IGFuZCBwcmV2ZW50IHRoYXQgZnJvbSBoYXBwZW5pbmcgYWdhaW4gaGVyZS4KICAgICAgICAgICAgLy8gVGhpcyB0ZWNobmljYWxseSBnZXRzIHRoZSBvcmRlcmluZyB3cm9uZyB3LnIudC4gdG8gYC50cmlnZ2VyKClgIChpbiB3aGljaCB0aGUKICAgICAgICAgICAgLy8gYnViYmxpbmcgc3Vycm9nYXRlIHByb3BhZ2F0ZXMgKmFmdGVyKiB0aGUgbm9uLWJ1YmJsaW5nIGJhc2UpLCBidXQgdGhhdCBzZWVtcwogICAgICAgICAgICAvLyBsZXNzIGJhZCB0aGFuIGR1cGxpY2F0aW9uLgogICAgICAgICAgfSBlbHNlIGlmICgoalF1ZXJ5LmV2ZW50LnNwZWNpYWxbdHlwZV0gfHwge30pLmRlbGVnYXRlVHlwZSkgewogICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBJZiB0aGlzIGlzIGEgbmF0aXZlIGV2ZW50IHRyaWdnZXJlZCBhYm92ZSwgZXZlcnl0aGluZyBpcyBub3cgaW4gb3JkZXIKICAgICAgICAgIC8vIEZpcmUgYW4gaW5uZXIgc3ludGhldGljIGV2ZW50IHdpdGggdGhlIG9yaWdpbmFsIGFyZ3VtZW50cwogICAgICAgIH0gZWxzZSBpZiAoc2F2ZWQubGVuZ3RoKSB7CiAgICAgICAgICAvLyAuLi5hbmQgY2FwdHVyZSB0aGUgcmVzdWx0CiAgICAgICAgICBkYXRhUHJpdi5zZXQodGhpcywgdHlwZSwgewogICAgICAgICAgICB2YWx1ZTogalF1ZXJ5LmV2ZW50LnRyaWdnZXIoCiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OSAtIDExKwogICAgICAgICAgICAvLyBFeHRlbmQgd2l0aCB0aGUgcHJvdG90eXBlIHRvIHJlc2V0IHRoZSBhYm92ZSBzdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKQogICAgICAgICAgICBqUXVlcnkuZXh0ZW5kKHNhdmVkWzBdLCBqUXVlcnkuRXZlbnQucHJvdG90eXBlKSwgc2F2ZWQuc2xpY2UoMSksIHRoaXMpCiAgICAgICAgICB9KTsKCiAgICAgICAgICAvLyBBYm9ydCBoYW5kbGluZyBvZiB0aGUgbmF0aXZlIGV2ZW50CiAgICAgICAgICBldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KICBqUXVlcnkucmVtb3ZlRXZlbnQgPSBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgaGFuZGxlKSB7CiAgICAvLyBUaGlzICJpZiIgaXMgbmVlZGVkIGZvciBwbGFpbiBvYmplY3RzCiAgICBpZiAoZWxlbS5yZW1vdmVFdmVudExpc3RlbmVyKSB7CiAgICAgIGVsZW0ucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBoYW5kbGUpOwogICAgfQogIH07CiAgalF1ZXJ5LkV2ZW50ID0gZnVuY3Rpb24gKHNyYywgcHJvcHMpIHsKICAgIC8vIEFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCB0aGUgJ25ldycga2V5d29yZAogICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGpRdWVyeS5FdmVudCkpIHsKICAgICAgcmV0dXJuIG5ldyBqUXVlcnkuRXZlbnQoc3JjLCBwcm9wcyk7CiAgICB9CgogICAgLy8gRXZlbnQgb2JqZWN0CiAgICBpZiAoc3JjICYmIHNyYy50eXBlKSB7CiAgICAgIHRoaXMub3JpZ2luYWxFdmVudCA9IHNyYzsKICAgICAgdGhpcy50eXBlID0gc3JjLnR5cGU7CgogICAgICAvLyBFdmVudHMgYnViYmxpbmcgdXAgdGhlIGRvY3VtZW50IG1heSBoYXZlIGJlZW4gbWFya2VkIGFzIHByZXZlbnRlZAogICAgICAvLyBieSBhIGhhbmRsZXIgbG93ZXIgZG93biB0aGUgdHJlZTsgcmVmbGVjdCB0aGUgY29ycmVjdCB2YWx1ZS4KICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSBzcmMuZGVmYXVsdFByZXZlbnRlZCB8fCBzcmMuZGVmYXVsdFByZXZlbnRlZCA9PT0gdW5kZWZpbmVkICYmCiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD0yLjMgb25seQogICAgICBzcmMucmV0dXJuVmFsdWUgPT09IGZhbHNlID8gcmV0dXJuVHJ1ZSA6IHJldHVybkZhbHNlOwoKICAgICAgLy8gQ3JlYXRlIHRhcmdldCBwcm9wZXJ0aWVzCiAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA8PTYgLSA3IG9ubHkKICAgICAgLy8gVGFyZ2V0IHNob3VsZCBub3QgYmUgYSB0ZXh0IG5vZGUgKHRyYWMtNTA0LCB0cmFjLTEzMTQzKQogICAgICB0aGlzLnRhcmdldCA9IHNyYy50YXJnZXQgJiYgc3JjLnRhcmdldC5ub2RlVHlwZSA9PT0gMyA/IHNyYy50YXJnZXQucGFyZW50Tm9kZSA6IHNyYy50YXJnZXQ7CiAgICAgIHRoaXMuY3VycmVudFRhcmdldCA9IHNyYy5jdXJyZW50VGFyZ2V0OwogICAgICB0aGlzLnJlbGF0ZWRUYXJnZXQgPSBzcmMucmVsYXRlZFRhcmdldDsKCiAgICAgIC8vIEV2ZW50IHR5cGUKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMudHlwZSA9IHNyYzsKICAgIH0KCiAgICAvLyBQdXQgZXhwbGljaXRseSBwcm92aWRlZCBwcm9wZXJ0aWVzIG9udG8gdGhlIGV2ZW50IG9iamVjdAogICAgaWYgKHByb3BzKSB7CiAgICAgIGpRdWVyeS5leHRlbmQodGhpcywgcHJvcHMpOwogICAgfQoKICAgIC8vIENyZWF0ZSBhIHRpbWVzdGFtcCBpZiBpbmNvbWluZyBldmVudCBkb2Vzbid0IGhhdmUgb25lCiAgICB0aGlzLnRpbWVTdGFtcCA9IHNyYyAmJiBzcmMudGltZVN0YW1wIHx8IERhdGUubm93KCk7CgogICAgLy8gTWFyayBpdCBhcyBmaXhlZAogICAgdGhpc1tqUXVlcnkuZXhwYW5kb10gPSB0cnVlOwogIH07CgogIC8vIGpRdWVyeS5FdmVudCBpcyBiYXNlZCBvbiBET00zIEV2ZW50cyBhcyBzcGVjaWZpZWQgYnkgdGhlIEVDTUFTY3JpcHQgTGFuZ3VhZ2UgQmluZGluZwogIC8vIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDAzL1dELURPTS1MZXZlbC0zLUV2ZW50cy0yMDAzMDMzMS9lY21hLXNjcmlwdC1iaW5kaW5nLmh0bWwKICBqUXVlcnkuRXZlbnQucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IGpRdWVyeS5FdmVudCwKICAgIGlzRGVmYXVsdFByZXZlbnRlZDogcmV0dXJuRmFsc2UsCiAgICBpc1Byb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZDogcmV0dXJuRmFsc2UsCiAgICBpc1NpbXVsYXRlZDogZmFsc2UsCiAgICBwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0RlZmF1bHRQcmV2ZW50ZWQgPSByZXR1cm5UcnVlOwogICAgICBpZiAoZSAmJiAhdGhpcy5pc1NpbXVsYXRlZCkgewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgfQogICAgfSwKICAgIHN0b3BQcm9wYWdhdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc1Byb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmICF0aGlzLmlzU2ltdWxhdGVkKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgICAgfQogICAgfSwKICAgIHN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbjogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IHRoaXMub3JpZ2luYWxFdmVudDsKICAgICAgdGhpcy5pc0ltbWVkaWF0ZVByb3BhZ2F0aW9uU3RvcHBlZCA9IHJldHVyblRydWU7CiAgICAgIGlmIChlICYmICF0aGlzLmlzU2ltdWxhdGVkKSB7CiAgICAgICAgZS5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgfQogICAgICB0aGlzLnN0b3BQcm9wYWdhdGlvbigpOwogICAgfQogIH07CgogIC8vIEluY2x1ZGVzIGFsbCBjb21tb24gZXZlbnQgcHJvcHMgaW5jbHVkaW5nIEtleUV2ZW50IGFuZCBNb3VzZUV2ZW50IHNwZWNpZmljIHByb3BzCiAgalF1ZXJ5LmVhY2goewogICAgYWx0S2V5OiB0cnVlLAogICAgYnViYmxlczogdHJ1ZSwKICAgIGNhbmNlbGFibGU6IHRydWUsCiAgICBjaGFuZ2VkVG91Y2hlczogdHJ1ZSwKICAgIGN0cmxLZXk6IHRydWUsCiAgICBkZXRhaWw6IHRydWUsCiAgICBldmVudFBoYXNlOiB0cnVlLAogICAgbWV0YUtleTogdHJ1ZSwKICAgIHBhZ2VYOiB0cnVlLAogICAgcGFnZVk6IHRydWUsCiAgICBzaGlmdEtleTogdHJ1ZSwKICAgIHZpZXc6IHRydWUsCiAgICAiY2hhciI6IHRydWUsCiAgICBjb2RlOiB0cnVlLAogICAgY2hhckNvZGU6IHRydWUsCiAgICBrZXk6IHRydWUsCiAgICBrZXlDb2RlOiB0cnVlLAogICAgYnV0dG9uOiB0cnVlLAogICAgYnV0dG9uczogdHJ1ZSwKICAgIGNsaWVudFg6IHRydWUsCiAgICBjbGllbnRZOiB0cnVlLAogICAgb2Zmc2V0WDogdHJ1ZSwKICAgIG9mZnNldFk6IHRydWUsCiAgICBwb2ludGVySWQ6IHRydWUsCiAgICBwb2ludGVyVHlwZTogdHJ1ZSwKICAgIHNjcmVlblg6IHRydWUsCiAgICBzY3JlZW5ZOiB0cnVlLAogICAgdGFyZ2V0VG91Y2hlczogdHJ1ZSwKICAgIHRvRWxlbWVudDogdHJ1ZSwKICAgIHRvdWNoZXM6IHRydWUsCiAgICB3aGljaDogdHJ1ZQogIH0sIGpRdWVyeS5ldmVudC5hZGRQcm9wKTsKICBqUXVlcnkuZWFjaCh7CiAgICBmb2N1czogImZvY3VzaW4iLAogICAgYmx1cjogImZvY3Vzb3V0IgogIH0sIGZ1bmN0aW9uICh0eXBlLCBkZWxlZ2F0ZVR5cGUpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW3R5cGVdID0gewogICAgICAvLyBVdGlsaXplIG5hdGl2ZSBldmVudCBpZiBwb3NzaWJsZSBzbyBibHVyL2ZvY3VzIHNlcXVlbmNlIGlzIGNvcnJlY3QKICAgICAgc2V0dXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBDbGFpbSB0aGUgZmlyc3QgaGFuZGxlcgogICAgICAgIC8vIGRhdGFQcml2LnNldCggdGhpcywgImZvY3VzIiwgLi4uICkKICAgICAgICAvLyBkYXRhUHJpdi5zZXQoIHRoaXMsICJibHVyIiwgLi4uICkKICAgICAgICBsZXZlcmFnZU5hdGl2ZSh0aGlzLCB0eXBlLCBleHBlY3RTeW5jKTsKCiAgICAgICAgLy8gUmV0dXJuIGZhbHNlIHRvIGFsbG93IG5vcm1hbCBwcm9jZXNzaW5nIGluIHRoZSBjYWxsZXIKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0sCiAgICAgIHRyaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyBGb3JjZSBzZXR1cCBiZWZvcmUgdHJpZ2dlcgogICAgICAgIGxldmVyYWdlTmF0aXZlKHRoaXMsIHR5cGUpOwoKICAgICAgICAvLyBSZXR1cm4gbm9uLWZhbHNlIHRvIGFsbG93IG5vcm1hbCBldmVudC1wYXRoIHByb3BhZ2F0aW9uCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0sCiAgICAgIC8vIFN1cHByZXNzIG5hdGl2ZSBmb2N1cyBvciBibHVyIGlmIHdlJ3JlIGN1cnJlbnRseSBpbnNpZGUKICAgICAgLy8gYSBsZXZlcmFnZWQgbmF0aXZlLWV2ZW50IHN0YWNrCiAgICAgIF9kZWZhdWx0OiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gZGF0YVByaXYuZ2V0KGV2ZW50LnRhcmdldCwgdHlwZSk7CiAgICAgIH0sCiAgICAgIGRlbGVnYXRlVHlwZTogZGVsZWdhdGVUeXBlCiAgICB9OwogIH0pOwoKICAvLyBDcmVhdGUgbW91c2VlbnRlci9sZWF2ZSBldmVudHMgdXNpbmcgbW91c2VvdmVyL291dCBhbmQgZXZlbnQtdGltZSBjaGVja3MKICAvLyBzbyB0aGF0IGV2ZW50IGRlbGVnYXRpb24gd29ya3MgaW4galF1ZXJ5LgogIC8vIERvIHRoZSBzYW1lIGZvciBwb2ludGVyZW50ZXIvcG9pbnRlcmxlYXZlIGFuZCBwb2ludGVyb3Zlci9wb2ludGVyb3V0CiAgLy8KICAvLyBTdXBwb3J0OiBTYWZhcmkgNyBvbmx5CiAgLy8gU2FmYXJpIHNlbmRzIG1vdXNlZW50ZXIgdG9vIG9mdGVuOyBzZWU6CiAgLy8gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NDcwMjU4CiAgLy8gZm9yIHRoZSBkZXNjcmlwdGlvbiBvZiB0aGUgYnVnIChpdCBleGlzdGVkIGluIG9sZGVyIENocm9tZSB2ZXJzaW9ucyBhcyB3ZWxsKS4KICBqUXVlcnkuZWFjaCh7CiAgICBtb3VzZWVudGVyOiAibW91c2VvdmVyIiwKICAgIG1vdXNlbGVhdmU6ICJtb3VzZW91dCIsCiAgICBwb2ludGVyZW50ZXI6ICJwb2ludGVyb3ZlciIsCiAgICBwb2ludGVybGVhdmU6ICJwb2ludGVyb3V0IgogIH0sIGZ1bmN0aW9uIChvcmlnLCBmaXgpIHsKICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW29yaWddID0gewogICAgICBkZWxlZ2F0ZVR5cGU6IGZpeCwKICAgICAgYmluZFR5cGU6IGZpeCwKICAgICAgaGFuZGxlOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICB2YXIgcmV0LAogICAgICAgICAgdGFyZ2V0ID0gdGhpcywKICAgICAgICAgIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0LAogICAgICAgICAgaGFuZGxlT2JqID0gZXZlbnQuaGFuZGxlT2JqOwoKICAgICAgICAvLyBGb3IgbW91c2VlbnRlci9sZWF2ZSBjYWxsIHRoZSBoYW5kbGVyIGlmIHJlbGF0ZWQgaXMgb3V0c2lkZSB0aGUgdGFyZ2V0LgogICAgICAgIC8vIE5COiBObyByZWxhdGVkVGFyZ2V0IGlmIHRoZSBtb3VzZSBsZWZ0L2VudGVyZWQgdGhlIGJyb3dzZXIgd2luZG93CiAgICAgICAgaWYgKCFyZWxhdGVkIHx8IHJlbGF0ZWQgIT09IHRhcmdldCAmJiAhalF1ZXJ5LmNvbnRhaW5zKHRhcmdldCwgcmVsYXRlZCkpIHsKICAgICAgICAgIGV2ZW50LnR5cGUgPSBoYW5kbGVPYmoub3JpZ1R5cGU7CiAgICAgICAgICByZXQgPSBoYW5kbGVPYmouaGFuZGxlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgZXZlbnQudHlwZSA9IGZpeDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJldDsKICAgICAgfQogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIG9uOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gb24odGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbik7CiAgICB9LAogICAgb25lOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbikgewogICAgICByZXR1cm4gb24odGhpcywgdHlwZXMsIHNlbGVjdG9yLCBkYXRhLCBmbiwgMSk7CiAgICB9LAogICAgb2ZmOiBmdW5jdGlvbiAodHlwZXMsIHNlbGVjdG9yLCBmbikgewogICAgICB2YXIgaGFuZGxlT2JqLCB0eXBlOwogICAgICBpZiAodHlwZXMgJiYgdHlwZXMucHJldmVudERlZmF1bHQgJiYgdHlwZXMuaGFuZGxlT2JqKSB7CiAgICAgICAgLy8gKCBldmVudCApICBkaXNwYXRjaGVkIGpRdWVyeS5FdmVudAogICAgICAgIGhhbmRsZU9iaiA9IHR5cGVzLmhhbmRsZU9iajsKICAgICAgICBqUXVlcnkodHlwZXMuZGVsZWdhdGVUYXJnZXQpLm9mZihoYW5kbGVPYmoubmFtZXNwYWNlID8gaGFuZGxlT2JqLm9yaWdUeXBlICsgIi4iICsgaGFuZGxlT2JqLm5hbWVzcGFjZSA6IGhhbmRsZU9iai5vcmlnVHlwZSwgaGFuZGxlT2JqLnNlbGVjdG9yLCBoYW5kbGVPYmouaGFuZGxlcik7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiB0eXBlcyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAvLyAoIHR5cGVzLW9iamVjdCBbLCBzZWxlY3Rvcl0gKQogICAgICAgIGZvciAodHlwZSBpbiB0eXBlcykgewogICAgICAgICAgdGhpcy5vZmYodHlwZSwgc2VsZWN0b3IsIHR5cGVzW3R5cGVdKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgICAgaWYgKHNlbGVjdG9yID09PSBmYWxzZSB8fCB0eXBlb2Ygc2VsZWN0b3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAvLyAoIHR5cGVzIFssIGZuXSApCiAgICAgICAgZm4gPSBzZWxlY3RvcjsKICAgICAgICBzZWxlY3RvciA9IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAoZm4gPT09IGZhbHNlKSB7CiAgICAgICAgZm4gPSByZXR1cm5GYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKHRoaXMsIHR5cGVzLCBmbiwgc2VsZWN0b3IpOwogICAgICB9KTsKICAgIH0KICB9KTsKICB2YXIKICAgIC8vIFN1cHBvcnQ6IElFIDw9MTAgLSAxMSwgRWRnZSAxMiAtIDEzIG9ubHkKICAgIC8vIEluIElFL0VkZ2UgdXNpbmcgcmVnZXggZ3JvdXBzIGhlcmUgY2F1c2VzIHNldmVyZSBzbG93ZG93bnMuCiAgICAvLyBTZWUgaHR0cHM6Ly9jb25uZWN0Lm1pY3Jvc29mdC5jb20vSUUvZmVlZGJhY2svZGV0YWlscy8xNzM2NTEyLwogICAgcm5vSW5uZXJodG1sID0gLzxzY3JpcHR8PHN0eWxlfDxsaW5rL2ksCiAgICAvLyBjaGVja2VkPSJjaGVja2VkIiBvciBjaGVja2VkCiAgICByY2hlY2tlZCA9IC9jaGVja2VkXHMqKD86W149XXw9XHMqLmNoZWNrZWQuKS9pLAogICAgcmNsZWFuU2NyaXB0ID0gL15ccyo8IVxbQ0RBVEFcW3xcXVxdPlxzKiQvZzsKCiAgLy8gUHJlZmVyIGEgdGJvZHkgb3ZlciBpdHMgcGFyZW50IHRhYmxlIGZvciBjb250YWluaW5nIG5ldyByb3dzCiAgZnVuY3Rpb24gbWFuaXB1bGF0aW9uVGFyZ2V0KGVsZW0sIGNvbnRlbnQpIHsKICAgIGlmIChub2RlTmFtZShlbGVtLCAidGFibGUiKSAmJiBub2RlTmFtZShjb250ZW50Lm5vZGVUeXBlICE9PSAxMSA/IGNvbnRlbnQgOiBjb250ZW50LmZpcnN0Q2hpbGQsICJ0ciIpKSB7CiAgICAgIHJldHVybiBqUXVlcnkoZWxlbSkuY2hpbGRyZW4oInRib2R5IilbMF0gfHwgZWxlbTsKICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KCiAgLy8gUmVwbGFjZS9yZXN0b3JlIHRoZSB0eXBlIGF0dHJpYnV0ZSBvZiBzY3JpcHQgZWxlbWVudHMgZm9yIHNhZmUgRE9NIG1hbmlwdWxhdGlvbgogIGZ1bmN0aW9uIGRpc2FibGVTY3JpcHQoZWxlbSkgewogICAgZWxlbS50eXBlID0gKGVsZW0uZ2V0QXR0cmlidXRlKCJ0eXBlIikgIT09IG51bGwpICsgIi8iICsgZWxlbS50eXBlOwogICAgcmV0dXJuIGVsZW07CiAgfQogIGZ1bmN0aW9uIHJlc3RvcmVTY3JpcHQoZWxlbSkgewogICAgaWYgKChlbGVtLnR5cGUgfHwgIiIpLnNsaWNlKDAsIDUpID09PSAidHJ1ZS8iKSB7CiAgICAgIGVsZW0udHlwZSA9IGVsZW0udHlwZS5zbGljZSg1KTsKICAgIH0gZWxzZSB7CiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKCJ0eXBlIik7CiAgICB9CiAgICByZXR1cm4gZWxlbTsKICB9CiAgZnVuY3Rpb24gY2xvbmVDb3B5RXZlbnQoc3JjLCBkZXN0KSB7CiAgICB2YXIgaSwgbCwgdHlwZSwgcGRhdGFPbGQsIHVkYXRhT2xkLCB1ZGF0YUN1ciwgZXZlbnRzOwogICAgaWYgKGRlc3Qubm9kZVR5cGUgIT09IDEpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIDEuIENvcHkgcHJpdmF0ZSBkYXRhOiBldmVudHMsIGhhbmRsZXJzLCBldGMuCiAgICBpZiAoZGF0YVByaXYuaGFzRGF0YShzcmMpKSB7CiAgICAgIHBkYXRhT2xkID0gZGF0YVByaXYuZ2V0KHNyYyk7CiAgICAgIGV2ZW50cyA9IHBkYXRhT2xkLmV2ZW50czsKICAgICAgaWYgKGV2ZW50cykgewogICAgICAgIGRhdGFQcml2LnJlbW92ZShkZXN0LCAiaGFuZGxlIGV2ZW50cyIpOwogICAgICAgIGZvciAodHlwZSBpbiBldmVudHMpIHsKICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBldmVudHNbdHlwZV0ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgIGpRdWVyeS5ldmVudC5hZGQoZGVzdCwgdHlwZSwgZXZlbnRzW3R5cGVdW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyAyLiBDb3B5IHVzZXIgZGF0YQogICAgaWYgKGRhdGFVc2VyLmhhc0RhdGEoc3JjKSkgewogICAgICB1ZGF0YU9sZCA9IGRhdGFVc2VyLmFjY2VzcyhzcmMpOwogICAgICB1ZGF0YUN1ciA9IGpRdWVyeS5leHRlbmQoe30sIHVkYXRhT2xkKTsKICAgICAgZGF0YVVzZXIuc2V0KGRlc3QsIHVkYXRhQ3VyKTsKICAgIH0KICB9CgogIC8vIEZpeCBJRSBidWdzLCBzZWUgc3VwcG9ydCB0ZXN0cwogIGZ1bmN0aW9uIGZpeElucHV0KHNyYywgZGVzdCkgewogICAgdmFyIG5vZGVOYW1lID0gZGVzdC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgIC8vIEZhaWxzIHRvIHBlcnNpc3QgdGhlIGNoZWNrZWQgc3RhdGUgb2YgYSBjbG9uZWQgY2hlY2tib3ggb3IgcmFkaW8gYnV0dG9uLgogICAgaWYgKG5vZGVOYW1lID09PSAiaW5wdXQiICYmIHJjaGVja2FibGVUeXBlLnRlc3Qoc3JjLnR5cGUpKSB7CiAgICAgIGRlc3QuY2hlY2tlZCA9IHNyYy5jaGVja2VkOwoKICAgICAgLy8gRmFpbHMgdG8gcmV0dXJuIHRoZSBzZWxlY3RlZCBvcHRpb24gdG8gdGhlIGRlZmF1bHQgc2VsZWN0ZWQgc3RhdGUgd2hlbiBjbG9uaW5nIG9wdGlvbnMKICAgIH0gZWxzZSBpZiAobm9kZU5hbWUgPT09ICJpbnB1dCIgfHwgbm9kZU5hbWUgPT09ICJ0ZXh0YXJlYSIpIHsKICAgICAgZGVzdC5kZWZhdWx0VmFsdWUgPSBzcmMuZGVmYXVsdFZhbHVlOwogICAgfQogIH0KICBmdW5jdGlvbiBkb21NYW5pcChjb2xsZWN0aW9uLCBhcmdzLCBjYWxsYmFjaywgaWdub3JlZCkgewogICAgLy8gRmxhdHRlbiBhbnkgbmVzdGVkIGFycmF5cwogICAgYXJncyA9IGZsYXQoYXJncyk7CiAgICB2YXIgZnJhZ21lbnQsCiAgICAgIGZpcnN0LAogICAgICBzY3JpcHRzLAogICAgICBoYXNTY3JpcHRzLAogICAgICBub2RlLAogICAgICBkb2MsCiAgICAgIGkgPSAwLAogICAgICBsID0gY29sbGVjdGlvbi5sZW5ndGgsCiAgICAgIGlOb0Nsb25lID0gbCAtIDEsCiAgICAgIHZhbHVlID0gYXJnc1swXSwKICAgICAgdmFsdWVJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbih2YWx1ZSk7CgogICAgLy8gV2UgY2FuJ3QgY2xvbmVOb2RlIGZyYWdtZW50cyB0aGF0IGNvbnRhaW4gY2hlY2tlZCwgaW4gV2ViS2l0CiAgICBpZiAodmFsdWVJc0Z1bmN0aW9uIHx8IGwgPiAxICYmIHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXN1cHBvcnQuY2hlY2tDbG9uZSAmJiByY2hlY2tlZC50ZXN0KHZhbHVlKSkgewogICAgICByZXR1cm4gY29sbGVjdGlvbi5lYWNoKGZ1bmN0aW9uIChpbmRleCkgewogICAgICAgIHZhciBzZWxmID0gY29sbGVjdGlvbi5lcShpbmRleCk7CiAgICAgICAgaWYgKHZhbHVlSXNGdW5jdGlvbikgewogICAgICAgICAgYXJnc1swXSA9IHZhbHVlLmNhbGwodGhpcywgaW5kZXgsIHNlbGYuaHRtbCgpKTsKICAgICAgICB9CiAgICAgICAgZG9tTWFuaXAoc2VsZiwgYXJncywgY2FsbGJhY2ssIGlnbm9yZWQpOwogICAgICB9KTsKICAgIH0KICAgIGlmIChsKSB7CiAgICAgIGZyYWdtZW50ID0gYnVpbGRGcmFnbWVudChhcmdzLCBjb2xsZWN0aW9uWzBdLm93bmVyRG9jdW1lbnQsIGZhbHNlLCBjb2xsZWN0aW9uLCBpZ25vcmVkKTsKICAgICAgZmlyc3QgPSBmcmFnbWVudC5maXJzdENoaWxkOwogICAgICBpZiAoZnJhZ21lbnQuY2hpbGROb2Rlcy5sZW5ndGggPT09IDEpIHsKICAgICAgICBmcmFnbWVudCA9IGZpcnN0OwogICAgICB9CgogICAgICAvLyBSZXF1aXJlIGVpdGhlciBuZXcgY29udGVudCBvciBhbiBpbnRlcmVzdCBpbiBpZ25vcmVkIGVsZW1lbnRzIHRvIGludm9rZSB0aGUgY2FsbGJhY2sKICAgICAgaWYgKGZpcnN0IHx8IGlnbm9yZWQpIHsKICAgICAgICBzY3JpcHRzID0galF1ZXJ5Lm1hcChnZXRBbGwoZnJhZ21lbnQsICJzY3JpcHQiKSwgZGlzYWJsZVNjcmlwdCk7CiAgICAgICAgaGFzU2NyaXB0cyA9IHNjcmlwdHMubGVuZ3RoOwoKICAgICAgICAvLyBVc2UgdGhlIG9yaWdpbmFsIGZyYWdtZW50IGZvciB0aGUgbGFzdCBpdGVtCiAgICAgICAgLy8gaW5zdGVhZCBvZiB0aGUgZmlyc3QgYmVjYXVzZSBpdCBjYW4gZW5kIHVwCiAgICAgICAgLy8gYmVpbmcgZW1wdGllZCBpbmNvcnJlY3RseSBpbiBjZXJ0YWluIHNpdHVhdGlvbnMgKHRyYWMtODA3MCkuCiAgICAgICAgZm9yICg7IGkgPCBsOyBpKyspIHsKICAgICAgICAgIG5vZGUgPSBmcmFnbWVudDsKICAgICAgICAgIGlmIChpICE9PSBpTm9DbG9uZSkgewogICAgICAgICAgICBub2RlID0galF1ZXJ5LmNsb25lKG5vZGUsIHRydWUsIHRydWUpOwoKICAgICAgICAgICAgLy8gS2VlcCByZWZlcmVuY2VzIHRvIGNsb25lZCBzY3JpcHRzIGZvciBsYXRlciByZXN0b3JhdGlvbgogICAgICAgICAgICBpZiAoaGFzU2NyaXB0cykgewogICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjAgb25seSwgUGhhbnRvbUpTIDEgb25seQogICAgICAgICAgICAgIC8vIHB1c2guYXBwbHkoXywgYXJyYXlsaWtlKSB0aHJvd3Mgb24gYW5jaWVudCBXZWJLaXQKICAgICAgICAgICAgICBqUXVlcnkubWVyZ2Uoc2NyaXB0cywgZ2V0QWxsKG5vZGUsICJzY3JpcHQiKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIGNhbGxiYWNrLmNhbGwoY29sbGVjdGlvbltpXSwgbm9kZSwgaSk7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNTY3JpcHRzKSB7CiAgICAgICAgICBkb2MgPSBzY3JpcHRzW3NjcmlwdHMubGVuZ3RoIC0gMV0ub3duZXJEb2N1bWVudDsKCiAgICAgICAgICAvLyBSZWVuYWJsZSBzY3JpcHRzCiAgICAgICAgICBqUXVlcnkubWFwKHNjcmlwdHMsIHJlc3RvcmVTY3JpcHQpOwoKICAgICAgICAgIC8vIEV2YWx1YXRlIGV4ZWN1dGFibGUgc2NyaXB0cyBvbiBmaXJzdCBkb2N1bWVudCBpbnNlcnRpb24KICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBoYXNTY3JpcHRzOyBpKyspIHsKICAgICAgICAgICAgbm9kZSA9IHNjcmlwdHNbaV07CiAgICAgICAgICAgIGlmIChyc2NyaXB0VHlwZS50ZXN0KG5vZGUudHlwZSB8fCAiIikgJiYgIWRhdGFQcml2LmFjY2Vzcyhub2RlLCAiZ2xvYmFsRXZhbCIpICYmIGpRdWVyeS5jb250YWlucyhkb2MsIG5vZGUpKSB7CiAgICAgICAgICAgICAgaWYgKG5vZGUuc3JjICYmIChub2RlLnR5cGUgfHwgIiIpLnRvTG93ZXJDYXNlKCkgIT09ICJtb2R1bGUiKSB7CiAgICAgICAgICAgICAgICAvLyBPcHRpb25hbCBBSkFYIGRlcGVuZGVuY3ksIGJ1dCB3b24ndCBydW4gc2NyaXB0cyBpZiBub3QgcHJlc2VudAogICAgICAgICAgICAgICAgaWYgKGpRdWVyeS5fZXZhbFVybCAmJiAhbm9kZS5ub01vZHVsZSkgewogICAgICAgICAgICAgICAgICBqUXVlcnkuX2V2YWxVcmwobm9kZS5zcmMsIHsKICAgICAgICAgICAgICAgICAgICBub25jZTogbm9kZS5ub25jZSB8fCBub2RlLmdldEF0dHJpYnV0ZSgibm9uY2UiKQogICAgICAgICAgICAgICAgICB9LCBkb2MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBVbndyYXAgYSBDREFUQSBzZWN0aW9uIGNvbnRhaW5pbmcgc2NyaXB0IGNvbnRlbnRzLiBUaGlzIHNob3VsZG4ndCBiZQogICAgICAgICAgICAgICAgLy8gbmVlZGVkIGFzIGluIFhNTCBkb2N1bWVudHMgdGhleSdyZSBhbHJlYWR5IG5vdCB2aXNpYmxlIHdoZW4KICAgICAgICAgICAgICAgIC8vIGluc3BlY3RpbmcgZWxlbWVudCBjb250ZW50cyBhbmQgaW4gSFRNTCBkb2N1bWVudHMgdGhleSBoYXZlIG5vCiAgICAgICAgICAgICAgICAvLyBtZWFuaW5nIGJ1dCB3ZSdyZSBwcmVzZXJ2aW5nIHRoYXQgbG9naWMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LgogICAgICAgICAgICAgICAgLy8gVGhpcyB3aWxsIGJlIHJlbW92ZWQgY29tcGxldGVseSBpbiA0LjAuIFNlZSBnaC00OTA0LgogICAgICAgICAgICAgICAgRE9NRXZhbChub2RlLnRleHRDb250ZW50LnJlcGxhY2UocmNsZWFuU2NyaXB0LCAiIiksIG5vZGUsIGRvYyk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICByZXR1cm4gY29sbGVjdGlvbjsKICB9CiAgZnVuY3Rpb24gcmVtb3ZlKGVsZW0sIHNlbGVjdG9yLCBrZWVwRGF0YSkgewogICAgdmFyIG5vZGUsCiAgICAgIG5vZGVzID0gc2VsZWN0b3IgPyBqUXVlcnkuZmlsdGVyKHNlbGVjdG9yLCBlbGVtKSA6IGVsZW0sCiAgICAgIGkgPSAwOwogICAgZm9yICg7IChub2RlID0gbm9kZXNbaV0pICE9IG51bGw7IGkrKykgewogICAgICBpZiAoIWtlZXBEYXRhICYmIG5vZGUubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChub2RlKSk7CiAgICAgIH0KICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkgewogICAgICAgIGlmIChrZWVwRGF0YSAmJiBpc0F0dGFjaGVkKG5vZGUpKSB7CiAgICAgICAgICBzZXRHbG9iYWxFdmFsKGdldEFsbChub2RlLCAic2NyaXB0IikpOwogICAgICAgIH0KICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBlbGVtOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIGh0bWxQcmVmaWx0ZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIHJldHVybiBodG1sOwogICAgfSwKICAgIGNsb25lOiBmdW5jdGlvbiAoZWxlbSwgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgdmFyIGksCiAgICAgICAgbCwKICAgICAgICBzcmNFbGVtZW50cywKICAgICAgICBkZXN0RWxlbWVudHMsCiAgICAgICAgY2xvbmUgPSBlbGVtLmNsb25lTm9kZSh0cnVlKSwKICAgICAgICBpblBhZ2UgPSBpc0F0dGFjaGVkKGVsZW0pOwoKICAgICAgLy8gRml4IElFIGNsb25pbmcgaXNzdWVzCiAgICAgIGlmICghc3VwcG9ydC5ub0Nsb25lQ2hlY2tlZCAmJiAoZWxlbS5ub2RlVHlwZSA9PT0gMSB8fCBlbGVtLm5vZGVUeXBlID09PSAxMSkgJiYgIWpRdWVyeS5pc1hNTERvYyhlbGVtKSkgewogICAgICAgIC8vIFdlIGVzY2hldyBTaXp6bGUgaGVyZSBmb3IgcGVyZm9ybWFuY2UgcmVhc29uczogaHR0cHM6Ly9qc3BlcmYuY29tL2dldGFsbC12cy1zaXp6bGUvMgogICAgICAgIGRlc3RFbGVtZW50cyA9IGdldEFsbChjbG9uZSk7CiAgICAgICAgc3JjRWxlbWVudHMgPSBnZXRBbGwoZWxlbSk7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgZml4SW5wdXQoc3JjRWxlbWVudHNbaV0sIGRlc3RFbGVtZW50c1tpXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBDb3B5IHRoZSBldmVudHMgZnJvbSB0aGUgb3JpZ2luYWwgdG8gdGhlIGNsb25lCiAgICAgIGlmIChkYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgaWYgKGRlZXBEYXRhQW5kRXZlbnRzKSB7CiAgICAgICAgICBzcmNFbGVtZW50cyA9IHNyY0VsZW1lbnRzIHx8IGdldEFsbChlbGVtKTsKICAgICAgICAgIGRlc3RFbGVtZW50cyA9IGRlc3RFbGVtZW50cyB8fCBnZXRBbGwoY2xvbmUpOwogICAgICAgICAgZm9yIChpID0gMCwgbCA9IHNyY0VsZW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgICBjbG9uZUNvcHlFdmVudChzcmNFbGVtZW50c1tpXSwgZGVzdEVsZW1lbnRzW2ldKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2xvbmVDb3B5RXZlbnQoZWxlbSwgY2xvbmUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUHJlc2VydmUgc2NyaXB0IGV2YWx1YXRpb24gaGlzdG9yeQogICAgICBkZXN0RWxlbWVudHMgPSBnZXRBbGwoY2xvbmUsICJzY3JpcHQiKTsKICAgICAgaWYgKGRlc3RFbGVtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgc2V0R2xvYmFsRXZhbChkZXN0RWxlbWVudHMsICFpblBhZ2UgJiYgZ2V0QWxsKGVsZW0sICJzY3JpcHQiKSk7CiAgICAgIH0KCiAgICAgIC8vIFJldHVybiB0aGUgY2xvbmVkIHNldAogICAgICByZXR1cm4gY2xvbmU7CiAgICB9LAogICAgY2xlYW5EYXRhOiBmdW5jdGlvbiAoZWxlbXMpIHsKICAgICAgdmFyIGRhdGEsCiAgICAgICAgZWxlbSwKICAgICAgICB0eXBlLAogICAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbCwKICAgICAgICBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gZWxlbXNbaV0pICE9PSB1bmRlZmluZWQ7IGkrKykgewogICAgICAgIGlmIChhY2NlcHREYXRhKGVsZW0pKSB7CiAgICAgICAgICBpZiAoZGF0YSA9IGVsZW1bZGF0YVByaXYuZXhwYW5kb10pIHsKICAgICAgICAgICAgaWYgKGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgZm9yICh0eXBlIGluIGRhdGEuZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoc3BlY2lhbFt0eXBlXSkgewogICAgICAgICAgICAgICAgICBqUXVlcnkuZXZlbnQucmVtb3ZlKGVsZW0sIHR5cGUpOwoKICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBhIHNob3J0Y3V0IHRvIGF2b2lkIGpRdWVyeS5ldmVudC5yZW1vdmUncyBvdmVyaGVhZAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgalF1ZXJ5LnJlbW92ZUV2ZW50KGVsZW0sIHR5cGUsIGRhdGEuaGFuZGxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN1cHBvcnQ6IENocm9tZSA8PTM1IC0gNDUrCiAgICAgICAgICAgIC8vIEFzc2lnbiB1bmRlZmluZWQgaW5zdGVhZCBvZiB1c2luZyBkZWxldGUsIHNlZSBEYXRhI3JlbW92ZQogICAgICAgICAgICBlbGVtW2RhdGFQcml2LmV4cGFuZG9dID0gdW5kZWZpbmVkOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGVsZW1bZGF0YVVzZXIuZXhwYW5kb10pIHsKICAgICAgICAgICAgLy8gU3VwcG9ydDogQ2hyb21lIDw9MzUgLSA0NSsKICAgICAgICAgICAgLy8gQXNzaWduIHVuZGVmaW5lZCBpbnN0ZWFkIG9mIHVzaW5nIGRlbGV0ZSwgc2VlIERhdGEjcmVtb3ZlCiAgICAgICAgICAgIGVsZW1bZGF0YVVzZXIuZXhwYW5kb10gPSB1bmRlZmluZWQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBkZXRhY2g6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gcmVtb3ZlKHRoaXMsIHNlbGVjdG9yLCB0cnVlKTsKICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uIChzZWxlY3RvcikgewogICAgICByZXR1cm4gcmVtb3ZlKHRoaXMsIHNlbGVjdG9yKTsKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICByZXR1cm4gdmFsdWUgPT09IHVuZGVmaW5lZCA/IGpRdWVyeS50ZXh0KHRoaXMpIDogdGhpcy5lbXB0eSgpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gMTEgfHwgdGhpcy5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICB0aGlzLnRleHRDb250ZW50ID0gdmFsdWU7CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICBhcHBlbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGRvbU1hbmlwKHRoaXMsIGFyZ3VtZW50cywgZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICBpZiAodGhpcy5ub2RlVHlwZSA9PT0gMSB8fCB0aGlzLm5vZGVUeXBlID09PSAxMSB8fCB0aGlzLm5vZGVUeXBlID09PSA5KSB7CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gbWFuaXB1bGF0aW9uVGFyZ2V0KHRoaXMsIGVsZW0pOwogICAgICAgICAgdGFyZ2V0LmFwcGVuZENoaWxkKGVsZW0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgcHJlcGVuZDogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZG9tTWFuaXAodGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlID09PSAxIHx8IHRoaXMubm9kZVR5cGUgPT09IDExIHx8IHRoaXMubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBtYW5pcHVsYXRpb25UYXJnZXQodGhpcywgZWxlbSk7CiAgICAgICAgICB0YXJnZXQuaW5zZXJ0QmVmb3JlKGVsZW0sIHRhcmdldC5maXJzdENoaWxkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGJlZm9yZTogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZG9tTWFuaXAodGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBhZnRlcjogZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZG9tTWFuaXAodGhpcywgYXJndW1lbnRzLCBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgIGlmICh0aGlzLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHRoaXMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoZWxlbSwgdGhpcy5uZXh0U2libGluZyk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBlbXB0eTogZnVuY3Rpb24gKCkgewogICAgICB2YXIgZWxlbSwKICAgICAgICBpID0gMDsKICAgICAgZm9yICg7IChlbGVtID0gdGhpc1tpXSkgIT0gbnVsbDsgaSsrKSB7CiAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICAgIC8vIFByZXZlbnQgbWVtb3J5IGxlYWtzCiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwoKICAgICAgICAgIC8vIFJlbW92ZSBhbnkgcmVtYWluaW5nIG5vZGVzCiAgICAgICAgICBlbGVtLnRleHRDb250ZW50ID0gIiI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGNsb25lOiBmdW5jdGlvbiAoZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpIHsKICAgICAgZGF0YUFuZEV2ZW50cyA9IGRhdGFBbmRFdmVudHMgPT0gbnVsbCA/IGZhbHNlIDogZGF0YUFuZEV2ZW50czsKICAgICAgZGVlcERhdGFBbmRFdmVudHMgPSBkZWVwRGF0YUFuZEV2ZW50cyA9PSBudWxsID8gZGF0YUFuZEV2ZW50cyA6IGRlZXBEYXRhQW5kRXZlbnRzOwogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBqUXVlcnkuY2xvbmUodGhpcywgZGF0YUFuZEV2ZW50cywgZGVlcERhdGFBbmRFdmVudHMpOwogICAgICB9KTsKICAgIH0sCiAgICBodG1sOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgZWxlbSA9IHRoaXNbMF0gfHwge30sCiAgICAgICAgICBpID0gMCwKICAgICAgICAgIGwgPSB0aGlzLmxlbmd0aDsKICAgICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCAmJiBlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICByZXR1cm4gZWxlbS5pbm5lckhUTUw7CiAgICAgICAgfQoKICAgICAgICAvLyBTZWUgaWYgd2UgY2FuIHRha2UgYSBzaG9ydGN1dCBhbmQganVzdCB1c2UgaW5uZXJIVE1MCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgJiYgIXJub0lubmVyaHRtbC50ZXN0KHZhbHVlKSAmJiAhd3JhcE1hcFsocnRhZ05hbWUuZXhlYyh2YWx1ZSkgfHwgWyIiLCAiIl0pWzFdLnRvTG93ZXJDYXNlKCldKSB7CiAgICAgICAgICB2YWx1ZSA9IGpRdWVyeS5odG1sUHJlZmlsdGVyKHZhbHVlKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGZvciAoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgZWxlbSA9IHRoaXNbaV0gfHwge307CgogICAgICAgICAgICAgIC8vIFJlbW92ZSBlbGVtZW50IG5vZGVzIGFuZCBwcmV2ZW50IG1lbW9yeSBsZWFrcwogICAgICAgICAgICAgIGlmIChlbGVtLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbChlbGVtLCBmYWxzZSkpOwogICAgICAgICAgICAgICAgZWxlbS5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxlbSA9IDA7CgogICAgICAgICAgICAvLyBJZiB1c2luZyBpbm5lckhUTUwgdGhyb3dzIGFuIGV4Y2VwdGlvbiwgdXNlIHRoZSBmYWxsYmFjayBtZXRob2QKICAgICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgfQogICAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgICB0aGlzLmVtcHR5KCkuYXBwZW5kKHZhbHVlKTsKICAgICAgICB9CiAgICAgIH0sIG51bGwsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH0sCiAgICByZXBsYWNlV2l0aDogZnVuY3Rpb24gKCkgewogICAgICB2YXIgaWdub3JlZCA9IFtdOwoKICAgICAgLy8gTWFrZSB0aGUgY2hhbmdlcywgcmVwbGFjaW5nIGVhY2ggbm9uLWlnbm9yZWQgY29udGV4dCBlbGVtZW50IHdpdGggdGhlIG5ldyBjb250ZW50CiAgICAgIHJldHVybiBkb21NYW5pcCh0aGlzLCBhcmd1bWVudHMsIGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgdmFyIHBhcmVudCA9IHRoaXMucGFyZW50Tm9kZTsKICAgICAgICBpZiAoalF1ZXJ5LmluQXJyYXkodGhpcywgaWdub3JlZCkgPCAwKSB7CiAgICAgICAgICBqUXVlcnkuY2xlYW5EYXRhKGdldEFsbCh0aGlzKSk7CiAgICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICAgIHBhcmVudC5yZXBsYWNlQ2hpbGQoZWxlbSwgdGhpcyk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBGb3JjZSBjYWxsYmFjayBpbnZvY2F0aW9uCiAgICAgIH0sIGlnbm9yZWQpOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKHsKICAgIGFwcGVuZFRvOiAiYXBwZW5kIiwKICAgIHByZXBlbmRUbzogInByZXBlbmQiLAogICAgaW5zZXJ0QmVmb3JlOiAiYmVmb3JlIiwKICAgIGluc2VydEFmdGVyOiAiYWZ0ZXIiLAogICAgcmVwbGFjZUFsbDogInJlcGxhY2VXaXRoIgogIH0sIGZ1bmN0aW9uIChuYW1lLCBvcmlnaW5hbCkgewogICAgalF1ZXJ5LmZuW25hbWVdID0gZnVuY3Rpb24gKHNlbGVjdG9yKSB7CiAgICAgIHZhciBlbGVtcywKICAgICAgICByZXQgPSBbXSwKICAgICAgICBpbnNlcnQgPSBqUXVlcnkoc2VsZWN0b3IpLAogICAgICAgIGxhc3QgPSBpbnNlcnQubGVuZ3RoIC0gMSwKICAgICAgICBpID0gMDsKICAgICAgZm9yICg7IGkgPD0gbGFzdDsgaSsrKSB7CiAgICAgICAgZWxlbXMgPSBpID09PSBsYXN0ID8gdGhpcyA6IHRoaXMuY2xvbmUodHJ1ZSk7CiAgICAgICAgalF1ZXJ5KGluc2VydFtpXSlbb3JpZ2luYWxdKGVsZW1zKTsKCiAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMCBvbmx5LCBQaGFudG9tSlMgMSBvbmx5CiAgICAgICAgLy8gLmdldCgpIGJlY2F1c2UgcHVzaC5hcHBseShfLCBhcnJheWxpa2UpIHRocm93cyBvbiBhbmNpZW50IFdlYktpdAogICAgICAgIHB1c2guYXBwbHkocmV0LCBlbGVtcy5nZXQoKSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMucHVzaFN0YWNrKHJldCk7CiAgICB9OwogIH0pOwogIHZhciBybnVtbm9ucHggPSBuZXcgUmVnRXhwKCJeKCIgKyBwbnVtICsgIikoPyFweClbYS16JV0rJCIsICJpIik7CiAgdmFyIHJjdXN0b21Qcm9wID0gL14tLS87CiAgdmFyIGdldFN0eWxlcyA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHksIEZpcmVmb3ggPD0zMCAodHJhYy0xNTA5OCwgdHJhYy0xNDE1MCkKICAgIC8vIElFIHRocm93cyBvbiBlbGVtZW50cyBjcmVhdGVkIGluIHBvcHVwcwogICAgLy8gRkYgbWVhbndoaWxlIHRocm93cyBvbiBmcmFtZSBlbGVtZW50cyB0aHJvdWdoICJkZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlIgogICAgdmFyIHZpZXcgPSBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXc7CiAgICBpZiAoIXZpZXcgfHwgIXZpZXcub3BlbmVyKSB7CiAgICAgIHZpZXcgPSB3aW5kb3c7CiAgICB9CiAgICByZXR1cm4gdmlldy5nZXRDb21wdXRlZFN0eWxlKGVsZW0pOwogIH07CiAgdmFyIHN3YXAgPSBmdW5jdGlvbiAoZWxlbSwgb3B0aW9ucywgY2FsbGJhY2spIHsKICAgIHZhciByZXQsCiAgICAgIG5hbWUsCiAgICAgIG9sZCA9IHt9OwoKICAgIC8vIFJlbWVtYmVyIHRoZSBvbGQgdmFsdWVzLCBhbmQgaW5zZXJ0IHRoZSBuZXcgb25lcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgb2xkW25hbWVdID0gZWxlbS5zdHlsZVtuYW1lXTsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9wdGlvbnNbbmFtZV07CiAgICB9CiAgICByZXQgPSBjYWxsYmFjay5jYWxsKGVsZW0pOwoKICAgIC8vIFJldmVydCB0aGUgb2xkIHZhbHVlcwogICAgZm9yIChuYW1lIGluIG9wdGlvbnMpIHsKICAgICAgZWxlbS5zdHlsZVtuYW1lXSA9IG9sZFtuYW1lXTsKICAgIH0KICAgIHJldHVybiByZXQ7CiAgfTsKICB2YXIgcmJveFN0eWxlID0gbmV3IFJlZ0V4cChjc3NFeHBhbmQuam9pbigifCIpLCAiaSIpOwogIHZhciB3aGl0ZXNwYWNlID0gIltcXHgyMFxcdFxcclxcblxcZl0iOwogIHZhciBydHJpbUNTUyA9IG5ldyBSZWdFeHAoIl4iICsgd2hpdGVzcGFjZSArICIrfCgoPzpefFteXFxcXF0pKD86XFxcXC4pKikiICsgd2hpdGVzcGFjZSArICIrJCIsICJnIik7CiAgKGZ1bmN0aW9uICgpIHsKICAgIC8vIEV4ZWN1dGluZyBib3RoIHBpeGVsUG9zaXRpb24gJiBib3hTaXppbmdSZWxpYWJsZSB0ZXN0cyByZXF1aXJlIG9ubHkgb25lIGxheW91dAogICAgLy8gc28gdGhleSdyZSBleGVjdXRlZCBhdCB0aGUgc2FtZSB0aW1lIHRvIHNhdmUgdGhlIHNlY29uZCBjb21wdXRhdGlvbi4KICAgIGZ1bmN0aW9uIGNvbXB1dGVTdHlsZVRlc3RzKCkgewogICAgICAvLyBUaGlzIGlzIGEgc2luZ2xldG9uLCB3ZSBuZWVkIHRvIGV4ZWN1dGUgaXQgb25seSBvbmNlCiAgICAgIGlmICghZGl2KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOmFic29sdXRlO2xlZnQ6LTExMTExcHg7d2lkdGg6NjBweDsiICsgIm1hcmdpbi10b3A6MXB4O3BhZGRpbmc6MDtib3JkZXI6MCI7CiAgICAgIGRpdi5zdHlsZS5jc3NUZXh0ID0gInBvc2l0aW9uOnJlbGF0aXZlO2Rpc3BsYXk6YmxvY2s7Ym94LXNpemluZzpib3JkZXItYm94O292ZXJmbG93OnNjcm9sbDsiICsgIm1hcmdpbjphdXRvO2JvcmRlcjoxcHg7cGFkZGluZzoxcHg7IiArICJ3aWR0aDo2MCU7dG9wOjElIjsKICAgICAgZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKGNvbnRhaW5lcikuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgdmFyIGRpdlN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZGl2KTsKICAgICAgcGl4ZWxQb3NpdGlvblZhbCA9IGRpdlN0eWxlLnRvcCAhPT0gIjElIjsKCiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIEZpcmVmb3ggPD0zIC0gNDQKICAgICAgcmVsaWFibGVNYXJnaW5MZWZ0VmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKGRpdlN0eWxlLm1hcmdpbkxlZnQpID09PSAxMjsKCiAgICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgNC4wIC0gNC4zIG9ubHksIFNhZmFyaSA8PTkuMSAtIDEwLjEsIGlPUyA8PTcuMCAtIDkuMwogICAgICAvLyBTb21lIHN0eWxlcyBjb21lIGJhY2sgd2l0aCBwZXJjZW50YWdlIHZhbHVlcywgZXZlbiB0aG91Z2ggdGhleSBzaG91bGRuJ3QKICAgICAgZGl2LnN0eWxlLnJpZ2h0ID0gIjYwJSI7CiAgICAgIHBpeGVsQm94U3R5bGVzVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKGRpdlN0eWxlLnJpZ2h0KSA9PT0gMzY7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seQogICAgICAvLyBEZXRlY3QgbWlzcmVwb3J0aW5nIG9mIGNvbnRlbnQgZGltZW5zaW9ucyBmb3IgYm94LXNpemluZzpib3JkZXItYm94IGVsZW1lbnRzCiAgICAgIGJveFNpemluZ1JlbGlhYmxlVmFsID0gcm91bmRQaXhlbE1lYXN1cmVzKGRpdlN0eWxlLndpZHRoKSA9PT0gMzY7CgogICAgICAvLyBTdXBwb3J0OiBJRSA5IG9ubHkKICAgICAgLy8gRGV0ZWN0IG92ZXJmbG93OnNjcm9sbCBzY3Jld2luZXNzIChnaC0zNjk5KQogICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgPD02NAogICAgICAvLyBEb24ndCBnZXQgdHJpY2tlZCB3aGVuIHpvb20gYWZmZWN0cyBvZmZzZXRXaWR0aCAoZ2gtNDAyOSkKICAgICAgZGl2LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgc2Nyb2xsYm94U2l6ZVZhbCA9IHJvdW5kUGl4ZWxNZWFzdXJlcyhkaXYub2Zmc2V0V2lkdGggLyAzKSA9PT0gMTI7CiAgICAgIGRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZChjb250YWluZXIpOwoKICAgICAgLy8gTnVsbGlmeSB0aGUgZGl2IHNvIGl0IHdvdWxkbid0IGJlIHN0b3JlZCBpbiB0aGUgbWVtb3J5IGFuZAogICAgICAvLyBpdCB3aWxsIGFsc28gYmUgYSBzaWduIHRoYXQgY2hlY2tzIGFscmVhZHkgcGVyZm9ybWVkCiAgICAgIGRpdiA9IG51bGw7CiAgICB9CiAgICBmdW5jdGlvbiByb3VuZFBpeGVsTWVhc3VyZXMobWVhc3VyZSkgewogICAgICByZXR1cm4gTWF0aC5yb3VuZChwYXJzZUZsb2F0KG1lYXN1cmUpKTsKICAgIH0KICAgIHZhciBwaXhlbFBvc2l0aW9uVmFsLAogICAgICBib3hTaXppbmdSZWxpYWJsZVZhbCwKICAgICAgc2Nyb2xsYm94U2l6ZVZhbCwKICAgICAgcGl4ZWxCb3hTdHlsZXNWYWwsCiAgICAgIHJlbGlhYmxlVHJEaW1lbnNpb25zVmFsLAogICAgICByZWxpYWJsZU1hcmdpbkxlZnRWYWwsCiAgICAgIGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLAogICAgICBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCiAgICAvLyBGaW5pc2ggZWFybHkgaW4gbGltaXRlZCAobm9uLWJyb3dzZXIpIGVudmlyb25tZW50cwogICAgaWYgKCFkaXYuc3R5bGUpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFIDw9OSAtIDExIG9ubHkKICAgIC8vIFN0eWxlIG9mIGNsb25lZCBlbGVtZW50IGFmZmVjdHMgc291cmNlIGVsZW1lbnQgY2xvbmVkICh0cmFjLTg5MDgpCiAgICBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPSAiY29udGVudC1ib3giOwogICAgZGl2LmNsb25lTm9kZSh0cnVlKS5zdHlsZS5iYWNrZ3JvdW5kQ2xpcCA9ICIiOwogICAgc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgPSBkaXYuc3R5bGUuYmFja2dyb3VuZENsaXAgPT09ICJjb250ZW50LWJveCI7CiAgICBqUXVlcnkuZXh0ZW5kKHN1cHBvcnQsIHsKICAgICAgYm94U2l6aW5nUmVsaWFibGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb21wdXRlU3R5bGVUZXN0cygpOwogICAgICAgIHJldHVybiBib3hTaXppbmdSZWxpYWJsZVZhbDsKICAgICAgfSwKICAgICAgcGl4ZWxCb3hTdHlsZXM6IGZ1bmN0aW9uICgpIHsKICAgICAgICBjb21wdXRlU3R5bGVUZXN0cygpOwogICAgICAgIHJldHVybiBwaXhlbEJveFN0eWxlc1ZhbDsKICAgICAgfSwKICAgICAgcGl4ZWxQb3NpdGlvbjogZnVuY3Rpb24gKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHBpeGVsUG9zaXRpb25WYWw7CiAgICAgIH0sCiAgICAgIHJlbGlhYmxlTWFyZ2luTGVmdDogZnVuY3Rpb24gKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHJlbGlhYmxlTWFyZ2luTGVmdFZhbDsKICAgICAgfSwKICAgICAgc2Nyb2xsYm94U2l6ZTogZnVuY3Rpb24gKCkgewogICAgICAgIGNvbXB1dGVTdHlsZVRlc3RzKCk7CiAgICAgICAgcmV0dXJuIHNjcm9sbGJveFNpemVWYWw7CiAgICAgIH0sCiAgICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSssIEVkZ2UgMTUgLSAxOCsKICAgICAgLy8gSUUvRWRnZSBtaXNyZXBvcnQgYGdldENvbXB1dGVkU3R5bGVgIG9mIHRhYmxlIHJvd3Mgd2l0aCB3aWR0aC9oZWlnaHQKICAgICAgLy8gc2V0IGluIENTUyB3aGlsZSBgb2Zmc2V0KmAgcHJvcGVydGllcyByZXBvcnQgY29ycmVjdCB2YWx1ZXMuCiAgICAgIC8vIEJlaGF2aW9yIGluIElFIDkgaXMgbW9yZSBzdWJ0bGUgdGhhbiBpbiBuZXdlciB2ZXJzaW9ucyAmIGl0IHBhc3NlcwogICAgICAvLyBzb21lIHZlcnNpb25zIG9mIHRoaXMgdGVzdDsgbWFrZSBzdXJlIG5vdCB0byBtYWtlIGl0IHBhc3MgdGhlcmUhCiAgICAgIC8vCiAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggNzArCiAgICAgIC8vIE9ubHkgRmlyZWZveCBpbmNsdWRlcyBib3JkZXIgd2lkdGhzCiAgICAgIC8vIGluIGNvbXB1dGVkIGRpbWVuc2lvbnMuIChnaC00NTI5KQogICAgICByZWxpYWJsZVRyRGltZW5zaW9uczogZnVuY3Rpb24gKCkgewogICAgICAgIHZhciB0YWJsZSwgdHIsIHRyQ2hpbGQsIHRyU3R5bGU7CiAgICAgICAgaWYgKHJlbGlhYmxlVHJEaW1lbnNpb25zVmFsID09IG51bGwpIHsKICAgICAgICAgIHRhYmxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGFibGUiKTsKICAgICAgICAgIHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidHIiKTsKICAgICAgICAgIHRyQ2hpbGQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIHRhYmxlLnN0eWxlLmNzc1RleHQgPSAicG9zaXRpb246YWJzb2x1dGU7bGVmdDotMTExMTFweDtib3JkZXItY29sbGFwc2U6c2VwYXJhdGUiOwogICAgICAgICAgdHIuc3R5bGUuY3NzVGV4dCA9ICJib3JkZXI6MXB4IHNvbGlkIjsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBDaHJvbWUgODYrCiAgICAgICAgICAvLyBIZWlnaHQgc2V0IHRocm91Z2ggY3NzVGV4dCBkb2VzIG5vdCBnZXQgYXBwbGllZC4KICAgICAgICAgIC8vIENvbXB1dGVkIGhlaWdodCB0aGVuIGNvbWVzIGJhY2sgYXMgMC4KICAgICAgICAgIHRyLnN0eWxlLmhlaWdodCA9ICIxcHgiOwogICAgICAgICAgdHJDaGlsZC5zdHlsZS5oZWlnaHQgPSAiOXB4IjsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBBbmRyb2lkIDggQ2hyb21lIDg2KwogICAgICAgICAgLy8gSW4gb3VyIGJvZHlCYWNrZ3JvdW5kLmh0bWwgaWZyYW1lLAogICAgICAgICAgLy8gZGlzcGxheSBmb3IgYWxsIGRpdiBlbGVtZW50cyBpcyBzZXQgdG8gImlubGluZSIsCiAgICAgICAgICAvLyB3aGljaCBjYXVzZXMgYSBwcm9ibGVtIG9ubHkgaW4gQW5kcm9pZCA4IENocm9tZSA4Ni4KICAgICAgICAgIC8vIEVuc3VyaW5nIHRoZSBkaXYgaXMgZGlzcGxheTogYmxvY2sKICAgICAgICAgIC8vIGdldHMgYXJvdW5kIHRoaXMgaXNzdWUuCiAgICAgICAgICB0ckNoaWxkLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKHRhYmxlKS5hcHBlbmRDaGlsZCh0cikuYXBwZW5kQ2hpbGQodHJDaGlsZCk7CiAgICAgICAgICB0clN0eWxlID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodHIpOwogICAgICAgICAgcmVsaWFibGVUckRpbWVuc2lvbnNWYWwgPSBwYXJzZUludCh0clN0eWxlLmhlaWdodCwgMTApICsgcGFyc2VJbnQodHJTdHlsZS5ib3JkZXJUb3BXaWR0aCwgMTApICsgcGFyc2VJbnQodHJTdHlsZS5ib3JkZXJCb3R0b21XaWR0aCwgMTApID09PSB0ci5vZmZzZXRIZWlnaHQ7CiAgICAgICAgICBkb2N1bWVudEVsZW1lbnQucmVtb3ZlQ2hpbGQodGFibGUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVsaWFibGVUckRpbWVuc2lvbnNWYWw7CiAgICAgIH0KICAgIH0pOwogIH0pKCk7CiAgZnVuY3Rpb24gY3VyQ1NTKGVsZW0sIG5hbWUsIGNvbXB1dGVkKSB7CiAgICB2YXIgd2lkdGgsCiAgICAgIG1pbldpZHRoLAogICAgICBtYXhXaWR0aCwKICAgICAgcmV0LAogICAgICBpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KG5hbWUpLAogICAgICAvLyBTdXBwb3J0OiBGaXJlZm94IDUxKwogICAgICAvLyBSZXRyaWV2aW5nIHN0eWxlIGJlZm9yZSBjb21wdXRlZCBzb21laG93CiAgICAgIC8vIGZpeGVzIGFuIGlzc3VlIHdpdGggZ2V0dGluZyB3cm9uZyB2YWx1ZXMKICAgICAgLy8gb24gZGV0YWNoZWQgZWxlbWVudHMKICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlOwogICAgY29tcHV0ZWQgPSBjb21wdXRlZCB8fCBnZXRTdHlsZXMoZWxlbSk7CgogICAgLy8gZ2V0UHJvcGVydHlWYWx1ZSBpcyBuZWVkZWQgZm9yOgogICAgLy8gICAuY3NzKCdmaWx0ZXInKSAoSUUgOSBvbmx5LCB0cmFjLTEyNTM3KQogICAgLy8gICAuY3NzKCctLWN1c3RvbVByb3BlcnR5KSAoZ2gtMzE0NCkKICAgIGlmIChjb21wdXRlZCkgewogICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSsKICAgICAgLy8gSUUgb25seSBzdXBwb3J0cyBgImZsb2F0ImAgaW4gYGdldFByb3BlcnR5VmFsdWVgOyBpbiBjb21wdXRlZCBzdHlsZXMKICAgICAgLy8gaXQncyBvbmx5IGF2YWlsYWJsZSBhcyBgImNzc0Zsb2F0ImAuIFdlIG5vIGxvbmdlciBtb2RpZnkgcHJvcGVydGllcwogICAgICAvLyBzZW50IHRvIGAuY3NzKClgIGFwYXJ0IGZyb20gY2FtZWxDYXNpbmcsIHNvIHdlIG5lZWQgdG8gY2hlY2sgYm90aC4KICAgICAgLy8gTm9ybWFsbHksIHRoaXMgd291bGQgY3JlYXRlIGRpZmZlcmVuY2UgaW4gYmVoYXZpb3I6IGlmCiAgICAgIC8vIGBnZXRQcm9wZXJ0eVZhbHVlYCByZXR1cm5zIGFuIGVtcHR5IHN0cmluZywgdGhlIHZhbHVlIHJldHVybmVkCiAgICAgIC8vIGJ5IGAuY3NzKClgIHdvdWxkIGJlIGB1bmRlZmluZWRgLiBUaGlzIGlzIHVzdWFsbHkgdGhlIGNhc2UgZm9yCiAgICAgIC8vIGRpc2Nvbm5lY3RlZCBlbGVtZW50cy4gSG93ZXZlciwgaW4gSUUgZXZlbiBkaXNjb25uZWN0ZWQgZWxlbWVudHMKICAgICAgLy8gd2l0aCBubyBzdHlsZXMgcmV0dXJuIGAibm9uZSJgIGZvciBgZ2V0UHJvcGVydHlWYWx1ZSggImZsb2F0IiApYAogICAgICByZXQgPSBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKG5hbWUpIHx8IGNvbXB1dGVkW25hbWVdOwogICAgICBpZiAoaXNDdXN0b21Qcm9wICYmIHJldCkgewogICAgICAgIC8vIFN1cHBvcnQ6IEZpcmVmb3ggMTA1KywgQ2hyb21lIDw9MTA1KwogICAgICAgIC8vIFNwZWMgcmVxdWlyZXMgdHJpbW1pbmcgd2hpdGVzcGFjZSBmb3IgY3VzdG9tIHByb3BlcnRpZXMgKGdoLTQ5MjYpLgogICAgICAgIC8vIEZpcmVmb3ggb25seSB0cmltcyBsZWFkaW5nIHdoaXRlc3BhY2UuIENocm9tZSBqdXN0IGNvbGxhcHNlcwogICAgICAgIC8vIGJvdGggbGVhZGluZyAmIHRyYWlsaW5nIHdoaXRlc3BhY2UgdG8gYSBzaW5nbGUgc3BhY2UuCiAgICAgICAgLy8KICAgICAgICAvLyBGYWxsIGJhY2sgdG8gYHVuZGVmaW5lZGAgaWYgZW1wdHkgc3RyaW5nIHJldHVybmVkLgogICAgICAgIC8vIFRoaXMgY29sbGFwc2VzIGEgbWlzc2luZyBkZWZpbml0aW9uIHdpdGggcHJvcGVydHkgZGVmaW5lZAogICAgICAgIC8vIGFuZCBzZXQgdG8gYW4gZW1wdHkgc3RyaW5nIGJ1dCB0aGVyZSdzIG5vIHN0YW5kYXJkIEFQSQogICAgICAgIC8vIGFsbG93aW5nIHVzIHRvIGRpZmZlcmVudGlhdGUgdGhlbSB3aXRob3V0IGEgcGVyZm9ybWFuY2UgcGVuYWx0eQogICAgICAgIC8vIGFuZCByZXR1cm5pbmcgYHVuZGVmaW5lZGAgYWxpZ25zIHdpdGggb2xkZXIgalF1ZXJ5LgogICAgICAgIC8vCiAgICAgICAgLy8gcnRyaW1DU1MgdHJlYXRzIFUrMDAwRCBDQVJSSUFHRSBSRVRVUk4gYW5kIFUrMDAwQyBGT1JNIEZFRUQKICAgICAgICAvLyBhcyB3aGl0ZXNwYWNlIHdoaWxlIENTUyBkb2VzIG5vdCwgYnV0IHRoaXMgaXMgbm90IGEgcHJvYmxlbQogICAgICAgIC8vIGJlY2F1c2UgQ1NTIHByZXByb2Nlc3NpbmcgcmVwbGFjZXMgdGhlbSB3aXRoIFUrMDAwQSBMSU5FIEZFRUQKICAgICAgICAvLyAod2hpY2ggKmlzKiBDU1Mgd2hpdGVzcGFjZSkKICAgICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvY3NzLXN5bnRheC0zLyNpbnB1dC1wcmVwcm9jZXNzaW5nCiAgICAgICAgcmV0ID0gcmV0LnJlcGxhY2UocnRyaW1DU1MsICIkMSIpIHx8IHVuZGVmaW5lZDsKICAgICAgfQogICAgICBpZiAocmV0ID09PSAiIiAmJiAhaXNBdHRhY2hlZChlbGVtKSkgewogICAgICAgIHJldCA9IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lKTsKICAgICAgfQoKICAgICAgLy8gQSB0cmlidXRlIHRvIHRoZSAiYXdlc29tZSBoYWNrIGJ5IERlYW4gRWR3YXJkcyIKICAgICAgLy8gQW5kcm9pZCBCcm93c2VyIHJldHVybnMgcGVyY2VudGFnZSBmb3Igc29tZSB2YWx1ZXMsCiAgICAgIC8vIGJ1dCB3aWR0aCBzZWVtcyB0byBiZSByZWxpYWJseSBwaXhlbHMuCiAgICAgIC8vIFRoaXMgaXMgYWdhaW5zdCB0aGUgQ1NTT00gZHJhZnQgc3BlYzoKICAgICAgLy8gaHR0cHM6Ly9kcmFmdHMuY3Nzd2cub3JnL2Nzc29tLyNyZXNvbHZlZC12YWx1ZXMKICAgICAgaWYgKCFzdXBwb3J0LnBpeGVsQm94U3R5bGVzKCkgJiYgcm51bW5vbnB4LnRlc3QocmV0KSAmJiByYm94U3R5bGUudGVzdChuYW1lKSkgewogICAgICAgIC8vIFJlbWVtYmVyIHRoZSBvcmlnaW5hbCB2YWx1ZXMKICAgICAgICB3aWR0aCA9IHN0eWxlLndpZHRoOwogICAgICAgIG1pbldpZHRoID0gc3R5bGUubWluV2lkdGg7CiAgICAgICAgbWF4V2lkdGggPSBzdHlsZS5tYXhXaWR0aDsKCiAgICAgICAgLy8gUHV0IGluIHRoZSBuZXcgdmFsdWVzIHRvIGdldCBhIGNvbXB1dGVkIHZhbHVlIG91dAogICAgICAgIHN0eWxlLm1pbldpZHRoID0gc3R5bGUubWF4V2lkdGggPSBzdHlsZS53aWR0aCA9IHJldDsKICAgICAgICByZXQgPSBjb21wdXRlZC53aWR0aDsKCiAgICAgICAgLy8gUmV2ZXJ0IHRoZSBjaGFuZ2VkIHZhbHVlcwogICAgICAgIHN0eWxlLndpZHRoID0gd2lkdGg7CiAgICAgICAgc3R5bGUubWluV2lkdGggPSBtaW5XaWR0aDsKICAgICAgICBzdHlsZS5tYXhXaWR0aCA9IG1heFdpZHRoOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmV0ICE9PSB1bmRlZmluZWQgPwogICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgLy8gSUUgcmV0dXJucyB6SW5kZXggdmFsdWUgYXMgYW4gaW50ZWdlci4KICAgIHJldCArICIiIDogcmV0OwogIH0KICBmdW5jdGlvbiBhZGRHZXRIb29rSWYoY29uZGl0aW9uRm4sIGhvb2tGbikgewogICAgLy8gRGVmaW5lIHRoZSBob29rLCB3ZSdsbCBjaGVjayBvbiB0aGUgZmlyc3QgcnVuIGlmIGl0J3MgcmVhbGx5IG5lZWRlZC4KICAgIHJldHVybiB7CiAgICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChjb25kaXRpb25GbigpKSB7CiAgICAgICAgICAvLyBIb29rIG5vdCBuZWVkZWQgKG9yIGl0J3Mgbm90IHBvc3NpYmxlIHRvIHVzZSBpdCBkdWUKICAgICAgICAgIC8vIHRvIG1pc3NpbmcgZGVwZW5kZW5jeSksIHJlbW92ZSBpdC4KICAgICAgICAgIGRlbGV0ZSB0aGlzLmdldDsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vIEhvb2sgbmVlZGVkOyByZWRlZmluZSBpdCBzbyB0aGF0IHRoZSBzdXBwb3J0IHRlc3QgaXMgbm90IGV4ZWN1dGVkIGFnYWluLgogICAgICAgIHJldHVybiAodGhpcy5nZXQgPSBob29rRm4pLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQogIHZhciBjc3NQcmVmaXhlcyA9IFsiV2Via2l0IiwgIk1veiIsICJtcyJdLAogICAgZW1wdHlTdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpLnN0eWxlLAogICAgdmVuZG9yUHJvcHMgPSB7fTsKCiAgLy8gUmV0dXJuIGEgdmVuZG9yLXByZWZpeGVkIHByb3BlcnR5IG9yIHVuZGVmaW5lZAogIGZ1bmN0aW9uIHZlbmRvclByb3BOYW1lKG5hbWUpIHsKICAgIC8vIENoZWNrIGZvciB2ZW5kb3IgcHJlZml4ZWQgbmFtZXMKICAgIHZhciBjYXBOYW1lID0gbmFtZVswXS50b1VwcGVyQ2FzZSgpICsgbmFtZS5zbGljZSgxKSwKICAgICAgaSA9IGNzc1ByZWZpeGVzLmxlbmd0aDsKICAgIHdoaWxlIChpLS0pIHsKICAgICAgbmFtZSA9IGNzc1ByZWZpeGVzW2ldICsgY2FwTmFtZTsKICAgICAgaWYgKG5hbWUgaW4gZW1wdHlTdHlsZSkgewogICAgICAgIHJldHVybiBuYW1lOwogICAgICB9CiAgICB9CiAgfQoKICAvLyBSZXR1cm4gYSBwb3RlbnRpYWxseS1tYXBwZWQgalF1ZXJ5LmNzc1Byb3BzIG9yIHZlbmRvciBwcmVmaXhlZCBwcm9wZXJ0eQogIGZ1bmN0aW9uIGZpbmFsUHJvcE5hbWUobmFtZSkgewogICAgdmFyIGZpbmFsID0galF1ZXJ5LmNzc1Byb3BzW25hbWVdIHx8IHZlbmRvclByb3BzW25hbWVdOwogICAgaWYgKGZpbmFsKSB7CiAgICAgIHJldHVybiBmaW5hbDsKICAgIH0KICAgIGlmIChuYW1lIGluIGVtcHR5U3R5bGUpIHsKICAgICAgcmV0dXJuIG5hbWU7CiAgICB9CiAgICByZXR1cm4gdmVuZG9yUHJvcHNbbmFtZV0gPSB2ZW5kb3JQcm9wTmFtZShuYW1lKSB8fCBuYW1lOwogIH0KICB2YXIKICAgIC8vIFN3YXBwYWJsZSBpZiBkaXNwbGF5IGlzIG5vbmUgb3Igc3RhcnRzIHdpdGggdGFibGUKICAgIC8vIGV4Y2VwdCAidGFibGUiLCAidGFibGUtY2VsbCIsIG9yICJ0YWJsZS1jYXB0aW9uIgogICAgLy8gU2VlIGhlcmUgZm9yIGRpc3BsYXkgdmFsdWVzOiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0NTUy9kaXNwbGF5CiAgICByZGlzcGxheXN3YXAgPSAvXihub25lfHRhYmxlKD8hLWNbZWFdKS4rKS8sCiAgICBjc3NTaG93ID0gewogICAgICBwb3NpdGlvbjogImFic29sdXRlIiwKICAgICAgdmlzaWJpbGl0eTogImhpZGRlbiIsCiAgICAgIGRpc3BsYXk6ICJibG9jayIKICAgIH0sCiAgICBjc3NOb3JtYWxUcmFuc2Zvcm0gPSB7CiAgICAgIGxldHRlclNwYWNpbmc6ICIwIiwKICAgICAgZm9udFdlaWdodDogIjQwMCIKICAgIH07CiAgZnVuY3Rpb24gc2V0UG9zaXRpdmVOdW1iZXIoX2VsZW0sIHZhbHVlLCBzdWJ0cmFjdCkgewogICAgLy8gQW55IHJlbGF0aXZlICgrLy0pIHZhbHVlcyBoYXZlIGFscmVhZHkgYmVlbgogICAgLy8gbm9ybWFsaXplZCBhdCB0aGlzIHBvaW50CiAgICB2YXIgbWF0Y2hlcyA9IHJjc3NOdW0uZXhlYyh2YWx1ZSk7CiAgICByZXR1cm4gbWF0Y2hlcyA/CiAgICAvLyBHdWFyZCBhZ2FpbnN0IHVuZGVmaW5lZCAic3VidHJhY3QiLCBlLmcuLCB3aGVuIHVzZWQgYXMgaW4gY3NzSG9va3MKICAgIE1hdGgubWF4KDAsIG1hdGNoZXNbMl0gLSAoc3VidHJhY3QgfHwgMCkpICsgKG1hdGNoZXNbM10gfHwgInB4IikgOiB2YWx1ZTsKICB9CiAgZnVuY3Rpb24gYm94TW9kZWxBZGp1c3RtZW50KGVsZW0sIGRpbWVuc2lvbiwgYm94LCBpc0JvcmRlckJveCwgc3R5bGVzLCBjb21wdXRlZFZhbCkgewogICAgdmFyIGkgPSBkaW1lbnNpb24gPT09ICJ3aWR0aCIgPyAxIDogMCwKICAgICAgZXh0cmEgPSAwLAogICAgICBkZWx0YSA9IDA7CgogICAgLy8gQWRqdXN0bWVudCBtYXkgbm90IGJlIG5lY2Vzc2FyeQogICAgaWYgKGJveCA9PT0gKGlzQm9yZGVyQm94ID8gImJvcmRlciIgOiAiY29udGVudCIpKSB7CiAgICAgIHJldHVybiAwOwogICAgfQogICAgZm9yICg7IGkgPCA0OyBpICs9IDIpIHsKICAgICAgLy8gQm90aCBib3ggbW9kZWxzIGV4Y2x1ZGUgbWFyZ2luCiAgICAgIGlmIChib3ggPT09ICJtYXJnaW4iKSB7CiAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCBib3ggKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CiAgICAgIH0KCiAgICAgIC8vIElmIHdlIGdldCBoZXJlIHdpdGggYSBjb250ZW50LWJveCwgd2UncmUgc2Vla2luZyAicGFkZGluZyIgb3IgImJvcmRlciIgb3IgIm1hcmdpbiIKICAgICAgaWYgKCFpc0JvcmRlckJveCkgewogICAgICAgIC8vIEFkZCBwYWRkaW5nCiAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAicGFkZGluZyIgKyBjc3NFeHBhbmRbaV0sIHRydWUsIHN0eWxlcyk7CgogICAgICAgIC8vIEZvciAiYm9yZGVyIiBvciAibWFyZ2luIiwgYWRkIGJvcmRlcgogICAgICAgIGlmIChib3ggIT09ICJwYWRkaW5nIikgewogICAgICAgICAgZGVsdGEgKz0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CgogICAgICAgICAgLy8gQnV0IHN0aWxsIGtlZXAgdHJhY2sgb2YgaXQgb3RoZXJ3aXNlCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGV4dHJhICs9IGpRdWVyeS5jc3MoZWxlbSwgImJvcmRlciIgKyBjc3NFeHBhbmRbaV0gKyAiV2lkdGgiLCB0cnVlLCBzdHlsZXMpOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgd2UgZ2V0IGhlcmUgd2l0aCBhIGJvcmRlci1ib3ggKGNvbnRlbnQgKyBwYWRkaW5nICsgYm9yZGVyKSwgd2UncmUgc2Vla2luZyAiY29udGVudCIgb3IKICAgICAgICAvLyAicGFkZGluZyIgb3IgIm1hcmdpbiIKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBGb3IgImNvbnRlbnQiLCBzdWJ0cmFjdCBwYWRkaW5nCiAgICAgICAgaWYgKGJveCA9PT0gImNvbnRlbnQiKSB7CiAgICAgICAgICBkZWx0YSAtPSBqUXVlcnkuY3NzKGVsZW0sICJwYWRkaW5nIiArIGNzc0V4cGFuZFtpXSwgdHJ1ZSwgc3R5bGVzKTsKICAgICAgICB9CgogICAgICAgIC8vIEZvciAiY29udGVudCIgb3IgInBhZGRpbmciLCBzdWJ0cmFjdCBib3JkZXIKICAgICAgICBpZiAoYm94ICE9PSAibWFyZ2luIikgewogICAgICAgICAgZGVsdGEgLT0galF1ZXJ5LmNzcyhlbGVtLCAiYm9yZGVyIiArIGNzc0V4cGFuZFtpXSArICJXaWR0aCIsIHRydWUsIHN0eWxlcyk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gQWNjb3VudCBmb3IgcG9zaXRpdmUgY29udGVudC1ib3ggc2Nyb2xsIGd1dHRlciB3aGVuIHJlcXVlc3RlZCBieSBwcm92aWRpbmcgY29tcHV0ZWRWYWwKICAgIGlmICghaXNCb3JkZXJCb3ggJiYgY29tcHV0ZWRWYWwgPj0gMCkgewogICAgICAvLyBvZmZzZXRXaWR0aC9vZmZzZXRIZWlnaHQgaXMgYSByb3VuZGVkIHN1bSBvZiBjb250ZW50LCBwYWRkaW5nLCBzY3JvbGwgZ3V0dGVyLCBhbmQgYm9yZGVyCiAgICAgIC8vIEFzc3VtaW5nIGludGVnZXIgc2Nyb2xsIGd1dHRlciwgc3VidHJhY3QgdGhlIHJlc3QgYW5kIHJvdW5kIGRvd24KICAgICAgZGVsdGEgKz0gTWF0aC5tYXgoMCwgTWF0aC5jZWlsKGVsZW1bIm9mZnNldCIgKyBkaW1lbnNpb25bMF0udG9VcHBlckNhc2UoKSArIGRpbWVuc2lvbi5zbGljZSgxKV0gLSBjb21wdXRlZFZhbCAtIGRlbHRhIC0gZXh0cmEgLSAwLjUKCiAgICAgIC8vIElmIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBpcyB1bmtub3duLCB0aGVuIHdlIGNhbid0IGRldGVybWluZSBjb250ZW50LWJveCBzY3JvbGwgZ3V0dGVyCiAgICAgIC8vIFVzZSBhbiBleHBsaWNpdCB6ZXJvIHRvIGF2b2lkIE5hTiAoZ2gtMzk2NCkKICAgICAgKSkgfHwgMDsKICAgIH0KICAgIHJldHVybiBkZWx0YTsKICB9CiAgZnVuY3Rpb24gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKSB7CiAgICAvLyBTdGFydCB3aXRoIGNvbXB1dGVkIHN0eWxlCiAgICB2YXIgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pLAogICAgICAvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC00MzIyKS4KICAgICAgLy8gRmFrZSBjb250ZW50LWJveCB1bnRpbCB3ZSBrbm93IGl0J3MgbmVlZGVkIHRvIGtub3cgdGhlIHRydWUgdmFsdWUuCiAgICAgIGJveFNpemluZ05lZWRlZCA9ICFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgfHwgZXh0cmEsCiAgICAgIGlzQm9yZGVyQm94ID0gYm94U2l6aW5nTmVlZGVkICYmIGpRdWVyeS5jc3MoZWxlbSwgImJveFNpemluZyIsIGZhbHNlLCBzdHlsZXMpID09PSAiYm9yZGVyLWJveCIsCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBpc0JvcmRlckJveCwKICAgICAgdmFsID0gY3VyQ1NTKGVsZW0sIGRpbWVuc2lvbiwgc3R5bGVzKSwKICAgICAgb2Zmc2V0UHJvcCA9ICJvZmZzZXQiICsgZGltZW5zaW9uWzBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoMSk7CgogICAgLy8gU3VwcG9ydDogRmlyZWZveCA8PTU0CiAgICAvLyBSZXR1cm4gYSBjb25mb3VuZGluZyBub24tcGl4ZWwgdmFsdWUgb3IgZmVpZ24gaWdub3JhbmNlLCBhcyBhcHByb3ByaWF0ZS4KICAgIGlmIChybnVtbm9ucHgudGVzdCh2YWwpKSB7CiAgICAgIGlmICghZXh0cmEpIHsKICAgICAgICByZXR1cm4gdmFsOwogICAgICB9CiAgICAgIHZhbCA9ICJhdXRvIjsKICAgIH0KCiAgICAvLyBTdXBwb3J0OiBJRSA5IC0gMTEgb25seQogICAgLy8gVXNlIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCBmb3Igd2hlbiBib3ggc2l6aW5nIGlzIHVucmVsaWFibGUuCiAgICAvLyBJbiB0aG9zZSBjYXNlcywgdGhlIGNvbXB1dGVkIHZhbHVlIGNhbiBiZSB0cnVzdGVkIHRvIGJlIGJvcmRlci1ib3guCiAgICBpZiAoKCFzdXBwb3J0LmJveFNpemluZ1JlbGlhYmxlKCkgJiYgaXNCb3JkZXJCb3ggfHwKICAgIC8vIFN1cHBvcnQ6IElFIDEwIC0gMTErLCBFZGdlIDE1IC0gMTgrCiAgICAvLyBJRS9FZGdlIG1pc3JlcG9ydCBgZ2V0Q29tcHV0ZWRTdHlsZWAgb2YgdGFibGUgcm93cyB3aXRoIHdpZHRoL2hlaWdodAogICAgLy8gc2V0IGluIENTUyB3aGlsZSBgb2Zmc2V0KmAgcHJvcGVydGllcyByZXBvcnQgY29ycmVjdCB2YWx1ZXMuCiAgICAvLyBJbnRlcmVzdGluZ2x5LCBpbiBzb21lIGNhc2VzIElFIDkgZG9lc24ndCBzdWZmZXIgZnJvbSB0aGlzIGlzc3VlLgogICAgIXN1cHBvcnQucmVsaWFibGVUckRpbWVuc2lvbnMoKSAmJiBub2RlTmFtZShlbGVtLCAidHIiKSB8fAogICAgLy8gRmFsbCBiYWNrIHRvIG9mZnNldFdpZHRoL29mZnNldEhlaWdodCB3aGVuIHZhbHVlIGlzICJhdXRvIgogICAgLy8gVGhpcyBoYXBwZW5zIGZvciBpbmxpbmUgZWxlbWVudHMgd2l0aCBubyBleHBsaWNpdCBzZXR0aW5nIChnaC0zNTcxKQogICAgdmFsID09PSAiYXV0byIgfHwKICAgIC8vIFN1cHBvcnQ6IEFuZHJvaWQgPD00LjEgLSA0LjMgb25seQogICAgLy8gQWxzbyB1c2Ugb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGZvciBtaXNyZXBvcnRlZCBpbmxpbmUgZGltZW5zaW9ucyAoZ2gtMzYwMikKICAgICFwYXJzZUZsb2F0KHZhbCkgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiZGlzcGxheSIsIGZhbHNlLCBzdHlsZXMpID09PSAiaW5saW5lIikgJiYKICAgIC8vIE1ha2Ugc3VyZSB0aGUgZWxlbWVudCBpcyB2aXNpYmxlICYgY29ubmVjdGVkCiAgICBlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoKSB7CiAgICAgIGlzQm9yZGVyQm94ID0galF1ZXJ5LmNzcyhlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcykgPT09ICJib3JkZXItYm94IjsKCiAgICAgIC8vIFdoZXJlIGF2YWlsYWJsZSwgb2Zmc2V0V2lkdGgvb2Zmc2V0SGVpZ2h0IGFwcHJveGltYXRlIGJvcmRlciBib3ggZGltZW5zaW9ucy4KICAgICAgLy8gV2hlcmUgbm90IGF2YWlsYWJsZSAoZS5nLiwgU1ZHKSwgYXNzdW1lIHVucmVsaWFibGUgYm94LXNpemluZyBhbmQgaW50ZXJwcmV0IHRoZQogICAgICAvLyByZXRyaWV2ZWQgdmFsdWUgYXMgYSBjb250ZW50IGJveCBkaW1lbnNpb24uCiAgICAgIHZhbHVlSXNCb3JkZXJCb3ggPSBvZmZzZXRQcm9wIGluIGVsZW07CiAgICAgIGlmICh2YWx1ZUlzQm9yZGVyQm94KSB7CiAgICAgICAgdmFsID0gZWxlbVtvZmZzZXRQcm9wXTsKICAgICAgfQogICAgfQoKICAgIC8vIE5vcm1hbGl6ZSAiIiBhbmQgYXV0bwogICAgdmFsID0gcGFyc2VGbG9hdCh2YWwpIHx8IDA7CgogICAgLy8gQWRqdXN0IGZvciB0aGUgZWxlbWVudCdzIGJveCBtb2RlbAogICAgcmV0dXJuIHZhbCArIGJveE1vZGVsQWRqdXN0bWVudChlbGVtLCBkaW1lbnNpb24sIGV4dHJhIHx8IChpc0JvcmRlckJveCA/ICJib3JkZXIiIDogImNvbnRlbnQiKSwgdmFsdWVJc0JvcmRlckJveCwgc3R5bGVzLAogICAgLy8gUHJvdmlkZSB0aGUgY3VycmVudCBjb21wdXRlZCBzaXplIHRvIHJlcXVlc3Qgc2Nyb2xsIGd1dHRlciBjYWxjdWxhdGlvbiAoZ2gtMzU4OSkKICAgIHZhbCkgKyAicHgiOwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIEFkZCBpbiBzdHlsZSBwcm9wZXJ0eSBob29rcyBmb3Igb3ZlcnJpZGluZyB0aGUgZGVmYXVsdAogICAgLy8gYmVoYXZpb3Igb2YgZ2V0dGluZyBhbmQgc2V0dGluZyBhIHN0eWxlIHByb3BlcnR5CiAgICBjc3NIb29rczogewogICAgICBvcGFjaXR5OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgICAgIGlmIChjb21wdXRlZCkgewogICAgICAgICAgICAvLyBXZSBzaG91bGQgYWx3YXlzIGdldCBhIG51bWJlciBiYWNrIGZyb20gb3BhY2l0eQogICAgICAgICAgICB2YXIgcmV0ID0gY3VyQ1NTKGVsZW0sICJvcGFjaXR5Iik7CiAgICAgICAgICAgIHJldHVybiByZXQgPT09ICIiID8gIjEiIDogcmV0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIC8vIERvbid0IGF1dG9tYXRpY2FsbHkgYWRkICJweCIgdG8gdGhlc2UgcG9zc2libHktdW5pdGxlc3MgcHJvcGVydGllcwogICAgY3NzTnVtYmVyOiB7CiAgICAgICJhbmltYXRpb25JdGVyYXRpb25Db3VudCI6IHRydWUsCiAgICAgICJjb2x1bW5Db3VudCI6IHRydWUsCiAgICAgICJmaWxsT3BhY2l0eSI6IHRydWUsCiAgICAgICJmbGV4R3JvdyI6IHRydWUsCiAgICAgICJmbGV4U2hyaW5rIjogdHJ1ZSwKICAgICAgImZvbnRXZWlnaHQiOiB0cnVlLAogICAgICAiZ3JpZEFyZWEiOiB0cnVlLAogICAgICAiZ3JpZENvbHVtbiI6IHRydWUsCiAgICAgICJncmlkQ29sdW1uRW5kIjogdHJ1ZSwKICAgICAgImdyaWRDb2x1bW5TdGFydCI6IHRydWUsCiAgICAgICJncmlkUm93IjogdHJ1ZSwKICAgICAgImdyaWRSb3dFbmQiOiB0cnVlLAogICAgICAiZ3JpZFJvd1N0YXJ0IjogdHJ1ZSwKICAgICAgImxpbmVIZWlnaHQiOiB0cnVlLAogICAgICAib3BhY2l0eSI6IHRydWUsCiAgICAgICJvcmRlciI6IHRydWUsCiAgICAgICJvcnBoYW5zIjogdHJ1ZSwKICAgICAgIndpZG93cyI6IHRydWUsCiAgICAgICJ6SW5kZXgiOiB0cnVlLAogICAgICAiem9vbSI6IHRydWUKICAgIH0sCiAgICAvLyBBZGQgaW4gcHJvcGVydGllcyB3aG9zZSBuYW1lcyB5b3Ugd2lzaCB0byBmaXggYmVmb3JlCiAgICAvLyBzZXR0aW5nIG9yIGdldHRpbmcgdGhlIHZhbHVlCiAgICBjc3NQcm9wczoge30sCiAgICAvLyBHZXQgYW5kIHNldCB0aGUgc3R5bGUgcHJvcGVydHkgb24gYSBET00gTm9kZQogICAgc3R5bGU6IGZ1bmN0aW9uIChlbGVtLCBuYW1lLCB2YWx1ZSwgZXh0cmEpIHsKICAgICAgLy8gRG9uJ3Qgc2V0IHN0eWxlcyBvbiB0ZXh0IGFuZCBjb21tZW50IG5vZGVzCiAgICAgIGlmICghZWxlbSB8fCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDggfHwgIWVsZW0uc3R5bGUpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IHdlJ3JlIHdvcmtpbmcgd2l0aCB0aGUgcmlnaHQgbmFtZQogICAgICB2YXIgcmV0LAogICAgICAgIHR5cGUsCiAgICAgICAgaG9va3MsCiAgICAgICAgb3JpZ05hbWUgPSBjYW1lbENhc2UobmFtZSksCiAgICAgICAgaXNDdXN0b21Qcm9wID0gcmN1c3RvbVByb3AudGVzdChuYW1lKSwKICAgICAgICBzdHlsZSA9IGVsZW0uc3R5bGU7CgogICAgICAvLyBNYWtlIHN1cmUgdGhhdCB3ZSdyZSB3b3JraW5nIHdpdGggdGhlIHJpZ2h0IG5hbWUuIFdlIGRvbid0CiAgICAgIC8vIHdhbnQgdG8gcXVlcnkgdGhlIHZhbHVlIGlmIGl0IGlzIGEgQ1NTIGN1c3RvbSBwcm9wZXJ0eQogICAgICAvLyBzaW5jZSB0aGV5IGFyZSB1c2VyLWRlZmluZWQuCiAgICAgIGlmICghaXNDdXN0b21Qcm9wKSB7CiAgICAgICAgbmFtZSA9IGZpbmFsUHJvcE5hbWUob3JpZ05hbWUpOwogICAgICB9CgogICAgICAvLyBHZXRzIGhvb2sgZm9yIHRoZSBwcmVmaXhlZCB2ZXJzaW9uLCB0aGVuIHVucHJlZml4ZWQgdmVyc2lvbgogICAgICBob29rcyA9IGpRdWVyeS5jc3NIb29rc1tuYW1lXSB8fCBqUXVlcnkuY3NzSG9va3Nbb3JpZ05hbWVdOwoKICAgICAgLy8gQ2hlY2sgaWYgd2UncmUgc2V0dGluZyBhIHZhbHVlCiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgdHlwZSA9IHR5cGVvZiB2YWx1ZTsKCiAgICAgICAgLy8gQ29udmVydCAiKz0iIG9yICItPSIgdG8gcmVsYXRpdmUgbnVtYmVycyAodHJhYy03MzQ1KQogICAgICAgIGlmICh0eXBlID09PSAic3RyaW5nIiAmJiAocmV0ID0gcmNzc051bS5leGVjKHZhbHVlKSkgJiYgcmV0WzFdKSB7CiAgICAgICAgICB2YWx1ZSA9IGFkanVzdENTUyhlbGVtLCBuYW1lLCByZXQpOwoKICAgICAgICAgIC8vIEZpeGVzIGJ1ZyB0cmFjLTkyMzcKICAgICAgICAgIHR5cGUgPSAibnVtYmVyIjsKICAgICAgICB9CgogICAgICAgIC8vIE1ha2Ugc3VyZSB0aGF0IG51bGwgYW5kIE5hTiB2YWx1ZXMgYXJlbid0IHNldCAodHJhYy03MTE2KQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsIHx8IHZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gSWYgYSBudW1iZXIgd2FzIHBhc3NlZCBpbiwgYWRkIHRoZSB1bml0IChleGNlcHQgZm9yIGNlcnRhaW4gQ1NTIHByb3BlcnRpZXMpCiAgICAgICAgLy8gVGhlIGlzQ3VzdG9tUHJvcCBjaGVjayBjYW4gYmUgcmVtb3ZlZCBpbiBqUXVlcnkgNC4wIHdoZW4gd2Ugb25seSBhdXRvLWFwcGVuZAogICAgICAgIC8vICJweCIgdG8gYSBmZXcgaGFyZGNvZGVkIHZhbHVlcy4KICAgICAgICBpZiAodHlwZSA9PT0gIm51bWJlciIgJiYgIWlzQ3VzdG9tUHJvcCkgewogICAgICAgICAgdmFsdWUgKz0gcmV0ICYmIHJldFszXSB8fCAoalF1ZXJ5LmNzc051bWJlcltvcmlnTmFtZV0gPyAiIiA6ICJweCIpOwogICAgICAgIH0KCiAgICAgICAgLy8gYmFja2dyb3VuZC0qIHByb3BzIGFmZmVjdCBvcmlnaW5hbCBjbG9uZSdzIHZhbHVlcwogICAgICAgIGlmICghc3VwcG9ydC5jbGVhckNsb25lU3R5bGUgJiYgdmFsdWUgPT09ICIiICYmIG5hbWUuaW5kZXhPZigiYmFja2dyb3VuZCIpID09PSAwKSB7CiAgICAgICAgICBzdHlsZVtuYW1lXSA9ICJpbmhlcml0IjsKICAgICAgICB9CgogICAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQsIHVzZSB0aGF0IHZhbHVlLCBvdGhlcndpc2UganVzdCBzZXQgdGhlIHNwZWNpZmllZCB2YWx1ZQogICAgICAgIGlmICghaG9va3MgfHwgISgic2V0IiBpbiBob29rcykgfHwgKHZhbHVlID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBleHRyYSkpICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGlmIChpc0N1c3RvbVByb3ApIHsKICAgICAgICAgICAgc3R5bGUuc2V0UHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3R5bGVbbmFtZV0gPSB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gSWYgYSBob29rIHdhcyBwcm92aWRlZCBnZXQgdGhlIG5vbi1jb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgICAgaWYgKGhvb2tzICYmICJnZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5nZXQoZWxlbSwgZmFsc2UsIGV4dHJhKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CgogICAgICAgIC8vIE90aGVyd2lzZSBqdXN0IGdldCB0aGUgdmFsdWUgZnJvbSB0aGUgc3R5bGUgb2JqZWN0CiAgICAgICAgcmV0dXJuIHN0eWxlW25hbWVdOwogICAgICB9CiAgICB9LAogICAgY3NzOiBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgZXh0cmEsIHN0eWxlcykgewogICAgICB2YXIgdmFsLAogICAgICAgIG51bSwKICAgICAgICBob29rcywKICAgICAgICBvcmlnTmFtZSA9IGNhbWVsQ2FzZShuYW1lKSwKICAgICAgICBpc0N1c3RvbVByb3AgPSByY3VzdG9tUHJvcC50ZXN0KG5hbWUpOwoKICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgd2UncmUgd29ya2luZyB3aXRoIHRoZSByaWdodCBuYW1lLiBXZSBkb24ndAogICAgICAvLyB3YW50IHRvIG1vZGlmeSB0aGUgdmFsdWUgaWYgaXQgaXMgYSBDU1MgY3VzdG9tIHByb3BlcnR5CiAgICAgIC8vIHNpbmNlIHRoZXkgYXJlIHVzZXItZGVmaW5lZC4KICAgICAgaWYgKCFpc0N1c3RvbVByb3ApIHsKICAgICAgICBuYW1lID0gZmluYWxQcm9wTmFtZShvcmlnTmFtZSk7CiAgICAgIH0KCiAgICAgIC8vIFRyeSBwcmVmaXhlZCBuYW1lIGZvbGxvd2VkIGJ5IHRoZSB1bnByZWZpeGVkIG5hbWUKICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV0gfHwgalF1ZXJ5LmNzc0hvb2tzW29yaWdOYW1lXTsKCiAgICAgIC8vIElmIGEgaG9vayB3YXMgcHJvdmlkZWQgZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBmcm9tIHRoZXJlCiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcykgewogICAgICAgIHZhbCA9IGhvb2tzLmdldChlbGVtLCB0cnVlLCBleHRyYSk7CiAgICAgIH0KCiAgICAgIC8vIE90aGVyd2lzZSwgaWYgYSB3YXkgdG8gZ2V0IHRoZSBjb21wdXRlZCB2YWx1ZSBleGlzdHMsIHVzZSB0aGF0CiAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgIHZhbCA9IGN1ckNTUyhlbGVtLCBuYW1lLCBzdHlsZXMpOwogICAgICB9CgogICAgICAvLyBDb252ZXJ0ICJub3JtYWwiIHRvIGNvbXB1dGVkIHZhbHVlCiAgICAgIGlmICh2YWwgPT09ICJub3JtYWwiICYmIG5hbWUgaW4gY3NzTm9ybWFsVHJhbnNmb3JtKSB7CiAgICAgICAgdmFsID0gY3NzTm9ybWFsVHJhbnNmb3JtW25hbWVdOwogICAgICB9CgogICAgICAvLyBNYWtlIG51bWVyaWMgaWYgZm9yY2VkIG9yIGEgcXVhbGlmaWVyIHdhcyBwcm92aWRlZCBhbmQgdmFsIGxvb2tzIG51bWVyaWMKICAgICAgaWYgKGV4dHJhID09PSAiIiB8fCBleHRyYSkgewogICAgICAgIG51bSA9IHBhcnNlRmxvYXQodmFsKTsKICAgICAgICByZXR1cm4gZXh0cmEgPT09IHRydWUgfHwgaXNGaW5pdGUobnVtKSA/IG51bSB8fCAwIDogdmFsOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmVhY2goWyJoZWlnaHQiLCAid2lkdGgiXSwgZnVuY3Rpb24gKF9pLCBkaW1lbnNpb24pIHsKICAgIGpRdWVyeS5jc3NIb29rc1tkaW1lbnNpb25dID0gewogICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCwgZXh0cmEpIHsKICAgICAgICBpZiAoY29tcHV0ZWQpIHsKICAgICAgICAgIC8vIENlcnRhaW4gZWxlbWVudHMgY2FuIGhhdmUgZGltZW5zaW9uIGluZm8gaWYgd2UgaW52aXNpYmx5IHNob3cgdGhlbQogICAgICAgICAgLy8gYnV0IGl0IG11c3QgaGF2ZSBhIGN1cnJlbnQgZGlzcGxheSBzdHlsZSB0aGF0IHdvdWxkIGJlbmVmaXQKICAgICAgICAgIHJldHVybiByZGlzcGxheXN3YXAudGVzdChqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5IikpICYmICgKICAgICAgICAgIC8vIFN1cHBvcnQ6IFNhZmFyaSA4KwogICAgICAgICAgLy8gVGFibGUgY29sdW1ucyBpbiBTYWZhcmkgaGF2ZSBub24temVybyBvZmZzZXRXaWR0aCAmIHplcm8KICAgICAgICAgIC8vIGdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoIHVubGVzcyBkaXNwbGF5IGlzIGNoYW5nZWQuCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAgICAgICAgIC8vIFJ1bm5pbmcgZ2V0Qm91bmRpbmdDbGllbnRSZWN0IG9uIGEgZGlzY29ubmVjdGVkIG5vZGUKICAgICAgICAgIC8vIGluIElFIHRocm93cyBhbiBlcnJvci4KICAgICAgICAgICFlbGVtLmdldENsaWVudFJlY3RzKCkubGVuZ3RoIHx8ICFlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKSA/IHN3YXAoZWxlbSwgY3NzU2hvdywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKTsKICAgICAgICAgIH0pIDogZ2V0V2lkdGhPckhlaWdodChlbGVtLCBkaW1lbnNpb24sIGV4dHJhKTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlLCBleHRyYSkgewogICAgICAgIHZhciBtYXRjaGVzLAogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pLAogICAgICAgICAgLy8gT25seSByZWFkIHN0eWxlcy5wb3NpdGlvbiBpZiB0aGUgdGVzdCBoYXMgYSBjaGFuY2UgdG8gZmFpbAogICAgICAgICAgLy8gdG8gYXZvaWQgZm9yY2luZyBhIHJlZmxvdy4KICAgICAgICAgIHNjcm9sbGJveFNpemVCdWdneSA9ICFzdXBwb3J0LnNjcm9sbGJveFNpemUoKSAmJiBzdHlsZXMucG9zaXRpb24gPT09ICJhYnNvbHV0ZSIsCiAgICAgICAgICAvLyBUbyBhdm9pZCBmb3JjaW5nIGEgcmVmbG93LCBvbmx5IGZldGNoIGJveFNpemluZyBpZiB3ZSBuZWVkIGl0IChnaC0zOTkxKQogICAgICAgICAgYm94U2l6aW5nTmVlZGVkID0gc2Nyb2xsYm94U2l6ZUJ1Z2d5IHx8IGV4dHJhLAogICAgICAgICAgaXNCb3JkZXJCb3ggPSBib3hTaXppbmdOZWVkZWQgJiYgalF1ZXJ5LmNzcyhlbGVtLCAiYm94U2l6aW5nIiwgZmFsc2UsIHN0eWxlcykgPT09ICJib3JkZXItYm94IiwKICAgICAgICAgIHN1YnRyYWN0ID0gZXh0cmEgPyBib3hNb2RlbEFkanVzdG1lbnQoZWxlbSwgZGltZW5zaW9uLCBleHRyYSwgaXNCb3JkZXJCb3gsIHN0eWxlcykgOiAwOwoKICAgICAgICAvLyBBY2NvdW50IGZvciB1bnJlbGlhYmxlIGJvcmRlci1ib3ggZGltZW5zaW9ucyBieSBjb21wYXJpbmcgb2Zmc2V0KiB0byBjb21wdXRlZCBhbmQKICAgICAgICAvLyBmYWtpbmcgYSBjb250ZW50LWJveCB0byBnZXQgYm9yZGVyIGFuZCBwYWRkaW5nIChnaC0zNjk5KQogICAgICAgIGlmIChpc0JvcmRlckJveCAmJiBzY3JvbGxib3hTaXplQnVnZ3kpIHsKICAgICAgICAgIHN1YnRyYWN0IC09IE1hdGguY2VpbChlbGVtWyJvZmZzZXQiICsgZGltZW5zaW9uWzBdLnRvVXBwZXJDYXNlKCkgKyBkaW1lbnNpb24uc2xpY2UoMSldIC0gcGFyc2VGbG9hdChzdHlsZXNbZGltZW5zaW9uXSkgLSBib3hNb2RlbEFkanVzdG1lbnQoZWxlbSwgZGltZW5zaW9uLCAiYm9yZGVyIiwgZmFsc2UsIHN0eWxlcykgLSAwLjUpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ29udmVydCB0byBwaXhlbHMgaWYgdmFsdWUgYWRqdXN0bWVudCBpcyBuZWVkZWQKICAgICAgICBpZiAoc3VidHJhY3QgJiYgKG1hdGNoZXMgPSByY3NzTnVtLmV4ZWModmFsdWUpKSAmJiAobWF0Y2hlc1szXSB8fCAicHgiKSAhPT0gInB4IikgewogICAgICAgICAgZWxlbS5zdHlsZVtkaW1lbnNpb25dID0gdmFsdWU7CiAgICAgICAgICB2YWx1ZSA9IGpRdWVyeS5jc3MoZWxlbSwgZGltZW5zaW9uKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNldFBvc2l0aXZlTnVtYmVyKGVsZW0sIHZhbHVlLCBzdWJ0cmFjdCk7CiAgICAgIH0KICAgIH07CiAgfSk7CiAgalF1ZXJ5LmNzc0hvb2tzLm1hcmdpbkxlZnQgPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5yZWxpYWJsZU1hcmdpbkxlZnQsIGZ1bmN0aW9uIChlbGVtLCBjb21wdXRlZCkgewogICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgIHJldHVybiAocGFyc2VGbG9hdChjdXJDU1MoZWxlbSwgIm1hcmdpbkxlZnQiKSkgfHwgZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0gc3dhcChlbGVtLCB7CiAgICAgICAgbWFyZ2luTGVmdDogMAogICAgICB9LCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdDsKICAgICAgfSkpICsgInB4IjsKICAgIH0KICB9KTsKCiAgLy8gVGhlc2UgaG9va3MgYXJlIHVzZWQgYnkgYW5pbWF0ZSB0byBleHBhbmQgcHJvcGVydGllcwogIGpRdWVyeS5lYWNoKHsKICAgIG1hcmdpbjogIiIsCiAgICBwYWRkaW5nOiAiIiwKICAgIGJvcmRlcjogIldpZHRoIgogIH0sIGZ1bmN0aW9uIChwcmVmaXgsIHN1ZmZpeCkgewogICAgalF1ZXJ5LmNzc0hvb2tzW3ByZWZpeCArIHN1ZmZpeF0gPSB7CiAgICAgIGV4cGFuZDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgZXhwYW5kZWQgPSB7fSwKICAgICAgICAgIC8vIEFzc3VtZXMgYSBzaW5nbGUgbnVtYmVyIGlmIG5vdCBhIHN0cmluZwogICAgICAgICAgcGFydHMgPSB0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciID8gdmFsdWUuc3BsaXQoIiAiKSA6IFt2YWx1ZV07CiAgICAgICAgZm9yICg7IGkgPCA0OyBpKyspIHsKICAgICAgICAgIGV4cGFuZGVkW3ByZWZpeCArIGNzc0V4cGFuZFtpXSArIHN1ZmZpeF0gPSBwYXJ0c1tpXSB8fCBwYXJ0c1tpIC0gMl0gfHwgcGFydHNbMF07CiAgICAgICAgfQogICAgICAgIHJldHVybiBleHBhbmRlZDsKICAgICAgfQogICAgfTsKICAgIGlmIChwcmVmaXggIT09ICJtYXJnaW4iKSB7CiAgICAgIGpRdWVyeS5jc3NIb29rc1twcmVmaXggKyBzdWZmaXhdLnNldCA9IHNldFBvc2l0aXZlTnVtYmVyOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgY3NzOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgdmFsdWUpIHsKICAgICAgICB2YXIgc3R5bGVzLAogICAgICAgICAgbGVuLAogICAgICAgICAgbWFwID0ge30sCiAgICAgICAgICBpID0gMDsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuYW1lKSkgewogICAgICAgICAgc3R5bGVzID0gZ2V0U3R5bGVzKGVsZW0pOwogICAgICAgICAgbGVuID0gbmFtZS5sZW5ndGg7CiAgICAgICAgICBmb3IgKDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIG1hcFtuYW1lW2ldXSA9IGpRdWVyeS5jc3MoZWxlbSwgbmFtZVtpXSwgZmFsc2UsIHN0eWxlcyk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gbWFwOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCA/IGpRdWVyeS5zdHlsZShlbGVtLCBuYW1lLCB2YWx1ZSkgOiBqUXVlcnkuY3NzKGVsZW0sIG5hbWUpOwogICAgICB9LCBuYW1lLCB2YWx1ZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEpOwogICAgfQogIH0pOwogIGZ1bmN0aW9uIFR3ZWVuKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKSB7CiAgICByZXR1cm4gbmV3IFR3ZWVuLnByb3RvdHlwZS5pbml0KGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nKTsKICB9CiAgalF1ZXJ5LlR3ZWVuID0gVHdlZW47CiAgVHdlZW4ucHJvdG90eXBlID0gewogICAgY29uc3RydWN0b3I6IFR3ZWVuLAogICAgaW5pdDogZnVuY3Rpb24gKGVsZW0sIG9wdGlvbnMsIHByb3AsIGVuZCwgZWFzaW5nLCB1bml0KSB7CiAgICAgIHRoaXMuZWxlbSA9IGVsZW07CiAgICAgIHRoaXMucHJvcCA9IHByb3A7CiAgICAgIHRoaXMuZWFzaW5nID0gZWFzaW5nIHx8IGpRdWVyeS5lYXNpbmcuX2RlZmF1bHQ7CiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLm5vdyA9IHRoaXMuY3VyKCk7CiAgICAgIHRoaXMuZW5kID0gZW5kOwogICAgICB0aGlzLnVuaXQgPSB1bml0IHx8IChqUXVlcnkuY3NzTnVtYmVyW3Byb3BdID8gIiIgOiAicHgiKTsKICAgIH0sCiAgICBjdXI6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIHJldHVybiBob29rcyAmJiBob29rcy5nZXQgPyBob29rcy5nZXQodGhpcykgOiBUd2Vlbi5wcm9wSG9va3MuX2RlZmF1bHQuZ2V0KHRoaXMpOwogICAgfSwKICAgIHJ1bjogZnVuY3Rpb24gKHBlcmNlbnQpIHsKICAgICAgdmFyIGVhc2VkLAogICAgICAgIGhvb2tzID0gVHdlZW4ucHJvcEhvb2tzW3RoaXMucHJvcF07CiAgICAgIGlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0galF1ZXJ5LmVhc2luZ1t0aGlzLmVhc2luZ10ocGVyY2VudCwgdGhpcy5vcHRpb25zLmR1cmF0aW9uICogcGVyY2VudCwgMCwgMSwgdGhpcy5vcHRpb25zLmR1cmF0aW9uKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnBvcyA9IGVhc2VkID0gcGVyY2VudDsKICAgICAgfQogICAgICB0aGlzLm5vdyA9ICh0aGlzLmVuZCAtIHRoaXMuc3RhcnQpICogZWFzZWQgKyB0aGlzLnN0YXJ0OwogICAgICBpZiAodGhpcy5vcHRpb25zLnN0ZXApIHsKICAgICAgICB0aGlzLm9wdGlvbnMuc3RlcC5jYWxsKHRoaXMuZWxlbSwgdGhpcy5ub3csIHRoaXMpOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiBob29rcy5zZXQpIHsKICAgICAgICBob29rcy5zZXQodGhpcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgVHdlZW4ucHJvcEhvb2tzLl9kZWZhdWx0LnNldCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwogIFR3ZWVuLnByb3RvdHlwZS5pbml0LnByb3RvdHlwZSA9IFR3ZWVuLnByb3RvdHlwZTsKICBUd2Vlbi5wcm9wSG9va3MgPSB7CiAgICBfZGVmYXVsdDogewogICAgICBnZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIHZhciByZXN1bHQ7CgogICAgICAgIC8vIFVzZSBhIHByb3BlcnR5IG9uIHRoZSBlbGVtZW50IGRpcmVjdGx5IHdoZW4gaXQgaXMgbm90IGEgRE9NIGVsZW1lbnQsCiAgICAgICAgLy8gb3Igd2hlbiB0aGVyZSBpcyBubyBtYXRjaGluZyBzdHlsZSBwcm9wZXJ0eSB0aGF0IGV4aXN0cy4KICAgICAgICBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSAhPT0gMSB8fCB0d2Vlbi5lbGVtW3R3ZWVuLnByb3BdICE9IG51bGwgJiYgdHdlZW4uZWxlbS5zdHlsZVt0d2Vlbi5wcm9wXSA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXTsKICAgICAgICB9CgogICAgICAgIC8vIFBhc3NpbmcgYW4gZW1wdHkgc3RyaW5nIGFzIGEgM3JkIHBhcmFtZXRlciB0byAuY3NzIHdpbGwgYXV0b21hdGljYWxseQogICAgICAgIC8vIGF0dGVtcHQgYSBwYXJzZUZsb2F0IGFuZCBmYWxsYmFjayB0byBhIHN0cmluZyBpZiB0aGUgcGFyc2UgZmFpbHMuCiAgICAgICAgLy8gU2ltcGxlIHZhbHVlcyBzdWNoIGFzICIxMHB4IiBhcmUgcGFyc2VkIHRvIEZsb2F0OwogICAgICAgIC8vIGNvbXBsZXggdmFsdWVzIHN1Y2ggYXMgInJvdGF0ZSgxcmFkKSIgYXJlIHJldHVybmVkIGFzLWlzLgogICAgICAgIHJlc3VsdCA9IGpRdWVyeS5jc3ModHdlZW4uZWxlbSwgdHdlZW4ucHJvcCwgIiIpOwoKICAgICAgICAvLyBFbXB0eSBzdHJpbmdzLCBudWxsLCB1bmRlZmluZWQgYW5kICJhdXRvIiBhcmUgY29udmVydGVkIHRvIDAuCiAgICAgICAgcmV0dXJuICFyZXN1bHQgfHwgcmVzdWx0ID09PSAiYXV0byIgPyAwIDogcmVzdWx0OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uICh0d2VlbikgewogICAgICAgIC8vIFVzZSBzdGVwIGhvb2sgZm9yIGJhY2sgY29tcGF0LgogICAgICAgIC8vIFVzZSBjc3NIb29rIGlmIGl0cyB0aGVyZS4KICAgICAgICAvLyBVc2UgLnN0eWxlIGlmIGF2YWlsYWJsZSBhbmQgdXNlIHBsYWluIHByb3BlcnRpZXMgd2hlcmUgYXZhaWxhYmxlLgogICAgICAgIGlmIChqUXVlcnkuZnguc3RlcFt0d2Vlbi5wcm9wXSkgewogICAgICAgICAgalF1ZXJ5LmZ4LnN0ZXBbdHdlZW4ucHJvcF0odHdlZW4pOwogICAgICAgIH0gZWxzZSBpZiAodHdlZW4uZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoalF1ZXJ5LmNzc0hvb2tzW3R3ZWVuLnByb3BdIHx8IHR3ZWVuLmVsZW0uc3R5bGVbZmluYWxQcm9wTmFtZSh0d2Vlbi5wcm9wKV0gIT0gbnVsbCkpIHsKICAgICAgICAgIGpRdWVyeS5zdHlsZSh0d2Vlbi5lbGVtLCB0d2Vlbi5wcm9wLCB0d2Vlbi5ub3cgKyB0d2Vlbi51bml0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdHdlZW4uZWxlbVt0d2Vlbi5wcm9wXSA9IHR3ZWVuLm5vdzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogIC8vIFBhbmljIGJhc2VkIGFwcHJvYWNoIHRvIHNldHRpbmcgdGhpbmdzIG9uIGRpc2Nvbm5lY3RlZCBub2RlcwogIFR3ZWVuLnByb3BIb29rcy5zY3JvbGxUb3AgPSBUd2Vlbi5wcm9wSG9va3Muc2Nyb2xsTGVmdCA9IHsKICAgIHNldDogZnVuY3Rpb24gKHR3ZWVuKSB7CiAgICAgIGlmICh0d2Vlbi5lbGVtLm5vZGVUeXBlICYmIHR3ZWVuLmVsZW0ucGFyZW50Tm9kZSkgewogICAgICAgIHR3ZWVuLmVsZW1bdHdlZW4ucHJvcF0gPSB0d2Vlbi5ub3c7CiAgICAgIH0KICAgIH0KICB9OwogIGpRdWVyeS5lYXNpbmcgPSB7CiAgICBsaW5lYXI6IGZ1bmN0aW9uIChwKSB7CiAgICAgIHJldHVybiBwOwogICAgfSwKICAgIHN3aW5nOiBmdW5jdGlvbiAocCkgewogICAgICByZXR1cm4gMC41IC0gTWF0aC5jb3MocCAqIE1hdGguUEkpIC8gMjsKICAgIH0sCiAgICBfZGVmYXVsdDogInN3aW5nIgogIH07CiAgalF1ZXJ5LmZ4ID0gVHdlZW4ucHJvdG90eXBlLmluaXQ7CgogIC8vIEJhY2sgY29tcGF0IDwxLjggZXh0ZW5zaW9uIHBvaW50CiAgalF1ZXJ5LmZ4LnN0ZXAgPSB7fTsKICB2YXIgZnhOb3csCiAgICBpblByb2dyZXNzLAogICAgcmZ4dHlwZXMgPSAvXig/OnRvZ2dsZXxzaG93fGhpZGUpJC8sCiAgICBycnVuID0gL3F1ZXVlSG9va3MkLzsKICBmdW5jdGlvbiBzY2hlZHVsZSgpIHsKICAgIGlmIChpblByb2dyZXNzKSB7CiAgICAgIGlmIChkb2N1bWVudC5oaWRkZW4gPT09IGZhbHNlICYmIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpIHsKICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHNjaGVkdWxlKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB3aW5kb3cuc2V0VGltZW91dChzY2hlZHVsZSwgalF1ZXJ5LmZ4LmludGVydmFsKTsKICAgICAgfQogICAgICBqUXVlcnkuZngudGljaygpOwogICAgfQogIH0KCiAgLy8gQW5pbWF0aW9ucyBjcmVhdGVkIHN5bmNocm9ub3VzbHkgd2lsbCBydW4gc3luY2hyb25vdXNseQogIGZ1bmN0aW9uIGNyZWF0ZUZ4Tm93KCkgewogICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBmeE5vdyA9IHVuZGVmaW5lZDsKICAgIH0pOwogICAgcmV0dXJuIGZ4Tm93ID0gRGF0ZS5ub3coKTsKICB9CgogIC8vIEdlbmVyYXRlIHBhcmFtZXRlcnMgdG8gY3JlYXRlIGEgc3RhbmRhcmQgYW5pbWF0aW9uCiAgZnVuY3Rpb24gZ2VuRngodHlwZSwgaW5jbHVkZVdpZHRoKSB7CiAgICB2YXIgd2hpY2gsCiAgICAgIGkgPSAwLAogICAgICBhdHRycyA9IHsKICAgICAgICBoZWlnaHQ6IHR5cGUKICAgICAgfTsKCiAgICAvLyBJZiB3ZSBpbmNsdWRlIHdpZHRoLCBzdGVwIHZhbHVlIGlzIDEgdG8gZG8gYWxsIGNzc0V4cGFuZCB2YWx1ZXMsCiAgICAvLyBvdGhlcndpc2Ugc3RlcCB2YWx1ZSBpcyAyIHRvIHNraXAgb3ZlciBMZWZ0IGFuZCBSaWdodAogICAgaW5jbHVkZVdpZHRoID0gaW5jbHVkZVdpZHRoID8gMSA6IDA7CiAgICBmb3IgKDsgaSA8IDQ7IGkgKz0gMiAtIGluY2x1ZGVXaWR0aCkgewogICAgICB3aGljaCA9IGNzc0V4cGFuZFtpXTsKICAgICAgYXR0cnNbIm1hcmdpbiIgKyB3aGljaF0gPSBhdHRyc1sicGFkZGluZyIgKyB3aGljaF0gPSB0eXBlOwogICAgfQogICAgaWYgKGluY2x1ZGVXaWR0aCkgewogICAgICBhdHRycy5vcGFjaXR5ID0gYXR0cnMud2lkdGggPSB0eXBlOwogICAgfQogICAgcmV0dXJuIGF0dHJzOwogIH0KICBmdW5jdGlvbiBjcmVhdGVUd2Vlbih2YWx1ZSwgcHJvcCwgYW5pbWF0aW9uKSB7CiAgICB2YXIgdHdlZW4sCiAgICAgIGNvbGxlY3Rpb24gPSAoQW5pbWF0aW9uLnR3ZWVuZXJzW3Byb3BdIHx8IFtdKS5jb25jYXQoQW5pbWF0aW9uLnR3ZWVuZXJzWyIqIl0pLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IGNvbGxlY3Rpb24ubGVuZ3RoOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIGlmICh0d2VlbiA9IGNvbGxlY3Rpb25baW5kZXhdLmNhbGwoYW5pbWF0aW9uLCBwcm9wLCB2YWx1ZSkpIHsKICAgICAgICAvLyBXZSdyZSBkb25lIHdpdGggdGhpcyBwcm9wZXJ0eQogICAgICAgIHJldHVybiB0d2VlbjsKICAgICAgfQogICAgfQogIH0KICBmdW5jdGlvbiBkZWZhdWx0UHJlZmlsdGVyKGVsZW0sIHByb3BzLCBvcHRzKSB7CiAgICB2YXIgcHJvcCwKICAgICAgdmFsdWUsCiAgICAgIHRvZ2dsZSwKICAgICAgaG9va3MsCiAgICAgIG9sZGZpcmUsCiAgICAgIHByb3BUd2VlbiwKICAgICAgcmVzdG9yZURpc3BsYXksCiAgICAgIGRpc3BsYXksCiAgICAgIGlzQm94ID0gIndpZHRoIiBpbiBwcm9wcyB8fCAiaGVpZ2h0IiBpbiBwcm9wcywKICAgICAgYW5pbSA9IHRoaXMsCiAgICAgIG9yaWcgPSB7fSwKICAgICAgc3R5bGUgPSBlbGVtLnN0eWxlLAogICAgICBoaWRkZW4gPSBlbGVtLm5vZGVUeXBlICYmIGlzSGlkZGVuV2l0aGluVHJlZShlbGVtKSwKICAgICAgZGF0YVNob3cgPSBkYXRhUHJpdi5nZXQoZWxlbSwgImZ4c2hvdyIpOwoKICAgIC8vIFF1ZXVlLXNraXBwaW5nIGFuaW1hdGlvbnMgaGlqYWNrIHRoZSBmeCBob29rcwogICAgaWYgKCFvcHRzLnF1ZXVlKSB7CiAgICAgIGhvb2tzID0galF1ZXJ5Ll9xdWV1ZUhvb2tzKGVsZW0sICJmeCIpOwogICAgICBpZiAoaG9va3MudW5xdWV1ZWQgPT0gbnVsbCkgewogICAgICAgIGhvb2tzLnVucXVldWVkID0gMDsKICAgICAgICBvbGRmaXJlID0gaG9va3MuZW1wdHkuZmlyZTsKICAgICAgICBob29rcy5lbXB0eS5maXJlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgaWYgKCFob29rcy51bnF1ZXVlZCkgewogICAgICAgICAgICBvbGRmaXJlKCk7CiAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgfQogICAgICBob29rcy51bnF1ZXVlZCsrOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gRW5zdXJlIHRoZSBjb21wbGV0ZSBoYW5kbGVyIGlzIGNhbGxlZCBiZWZvcmUgdGhpcyBjb21wbGV0ZXMKICAgICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgICBob29rcy51bnF1ZXVlZC0tOwogICAgICAgICAgaWYgKCFqUXVlcnkucXVldWUoZWxlbSwgImZ4IikubGVuZ3RoKSB7CiAgICAgICAgICAgIGhvb2tzLmVtcHR5LmZpcmUoKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gRGV0ZWN0IHNob3cvaGlkZSBhbmltYXRpb25zCiAgICBmb3IgKHByb3AgaW4gcHJvcHMpIHsKICAgICAgdmFsdWUgPSBwcm9wc1twcm9wXTsKICAgICAgaWYgKHJmeHR5cGVzLnRlc3QodmFsdWUpKSB7CiAgICAgICAgZGVsZXRlIHByb3BzW3Byb3BdOwogICAgICAgIHRvZ2dsZSA9IHRvZ2dsZSB8fCB2YWx1ZSA9PT0gInRvZ2dsZSI7CiAgICAgICAgaWYgKHZhbHVlID09PSAoaGlkZGVuID8gImhpZGUiIDogInNob3ciKSkgewogICAgICAgICAgLy8gUHJldGVuZCB0byBiZSBoaWRkZW4gaWYgdGhpcyBpcyBhICJzaG93IiBhbmQKICAgICAgICAgIC8vIHRoZXJlIGlzIHN0aWxsIGRhdGEgZnJvbSBhIHN0b3BwZWQgc2hvdy9oaWRlCiAgICAgICAgICBpZiAodmFsdWUgPT09ICJzaG93IiAmJiBkYXRhU2hvdyAmJiBkYXRhU2hvd1twcm9wXSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIGhpZGRlbiA9IHRydWU7CgogICAgICAgICAgICAvLyBJZ25vcmUgYWxsIG90aGVyIG5vLW9wIHNob3cvaGlkZSBkYXRhCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3JpZ1twcm9wXSA9IGRhdGFTaG93ICYmIGRhdGFTaG93W3Byb3BdIHx8IGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wKTsKICAgICAgfQogICAgfQoKICAgIC8vIEJhaWwgb3V0IGlmIHRoaXMgaXMgYSBuby1vcCBsaWtlIC5oaWRlKCkuaGlkZSgpCiAgICBwcm9wVHdlZW4gPSAhalF1ZXJ5LmlzRW1wdHlPYmplY3QocHJvcHMpOwogICAgaWYgKCFwcm9wVHdlZW4gJiYgalF1ZXJ5LmlzRW1wdHlPYmplY3Qob3JpZykpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIFJlc3RyaWN0ICJvdmVyZmxvdyIgYW5kICJkaXNwbGF5IiBzdHlsZXMgZHVyaW5nIGJveCBhbmltYXRpb25zCiAgICBpZiAoaXNCb3ggJiYgZWxlbS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgLSAxMSwgRWRnZSAxMiAtIDE1CiAgICAgIC8vIFJlY29yZCBhbGwgMyBvdmVyZmxvdyBhdHRyaWJ1dGVzIGJlY2F1c2UgSUUgZG9lcyBub3QgaW5mZXIgdGhlIHNob3J0aGFuZAogICAgICAvLyBmcm9tIGlkZW50aWNhbGx5LXZhbHVlZCBvdmVyZmxvd1ggYW5kIG92ZXJmbG93WSBhbmQgRWRnZSBqdXN0IG1pcnJvcnMKICAgICAgLy8gdGhlIG92ZXJmbG93WCB2YWx1ZSB0aGVyZS4KICAgICAgb3B0cy5vdmVyZmxvdyA9IFtzdHlsZS5vdmVyZmxvdywgc3R5bGUub3ZlcmZsb3dYLCBzdHlsZS5vdmVyZmxvd1ldOwoKICAgICAgLy8gSWRlbnRpZnkgYSBkaXNwbGF5IHR5cGUsIHByZWZlcnJpbmcgb2xkIHNob3cvaGlkZSBkYXRhIG92ZXIgdGhlIENTUyBjYXNjYWRlCiAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZGF0YVNob3cgJiYgZGF0YVNob3cuZGlzcGxheTsKICAgICAgaWYgKHJlc3RvcmVEaXNwbGF5ID09IG51bGwpIHsKICAgICAgICByZXN0b3JlRGlzcGxheSA9IGRhdGFQcml2LmdldChlbGVtLCAiZGlzcGxheSIpOwogICAgICB9CiAgICAgIGRpc3BsYXkgPSBqUXVlcnkuY3NzKGVsZW0sICJkaXNwbGF5Iik7CiAgICAgIGlmIChkaXNwbGF5ID09PSAibm9uZSIpIHsKICAgICAgICBpZiAocmVzdG9yZURpc3BsYXkpIHsKICAgICAgICAgIGRpc3BsYXkgPSByZXN0b3JlRGlzcGxheTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gR2V0IG5vbmVtcHR5IHZhbHVlKHMpIGJ5IHRlbXBvcmFyaWx5IGZvcmNpbmcgdmlzaWJpbGl0eQogICAgICAgICAgc2hvd0hpZGUoW2VsZW1dLCB0cnVlKTsKICAgICAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZWxlbS5zdHlsZS5kaXNwbGF5IHx8IHJlc3RvcmVEaXNwbGF5OwogICAgICAgICAgZGlzcGxheSA9IGpRdWVyeS5jc3MoZWxlbSwgImRpc3BsYXkiKTsKICAgICAgICAgIHNob3dIaWRlKFtlbGVtXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBBbmltYXRlIGlubGluZSBlbGVtZW50cyBhcyBpbmxpbmUtYmxvY2sKICAgICAgaWYgKGRpc3BsYXkgPT09ICJpbmxpbmUiIHx8IGRpc3BsYXkgPT09ICJpbmxpbmUtYmxvY2siICYmIHJlc3RvcmVEaXNwbGF5ICE9IG51bGwpIHsKICAgICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAiZmxvYXQiKSA9PT0gIm5vbmUiKSB7CiAgICAgICAgICAvLyBSZXN0b3JlIHRoZSBvcmlnaW5hbCBkaXNwbGF5IHZhbHVlIGF0IHRoZSBlbmQgb2YgcHVyZSBzaG93L2hpZGUgYW5pbWF0aW9ucwogICAgICAgICAgaWYgKCFwcm9wVHdlZW4pIHsKICAgICAgICAgICAgYW5pbS5kb25lKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICBzdHlsZS5kaXNwbGF5ID0gcmVzdG9yZURpc3BsYXk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAocmVzdG9yZURpc3BsYXkgPT0gbnVsbCkgewogICAgICAgICAgICAgIGRpc3BsYXkgPSBzdHlsZS5kaXNwbGF5OwogICAgICAgICAgICAgIHJlc3RvcmVEaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gIiIgOiBkaXNwbGF5OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBzdHlsZS5kaXNwbGF5ID0gImlubGluZS1ibG9jayI7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgICBpZiAob3B0cy5vdmVyZmxvdykgewogICAgICBzdHlsZS5vdmVyZmxvdyA9ICJoaWRkZW4iOwogICAgICBhbmltLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgc3R5bGUub3ZlcmZsb3cgPSBvcHRzLm92ZXJmbG93WzBdOwogICAgICAgIHN0eWxlLm92ZXJmbG93WCA9IG9wdHMub3ZlcmZsb3dbMV07CiAgICAgICAgc3R5bGUub3ZlcmZsb3dZID0gb3B0cy5vdmVyZmxvd1syXTsKICAgICAgfSk7CiAgICB9CgogICAgLy8gSW1wbGVtZW50IHNob3cvaGlkZSBhbmltYXRpb25zCiAgICBwcm9wVHdlZW4gPSBmYWxzZTsKICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgIC8vIEdlbmVyYWwgc2hvdy9oaWRlIHNldHVwIGZvciB0aGlzIGVsZW1lbnQgYW5pbWF0aW9uCiAgICAgIGlmICghcHJvcFR3ZWVuKSB7CiAgICAgICAgaWYgKGRhdGFTaG93KSB7CiAgICAgICAgICBpZiAoImhpZGRlbiIgaW4gZGF0YVNob3cpIHsKICAgICAgICAgICAgaGlkZGVuID0gZGF0YVNob3cuaGlkZGVuOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkYXRhU2hvdyA9IGRhdGFQcml2LmFjY2VzcyhlbGVtLCAiZnhzaG93IiwgewogICAgICAgICAgICBkaXNwbGF5OiByZXN0b3JlRGlzcGxheQogICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAvLyBTdG9yZSBoaWRkZW4vdmlzaWJsZSBmb3IgdG9nZ2xlIHNvIGAuc3RvcCgpLnRvZ2dsZSgpYCAicmV2ZXJzZXMiCiAgICAgICAgaWYgKHRvZ2dsZSkgewogICAgICAgICAgZGF0YVNob3cuaGlkZGVuID0gIWhpZGRlbjsKICAgICAgICB9CgogICAgICAgIC8vIFNob3cgZWxlbWVudHMgYmVmb3JlIGFuaW1hdGluZyB0aGVtCiAgICAgICAgaWYgKGhpZGRlbikgewogICAgICAgICAgc2hvd0hpZGUoW2VsZW1dLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIC8qIGVzbGludC1kaXNhYmxlIG5vLWxvb3AtZnVuYyAqLwoKICAgICAgICBhbmltLmRvbmUoZnVuY3Rpb24gKCkgewogICAgICAgICAgLyogZXNsaW50LWVuYWJsZSBuby1sb29wLWZ1bmMgKi8KCiAgICAgICAgICAvLyBUaGUgZmluYWwgc3RlcCBvZiBhICJoaWRlIiBhbmltYXRpb24gaXMgYWN0dWFsbHkgaGlkaW5nIHRoZSBlbGVtZW50CiAgICAgICAgICBpZiAoIWhpZGRlbikgewogICAgICAgICAgICBzaG93SGlkZShbZWxlbV0pOwogICAgICAgICAgfQogICAgICAgICAgZGF0YVByaXYucmVtb3ZlKGVsZW0sICJmeHNob3ciKTsKICAgICAgICAgIGZvciAocHJvcCBpbiBvcmlnKSB7CiAgICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCBwcm9wLCBvcmlnW3Byb3BdKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQoKICAgICAgLy8gUGVyLXByb3BlcnR5IHNldHVwCiAgICAgIHByb3BUd2VlbiA9IGNyZWF0ZVR3ZWVuKGhpZGRlbiA/IGRhdGFTaG93W3Byb3BdIDogMCwgcHJvcCwgYW5pbSk7CiAgICAgIGlmICghKHByb3AgaW4gZGF0YVNob3cpKSB7CiAgICAgICAgZGF0YVNob3dbcHJvcF0gPSBwcm9wVHdlZW4uc3RhcnQ7CiAgICAgICAgaWYgKGhpZGRlbikgewogICAgICAgICAgcHJvcFR3ZWVuLmVuZCA9IHByb3BUd2Vlbi5zdGFydDsKICAgICAgICAgIHByb3BUd2Vlbi5zdGFydCA9IDA7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIHByb3BGaWx0ZXIocHJvcHMsIHNwZWNpYWxFYXNpbmcpIHsKICAgIHZhciBpbmRleCwgbmFtZSwgZWFzaW5nLCB2YWx1ZSwgaG9va3M7CgogICAgLy8gY2FtZWxDYXNlLCBzcGVjaWFsRWFzaW5nIGFuZCBleHBhbmQgY3NzSG9vayBwYXNzCiAgICBmb3IgKGluZGV4IGluIHByb3BzKSB7CiAgICAgIG5hbWUgPSBjYW1lbENhc2UoaW5kZXgpOwogICAgICBlYXNpbmcgPSBzcGVjaWFsRWFzaW5nW25hbWVdOwogICAgICB2YWx1ZSA9IHByb3BzW2luZGV4XTsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgZWFzaW5nID0gdmFsdWVbMV07CiAgICAgICAgdmFsdWUgPSBwcm9wc1tpbmRleF0gPSB2YWx1ZVswXTsKICAgICAgfQogICAgICBpZiAoaW5kZXggIT09IG5hbWUpIHsKICAgICAgICBwcm9wc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIGRlbGV0ZSBwcm9wc1tpbmRleF07CiAgICAgIH0KICAgICAgaG9va3MgPSBqUXVlcnkuY3NzSG9va3NbbmFtZV07CiAgICAgIGlmIChob29rcyAmJiAiZXhwYW5kIiBpbiBob29rcykgewogICAgICAgIHZhbHVlID0gaG9va3MuZXhwYW5kKHZhbHVlKTsKICAgICAgICBkZWxldGUgcHJvcHNbbmFtZV07CgogICAgICAgIC8vIE5vdCBxdWl0ZSAkLmV4dGVuZCwgdGhpcyB3b24ndCBvdmVyd3JpdGUgZXhpc3Rpbmcga2V5cy4KICAgICAgICAvLyBSZXVzaW5nICdpbmRleCcgYmVjYXVzZSB3ZSBoYXZlIHRoZSBjb3JyZWN0ICJuYW1lIgogICAgICAgIGZvciAoaW5kZXggaW4gdmFsdWUpIHsKICAgICAgICAgIGlmICghKGluZGV4IGluIHByb3BzKSkgewogICAgICAgICAgICBwcm9wc1tpbmRleF0gPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICAgIHNwZWNpYWxFYXNpbmdbaW5kZXhdID0gZWFzaW5nOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzcGVjaWFsRWFzaW5nW25hbWVdID0gZWFzaW5nOwogICAgICB9CiAgICB9CiAgfQogIGZ1bmN0aW9uIEFuaW1hdGlvbihlbGVtLCBwcm9wZXJ0aWVzLCBvcHRpb25zKSB7CiAgICB2YXIgcmVzdWx0LAogICAgICBzdG9wcGVkLAogICAgICBpbmRleCA9IDAsCiAgICAgIGxlbmd0aCA9IEFuaW1hdGlvbi5wcmVmaWx0ZXJzLmxlbmd0aCwKICAgICAgZGVmZXJyZWQgPSBqUXVlcnkuRGVmZXJyZWQoKS5hbHdheXMoZnVuY3Rpb24gKCkgewogICAgICAgIC8vIERvbid0IG1hdGNoIGVsZW0gaW4gdGhlIDphbmltYXRlZCBzZWxlY3RvcgogICAgICAgIGRlbGV0ZSB0aWNrLmVsZW07CiAgICAgIH0pLAogICAgICB0aWNrID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIHZhciBjdXJyZW50VGltZSA9IGZ4Tm93IHx8IGNyZWF0ZUZ4Tm93KCksCiAgICAgICAgICByZW1haW5pbmcgPSBNYXRoLm1heCgwLCBhbmltYXRpb24uc3RhcnRUaW1lICsgYW5pbWF0aW9uLmR1cmF0aW9uIC0gY3VycmVudFRpbWUpLAogICAgICAgICAgLy8gU3VwcG9ydDogQW5kcm9pZCAyLjMgb25seQogICAgICAgICAgLy8gQXJjaGFpYyBjcmFzaCBidWcgd29uJ3QgYWxsb3cgdXMgdG8gdXNlIGAxIC0gKCAwLjUgfHwgMCApYCAodHJhYy0xMjQ5NykKICAgICAgICAgIHRlbXAgPSByZW1haW5pbmcgLyBhbmltYXRpb24uZHVyYXRpb24gfHwgMCwKICAgICAgICAgIHBlcmNlbnQgPSAxIC0gdGVtcCwKICAgICAgICAgIGluZGV4ID0gMCwKICAgICAgICAgIGxlbmd0aCA9IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoOwogICAgICAgIGZvciAoOyBpbmRleCA8IGxlbmd0aDsgaW5kZXgrKykgewogICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKHBlcmNlbnQpOwogICAgICAgIH0KICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIHBlcmNlbnQsIHJlbWFpbmluZ10pOwoKICAgICAgICAvLyBJZiB0aGVyZSdzIG1vcmUgdG8gZG8sIHlpZWxkCiAgICAgICAgaWYgKHBlcmNlbnQgPCAxICYmIGxlbmd0aCkgewogICAgICAgICAgcmV0dXJuIHJlbWFpbmluZzsKICAgICAgICB9CgogICAgICAgIC8vIElmIHRoaXMgd2FzIGFuIGVtcHR5IGFuaW1hdGlvbiwgc3ludGhlc2l6ZSBhIGZpbmFsIHByb2dyZXNzIG5vdGlmaWNhdGlvbgogICAgICAgIGlmICghbGVuZ3RoKSB7CiAgICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIDEsIDBdKTsKICAgICAgICB9CgogICAgICAgIC8vIFJlc29sdmUgdGhlIGFuaW1hdGlvbiBhbmQgcmVwb3J0IGl0cyBjb25jbHVzaW9uCiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbl0pOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfSwKICAgICAgYW5pbWF0aW9uID0gZGVmZXJyZWQucHJvbWlzZSh7CiAgICAgICAgZWxlbTogZWxlbSwKICAgICAgICBwcm9wczogalF1ZXJ5LmV4dGVuZCh7fSwgcHJvcGVydGllcyksCiAgICAgICAgb3B0czogalF1ZXJ5LmV4dGVuZCh0cnVlLCB7CiAgICAgICAgICBzcGVjaWFsRWFzaW5nOiB7fSwKICAgICAgICAgIGVhc2luZzogalF1ZXJ5LmVhc2luZy5fZGVmYXVsdAogICAgICAgIH0sIG9wdGlvbnMpLAogICAgICAgIG9yaWdpbmFsUHJvcGVydGllczogcHJvcGVydGllcywKICAgICAgICBvcmlnaW5hbE9wdGlvbnM6IG9wdGlvbnMsCiAgICAgICAgc3RhcnRUaW1lOiBmeE5vdyB8fCBjcmVhdGVGeE5vdygpLAogICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLmR1cmF0aW9uLAogICAgICAgIHR3ZWVuczogW10sCiAgICAgICAgY3JlYXRlVHdlZW46IGZ1bmN0aW9uIChwcm9wLCBlbmQpIHsKICAgICAgICAgIHZhciB0d2VlbiA9IGpRdWVyeS5Ud2VlbihlbGVtLCBhbmltYXRpb24ub3B0cywgcHJvcCwgZW5kLCBhbmltYXRpb24ub3B0cy5zcGVjaWFsRWFzaW5nW3Byb3BdIHx8IGFuaW1hdGlvbi5vcHRzLmVhc2luZyk7CiAgICAgICAgICBhbmltYXRpb24udHdlZW5zLnB1c2godHdlZW4pOwogICAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICAgIH0sCiAgICAgICAgc3RvcDogZnVuY3Rpb24gKGdvdG9FbmQpIHsKICAgICAgICAgIHZhciBpbmRleCA9IDAsCiAgICAgICAgICAgIC8vIElmIHdlIGFyZSBnb2luZyB0byB0aGUgZW5kLCB3ZSB3YW50IHRvIHJ1biBhbGwgdGhlIHR3ZWVucwogICAgICAgICAgICAvLyBvdGhlcndpc2Ugd2Ugc2tpcCB0aGlzIHBhcnQKICAgICAgICAgICAgbGVuZ3RoID0gZ290b0VuZCA/IGFuaW1hdGlvbi50d2VlbnMubGVuZ3RoIDogMDsKICAgICAgICAgIGlmIChzdG9wcGVkKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfQogICAgICAgICAgc3RvcHBlZCA9IHRydWU7CiAgICAgICAgICBmb3IgKDsgaW5kZXggPCBsZW5ndGg7IGluZGV4KyspIHsKICAgICAgICAgICAgYW5pbWF0aW9uLnR3ZWVuc1tpbmRleF0ucnVuKDEpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFJlc29sdmUgd2hlbiB3ZSBwbGF5ZWQgdGhlIGxhc3QgZnJhbWU7IG90aGVyd2lzZSwgcmVqZWN0CiAgICAgICAgICBpZiAoZ290b0VuZCkgewogICAgICAgICAgICBkZWZlcnJlZC5ub3RpZnlXaXRoKGVsZW0sIFthbmltYXRpb24sIDEsIDBdKTsKICAgICAgICAgICAgZGVmZXJyZWQucmVzb2x2ZVdpdGgoZWxlbSwgW2FuaW1hdGlvbiwgZ290b0VuZF0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGVmZXJyZWQucmVqZWN0V2l0aChlbGVtLCBbYW5pbWF0aW9uLCBnb3RvRW5kXSk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CiAgICAgIH0pLAogICAgICBwcm9wcyA9IGFuaW1hdGlvbi5wcm9wczsKICAgIHByb3BGaWx0ZXIocHJvcHMsIGFuaW1hdGlvbi5vcHRzLnNwZWNpYWxFYXNpbmcpOwogICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgIHJlc3VsdCA9IEFuaW1hdGlvbi5wcmVmaWx0ZXJzW2luZGV4XS5jYWxsKGFuaW1hdGlvbiwgZWxlbSwgcHJvcHMsIGFuaW1hdGlvbi5vcHRzKTsKICAgICAgaWYgKHJlc3VsdCkgewogICAgICAgIGlmIChpc0Z1bmN0aW9uKHJlc3VsdC5zdG9wKSkgewogICAgICAgICAgalF1ZXJ5Ll9xdWV1ZUhvb2tzKGFuaW1hdGlvbi5lbGVtLCBhbmltYXRpb24ub3B0cy5xdWV1ZSkuc3RvcCA9IHJlc3VsdC5zdG9wLmJpbmQocmVzdWx0KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHJlc3VsdDsKICAgICAgfQogICAgfQogICAgalF1ZXJ5Lm1hcChwcm9wcywgY3JlYXRlVHdlZW4sIGFuaW1hdGlvbik7CiAgICBpZiAoaXNGdW5jdGlvbihhbmltYXRpb24ub3B0cy5zdGFydCkpIHsKICAgICAgYW5pbWF0aW9uLm9wdHMuc3RhcnQuY2FsbChlbGVtLCBhbmltYXRpb24pOwogICAgfQoKICAgIC8vIEF0dGFjaCBjYWxsYmFja3MgZnJvbSBvcHRpb25zCiAgICBhbmltYXRpb24ucHJvZ3Jlc3MoYW5pbWF0aW9uLm9wdHMucHJvZ3Jlc3MpLmRvbmUoYW5pbWF0aW9uLm9wdHMuZG9uZSwgYW5pbWF0aW9uLm9wdHMuY29tcGxldGUpLmZhaWwoYW5pbWF0aW9uLm9wdHMuZmFpbCkuYWx3YXlzKGFuaW1hdGlvbi5vcHRzLmFsd2F5cyk7CiAgICBqUXVlcnkuZngudGltZXIoalF1ZXJ5LmV4dGVuZCh0aWNrLCB7CiAgICAgIGVsZW06IGVsZW0sCiAgICAgIGFuaW06IGFuaW1hdGlvbiwKICAgICAgcXVldWU6IGFuaW1hdGlvbi5vcHRzLnF1ZXVlCiAgICB9KSk7CiAgICByZXR1cm4gYW5pbWF0aW9uOwogIH0KICBqUXVlcnkuQW5pbWF0aW9uID0galF1ZXJ5LmV4dGVuZChBbmltYXRpb24sIHsKICAgIHR3ZWVuZXJzOiB7CiAgICAgICIqIjogW2Z1bmN0aW9uIChwcm9wLCB2YWx1ZSkgewogICAgICAgIHZhciB0d2VlbiA9IHRoaXMuY3JlYXRlVHdlZW4ocHJvcCwgdmFsdWUpOwogICAgICAgIGFkanVzdENTUyh0d2Vlbi5lbGVtLCBwcm9wLCByY3NzTnVtLmV4ZWModmFsdWUpLCB0d2Vlbik7CiAgICAgICAgcmV0dXJuIHR3ZWVuOwogICAgICB9XQogICAgfSwKICAgIHR3ZWVuZXI6IGZ1bmN0aW9uIChwcm9wcywgY2FsbGJhY2spIHsKICAgICAgaWYgKGlzRnVuY3Rpb24ocHJvcHMpKSB7CiAgICAgICAgY2FsbGJhY2sgPSBwcm9wczsKICAgICAgICBwcm9wcyA9IFsiKiJdOwogICAgICB9IGVsc2UgewogICAgICAgIHByb3BzID0gcHJvcHMubWF0Y2gocm5vdGh0bWx3aGl0ZSk7CiAgICAgIH0KICAgICAgdmFyIHByb3AsCiAgICAgICAgaW5kZXggPSAwLAogICAgICAgIGxlbmd0aCA9IHByb3BzLmxlbmd0aDsKICAgICAgZm9yICg7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgcHJvcCA9IHByb3BzW2luZGV4XTsKICAgICAgICBBbmltYXRpb24udHdlZW5lcnNbcHJvcF0gPSBBbmltYXRpb24udHdlZW5lcnNbcHJvcF0gfHwgW107CiAgICAgICAgQW5pbWF0aW9uLnR3ZWVuZXJzW3Byb3BdLnVuc2hpZnQoY2FsbGJhY2spOwogICAgICB9CiAgICB9LAogICAgcHJlZmlsdGVyczogW2RlZmF1bHRQcmVmaWx0ZXJdLAogICAgcHJlZmlsdGVyOiBmdW5jdGlvbiAoY2FsbGJhY2ssIHByZXBlbmQpIHsKICAgICAgaWYgKHByZXBlbmQpIHsKICAgICAgICBBbmltYXRpb24ucHJlZmlsdGVycy51bnNoaWZ0KGNhbGxiYWNrKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBBbmltYXRpb24ucHJlZmlsdGVycy5wdXNoKGNhbGxiYWNrKTsKICAgICAgfQogICAgfQogIH0pOwogIGpRdWVyeS5zcGVlZCA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBmbikgewogICAgdmFyIG9wdCA9IHNwZWVkICYmIHR5cGVvZiBzcGVlZCA9PT0gIm9iamVjdCIgPyBqUXVlcnkuZXh0ZW5kKHt9LCBzcGVlZCkgOiB7CiAgICAgIGNvbXBsZXRlOiBmbiB8fCAhZm4gJiYgZWFzaW5nIHx8IGlzRnVuY3Rpb24oc3BlZWQpICYmIHNwZWVkLAogICAgICBkdXJhdGlvbjogc3BlZWQsCiAgICAgIGVhc2luZzogZm4gJiYgZWFzaW5nIHx8IGVhc2luZyAmJiAhaXNGdW5jdGlvbihlYXNpbmcpICYmIGVhc2luZwogICAgfTsKCiAgICAvLyBHbyB0byB0aGUgZW5kIHN0YXRlIGlmIGZ4IGFyZSBvZmYKICAgIGlmIChqUXVlcnkuZngub2ZmKSB7CiAgICAgIG9wdC5kdXJhdGlvbiA9IDA7CiAgICB9IGVsc2UgewogICAgICBpZiAodHlwZW9mIG9wdC5kdXJhdGlvbiAhPT0gIm51bWJlciIpIHsKICAgICAgICBpZiAob3B0LmR1cmF0aW9uIGluIGpRdWVyeS5meC5zcGVlZHMpIHsKICAgICAgICAgIG9wdC5kdXJhdGlvbiA9IGpRdWVyeS5meC5zcGVlZHNbb3B0LmR1cmF0aW9uXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0LmR1cmF0aW9uID0galF1ZXJ5LmZ4LnNwZWVkcy5fZGVmYXVsdDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICAvLyBOb3JtYWxpemUgb3B0LnF1ZXVlIC0gdHJ1ZS91bmRlZmluZWQvbnVsbCAtPiAiZngiCiAgICBpZiAob3B0LnF1ZXVlID09IG51bGwgfHwgb3B0LnF1ZXVlID09PSB0cnVlKSB7CiAgICAgIG9wdC5xdWV1ZSA9ICJmeCI7CiAgICB9CgogICAgLy8gUXVldWVpbmcKICAgIG9wdC5vbGQgPSBvcHQuY29tcGxldGU7CiAgICBvcHQuY29tcGxldGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdC5vbGQpKSB7CiAgICAgICAgb3B0Lm9sZC5jYWxsKHRoaXMpOwogICAgICB9CiAgICAgIGlmIChvcHQucXVldWUpIHsKICAgICAgICBqUXVlcnkuZGVxdWV1ZSh0aGlzLCBvcHQucXVldWUpOwogICAgICB9CiAgICB9OwogICAgcmV0dXJuIG9wdDsKICB9OwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgZmFkZVRvOiBmdW5jdGlvbiAoc3BlZWQsIHRvLCBlYXNpbmcsIGNhbGxiYWNrKSB7CiAgICAgIC8vIFNob3cgYW55IGhpZGRlbiBlbGVtZW50cyBhZnRlciBzZXR0aW5nIG9wYWNpdHkgdG8gMAogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoaXNIaWRkZW5XaXRoaW5UcmVlKS5jc3MoIm9wYWNpdHkiLCAwKS5zaG93KCkKCiAgICAgIC8vIEFuaW1hdGUgdG8gdGhlIHZhbHVlIHNwZWNpZmllZAogICAgICAuZW5kKCkuYW5pbWF0ZSh7CiAgICAgICAgb3BhY2l0eTogdG8KICAgICAgfSwgc3BlZWQsIGVhc2luZywgY2FsbGJhY2spOwogICAgfSwKICAgIGFuaW1hdGU6IGZ1bmN0aW9uIChwcm9wLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICB2YXIgZW1wdHkgPSBqUXVlcnkuaXNFbXB0eU9iamVjdChwcm9wKSwKICAgICAgICBvcHRhbGwgPSBqUXVlcnkuc3BlZWQoc3BlZWQsIGVhc2luZywgY2FsbGJhY2spLAogICAgICAgIGRvQW5pbWF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgLy8gT3BlcmF0ZSBvbiBhIGNvcHkgb2YgcHJvcCBzbyBwZXItcHJvcGVydHkgZWFzaW5nIHdvbid0IGJlIGxvc3QKICAgICAgICAgIHZhciBhbmltID0gQW5pbWF0aW9uKHRoaXMsIGpRdWVyeS5leHRlbmQoe30sIHByb3ApLCBvcHRhbGwpOwoKICAgICAgICAgIC8vIEVtcHR5IGFuaW1hdGlvbnMsIG9yIGZpbmlzaGluZyByZXNvbHZlcyBpbW1lZGlhdGVseQogICAgICAgICAgaWYgKGVtcHR5IHx8IGRhdGFQcml2LmdldCh0aGlzLCAiZmluaXNoIikpIHsKICAgICAgICAgICAgYW5pbS5zdG9wKHRydWUpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIGRvQW5pbWF0aW9uLmZpbmlzaCA9IGRvQW5pbWF0aW9uOwogICAgICByZXR1cm4gZW1wdHkgfHwgb3B0YWxsLnF1ZXVlID09PSBmYWxzZSA/IHRoaXMuZWFjaChkb0FuaW1hdGlvbikgOiB0aGlzLnF1ZXVlKG9wdGFsbC5xdWV1ZSwgZG9BbmltYXRpb24pOwogICAgfSwKICAgIHN0b3A6IGZ1bmN0aW9uICh0eXBlLCBjbGVhclF1ZXVlLCBnb3RvRW5kKSB7CiAgICAgIHZhciBzdG9wUXVldWUgPSBmdW5jdGlvbiAoaG9va3MpIHsKICAgICAgICB2YXIgc3RvcCA9IGhvb2tzLnN0b3A7CiAgICAgICAgZGVsZXRlIGhvb2tzLnN0b3A7CiAgICAgICAgc3RvcChnb3RvRW5kKTsKICAgICAgfTsKICAgICAgaWYgKHR5cGVvZiB0eXBlICE9PSAic3RyaW5nIikgewogICAgICAgIGdvdG9FbmQgPSBjbGVhclF1ZXVlOwogICAgICAgIGNsZWFyUXVldWUgPSB0eXBlOwogICAgICAgIHR5cGUgPSB1bmRlZmluZWQ7CiAgICAgIH0KICAgICAgaWYgKGNsZWFyUXVldWUpIHsKICAgICAgICB0aGlzLnF1ZXVlKHR5cGUgfHwgImZ4IiwgW10pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkZXF1ZXVlID0gdHJ1ZSwKICAgICAgICAgIGluZGV4ID0gdHlwZSAhPSBudWxsICYmIHR5cGUgKyAicXVldWVIb29rcyIsCiAgICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgICAgZGF0YSA9IGRhdGFQcml2LmdldCh0aGlzKTsKICAgICAgICBpZiAoaW5kZXgpIHsKICAgICAgICAgIGlmIChkYXRhW2luZGV4XSAmJiBkYXRhW2luZGV4XS5zdG9wKSB7CiAgICAgICAgICAgIHN0b3BRdWV1ZShkYXRhW2luZGV4XSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGZvciAoaW5kZXggaW4gZGF0YSkgewogICAgICAgICAgICBpZiAoZGF0YVtpbmRleF0gJiYgZGF0YVtpbmRleF0uc3RvcCAmJiBycnVuLnRlc3QoaW5kZXgpKSB7CiAgICAgICAgICAgICAgc3RvcFF1ZXVlKGRhdGFbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGluZGV4ID0gdGltZXJzLmxlbmd0aDsgaW5kZXgtLTspIHsKICAgICAgICAgIGlmICh0aW1lcnNbaW5kZXhdLmVsZW0gPT09IHRoaXMgJiYgKHR5cGUgPT0gbnVsbCB8fCB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSkgewogICAgICAgICAgICB0aW1lcnNbaW5kZXhdLmFuaW0uc3RvcChnb3RvRW5kKTsKICAgICAgICAgICAgZGVxdWV1ZSA9IGZhbHNlOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIFN0YXJ0IHRoZSBuZXh0IGluIHRoZSBxdWV1ZSBpZiB0aGUgbGFzdCBzdGVwIHdhc24ndCBmb3JjZWQuCiAgICAgICAgLy8gVGltZXJzIGN1cnJlbnRseSB3aWxsIGNhbGwgdGhlaXIgY29tcGxldGUgY2FsbGJhY2tzLCB3aGljaAogICAgICAgIC8vIHdpbGwgZGVxdWV1ZSBidXQgb25seSBpZiB0aGV5IHdlcmUgZ290b0VuZC4KICAgICAgICBpZiAoZGVxdWV1ZSB8fCAhZ290b0VuZCkgewogICAgICAgICAgalF1ZXJ5LmRlcXVldWUodGhpcywgdHlwZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICBmaW5pc2g6IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgIGlmICh0eXBlICE9PSBmYWxzZSkgewogICAgICAgIHR5cGUgPSB0eXBlIHx8ICJmeCI7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGluZGV4LAogICAgICAgICAgZGF0YSA9IGRhdGFQcml2LmdldCh0aGlzKSwKICAgICAgICAgIHF1ZXVlID0gZGF0YVt0eXBlICsgInF1ZXVlIl0sCiAgICAgICAgICBob29rcyA9IGRhdGFbdHlwZSArICJxdWV1ZUhvb2tzIl0sCiAgICAgICAgICB0aW1lcnMgPSBqUXVlcnkudGltZXJzLAogICAgICAgICAgbGVuZ3RoID0gcXVldWUgPyBxdWV1ZS5sZW5ndGggOiAwOwoKICAgICAgICAvLyBFbmFibGUgZmluaXNoaW5nIGZsYWcgb24gcHJpdmF0ZSBkYXRhCiAgICAgICAgZGF0YS5maW5pc2ggPSB0cnVlOwoKICAgICAgICAvLyBFbXB0eSB0aGUgcXVldWUgZmlyc3QKICAgICAgICBqUXVlcnkucXVldWUodGhpcywgdHlwZSwgW10pOwogICAgICAgIGlmIChob29rcyAmJiBob29rcy5zdG9wKSB7CiAgICAgICAgICBob29rcy5zdG9wLmNhbGwodGhpcywgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAvLyBMb29rIGZvciBhbnkgYWN0aXZlIGFuaW1hdGlvbnMsIGFuZCBmaW5pc2ggdGhlbQogICAgICAgIGZvciAoaW5kZXggPSB0aW1lcnMubGVuZ3RoOyBpbmRleC0tOykgewogICAgICAgICAgaWYgKHRpbWVyc1tpbmRleF0uZWxlbSA9PT0gdGhpcyAmJiB0aW1lcnNbaW5kZXhdLnF1ZXVlID09PSB0eXBlKSB7CiAgICAgICAgICAgIHRpbWVyc1tpbmRleF0uYW5pbS5zdG9wKHRydWUpOwogICAgICAgICAgICB0aW1lcnMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIExvb2sgZm9yIGFueSBhbmltYXRpb25zIGluIHRoZSBvbGQgcXVldWUgYW5kIGZpbmlzaCB0aGVtCiAgICAgICAgZm9yIChpbmRleCA9IDA7IGluZGV4IDwgbGVuZ3RoOyBpbmRleCsrKSB7CiAgICAgICAgICBpZiAocXVldWVbaW5kZXhdICYmIHF1ZXVlW2luZGV4XS5maW5pc2gpIHsKICAgICAgICAgICAgcXVldWVbaW5kZXhdLmZpbmlzaC5jYWxsKHRoaXMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gVHVybiBvZmYgZmluaXNoaW5nIGZsYWcKICAgICAgICBkZWxldGUgZGF0YS5maW5pc2g7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKFsidG9nZ2xlIiwgInNob3ciLCAiaGlkZSJdLCBmdW5jdGlvbiAoX2ksIG5hbWUpIHsKICAgIHZhciBjc3NGbiA9IGpRdWVyeS5mbltuYW1lXTsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gc3BlZWQgPT0gbnVsbCB8fCB0eXBlb2Ygc3BlZWQgPT09ICJib29sZWFuIiA/IGNzc0ZuLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgOiB0aGlzLmFuaW1hdGUoZ2VuRngobmFtZSwgdHJ1ZSksIHNwZWVkLCBlYXNpbmcsIGNhbGxiYWNrKTsKICAgIH07CiAgfSk7CgogIC8vIEdlbmVyYXRlIHNob3J0Y3V0cyBmb3IgY3VzdG9tIGFuaW1hdGlvbnMKICBqUXVlcnkuZWFjaCh7CiAgICBzbGlkZURvd246IGdlbkZ4KCJzaG93IiksCiAgICBzbGlkZVVwOiBnZW5GeCgiaGlkZSIpLAogICAgc2xpZGVUb2dnbGU6IGdlbkZ4KCJ0b2dnbGUiKSwKICAgIGZhZGVJbjogewogICAgICBvcGFjaXR5OiAic2hvdyIKICAgIH0sCiAgICBmYWRlT3V0OiB7CiAgICAgIG9wYWNpdHk6ICJoaWRlIgogICAgfSwKICAgIGZhZGVUb2dnbGU6IHsKICAgICAgb3BhY2l0eTogInRvZ2dsZSIKICAgIH0KICB9LCBmdW5jdGlvbiAobmFtZSwgcHJvcHMpIHsKICAgIGpRdWVyeS5mbltuYW1lXSA9IGZ1bmN0aW9uIChzcGVlZCwgZWFzaW5nLCBjYWxsYmFjaykgewogICAgICByZXR1cm4gdGhpcy5hbmltYXRlKHByb3BzLCBzcGVlZCwgZWFzaW5nLCBjYWxsYmFjayk7CiAgICB9OwogIH0pOwogIGpRdWVyeS50aW1lcnMgPSBbXTsKICBqUXVlcnkuZngudGljayA9IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0aW1lciwKICAgICAgaSA9IDAsCiAgICAgIHRpbWVycyA9IGpRdWVyeS50aW1lcnM7CiAgICBmeE5vdyA9IERhdGUubm93KCk7CiAgICBmb3IgKDsgaSA8IHRpbWVycy5sZW5ndGg7IGkrKykgewogICAgICB0aW1lciA9IHRpbWVyc1tpXTsKCiAgICAgIC8vIFJ1biB0aGUgdGltZXIgYW5kIHNhZmVseSByZW1vdmUgaXQgd2hlbiBkb25lIChhbGxvd2luZyBmb3IgZXh0ZXJuYWwgcmVtb3ZhbCkKICAgICAgaWYgKCF0aW1lcigpICYmIHRpbWVyc1tpXSA9PT0gdGltZXIpIHsKICAgICAgICB0aW1lcnMuc3BsaWNlKGktLSwgMSk7CiAgICAgIH0KICAgIH0KICAgIGlmICghdGltZXJzLmxlbmd0aCkgewogICAgICBqUXVlcnkuZnguc3RvcCgpOwogICAgfQogICAgZnhOb3cgPSB1bmRlZmluZWQ7CiAgfTsKICBqUXVlcnkuZngudGltZXIgPSBmdW5jdGlvbiAodGltZXIpIHsKICAgIGpRdWVyeS50aW1lcnMucHVzaCh0aW1lcik7CiAgICBqUXVlcnkuZnguc3RhcnQoKTsKICB9OwogIGpRdWVyeS5meC5pbnRlcnZhbCA9IDEzOwogIGpRdWVyeS5meC5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgIGlmIChpblByb2dyZXNzKSB7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGluUHJvZ3Jlc3MgPSB0cnVlOwogICAgc2NoZWR1bGUoKTsKICB9OwogIGpRdWVyeS5meC5zdG9wID0gZnVuY3Rpb24gKCkgewogICAgaW5Qcm9ncmVzcyA9IG51bGw7CiAgfTsKICBqUXVlcnkuZnguc3BlZWRzID0gewogICAgc2xvdzogNjAwLAogICAgZmFzdDogMjAwLAogICAgLy8gRGVmYXVsdCBzcGVlZAogICAgX2RlZmF1bHQ6IDQwMAogIH07CgogIC8vIEJhc2VkIG9mZiBvZiB0aGUgcGx1Z2luIGJ5IENsaW50IEhlbGZlcnMsIHdpdGggcGVybWlzc2lvbi4KICBqUXVlcnkuZm4uZGVsYXkgPSBmdW5jdGlvbiAodGltZSwgdHlwZSkgewogICAgdGltZSA9IGpRdWVyeS5meCA/IGpRdWVyeS5meC5zcGVlZHNbdGltZV0gfHwgdGltZSA6IHRpbWU7CiAgICB0eXBlID0gdHlwZSB8fCAiZngiOwogICAgcmV0dXJuIHRoaXMucXVldWUodHlwZSwgZnVuY3Rpb24gKG5leHQsIGhvb2tzKSB7CiAgICAgIHZhciB0aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQobmV4dCwgdGltZSk7CiAgICAgIGhvb2tzLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgfTsKICAgIH0pOwogIH07CiAgKGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0IiksCiAgICAgIHNlbGVjdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNlbGVjdCIpLAogICAgICBvcHQgPSBzZWxlY3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib3B0aW9uIikpOwogICAgaW5wdXQudHlwZSA9ICJjaGVja2JveCI7CgogICAgLy8gU3VwcG9ydDogQW5kcm9pZCA8PTQuMyBvbmx5CiAgICAvLyBEZWZhdWx0IHZhbHVlIGZvciBhIGNoZWNrYm94IHNob3VsZCBiZSAib24iCiAgICBzdXBwb3J0LmNoZWNrT24gPSBpbnB1dC52YWx1ZSAhPT0gIiI7CgogICAgLy8gU3VwcG9ydDogSUUgPD0xMSBvbmx5CiAgICAvLyBNdXN0IGFjY2VzcyBzZWxlY3RlZEluZGV4IHRvIG1ha2UgZGVmYXVsdCBvcHRpb25zIHNlbGVjdAogICAgc3VwcG9ydC5vcHRTZWxlY3RlZCA9IG9wdC5zZWxlY3RlZDsKCiAgICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAgIC8vIEFuIGlucHV0IGxvc2VzIGl0cyB2YWx1ZSBhZnRlciBiZWNvbWluZyBhIHJhZGlvCiAgICBpbnB1dCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICBpbnB1dC52YWx1ZSA9ICJ0IjsKICAgIGlucHV0LnR5cGUgPSAicmFkaW8iOwogICAgc3VwcG9ydC5yYWRpb1ZhbHVlID0gaW5wdXQudmFsdWUgPT09ICJ0IjsKICB9KSgpOwogIHZhciBib29sSG9vaywKICAgIGF0dHJIYW5kbGUgPSBqUXVlcnkuZXhwci5hdHRySGFuZGxlOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LmF0dHIsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIodGhpcywgbmFtZSk7CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgYXR0cjogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsCiAgICAgICAgaG9va3MsCiAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgLy8gRG9uJ3QgZ2V0L3NldCBhdHRyaWJ1dGVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIEZhbGxiYWNrIHRvIHByb3Agd2hlbiBhdHRyaWJ1dGVzIGFyZSBub3Qgc3VwcG9ydGVkCiAgICAgIGlmICh0eXBlb2YgZWxlbS5nZXRBdHRyaWJ1dGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5wcm9wKGVsZW0sIG5hbWUsIHZhbHVlKTsKICAgICAgfQoKICAgICAgLy8gQXR0cmlidXRlIGhvb2tzIGFyZSBkZXRlcm1pbmVkIGJ5IHRoZSBsb3dlcmNhc2UgdmVyc2lvbgogICAgICAvLyBHcmFiIG5lY2Vzc2FyeSBob29rIGlmIG9uZSBpcyBkZWZpbmVkCiAgICAgIGlmIChuVHlwZSAhPT0gMSB8fCAhalF1ZXJ5LmlzWE1MRG9jKGVsZW0pKSB7CiAgICAgICAgaG9va3MgPSBqUXVlcnkuYXR0ckhvb2tzW25hbWUudG9Mb3dlckNhc2UoKV0gfHwgKGpRdWVyeS5leHByLm1hdGNoLmJvb2wudGVzdChuYW1lKSA/IGJvb2xIb29rIDogdW5kZWZpbmVkKTsKICAgICAgfQogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgalF1ZXJ5LnJlbW92ZUF0dHIoZWxlbSwgbmFtZSk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChob29rcyAmJiAic2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3Muc2V0KGVsZW0sIHZhbHVlLCBuYW1lKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHJldDsKICAgICAgICB9CiAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUgKyAiIik7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgICAgcmV0ID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCBuYW1lKTsKCiAgICAgIC8vIE5vbi1leGlzdGVudCBhdHRyaWJ1dGVzIHJldHVybiBudWxsLCB3ZSBub3JtYWxpemUgdG8gdW5kZWZpbmVkCiAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/IHVuZGVmaW5lZCA6IHJldDsKICAgIH0sCiAgICBhdHRySG9va3M6IHsKICAgICAgdHlwZTogewogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICBpZiAoIXN1cHBvcnQucmFkaW9WYWx1ZSAmJiB2YWx1ZSA9PT0gInJhZGlvIiAmJiBub2RlTmFtZShlbGVtLCAiaW5wdXQiKSkgewogICAgICAgICAgICB2YXIgdmFsID0gZWxlbS52YWx1ZTsKICAgICAgICAgICAgZWxlbS5zZXRBdHRyaWJ1dGUoInR5cGUiLCB2YWx1ZSk7CiAgICAgICAgICAgIGlmICh2YWwpIHsKICAgICAgICAgICAgICBlbGVtLnZhbHVlID0gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmVBdHRyOiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUpIHsKICAgICAgdmFyIG5hbWUsCiAgICAgICAgaSA9IDAsCiAgICAgICAgLy8gQXR0cmlidXRlIG5hbWVzIGNhbiBjb250YWluIG5vbi1IVE1MIHdoaXRlc3BhY2UgY2hhcmFjdGVycwogICAgICAgIC8vIGh0dHBzOi8vaHRtbC5zcGVjLndoYXR3Zy5vcmcvbXVsdGlwYWdlL3N5bnRheC5odG1sI2F0dHJpYnV0ZXMtMgogICAgICAgIGF0dHJOYW1lcyA9IHZhbHVlICYmIHZhbHVlLm1hdGNoKHJub3RodG1sd2hpdGUpOwogICAgICBpZiAoYXR0ck5hbWVzICYmIGVsZW0ubm9kZVR5cGUgPT09IDEpIHsKICAgICAgICB3aGlsZSAobmFtZSA9IGF0dHJOYW1lc1tpKytdKSB7CiAgICAgICAgICBlbGVtLnJlbW92ZUF0dHJpYnV0ZShuYW1lKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgLy8gSG9va3MgZm9yIGJvb2xlYW4gYXR0cmlidXRlcwogIGJvb2xIb29rID0gewogICAgc2V0OiBmdW5jdGlvbiAoZWxlbSwgdmFsdWUsIG5hbWUpIHsKICAgICAgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIC8vIFJlbW92ZSBib29sZWFuIGF0dHJpYnV0ZXMgd2hlbiBzZXQgdG8gZmFsc2UKICAgICAgICBqUXVlcnkucmVtb3ZlQXR0cihlbGVtLCBuYW1lKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbGVtLnNldEF0dHJpYnV0ZShuYW1lLCBuYW1lKTsKICAgICAgfQogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9OwogIGpRdWVyeS5lYWNoKGpRdWVyeS5leHByLm1hdGNoLmJvb2wuc291cmNlLm1hdGNoKC9cdysvZyksIGZ1bmN0aW9uIChfaSwgbmFtZSkgewogICAgdmFyIGdldHRlciA9IGF0dHJIYW5kbGVbbmFtZV0gfHwgalF1ZXJ5LmZpbmQuYXR0cjsKICAgIGF0dHJIYW5kbGVbbmFtZV0gPSBmdW5jdGlvbiAoZWxlbSwgbmFtZSwgaXNYTUwpIHsKICAgICAgdmFyIHJldCwKICAgICAgICBoYW5kbGUsCiAgICAgICAgbG93ZXJjYXNlTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgaWYgKCFpc1hNTCkgewogICAgICAgIC8vIEF2b2lkIGFuIGluZmluaXRlIGxvb3AgYnkgdGVtcG9yYXJpbHkgcmVtb3ZpbmcgdGhpcyBmdW5jdGlvbiBmcm9tIHRoZSBnZXR0ZXIKICAgICAgICBoYW5kbGUgPSBhdHRySGFuZGxlW2xvd2VyY2FzZU5hbWVdOwogICAgICAgIGF0dHJIYW5kbGVbbG93ZXJjYXNlTmFtZV0gPSByZXQ7CiAgICAgICAgcmV0ID0gZ2V0dGVyKGVsZW0sIG5hbWUsIGlzWE1MKSAhPSBudWxsID8gbG93ZXJjYXNlTmFtZSA6IG51bGw7CiAgICAgICAgYXR0ckhhbmRsZVtsb3dlcmNhc2VOYW1lXSA9IGhhbmRsZTsKICAgICAgfQogICAgICByZXR1cm4gcmV0OwogICAgfTsKICB9KTsKICB2YXIgcmZvY3VzYWJsZSA9IC9eKD86aW5wdXR8c2VsZWN0fHRleHRhcmVhfGJ1dHRvbikkL2ksCiAgICByY2xpY2thYmxlID0gL14oPzphfGFyZWEpJC9pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgcHJvcDogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgIHJldHVybiBhY2Nlc3ModGhpcywgalF1ZXJ5LnByb3AsIG5hbWUsIHZhbHVlLCBhcmd1bWVudHMubGVuZ3RoID4gMSk7CiAgICB9LAogICAgcmVtb3ZlUHJvcDogZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVsZXRlIHRoaXNbalF1ZXJ5LnByb3BGaXhbbmFtZV0gfHwgbmFtZV07CiAgICAgIH0pOwogICAgfQogIH0pOwogIGpRdWVyeS5leHRlbmQoewogICAgcHJvcDogZnVuY3Rpb24gKGVsZW0sIG5hbWUsIHZhbHVlKSB7CiAgICAgIHZhciByZXQsCiAgICAgICAgaG9va3MsCiAgICAgICAgblR5cGUgPSBlbGVtLm5vZGVUeXBlOwoKICAgICAgLy8gRG9uJ3QgZ2V0L3NldCBwcm9wZXJ0aWVzIG9uIHRleHQsIGNvbW1lbnQgYW5kIGF0dHJpYnV0ZSBub2RlcwogICAgICBpZiAoblR5cGUgPT09IDMgfHwgblR5cGUgPT09IDggfHwgblR5cGUgPT09IDIpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgaWYgKG5UeXBlICE9PSAxIHx8ICFqUXVlcnkuaXNYTUxEb2MoZWxlbSkpIHsKICAgICAgICAvLyBGaXggbmFtZSBhbmQgYXR0YWNoIGhvb2tzCiAgICAgICAgbmFtZSA9IGpRdWVyeS5wcm9wRml4W25hbWVdIHx8IG5hbWU7CiAgICAgICAgaG9va3MgPSBqUXVlcnkucHJvcEhvb2tzW25hbWVdOwogICAgICB9CiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgaWYgKGhvb2tzICYmICJzZXQiIGluIGhvb2tzICYmIChyZXQgPSBob29rcy5zZXQoZWxlbSwgdmFsdWUsIG5hbWUpKSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gZWxlbVtuYW1lXSA9IHZhbHVlOwogICAgICB9CiAgICAgIGlmIChob29rcyAmJiAiZ2V0IiBpbiBob29rcyAmJiAocmV0ID0gaG9va3MuZ2V0KGVsZW0sIG5hbWUpKSAhPT0gbnVsbCkgewogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgICAgcmV0dXJuIGVsZW1bbmFtZV07CiAgICB9LAogICAgcHJvcEhvb2tzOiB7CiAgICAgIHRhYkluZGV4OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD05IC0gMTEgb25seQogICAgICAgICAgLy8gZWxlbS50YWJJbmRleCBkb2Vzbid0IGFsd2F5cyByZXR1cm4gdGhlCiAgICAgICAgICAvLyBjb3JyZWN0IHZhbHVlIHdoZW4gaXQgaGFzbid0IGJlZW4gZXhwbGljaXRseSBzZXQKICAgICAgICAgIC8vIFVzZSBwcm9wZXIgYXR0cmlidXRlIHJldHJpZXZhbCAodHJhYy0xMjA3MikKICAgICAgICAgIHZhciB0YWJpbmRleCA9IGpRdWVyeS5maW5kLmF0dHIoZWxlbSwgInRhYmluZGV4Iik7CiAgICAgICAgICBpZiAodGFiaW5kZXgpIHsKICAgICAgICAgICAgcmV0dXJuIHBhcnNlSW50KHRhYmluZGV4LCAxMCk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocmZvY3VzYWJsZS50ZXN0KGVsZW0ubm9kZU5hbWUpIHx8IHJjbGlja2FibGUudGVzdChlbGVtLm5vZGVOYW1lKSAmJiBlbGVtLmhyZWYpIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcHJvcEZpeDogewogICAgICAiZm9yIjogImh0bWxGb3IiLAogICAgICAiY2xhc3MiOiAiY2xhc3NOYW1lIgogICAgfQogIH0pOwoKICAvLyBTdXBwb3J0OiBJRSA8PTExIG9ubHkKICAvLyBBY2Nlc3NpbmcgdGhlIHNlbGVjdGVkSW5kZXggcHJvcGVydHkKICAvLyBmb3JjZXMgdGhlIGJyb3dzZXIgdG8gcmVzcGVjdCBzZXR0aW5nIHNlbGVjdGVkCiAgLy8gb24gdGhlIG9wdGlvbgogIC8vIFRoZSBnZXR0ZXIgZW5zdXJlcyBhIGRlZmF1bHQgb3B0aW9uIGlzIHNlbGVjdGVkCiAgLy8gd2hlbiBpbiBhbiBvcHRncm91cAogIC8vIGVzbGludCBydWxlICJuby11bnVzZWQtZXhwcmVzc2lvbnMiIGlzIGRpc2FibGVkIGZvciB0aGlzIGNvZGUKICAvLyBzaW5jZSBpdCBjb25zaWRlcnMgc3VjaCBhY2Nlc3Npb25zIG5vb3AKICBpZiAoIXN1cHBvcnQub3B0U2VsZWN0ZWQpIHsKICAgIGpRdWVyeS5wcm9wSG9va3Muc2VsZWN0ZWQgPSB7CiAgICAgIGdldDogZnVuY3Rpb24gKGVsZW0pIHsKICAgICAgICAvKiBlc2xpbnQgbm8tdW51c2VkLWV4cHJlc3Npb25zOiAib2ZmIiAqLwoKICAgICAgICB2YXIgcGFyZW50ID0gZWxlbS5wYXJlbnROb2RlOwogICAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LnBhcmVudE5vZGUpIHsKICAgICAgICAgIHBhcmVudC5wYXJlbnROb2RlLnNlbGVjdGVkSW5kZXg7CiAgICAgICAgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgLyogZXNsaW50IG5vLXVudXNlZC1leHByZXNzaW9uczogIm9mZiIgKi8KCiAgICAgICAgdmFyIHBhcmVudCA9IGVsZW0ucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50KSB7CiAgICAgICAgICBwYXJlbnQuc2VsZWN0ZWRJbmRleDsKICAgICAgICAgIGlmIChwYXJlbnQucGFyZW50Tm9kZSkgewogICAgICAgICAgICBwYXJlbnQucGFyZW50Tm9kZS5zZWxlY3RlZEluZGV4OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9CiAgalF1ZXJ5LmVhY2goWyJ0YWJJbmRleCIsICJyZWFkT25seSIsICJtYXhMZW5ndGgiLCAiY2VsbFNwYWNpbmciLCAiY2VsbFBhZGRpbmciLCAicm93U3BhbiIsICJjb2xTcGFuIiwgInVzZU1hcCIsICJmcmFtZUJvcmRlciIsICJjb250ZW50RWRpdGFibGUiXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnByb3BGaXhbdGhpcy50b0xvd2VyQ2FzZSgpXSA9IHRoaXM7CiAgfSk7CgogIC8vIFN0cmlwIGFuZCBjb2xsYXBzZSB3aGl0ZXNwYWNlIGFjY29yZGluZyB0byBIVE1MIHNwZWMKICAvLyBodHRwczovL2luZnJhLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLWFzY2lpLXdoaXRlc3BhY2UKICBmdW5jdGlvbiBzdHJpcEFuZENvbGxhcHNlKHZhbHVlKSB7CiAgICB2YXIgdG9rZW5zID0gdmFsdWUubWF0Y2gocm5vdGh0bWx3aGl0ZSkgfHwgW107CiAgICByZXR1cm4gdG9rZW5zLmpvaW4oIiAiKTsKICB9CiAgZnVuY3Rpb24gZ2V0Q2xhc3MoZWxlbSkgewogICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlICYmIGVsZW0uZ2V0QXR0cmlidXRlKCJjbGFzcyIpIHx8ICIiOwogIH0KICBmdW5jdGlvbiBjbGFzc2VzVG9BcnJheSh2YWx1ZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7CiAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiB2YWx1ZS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbXTsKICAgIH0KICAgIHJldHVybiBbXTsKICB9CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBhZGRDbGFzczogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHZhciBjbGFzc05hbWVzLCBjdXIsIGN1clZhbHVlLCBjbGFzc05hbWUsIGksIGZpbmFsVmFsdWU7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGopIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS5hZGRDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGosIGdldENsYXNzKHRoaXMpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgY2xhc3NOYW1lcyA9IGNsYXNzZXNUb0FycmF5KHZhbHVlKTsKICAgICAgaWYgKGNsYXNzTmFtZXMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBjdXJWYWx1ZSA9IGdldENsYXNzKHRoaXMpOwogICAgICAgICAgY3VyID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiAiICIgKyBzdHJpcEFuZENvbGxhcHNlKGN1clZhbHVlKSArICIgIjsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNsYXNzTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVzW2ldOwogICAgICAgICAgICAgIGlmIChjdXIuaW5kZXhPZigiICIgKyBjbGFzc05hbWUgKyAiICIpIDwgMCkgewogICAgICAgICAgICAgICAgY3VyICs9IGNsYXNzTmFtZSArICIgIjsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE9ubHkgYXNzaWduIGlmIGRpZmZlcmVudCB0byBhdm9pZCB1bm5lZWRlZCByZW5kZXJpbmcuCiAgICAgICAgICAgIGZpbmFsVmFsdWUgPSBzdHJpcEFuZENvbGxhcHNlKGN1cik7CiAgICAgICAgICAgIGlmIChjdXJWYWx1ZSAhPT0gZmluYWxWYWx1ZSkgewogICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGZpbmFsVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgY2xhc3NOYW1lcywgY3VyLCBjdXJWYWx1ZSwgY2xhc3NOYW1lLCBpLCBmaW5hbFZhbHVlOwogICAgICBpZiAoaXNGdW5jdGlvbih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChqKSB7CiAgICAgICAgICBqUXVlcnkodGhpcykucmVtb3ZlQ2xhc3ModmFsdWUuY2FsbCh0aGlzLCBqLCBnZXRDbGFzcyh0aGlzKSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmICghYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dHIoImNsYXNzIiwgIiIpOwogICAgICB9CiAgICAgIGNsYXNzTmFtZXMgPSBjbGFzc2VzVG9BcnJheSh2YWx1ZSk7CiAgICAgIGlmIChjbGFzc05hbWVzLmxlbmd0aCkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgICAgY3VyVmFsdWUgPSBnZXRDbGFzcyh0aGlzKTsKCiAgICAgICAgICAvLyBUaGlzIGV4cHJlc3Npb24gaXMgaGVyZSBmb3IgYmV0dGVyIGNvbXByZXNzaWJpbGl0eSAoc2VlIGFkZENsYXNzKQogICAgICAgICAgY3VyID0gdGhpcy5ub2RlVHlwZSA9PT0gMSAmJiAiICIgKyBzdHJpcEFuZENvbGxhcHNlKGN1clZhbHVlKSArICIgIjsKICAgICAgICAgIGlmIChjdXIpIHsKICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGNsYXNzTmFtZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICBjbGFzc05hbWUgPSBjbGFzc05hbWVzW2ldOwoKICAgICAgICAgICAgICAvLyBSZW1vdmUgKmFsbCogaW5zdGFuY2VzCiAgICAgICAgICAgICAgd2hpbGUgKGN1ci5pbmRleE9mKCIgIiArIGNsYXNzTmFtZSArICIgIikgPiAtMSkgewogICAgICAgICAgICAgICAgY3VyID0gY3VyLnJlcGxhY2UoIiAiICsgY2xhc3NOYW1lICsgIiAiLCAiICIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gT25seSBhc3NpZ24gaWYgZGlmZmVyZW50IHRvIGF2b2lkIHVubmVlZGVkIHJlbmRlcmluZy4KICAgICAgICAgICAgZmluYWxWYWx1ZSA9IHN0cmlwQW5kQ29sbGFwc2UoY3VyKTsKICAgICAgICAgICAgaWYgKGN1clZhbHVlICE9PSBmaW5hbFZhbHVlKSB7CiAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgZmluYWxWYWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKHZhbHVlLCBzdGF0ZVZhbCkgewogICAgICB2YXIgY2xhc3NOYW1lcywKICAgICAgICBjbGFzc05hbWUsCiAgICAgICAgaSwKICAgICAgICBzZWxmLAogICAgICAgIHR5cGUgPSB0eXBlb2YgdmFsdWUsCiAgICAgICAgaXNWYWxpZFZhbHVlID0gdHlwZSA9PT0gInN0cmluZyIgfHwgQXJyYXkuaXNBcnJheSh2YWx1ZSk7CiAgICAgIGlmIChpc0Z1bmN0aW9uKHZhbHVlKSkgewogICAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICAgIGpRdWVyeSh0aGlzKS50b2dnbGVDbGFzcyh2YWx1ZS5jYWxsKHRoaXMsIGksIGdldENsYXNzKHRoaXMpLCBzdGF0ZVZhbCksIHN0YXRlVmFsKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAodHlwZW9mIHN0YXRlVmFsID09PSAiYm9vbGVhbiIgJiYgaXNWYWxpZFZhbHVlKSB7CiAgICAgICAgcmV0dXJuIHN0YXRlVmFsID8gdGhpcy5hZGRDbGFzcyh2YWx1ZSkgOiB0aGlzLnJlbW92ZUNsYXNzKHZhbHVlKTsKICAgICAgfQogICAgICBjbGFzc05hbWVzID0gY2xhc3Nlc1RvQXJyYXkodmFsdWUpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoaXNWYWxpZFZhbHVlKSB7CiAgICAgICAgICAvLyBUb2dnbGUgaW5kaXZpZHVhbCBjbGFzcyBuYW1lcwogICAgICAgICAgc2VsZiA9IGpRdWVyeSh0aGlzKTsKICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc05hbWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIGNsYXNzTmFtZSA9IGNsYXNzTmFtZXNbaV07CgogICAgICAgICAgICAvLyBDaGVjayBlYWNoIGNsYXNzTmFtZSBnaXZlbiwgc3BhY2Ugc2VwYXJhdGVkIGxpc3QKICAgICAgICAgICAgaWYgKHNlbGYuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgewogICAgICAgICAgICAgIHNlbGYucmVtb3ZlQ2xhc3MoY2xhc3NOYW1lKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzZWxmLmFkZENsYXNzKGNsYXNzTmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBUb2dnbGUgd2hvbGUgY2xhc3MgbmFtZQogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB0eXBlID09PSAiYm9vbGVhbiIpIHsKICAgICAgICAgIGNsYXNzTmFtZSA9IGdldENsYXNzKHRoaXMpOwogICAgICAgICAgaWYgKGNsYXNzTmFtZSkgewogICAgICAgICAgICAvLyBTdG9yZSBjbGFzc05hbWUgaWYgc2V0CiAgICAgICAgICAgIGRhdGFQcml2LnNldCh0aGlzLCAiX19jbGFzc05hbWVfXyIsIGNsYXNzTmFtZSk7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gSWYgdGhlIGVsZW1lbnQgaGFzIGEgY2xhc3MgbmFtZSBvciBpZiB3ZSdyZSBwYXNzZWQgYGZhbHNlYCwKICAgICAgICAgIC8vIHRoZW4gcmVtb3ZlIHRoZSB3aG9sZSBjbGFzc25hbWUgKGlmIHRoZXJlIHdhcyBvbmUsIHRoZSBhYm92ZSBzYXZlZCBpdCkuCiAgICAgICAgICAvLyBPdGhlcndpc2UgYnJpbmcgYmFjayB3aGF0ZXZlciB3YXMgcHJldmlvdXNseSBzYXZlZCAoaWYgYW55dGhpbmcpLAogICAgICAgICAgLy8gZmFsbGluZyBiYWNrIHRvIHRoZSBlbXB0eSBzdHJpbmcgaWYgbm90aGluZyB3YXMgc3RvcmVkLgogICAgICAgICAgaWYgKHRoaXMuc2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCJjbGFzcyIsIGNsYXNzTmFtZSB8fCB2YWx1ZSA9PT0gZmFsc2UgPyAiIiA6IGRhdGFQcml2LmdldCh0aGlzLCAiX19jbGFzc05hbWVfXyIpIHx8ICIiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfSwKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdmFyIGNsYXNzTmFtZSwKICAgICAgICBlbGVtLAogICAgICAgIGkgPSAwOwogICAgICBjbGFzc05hbWUgPSAiICIgKyBzZWxlY3RvciArICIgIjsKICAgICAgd2hpbGUgKGVsZW0gPSB0aGlzW2krK10pIHsKICAgICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMSAmJiAoIiAiICsgc3RyaXBBbmRDb2xsYXBzZShnZXRDbGFzcyhlbGVtKSkgKyAiICIpLmluZGV4T2YoY2xhc3NOYW1lKSA+IC0xKSB7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0pOwogIHZhciBycmV0dXJuID0gL1xyL2c7CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB2YWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICB2YXIgaG9va3MsCiAgICAgICAgcmV0LAogICAgICAgIHZhbHVlSXNGdW5jdGlvbiwKICAgICAgICBlbGVtID0gdGhpc1swXTsKICAgICAgaWYgKCFhcmd1bWVudHMubGVuZ3RoKSB7CiAgICAgICAgaWYgKGVsZW0pIHsKICAgICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW2VsZW0udHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW2VsZW0ubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoaG9va3MgJiYgImdldCIgaW4gaG9va3MgJiYgKHJldCA9IGhvb2tzLmdldChlbGVtLCAidmFsdWUiKSkgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gcmV0OwogICAgICAgICAgfQogICAgICAgICAgcmV0ID0gZWxlbS52YWx1ZTsKCiAgICAgICAgICAvLyBIYW5kbGUgbW9zdCBjb21tb24gc3RyaW5nIGNhc2VzCiAgICAgICAgICBpZiAodHlwZW9mIHJldCA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgcmV0dXJuIHJldC5yZXBsYWNlKHJyZXR1cm4sICIiKTsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBIYW5kbGUgY2FzZXMgd2hlcmUgdmFsdWUgaXMgbnVsbC91bmRlZiBvciBudW1iZXIKICAgICAgICAgIHJldHVybiByZXQgPT0gbnVsbCA/ICIiIDogcmV0OwogICAgICAgIH0KICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgdmFsdWVJc0Z1bmN0aW9uID0gaXNGdW5jdGlvbih2YWx1ZSk7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKGkpIHsKICAgICAgICB2YXIgdmFsOwogICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh2YWx1ZUlzRnVuY3Rpb24pIHsKICAgICAgICAgIHZhbCA9IHZhbHVlLmNhbGwodGhpcywgaSwgalF1ZXJ5KHRoaXMpLnZhbCgpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFsID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLyBUcmVhdCBudWxsL3VuZGVmaW5lZCBhcyAiIjsgY29udmVydCBudW1iZXJzIHRvIHN0cmluZwogICAgICAgIGlmICh2YWwgPT0gbnVsbCkgewogICAgICAgICAgdmFsID0gIiI7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsID09PSAibnVtYmVyIikgewogICAgICAgICAgdmFsICs9ICIiOwogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7CiAgICAgICAgICB2YWwgPSBqUXVlcnkubWFwKHZhbCwgZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSArICIiOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGhvb2tzID0galF1ZXJ5LnZhbEhvb2tzW3RoaXMudHlwZV0gfHwgalF1ZXJ5LnZhbEhvb2tzW3RoaXMubm9kZU5hbWUudG9Mb3dlckNhc2UoKV07CgogICAgICAgIC8vIElmIHNldCByZXR1cm5zIHVuZGVmaW5lZCwgZmFsbCBiYWNrIHRvIG5vcm1hbCBzZXR0aW5nCiAgICAgICAgaWYgKCFob29rcyB8fCAhKCJzZXQiIGluIGhvb2tzKSB8fCBob29rcy5zZXQodGhpcywgdmFsLCAidmFsdWUiKSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4dGVuZCh7CiAgICB2YWxIb29rczogewogICAgICBvcHRpb246IHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICB2YXIgdmFsID0galF1ZXJ5LmZpbmQuYXR0cihlbGVtLCAidmFsdWUiKTsKICAgICAgICAgIHJldHVybiB2YWwgIT0gbnVsbCA/IHZhbCA6CiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTEwIC0gMTEgb25seQogICAgICAgICAgLy8gb3B0aW9uLnRleHQgdGhyb3dzIGV4Y2VwdGlvbnMgKHRyYWMtMTQ2ODYsIHRyYWMtMTQ4NTgpCiAgICAgICAgICAvLyBTdHJpcCBhbmQgY29sbGFwc2Ugd2hpdGVzcGFjZQogICAgICAgICAgLy8gaHR0cHM6Ly9odG1sLnNwZWMud2hhdHdnLm9yZy8jc3RyaXAtYW5kLWNvbGxhcHNlLXdoaXRlc3BhY2UKICAgICAgICAgIHN0cmlwQW5kQ29sbGFwc2UoalF1ZXJ5LnRleHQoZWxlbSkpOwogICAgICAgIH0KICAgICAgfSwKICAgICAgc2VsZWN0OiB7CiAgICAgICAgZ2V0OiBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgdmFyIHZhbHVlLAogICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgIGksCiAgICAgICAgICAgIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCiAgICAgICAgICAgIGluZGV4ID0gZWxlbS5zZWxlY3RlZEluZGV4LAogICAgICAgICAgICBvbmUgPSBlbGVtLnR5cGUgPT09ICJzZWxlY3Qtb25lIiwKICAgICAgICAgICAgdmFsdWVzID0gb25lID8gbnVsbCA6IFtdLAogICAgICAgICAgICBtYXggPSBvbmUgPyBpbmRleCArIDEgOiBvcHRpb25zLmxlbmd0aDsKICAgICAgICAgIGlmIChpbmRleCA8IDApIHsKICAgICAgICAgICAgaSA9IG1heDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGkgPSBvbmUgPyBpbmRleCA6IDA7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGFsbCB0aGUgc2VsZWN0ZWQgb3B0aW9ucwogICAgICAgICAgZm9yICg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwoKICAgICAgICAgICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgICAgICAgICAgLy8gSUU4LTkgZG9lc24ndCB1cGRhdGUgc2VsZWN0ZWQgYWZ0ZXIgZm9ybSByZXNldCAodHJhYy0yNTUxKQogICAgICAgICAgICBpZiAoKG9wdGlvbi5zZWxlY3RlZCB8fCBpID09PSBpbmRleCkgJiYKICAgICAgICAgICAgLy8gRG9uJ3QgcmV0dXJuIG9wdGlvbnMgdGhhdCBhcmUgZGlzYWJsZWQgb3IgaW4gYSBkaXNhYmxlZCBvcHRncm91cAogICAgICAgICAgICAhb3B0aW9uLmRpc2FibGVkICYmICghb3B0aW9uLnBhcmVudE5vZGUuZGlzYWJsZWQgfHwgIW5vZGVOYW1lKG9wdGlvbi5wYXJlbnROb2RlLCAib3B0Z3JvdXAiKSkpIHsKICAgICAgICAgICAgICAvLyBHZXQgdGhlIHNwZWNpZmljIHZhbHVlIGZvciB0aGUgb3B0aW9uCiAgICAgICAgICAgICAgdmFsdWUgPSBqUXVlcnkob3B0aW9uKS52YWwoKTsKCiAgICAgICAgICAgICAgLy8gV2UgZG9uJ3QgbmVlZCBhbiBhcnJheSBmb3Igb25lIHNlbGVjdHMKICAgICAgICAgICAgICBpZiAob25lKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBNdWx0aS1TZWxlY3RzIHJldHVybiBhbiBhcnJheQogICAgICAgICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHZhbHVlczsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gKGVsZW0sIHZhbHVlKSB7CiAgICAgICAgICB2YXIgb3B0aW9uU2V0LAogICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgIG9wdGlvbnMgPSBlbGVtLm9wdGlvbnMsCiAgICAgICAgICAgIHZhbHVlcyA9IGpRdWVyeS5tYWtlQXJyYXkodmFsdWUpLAogICAgICAgICAgICBpID0gb3B0aW9ucy5sZW5ndGg7CiAgICAgICAgICB3aGlsZSAoaS0tKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CgogICAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25kLWFzc2lnbiAqLwoKICAgICAgICAgICAgaWYgKG9wdGlvbi5zZWxlY3RlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeS52YWxIb29rcy5vcHRpb24uZ2V0KG9wdGlvbiksIHZhbHVlcykgPiAtMSkgewogICAgICAgICAgICAgIG9wdGlvblNldCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8qIGVzbGludC1lbmFibGUgbm8tY29uZC1hc3NpZ24gKi8KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBGb3JjZSBicm93c2VycyB0byBiZWhhdmUgY29uc2lzdGVudGx5IHdoZW4gbm9uLW1hdGNoaW5nIHZhbHVlIGlzIHNldAogICAgICAgICAgaWYgKCFvcHRpb25TZXQpIHsKICAgICAgICAgICAgZWxlbS5zZWxlY3RlZEluZGV4ID0gLTE7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdmFsdWVzOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0pOwoKICAvLyBSYWRpb3MgYW5kIGNoZWNrYm94ZXMgZ2V0dGVyL3NldHRlcgogIGpRdWVyeS5lYWNoKFsicmFkaW8iLCAiY2hlY2tib3giXSwgZnVuY3Rpb24gKCkgewogICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdID0gewogICAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtLCB2YWx1ZSkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIGVsZW0uY2hlY2tlZCA9IGpRdWVyeS5pbkFycmF5KGpRdWVyeShlbGVtKS52YWwoKSwgdmFsdWUpID4gLTE7CiAgICAgICAgfQogICAgICB9CiAgICB9OwogICAgaWYgKCFzdXBwb3J0LmNoZWNrT24pIHsKICAgICAgalF1ZXJ5LnZhbEhvb2tzW3RoaXNdLmdldCA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGVsZW0uZ2V0QXR0cmlidXRlKCJ2YWx1ZSIpID09PSBudWxsID8gIm9uIiA6IGVsZW0udmFsdWU7CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIFJldHVybiBqUXVlcnkgZm9yIGF0dHJpYnV0ZXMtb25seSBpbmNsdXNpb24KCiAgc3VwcG9ydC5mb2N1c2luID0gIm9uZm9jdXNpbiIgaW4gd2luZG93OwogIHZhciByZm9jdXNNb3JwaCA9IC9eKD86Zm9jdXNpbmZvY3VzfGZvY3Vzb3V0Ymx1cikkLywKICAgIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrID0gZnVuY3Rpb24gKGUpIHsKICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTsKICAgIH07CiAgalF1ZXJ5LmV4dGVuZChqUXVlcnkuZXZlbnQsIHsKICAgIHRyaWdnZXI6IGZ1bmN0aW9uIChldmVudCwgZGF0YSwgZWxlbSwgb25seUhhbmRsZXJzKSB7CiAgICAgIHZhciBpLAogICAgICAgIGN1ciwKICAgICAgICB0bXAsCiAgICAgICAgYnViYmxlVHlwZSwKICAgICAgICBvbnR5cGUsCiAgICAgICAgaGFuZGxlLAogICAgICAgIHNwZWNpYWwsCiAgICAgICAgbGFzdEVsZW1lbnQsCiAgICAgICAgZXZlbnRQYXRoID0gW2VsZW0gfHwgZG9jdW1lbnRdLAogICAgICAgIHR5cGUgPSBoYXNPd24uY2FsbChldmVudCwgInR5cGUiKSA/IGV2ZW50LnR5cGUgOiBldmVudCwKICAgICAgICBuYW1lc3BhY2VzID0gaGFzT3duLmNhbGwoZXZlbnQsICJuYW1lc3BhY2UiKSA/IGV2ZW50Lm5hbWVzcGFjZS5zcGxpdCgiLiIpIDogW107CiAgICAgIGN1ciA9IGxhc3RFbGVtZW50ID0gdG1wID0gZWxlbSA9IGVsZW0gfHwgZG9jdW1lbnQ7CgogICAgICAvLyBEb24ndCBkbyBldmVudHMgb24gdGV4dCBhbmQgY29tbWVudCBub2RlcwogICAgICBpZiAoZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA4KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICAvLyBmb2N1cy9ibHVyIG1vcnBocyB0byBmb2N1c2luL291dDsgZW5zdXJlIHdlJ3JlIG5vdCBmaXJpbmcgdGhlbSByaWdodCBub3cKICAgICAgaWYgKHJmb2N1c01vcnBoLnRlc3QodHlwZSArIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CiAgICAgIGlmICh0eXBlLmluZGV4T2YoIi4iKSA+IC0xKSB7CiAgICAgICAgLy8gTmFtZXNwYWNlZCB0cmlnZ2VyOyBjcmVhdGUgYSByZWdleHAgdG8gbWF0Y2ggZXZlbnQgdHlwZSBpbiBoYW5kbGUoKQogICAgICAgIG5hbWVzcGFjZXMgPSB0eXBlLnNwbGl0KCIuIik7CiAgICAgICAgdHlwZSA9IG5hbWVzcGFjZXMuc2hpZnQoKTsKICAgICAgICBuYW1lc3BhY2VzLnNvcnQoKTsKICAgICAgfQogICAgICBvbnR5cGUgPSB0eXBlLmluZGV4T2YoIjoiKSA8IDAgJiYgIm9uIiArIHR5cGU7CgogICAgICAvLyBDYWxsZXIgY2FuIHBhc3MgaW4gYSBqUXVlcnkuRXZlbnQgb2JqZWN0LCBPYmplY3QsIG9yIGp1c3QgYW4gZXZlbnQgdHlwZSBzdHJpbmcKICAgICAgZXZlbnQgPSBldmVudFtqUXVlcnkuZXhwYW5kb10gPyBldmVudCA6IG5ldyBqUXVlcnkuRXZlbnQodHlwZSwgdHlwZW9mIGV2ZW50ID09PSAib2JqZWN0IiAmJiBldmVudCk7CgogICAgICAvLyBUcmlnZ2VyIGJpdG1hc2s6ICYgMSBmb3IgbmF0aXZlIGhhbmRsZXJzOyAmIDIgZm9yIGpRdWVyeSAoYWx3YXlzIHRydWUpCiAgICAgIGV2ZW50LmlzVHJpZ2dlciA9IG9ubHlIYW5kbGVycyA/IDIgOiAzOwogICAgICBldmVudC5uYW1lc3BhY2UgPSBuYW1lc3BhY2VzLmpvaW4oIi4iKTsKICAgICAgZXZlbnQucm5hbWVzcGFjZSA9IGV2ZW50Lm5hbWVzcGFjZSA/IG5ldyBSZWdFeHAoIihefFxcLikiICsgbmFtZXNwYWNlcy5qb2luKCJcXC4oPzouKlxcLnwpIikgKyAiKFxcLnwkKSIpIDogbnVsbDsKCiAgICAgIC8vIENsZWFuIHVwIHRoZSBldmVudCBpbiBjYXNlIGl0IGlzIGJlaW5nIHJldXNlZAogICAgICBldmVudC5yZXN1bHQgPSB1bmRlZmluZWQ7CiAgICAgIGlmICghZXZlbnQudGFyZ2V0KSB7CiAgICAgICAgZXZlbnQudGFyZ2V0ID0gZWxlbTsKICAgICAgfQoKICAgICAgLy8gQ2xvbmUgYW55IGluY29taW5nIGRhdGEgYW5kIHByZXBlbmQgdGhlIGV2ZW50LCBjcmVhdGluZyB0aGUgaGFuZGxlciBhcmcgbGlzdAogICAgICBkYXRhID0gZGF0YSA9PSBudWxsID8gW2V2ZW50XSA6IGpRdWVyeS5tYWtlQXJyYXkoZGF0YSwgW2V2ZW50XSk7CgogICAgICAvLyBBbGxvdyBzcGVjaWFsIGV2ZW50cyB0byBkcmF3IG91dHNpZGUgdGhlIGxpbmVzCiAgICAgIHNwZWNpYWwgPSBqUXVlcnkuZXZlbnQuc3BlY2lhbFt0eXBlXSB8fCB7fTsKICAgICAgaWYgKCFvbmx5SGFuZGxlcnMgJiYgc3BlY2lhbC50cmlnZ2VyICYmIHNwZWNpYWwudHJpZ2dlci5hcHBseShlbGVtLCBkYXRhKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIC8vIERldGVybWluZSBldmVudCBwcm9wYWdhdGlvbiBwYXRoIGluIGFkdmFuY2UsIHBlciBXM0MgZXZlbnRzIHNwZWMgKHRyYWMtOTk1MSkKICAgICAgLy8gQnViYmxlIHVwIHRvIGRvY3VtZW50LCB0aGVuIHRvIHdpbmRvdzsgd2F0Y2ggZm9yIGEgZ2xvYmFsIG93bmVyRG9jdW1lbnQgdmFyICh0cmFjLTk3MjQpCiAgICAgIGlmICghb25seUhhbmRsZXJzICYmICFzcGVjaWFsLm5vQnViYmxlICYmICFpc1dpbmRvdyhlbGVtKSkgewogICAgICAgIGJ1YmJsZVR5cGUgPSBzcGVjaWFsLmRlbGVnYXRlVHlwZSB8fCB0eXBlOwogICAgICAgIGlmICghcmZvY3VzTW9ycGgudGVzdChidWJibGVUeXBlICsgdHlwZSkpIHsKICAgICAgICAgIGN1ciA9IGN1ci5wYXJlbnROb2RlOwogICAgICAgIH0KICAgICAgICBmb3IgKDsgY3VyOyBjdXIgPSBjdXIucGFyZW50Tm9kZSkgewogICAgICAgICAgZXZlbnRQYXRoLnB1c2goY3VyKTsKICAgICAgICAgIHRtcCA9IGN1cjsKICAgICAgICB9CgogICAgICAgIC8vIE9ubHkgYWRkIHdpbmRvdyBpZiB3ZSBnb3QgdG8gZG9jdW1lbnQgKGUuZy4sIG5vdCBwbGFpbiBvYmogb3IgZGV0YWNoZWQgRE9NKQogICAgICAgIGlmICh0bXAgPT09IChlbGVtLm93bmVyRG9jdW1lbnQgfHwgZG9jdW1lbnQpKSB7CiAgICAgICAgICBldmVudFBhdGgucHVzaCh0bXAuZGVmYXVsdFZpZXcgfHwgdG1wLnBhcmVudFdpbmRvdyB8fCB3aW5kb3cpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gRmlyZSBoYW5kbGVycyBvbiB0aGUgZXZlbnQgcGF0aAogICAgICBpID0gMDsKICAgICAgd2hpbGUgKChjdXIgPSBldmVudFBhdGhbaSsrXSkgJiYgIWV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICBsYXN0RWxlbWVudCA9IGN1cjsKICAgICAgICBldmVudC50eXBlID0gaSA+IDEgPyBidWJibGVUeXBlIDogc3BlY2lhbC5iaW5kVHlwZSB8fCB0eXBlOwoKICAgICAgICAvLyBqUXVlcnkgaGFuZGxlcgogICAgICAgIGhhbmRsZSA9IChkYXRhUHJpdi5nZXQoY3VyLCAiZXZlbnRzIikgfHwgT2JqZWN0LmNyZWF0ZShudWxsKSlbZXZlbnQudHlwZV0gJiYgZGF0YVByaXYuZ2V0KGN1ciwgImhhbmRsZSIpOwogICAgICAgIGlmIChoYW5kbGUpIHsKICAgICAgICAgIGhhbmRsZS5hcHBseShjdXIsIGRhdGEpOwogICAgICAgIH0KCiAgICAgICAgLy8gTmF0aXZlIGhhbmRsZXIKICAgICAgICBoYW5kbGUgPSBvbnR5cGUgJiYgY3VyW29udHlwZV07CiAgICAgICAgaWYgKGhhbmRsZSAmJiBoYW5kbGUuYXBwbHkgJiYgYWNjZXB0RGF0YShjdXIpKSB7CiAgICAgICAgICBldmVudC5yZXN1bHQgPSBoYW5kbGUuYXBwbHkoY3VyLCBkYXRhKTsKICAgICAgICAgIGlmIChldmVudC5yZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGV2ZW50LnR5cGUgPSB0eXBlOwoKICAgICAgLy8gSWYgbm9ib2R5IHByZXZlbnRlZCB0aGUgZGVmYXVsdCBhY3Rpb24sIGRvIGl0IG5vdwogICAgICBpZiAoIW9ubHlIYW5kbGVycyAmJiAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkpIHsKICAgICAgICBpZiAoKCFzcGVjaWFsLl9kZWZhdWx0IHx8IHNwZWNpYWwuX2RlZmF1bHQuYXBwbHkoZXZlbnRQYXRoLnBvcCgpLCBkYXRhKSA9PT0gZmFsc2UpICYmIGFjY2VwdERhdGEoZWxlbSkpIHsKICAgICAgICAgIC8vIENhbGwgYSBuYXRpdmUgRE9NIG1ldGhvZCBvbiB0aGUgdGFyZ2V0IHdpdGggdGhlIHNhbWUgbmFtZSBhcyB0aGUgZXZlbnQuCiAgICAgICAgICAvLyBEb24ndCBkbyBkZWZhdWx0IGFjdGlvbnMgb24gd2luZG93LCB0aGF0J3Mgd2hlcmUgZ2xvYmFsIHZhcmlhYmxlcyBiZSAodHJhYy02MTcwKQogICAgICAgICAgaWYgKG9udHlwZSAmJiBpc0Z1bmN0aW9uKGVsZW1bdHlwZV0pICYmICFpc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgICAvLyBEb24ndCByZS10cmlnZ2VyIGFuIG9uRk9PIGV2ZW50IHdoZW4gd2UgY2FsbCBpdHMgRk9PKCkgbWV0aG9kCiAgICAgICAgICAgIHRtcCA9IGVsZW1bb250eXBlXTsKICAgICAgICAgICAgaWYgKHRtcCkgewogICAgICAgICAgICAgIGVsZW1bb250eXBlXSA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFByZXZlbnQgcmUtdHJpZ2dlcmluZyBvZiB0aGUgc2FtZSBldmVudCwgc2luY2Ugd2UgYWxyZWFkeSBidWJibGVkIGl0IGFib3ZlCiAgICAgICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyZWQgPSB0eXBlOwogICAgICAgICAgICBpZiAoZXZlbnQuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSkgewogICAgICAgICAgICAgIGxhc3RFbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodHlwZSwgc3RvcFByb3BhZ2F0aW9uQ2FsbGJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsZW1bdHlwZV0oKTsKICAgICAgICAgICAgaWYgKGV2ZW50LmlzUHJvcGFnYXRpb25TdG9wcGVkKCkpIHsKICAgICAgICAgICAgICBsYXN0RWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIHN0b3BQcm9wYWdhdGlvbkNhbGxiYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcmVkID0gdW5kZWZpbmVkOwogICAgICAgICAgICBpZiAodG1wKSB7CiAgICAgICAgICAgICAgZWxlbVtvbnR5cGVdID0gdG1wOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBldmVudC5yZXN1bHQ7CiAgICB9LAogICAgLy8gUGlnZ3liYWNrIG9uIGEgZG9ub3IgZXZlbnQgdG8gc2ltdWxhdGUgYSBkaWZmZXJlbnQgb25lCiAgICAvLyBVc2VkIG9ubHkgZm9yIGBmb2N1cyhpbiB8IG91dClgIGV2ZW50cwogICAgc2ltdWxhdGU6IGZ1bmN0aW9uICh0eXBlLCBlbGVtLCBldmVudCkgewogICAgICB2YXIgZSA9IGpRdWVyeS5leHRlbmQobmV3IGpRdWVyeS5FdmVudCgpLCBldmVudCwgewogICAgICAgIHR5cGU6IHR5cGUsCiAgICAgICAgaXNTaW11bGF0ZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKGUsIG51bGwsIGVsZW0pOwogICAgfQogIH0pOwogIGpRdWVyeS5mbi5leHRlbmQoewogICAgdHJpZ2dlcjogZnVuY3Rpb24gKHR5cGUsIGRhdGEpIHsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnRyaWdnZXIodHlwZSwgZGF0YSwgdGhpcyk7CiAgICAgIH0pOwogICAgfSwKICAgIHRyaWdnZXJIYW5kbGVyOiBmdW5jdGlvbiAodHlwZSwgZGF0YSkgewogICAgICB2YXIgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmIChlbGVtKSB7CiAgICAgICAgcmV0dXJuIGpRdWVyeS5ldmVudC50cmlnZ2VyKHR5cGUsIGRhdGEsIGVsZW0sIHRydWUpOwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIFN1cHBvcnQ6IEZpcmVmb3ggPD00NAogIC8vIEZpcmVmb3ggZG9lc24ndCBoYXZlIGZvY3VzKGluIHwgb3V0KSBldmVudHMKICAvLyBSZWxhdGVkIHRpY2tldCAtIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTY4Nzc4NwogIC8vCiAgLy8gU3VwcG9ydDogQ2hyb21lIDw9NDggLSA0OSwgU2FmYXJpIDw9OS4wIC0gOS4xCiAgLy8gZm9jdXMoaW4gfCBvdXQpIGV2ZW50cyBmaXJlIGFmdGVyIGZvY3VzICYgYmx1ciBldmVudHMsCiAgLy8gd2hpY2ggaXMgc3BlYyB2aW9sYXRpb24gLSBodHRwOi8vd3d3LnczLm9yZy9UUi9ET00tTGV2ZWwtMy1FdmVudHMvI2V2ZW50cy1mb2N1c2V2ZW50LWV2ZW50LW9yZGVyCiAgLy8gUmVsYXRlZCB0aWNrZXQgLSBodHRwczovL2J1Z3MuY2hyb21pdW0ub3JnL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD00NDk4NTcKICBpZiAoIXN1cHBvcnQuZm9jdXNpbikgewogICAgalF1ZXJ5LmVhY2goewogICAgICBmb2N1czogImZvY3VzaW4iLAogICAgICBibHVyOiAiZm9jdXNvdXQiCiAgICB9LCBmdW5jdGlvbiAob3JpZywgZml4KSB7CiAgICAgIC8vIEF0dGFjaCBhIHNpbmdsZSBjYXB0dXJpbmcgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQgd2hpbGUgc29tZW9uZSB3YW50cyBmb2N1c2luL2ZvY3Vzb3V0CiAgICAgIHZhciBoYW5kbGVyID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgalF1ZXJ5LmV2ZW50LnNpbXVsYXRlKGZpeCwgZXZlbnQudGFyZ2V0LCBqUXVlcnkuZXZlbnQuZml4KGV2ZW50KSk7CiAgICAgIH07CiAgICAgIGpRdWVyeS5ldmVudC5zcGVjaWFsW2ZpeF0gPSB7CiAgICAgICAgc2V0dXA6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIC8vIEhhbmRsZTogcmVndWxhciBub2RlcyAodmlhIGB0aGlzLm93bmVyRG9jdW1lbnRgKSwgd2luZG93CiAgICAgICAgICAvLyAodmlhIGB0aGlzLmRvY3VtZW50YCkgJiBkb2N1bWVudCAodmlhIGB0aGlzYCkuCiAgICAgICAgICB2YXIgZG9jID0gdGhpcy5vd25lckRvY3VtZW50IHx8IHRoaXMuZG9jdW1lbnQgfHwgdGhpcywKICAgICAgICAgICAgYXR0YWNoZXMgPSBkYXRhUHJpdi5hY2Nlc3MoZG9jLCBmaXgpOwogICAgICAgICAgaWYgKCFhdHRhY2hlcykgewogICAgICAgICAgICBkb2MuYWRkRXZlbnRMaXN0ZW5lcihvcmlnLCBoYW5kbGVyLCB0cnVlKTsKICAgICAgICAgIH0KICAgICAgICAgIGRhdGFQcml2LmFjY2Vzcyhkb2MsIGZpeCwgKGF0dGFjaGVzIHx8IDApICsgMSk7CiAgICAgICAgfSwKICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGRvYyA9IHRoaXMub3duZXJEb2N1bWVudCB8fCB0aGlzLmRvY3VtZW50IHx8IHRoaXMsCiAgICAgICAgICAgIGF0dGFjaGVzID0gZGF0YVByaXYuYWNjZXNzKGRvYywgZml4KSAtIDE7CiAgICAgICAgICBpZiAoIWF0dGFjaGVzKSB7CiAgICAgICAgICAgIGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKG9yaWcsIGhhbmRsZXIsIHRydWUpOwogICAgICAgICAgICBkYXRhUHJpdi5yZW1vdmUoZG9jLCBmaXgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZGF0YVByaXYuYWNjZXNzKGRvYywgZml4LCBhdHRhY2hlcyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9OwogICAgfSk7CiAgfQogIHZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbjsKICB2YXIgbm9uY2UgPSB7CiAgICBndWlkOiBEYXRlLm5vdygpCiAgfTsKICB2YXIgcnF1ZXJ5ID0gL1w/LzsKCiAgLy8gQ3Jvc3MtYnJvd3NlciB4bWwgcGFyc2luZwogIGpRdWVyeS5wYXJzZVhNTCA9IGZ1bmN0aW9uIChkYXRhKSB7CiAgICB2YXIgeG1sLCBwYXJzZXJFcnJvckVsZW07CiAgICBpZiAoIWRhdGEgfHwgdHlwZW9mIGRhdGEgIT09ICJzdHJpbmciKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfQoKICAgIC8vIFN1cHBvcnQ6IElFIDkgLSAxMSBvbmx5CiAgICAvLyBJRSB0aHJvd3Mgb24gcGFyc2VGcm9tU3RyaW5nIHdpdGggaW52YWxpZCBpbnB1dC4KICAgIHRyeSB7CiAgICAgIHhtbCA9IG5ldyB3aW5kb3cuRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKGRhdGEsICJ0ZXh0L3htbCIpOwogICAgfSBjYXRjaCAoZSkge30KICAgIHBhcnNlckVycm9yRWxlbSA9IHhtbCAmJiB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIilbMF07CiAgICBpZiAoIXhtbCB8fCBwYXJzZXJFcnJvckVsZW0pIHsKICAgICAgalF1ZXJ5LmVycm9yKCJJbnZhbGlkIFhNTDogIiArIChwYXJzZXJFcnJvckVsZW0gPyBqUXVlcnkubWFwKHBhcnNlckVycm9yRWxlbS5jaGlsZE5vZGVzLCBmdW5jdGlvbiAoZWwpIHsKICAgICAgICByZXR1cm4gZWwudGV4dENvbnRlbnQ7CiAgICAgIH0pLmpvaW4oIlxuIikgOiBkYXRhKSk7CiAgICB9CiAgICByZXR1cm4geG1sOwogIH07CiAgdmFyIHJicmFja2V0ID0gL1xbXF0kLywKICAgIHJDUkxGID0gL1xyP1xuL2csCiAgICByc3VibWl0dGVyVHlwZXMgPSAvXig/OnN1Ym1pdHxidXR0b258aW1hZ2V8cmVzZXR8ZmlsZSkkL2ksCiAgICByc3VibWl0dGFibGUgPSAvXig/OmlucHV0fHNlbGVjdHx0ZXh0YXJlYXxrZXlnZW4pL2k7CiAgZnVuY3Rpb24gYnVpbGRQYXJhbXMocHJlZml4LCBvYmosIHRyYWRpdGlvbmFsLCBhZGQpIHsKICAgIHZhciBuYW1lOwogICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkgewogICAgICAvLyBTZXJpYWxpemUgYXJyYXkgaXRlbS4KICAgICAgalF1ZXJ5LmVhY2gob2JqLCBmdW5jdGlvbiAoaSwgdikgewogICAgICAgIGlmICh0cmFkaXRpb25hbCB8fCByYnJhY2tldC50ZXN0KHByZWZpeCkpIHsKICAgICAgICAgIC8vIFRyZWF0IGVhY2ggYXJyYXkgaXRlbSBhcyBhIHNjYWxhci4KICAgICAgICAgIGFkZChwcmVmaXgsIHYpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBJdGVtIGlzIG5vbi1zY2FsYXIgKGFycmF5IG9yIG9iamVjdCksIGVuY29kZSBpdHMgbnVtZXJpYyBpbmRleC4KICAgICAgICAgIGJ1aWxkUGFyYW1zKHByZWZpeCArICJbIiArICh0eXBlb2YgdiA9PT0gIm9iamVjdCIgJiYgdiAhPSBudWxsID8gaSA6ICIiKSArICJdIiwgdiwgdHJhZGl0aW9uYWwsIGFkZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0gZWxzZSBpZiAoIXRyYWRpdGlvbmFsICYmIHRvVHlwZShvYmopID09PSAib2JqZWN0IikgewogICAgICAvLyBTZXJpYWxpemUgb2JqZWN0IGl0ZW0uCiAgICAgIGZvciAobmFtZSBpbiBvYmopIHsKICAgICAgICBidWlsZFBhcmFtcyhwcmVmaXggKyAiWyIgKyBuYW1lICsgIl0iLCBvYmpbbmFtZV0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBTZXJpYWxpemUgc2NhbGFyIGl0ZW0uCiAgICAgIGFkZChwcmVmaXgsIG9iaik7CiAgICB9CiAgfQoKICAvLyBTZXJpYWxpemUgYW4gYXJyYXkgb2YgZm9ybSBlbGVtZW50cyBvciBhIHNldCBvZgogIC8vIGtleS92YWx1ZXMgaW50byBhIHF1ZXJ5IHN0cmluZwogIGpRdWVyeS5wYXJhbSA9IGZ1bmN0aW9uIChhLCB0cmFkaXRpb25hbCkgewogICAgdmFyIHByZWZpeCwKICAgICAgcyA9IFtdLAogICAgICBhZGQgPSBmdW5jdGlvbiAoa2V5LCB2YWx1ZU9yRnVuY3Rpb24pIHsKICAgICAgICAvLyBJZiB2YWx1ZSBpcyBhIGZ1bmN0aW9uLCBpbnZva2UgaXQgYW5kIHVzZSBpdHMgcmV0dXJuIHZhbHVlCiAgICAgICAgdmFyIHZhbHVlID0gaXNGdW5jdGlvbih2YWx1ZU9yRnVuY3Rpb24pID8gdmFsdWVPckZ1bmN0aW9uKCkgOiB2YWx1ZU9yRnVuY3Rpb247CiAgICAgICAgc1tzLmxlbmd0aF0gPSBlbmNvZGVVUklDb21wb25lbnQoa2V5KSArICI9IiArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZSk7CiAgICAgIH07CiAgICBpZiAoYSA9PSBudWxsKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KCiAgICAvLyBJZiBhbiBhcnJheSB3YXMgcGFzc2VkIGluLCBhc3N1bWUgdGhhdCBpdCBpcyBhbiBhcnJheSBvZiBmb3JtIGVsZW1lbnRzLgogICAgaWYgKEFycmF5LmlzQXJyYXkoYSkgfHwgYS5qcXVlcnkgJiYgIWpRdWVyeS5pc1BsYWluT2JqZWN0KGEpKSB7CiAgICAgIC8vIFNlcmlhbGl6ZSB0aGUgZm9ybSBlbGVtZW50cwogICAgICBqUXVlcnkuZWFjaChhLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgYWRkKHRoaXMubmFtZSwgdGhpcy52YWx1ZSk7CiAgICAgIH0pOwogICAgfSBlbHNlIHsKICAgICAgLy8gSWYgdHJhZGl0aW9uYWwsIGVuY29kZSB0aGUgIm9sZCIgd2F5ICh0aGUgd2F5IDEuMy4yIG9yIG9sZGVyCiAgICAgIC8vIGRpZCBpdCksIG90aGVyd2lzZSBlbmNvZGUgcGFyYW1zIHJlY3Vyc2l2ZWx5LgogICAgICBmb3IgKHByZWZpeCBpbiBhKSB7CiAgICAgICAgYnVpbGRQYXJhbXMocHJlZml4LCBhW3ByZWZpeF0sIHRyYWRpdGlvbmFsLCBhZGQpOwogICAgICB9CiAgICB9CgogICAgLy8gUmV0dXJuIHRoZSByZXN1bHRpbmcgc2VyaWFsaXphdGlvbgogICAgcmV0dXJuIHMuam9pbigiJiIpOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICBzZXJpYWxpemU6IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGpRdWVyeS5wYXJhbSh0aGlzLnNlcmlhbGl6ZUFycmF5KCkpOwogICAgfSwKICAgIHNlcmlhbGl6ZUFycmF5OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gQ2FuIGFkZCBwcm9wSG9vayBmb3IgImVsZW1lbnRzIiB0byBmaWx0ZXIgb3IgYWRkIGZvcm0gZWxlbWVudHMKICAgICAgICB2YXIgZWxlbWVudHMgPSBqUXVlcnkucHJvcCh0aGlzLCAiZWxlbWVudHMiKTsKICAgICAgICByZXR1cm4gZWxlbWVudHMgPyBqUXVlcnkubWFrZUFycmF5KGVsZW1lbnRzKSA6IHRoaXM7CiAgICAgIH0pLmZpbHRlcihmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHR5cGUgPSB0aGlzLnR5cGU7CgogICAgICAgIC8vIFVzZSAuaXMoICI6ZGlzYWJsZWQiICkgc28gdGhhdCBmaWVsZHNldFtkaXNhYmxlZF0gd29ya3MKICAgICAgICByZXR1cm4gdGhpcy5uYW1lICYmICFqUXVlcnkodGhpcykuaXMoIjpkaXNhYmxlZCIpICYmIHJzdWJtaXR0YWJsZS50ZXN0KHRoaXMubm9kZU5hbWUpICYmICFyc3VibWl0dGVyVHlwZXMudGVzdCh0eXBlKSAmJiAodGhpcy5jaGVja2VkIHx8ICFyY2hlY2thYmxlVHlwZS50ZXN0KHR5cGUpKTsKICAgICAgfSkubWFwKGZ1bmN0aW9uIChfaSwgZWxlbSkgewogICAgICAgIHZhciB2YWwgPSBqUXVlcnkodGhpcykudmFsKCk7CiAgICAgICAgaWYgKHZhbCA9PSBudWxsKSB7CiAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkgewogICAgICAgICAgcmV0dXJuIGpRdWVyeS5tYXAodmFsLCBmdW5jdGlvbiAodmFsKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgbmFtZTogZWxlbS5uYW1lLAogICAgICAgICAgICAgIHZhbHVlOiB2YWwucmVwbGFjZShyQ1JMRiwgIlxyXG4iKQogICAgICAgICAgICB9OwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB7CiAgICAgICAgICBuYW1lOiBlbGVtLm5hbWUsCiAgICAgICAgICB2YWx1ZTogdmFsLnJlcGxhY2UockNSTEYsICJcclxuIikKICAgICAgICB9OwogICAgICB9KS5nZXQoKTsKICAgIH0KICB9KTsKICB2YXIgcjIwID0gLyUyMC9nLAogICAgcmhhc2ggPSAvIy4qJC8sCiAgICByYW50aUNhY2hlID0gLyhbPyZdKV89W14mXSovLAogICAgcmhlYWRlcnMgPSAvXiguKj8pOlsgXHRdKihbXlxyXG5dKikkL21nLAogICAgLy8gdHJhYy03NjUzLCB0cmFjLTgxMjUsIHRyYWMtODE1MjogbG9jYWwgcHJvdG9jb2wgZGV0ZWN0aW9uCiAgICBybG9jYWxQcm90b2NvbCA9IC9eKD86YWJvdXR8YXBwfGFwcC1zdG9yYWdlfC4rLWV4dGVuc2lvbnxmaWxlfHJlc3x3aWRnZXQpOiQvLAogICAgcm5vQ29udGVudCA9IC9eKD86R0VUfEhFQUQpJC8sCiAgICBycHJvdG9jb2wgPSAvXlwvXC8vLAogICAgLyogUHJlZmlsdGVycwogICAgICogMSkgVGhleSBhcmUgdXNlZnVsIHRvIGludHJvZHVjZSBjdXN0b20gZGF0YVR5cGVzIChzZWUgYWpheC9qc29ucC5qcyBmb3IgYW4gZXhhbXBsZSkKICAgICAqIDIpIFRoZXNlIGFyZSBjYWxsZWQ6CiAgICAgKiAgICAtIEJFRk9SRSBhc2tpbmcgZm9yIGEgdHJhbnNwb3J0CiAgICAgKiAgICAtIEFGVEVSIHBhcmFtIHNlcmlhbGl6YXRpb24gKHMuZGF0YSBpcyBhIHN0cmluZyBpZiBzLnByb2Nlc3NEYXRhIGlzIHRydWUpCiAgICAgKiAzKSBrZXkgaXMgdGhlIGRhdGFUeXBlCiAgICAgKiA0KSB0aGUgY2F0Y2hhbGwgc3ltYm9sICIqIiBjYW4gYmUgdXNlZAogICAgICogNSkgZXhlY3V0aW9uIHdpbGwgc3RhcnQgd2l0aCB0cmFuc3BvcnQgZGF0YVR5cGUgYW5kIFRIRU4gY29udGludWUgZG93biB0byAiKiIgaWYgbmVlZGVkCiAgICAgKi8KICAgIHByZWZpbHRlcnMgPSB7fSwKICAgIC8qIFRyYW5zcG9ydHMgYmluZGluZ3MKICAgICAqIDEpIGtleSBpcyB0aGUgZGF0YVR5cGUKICAgICAqIDIpIHRoZSBjYXRjaGFsbCBzeW1ib2wgIioiIGNhbiBiZSB1c2VkCiAgICAgKiAzKSBzZWxlY3Rpb24gd2lsbCBzdGFydCB3aXRoIHRyYW5zcG9ydCBkYXRhVHlwZSBhbmQgVEhFTiBnbyB0byAiKiIgaWYgbmVlZGVkCiAgICAgKi8KICAgIHRyYW5zcG9ydHMgPSB7fSwKICAgIC8vIEF2b2lkIGNvbW1lbnQtcHJvbG9nIGNoYXIgc2VxdWVuY2UgKHRyYWMtMTAwOTgpOyBtdXN0IGFwcGVhc2UgbGludCBhbmQgZXZhZGUgY29tcHJlc3Npb24KICAgIGFsbFR5cGVzID0gIiovIi5jb25jYXQoIioiKSwKICAgIC8vIEFuY2hvciB0YWcgZm9yIHBhcnNpbmcgdGhlIGRvY3VtZW50IG9yaWdpbgogICAgb3JpZ2luQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogIG9yaWdpbkFuY2hvci5ocmVmID0gbG9jYXRpb24uaHJlZjsKCiAgLy8gQmFzZSAiY29uc3RydWN0b3IiIGZvciBqUXVlcnkuYWpheFByZWZpbHRlciBhbmQgalF1ZXJ5LmFqYXhUcmFuc3BvcnQKICBmdW5jdGlvbiBhZGRUb1ByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlKSB7CiAgICAvLyBkYXRhVHlwZUV4cHJlc3Npb24gaXMgb3B0aW9uYWwgYW5kIGRlZmF1bHRzIHRvICIqIgogICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhVHlwZUV4cHJlc3Npb24sIGZ1bmMpIHsKICAgICAgaWYgKHR5cGVvZiBkYXRhVHlwZUV4cHJlc3Npb24gIT09ICJzdHJpbmciKSB7CiAgICAgICAgZnVuYyA9IGRhdGFUeXBlRXhwcmVzc2lvbjsKICAgICAgICBkYXRhVHlwZUV4cHJlc3Npb24gPSAiKiI7CiAgICAgIH0KICAgICAgdmFyIGRhdGFUeXBlLAogICAgICAgIGkgPSAwLAogICAgICAgIGRhdGFUeXBlcyA9IGRhdGFUeXBlRXhwcmVzc2lvbi50b0xvd2VyQ2FzZSgpLm1hdGNoKHJub3RodG1sd2hpdGUpIHx8IFtdOwogICAgICBpZiAoaXNGdW5jdGlvbihmdW5jKSkgewogICAgICAgIC8vIEZvciBlYWNoIGRhdGFUeXBlIGluIHRoZSBkYXRhVHlwZUV4cHJlc3Npb24KICAgICAgICB3aGlsZSAoZGF0YVR5cGUgPSBkYXRhVHlwZXNbaSsrXSkgewogICAgICAgICAgLy8gUHJlcGVuZCBpZiByZXF1ZXN0ZWQKICAgICAgICAgIGlmIChkYXRhVHlwZVswXSA9PT0gIisiKSB7CiAgICAgICAgICAgIGRhdGFUeXBlID0gZGF0YVR5cGUuc2xpY2UoMSkgfHwgIioiOwogICAgICAgICAgICAoc3RydWN0dXJlW2RhdGFUeXBlXSA9IHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10pLnVuc2hpZnQoZnVuYyk7CgogICAgICAgICAgICAvLyBPdGhlcndpc2UgYXBwZW5kCiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAoc3RydWN0dXJlW2RhdGFUeXBlXSA9IHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10pLnB1c2goZnVuYyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9OwogIH0KCiAgLy8gQmFzZSBpbnNwZWN0aW9uIGZ1bmN0aW9uIGZvciBwcmVmaWx0ZXJzIGFuZCB0cmFuc3BvcnRzCiAgZnVuY3Rpb24gaW5zcGVjdFByZWZpbHRlcnNPclRyYW5zcG9ydHMoc3RydWN0dXJlLCBvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKSB7CiAgICB2YXIgaW5zcGVjdGVkID0ge30sCiAgICAgIHNlZWtpbmdUcmFuc3BvcnQgPSBzdHJ1Y3R1cmUgPT09IHRyYW5zcG9ydHM7CiAgICBmdW5jdGlvbiBpbnNwZWN0KGRhdGFUeXBlKSB7CiAgICAgIHZhciBzZWxlY3RlZDsKICAgICAgaW5zcGVjdGVkW2RhdGFUeXBlXSA9IHRydWU7CiAgICAgIGpRdWVyeS5lYWNoKHN0cnVjdHVyZVtkYXRhVHlwZV0gfHwgW10sIGZ1bmN0aW9uIChfLCBwcmVmaWx0ZXJPckZhY3RvcnkpIHsKICAgICAgICB2YXIgZGF0YVR5cGVPclRyYW5zcG9ydCA9IHByZWZpbHRlck9yRmFjdG9yeShvcHRpb25zLCBvcmlnaW5hbE9wdGlvbnMsIGpxWEhSKTsKICAgICAgICBpZiAodHlwZW9mIGRhdGFUeXBlT3JUcmFuc3BvcnQgPT09ICJzdHJpbmciICYmICFzZWVraW5nVHJhbnNwb3J0ICYmICFpbnNwZWN0ZWRbZGF0YVR5cGVPclRyYW5zcG9ydF0pIHsKICAgICAgICAgIG9wdGlvbnMuZGF0YVR5cGVzLnVuc2hpZnQoZGF0YVR5cGVPclRyYW5zcG9ydCk7CiAgICAgICAgICBpbnNwZWN0KGRhdGFUeXBlT3JUcmFuc3BvcnQpOwogICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoc2Vla2luZ1RyYW5zcG9ydCkgewogICAgICAgICAgcmV0dXJuICEoc2VsZWN0ZWQgPSBkYXRhVHlwZU9yVHJhbnNwb3J0KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gc2VsZWN0ZWQ7CiAgICB9CiAgICByZXR1cm4gaW5zcGVjdChvcHRpb25zLmRhdGFUeXBlc1swXSkgfHwgIWluc3BlY3RlZFsiKiJdICYmIGluc3BlY3QoIioiKTsKICB9CgogIC8vIEEgc3BlY2lhbCBleHRlbmQgZm9yIGFqYXggb3B0aW9ucwogIC8vIHRoYXQgdGFrZXMgImZsYXQiIG9wdGlvbnMgKG5vdCB0byBiZSBkZWVwIGV4dGVuZGVkKQogIC8vIEZpeGVzIHRyYWMtOTg4NwogIGZ1bmN0aW9uIGFqYXhFeHRlbmQodGFyZ2V0LCBzcmMpIHsKICAgIHZhciBrZXksCiAgICAgIGRlZXAsCiAgICAgIGZsYXRPcHRpb25zID0galF1ZXJ5LmFqYXhTZXR0aW5ncy5mbGF0T3B0aW9ucyB8fCB7fTsKICAgIGZvciAoa2V5IGluIHNyYykgewogICAgICBpZiAoc3JjW2tleV0gIT09IHVuZGVmaW5lZCkgewogICAgICAgIChmbGF0T3B0aW9uc1trZXldID8gdGFyZ2V0IDogZGVlcCB8fCAoZGVlcCA9IHt9KSlba2V5XSA9IHNyY1trZXldOwogICAgICB9CiAgICB9CiAgICBpZiAoZGVlcCkgewogICAgICBqUXVlcnkuZXh0ZW5kKHRydWUsIHRhcmdldCwgZGVlcCk7CiAgICB9CiAgICByZXR1cm4gdGFyZ2V0OwogIH0KCiAgLyogSGFuZGxlcyByZXNwb25zZXMgdG8gYW4gYWpheCByZXF1ZXN0OgogICAqIC0gZmluZHMgdGhlIHJpZ2h0IGRhdGFUeXBlIChtZWRpYXRlcyBiZXR3ZWVuIGNvbnRlbnQtdHlwZSBhbmQgZXhwZWN0ZWQgZGF0YVR5cGUpCiAgICogLSByZXR1cm5zIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICovCiAgZnVuY3Rpb24gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKSB7CiAgICB2YXIgY3QsCiAgICAgIHR5cGUsCiAgICAgIGZpbmFsRGF0YVR5cGUsCiAgICAgIGZpcnN0RGF0YVR5cGUsCiAgICAgIGNvbnRlbnRzID0gcy5jb250ZW50cywKICAgICAgZGF0YVR5cGVzID0gcy5kYXRhVHlwZXM7CgogICAgLy8gUmVtb3ZlIGF1dG8gZGF0YVR5cGUgYW5kIGdldCBjb250ZW50LXR5cGUgaW4gdGhlIHByb2Nlc3MKICAgIHdoaWxlIChkYXRhVHlwZXNbMF0gPT09ICIqIikgewogICAgICBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN0ID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjdCA9IHMubWltZVR5cGUgfHwganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoIkNvbnRlbnQtVHlwZSIpOwogICAgICB9CiAgICB9CgogICAgLy8gQ2hlY2sgaWYgd2UncmUgZGVhbGluZyB3aXRoIGEga25vd24gY29udGVudC10eXBlCiAgICBpZiAoY3QpIHsKICAgICAgZm9yICh0eXBlIGluIGNvbnRlbnRzKSB7CiAgICAgICAgaWYgKGNvbnRlbnRzW3R5cGVdICYmIGNvbnRlbnRzW3R5cGVdLnRlc3QoY3QpKSB7CiAgICAgICAgICBkYXRhVHlwZXMudW5zaGlmdCh0eXBlKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGEgcmVzcG9uc2UgZm9yIHRoZSBleHBlY3RlZCBkYXRhVHlwZQogICAgaWYgKGRhdGFUeXBlc1swXSBpbiByZXNwb25zZXMpIHsKICAgICAgZmluYWxEYXRhVHlwZSA9IGRhdGFUeXBlc1swXTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIFRyeSBjb252ZXJ0aWJsZSBkYXRhVHlwZXMKICAgICAgZm9yICh0eXBlIGluIHJlc3BvbnNlcykgewogICAgICAgIGlmICghZGF0YVR5cGVzWzBdIHx8IHMuY29udmVydGVyc1t0eXBlICsgIiAiICsgZGF0YVR5cGVzWzBdXSkgewogICAgICAgICAgZmluYWxEYXRhVHlwZSA9IHR5cGU7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgaWYgKCFmaXJzdERhdGFUeXBlKSB7CiAgICAgICAgICBmaXJzdERhdGFUeXBlID0gdHlwZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIE9yIGp1c3QgdXNlIGZpcnN0IG9uZQogICAgICBmaW5hbERhdGFUeXBlID0gZmluYWxEYXRhVHlwZSB8fCBmaXJzdERhdGFUeXBlOwogICAgfQoKICAgIC8vIElmIHdlIGZvdW5kIGEgZGF0YVR5cGUKICAgIC8vIFdlIGFkZCB0aGUgZGF0YVR5cGUgdG8gdGhlIGxpc3QgaWYgbmVlZGVkCiAgICAvLyBhbmQgcmV0dXJuIHRoZSBjb3JyZXNwb25kaW5nIHJlc3BvbnNlCiAgICBpZiAoZmluYWxEYXRhVHlwZSkgewogICAgICBpZiAoZmluYWxEYXRhVHlwZSAhPT0gZGF0YVR5cGVzWzBdKSB7CiAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQoZmluYWxEYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHJlc3BvbnNlc1tmaW5hbERhdGFUeXBlXTsKICAgIH0KICB9CgogIC8qIENoYWluIGNvbnZlcnNpb25zIGdpdmVuIHRoZSByZXF1ZXN0IGFuZCB0aGUgb3JpZ2luYWwgcmVzcG9uc2UKICAgKiBBbHNvIHNldHMgdGhlIHJlc3BvbnNlWFhYIGZpZWxkcyBvbiB0aGUganFYSFIgaW5zdGFuY2UKICAgKi8KICBmdW5jdGlvbiBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2VzcykgewogICAgdmFyIGNvbnYyLAogICAgICBjdXJyZW50LAogICAgICBjb252LAogICAgICB0bXAsCiAgICAgIHByZXYsCiAgICAgIGNvbnZlcnRlcnMgPSB7fSwKICAgICAgLy8gV29yayB3aXRoIGEgY29weSBvZiBkYXRhVHlwZXMgaW4gY2FzZSB3ZSBuZWVkIHRvIG1vZGlmeSBpdCBmb3IgY29udmVyc2lvbgogICAgICBkYXRhVHlwZXMgPSBzLmRhdGFUeXBlcy5zbGljZSgpOwoKICAgIC8vIENyZWF0ZSBjb252ZXJ0ZXJzIG1hcCB3aXRoIGxvd2VyY2FzZWQga2V5cwogICAgaWYgKGRhdGFUeXBlc1sxXSkgewogICAgICBmb3IgKGNvbnYgaW4gcy5jb252ZXJ0ZXJzKSB7CiAgICAgICAgY29udmVydGVyc1tjb252LnRvTG93ZXJDYXNlKCldID0gcy5jb252ZXJ0ZXJzW2NvbnZdOwogICAgICB9CiAgICB9CiAgICBjdXJyZW50ID0gZGF0YVR5cGVzLnNoaWZ0KCk7CgogICAgLy8gQ29udmVydCB0byBlYWNoIHNlcXVlbnRpYWwgZGF0YVR5cGUKICAgIHdoaWxlIChjdXJyZW50KSB7CiAgICAgIGlmIChzLnJlc3BvbnNlRmllbGRzW2N1cnJlbnRdKSB7CiAgICAgICAganFYSFJbcy5yZXNwb25zZUZpZWxkc1tjdXJyZW50XV0gPSByZXNwb25zZTsKICAgICAgfQoKICAgICAgLy8gQXBwbHkgdGhlIGRhdGFGaWx0ZXIgaWYgcHJvdmlkZWQKICAgICAgaWYgKCFwcmV2ICYmIGlzU3VjY2VzcyAmJiBzLmRhdGFGaWx0ZXIpIHsKICAgICAgICByZXNwb25zZSA9IHMuZGF0YUZpbHRlcihyZXNwb25zZSwgcy5kYXRhVHlwZSk7CiAgICAgIH0KICAgICAgcHJldiA9IGN1cnJlbnQ7CiAgICAgIGN1cnJlbnQgPSBkYXRhVHlwZXMuc2hpZnQoKTsKICAgICAgaWYgKGN1cnJlbnQpIHsKICAgICAgICAvLyBUaGVyZSdzIG9ubHkgd29yayB0byBkbyBpZiBjdXJyZW50IGRhdGFUeXBlIGlzIG5vbi1hdXRvCiAgICAgICAgaWYgKGN1cnJlbnQgPT09ICIqIikgewogICAgICAgICAgY3VycmVudCA9IHByZXY7CgogICAgICAgICAgLy8gQ29udmVydCByZXNwb25zZSBpZiBwcmV2IGRhdGFUeXBlIGlzIG5vbi1hdXRvIGFuZCBkaWZmZXJzIGZyb20gY3VycmVudAogICAgICAgIH0gZWxzZSBpZiAocHJldiAhPT0gIioiICYmIHByZXYgIT09IGN1cnJlbnQpIHsKICAgICAgICAgIC8vIFNlZWsgYSBkaXJlY3QgY29udmVydGVyCiAgICAgICAgICBjb252ID0gY29udmVydGVyc1twcmV2ICsgIiAiICsgY3VycmVudF0gfHwgY29udmVydGVyc1siKiAiICsgY3VycmVudF07CgogICAgICAgICAgLy8gSWYgbm9uZSBmb3VuZCwgc2VlayBhIHBhaXIKICAgICAgICAgIGlmICghY29udikgewogICAgICAgICAgICBmb3IgKGNvbnYyIGluIGNvbnZlcnRlcnMpIHsKICAgICAgICAgICAgICAvLyBJZiBjb252MiBvdXRwdXRzIGN1cnJlbnQKICAgICAgICAgICAgICB0bXAgPSBjb252Mi5zcGxpdCgiICIpOwogICAgICAgICAgICAgIGlmICh0bXBbMV0gPT09IGN1cnJlbnQpIHsKICAgICAgICAgICAgICAgIC8vIElmIHByZXYgY2FuIGJlIGNvbnZlcnRlZCB0byBhY2NlcHRlZCBpbnB1dAogICAgICAgICAgICAgICAgY29udiA9IGNvbnZlcnRlcnNbcHJldiArICIgIiArIHRtcFswXV0gfHwgY29udmVydGVyc1siKiAiICsgdG1wWzBdXTsKICAgICAgICAgICAgICAgIGlmIChjb252KSB7CiAgICAgICAgICAgICAgICAgIC8vIENvbmRlbnNlIGVxdWl2YWxlbmNlIGNvbnZlcnRlcnMKICAgICAgICAgICAgICAgICAgaWYgKGNvbnYgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICBjb252ID0gY29udmVydGVyc1tjb252Ml07CgogICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaW5zZXJ0IHRoZSBpbnRlcm1lZGlhdGUgZGF0YVR5cGUKICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjb252ZXJ0ZXJzW2NvbnYyXSAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSB0bXBbMF07CiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGVzLnVuc2hpZnQodG1wWzFdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBBcHBseSBjb252ZXJ0ZXIgKGlmIG5vdCBhbiBlcXVpdmFsZW5jZSkKICAgICAgICAgIGlmIChjb252ICE9PSB0cnVlKSB7CiAgICAgICAgICAgIC8vIFVubGVzcyBlcnJvcnMgYXJlIGFsbG93ZWQgdG8gYnViYmxlLCBjYXRjaCBhbmQgcmV0dXJuIHRoZW0KICAgICAgICAgICAgaWYgKGNvbnYgJiYgcy50aHJvd3MpIHsKICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYocmVzcG9uc2UpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICByZXNwb25zZSA9IGNvbnYocmVzcG9uc2UpOwogICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgIHN0YXRlOiAicGFyc2VyZXJyb3IiLAogICAgICAgICAgICAgICAgICBlcnJvcjogY29udiA/IGUgOiAiTm8gY29udmVyc2lvbiBmcm9tICIgKyBwcmV2ICsgIiB0byAiICsgY3VycmVudAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgIHN0YXRlOiAic3VjY2VzcyIsCiAgICAgIGRhdGE6IHJlc3BvbnNlCiAgICB9OwogIH0KICBqUXVlcnkuZXh0ZW5kKHsKICAgIC8vIENvdW50ZXIgZm9yIGhvbGRpbmcgdGhlIG51bWJlciBvZiBhY3RpdmUgcXVlcmllcwogICAgYWN0aXZlOiAwLAogICAgLy8gTGFzdC1Nb2RpZmllZCBoZWFkZXIgY2FjaGUgZm9yIG5leHQgcmVxdWVzdAogICAgbGFzdE1vZGlmaWVkOiB7fSwKICAgIGV0YWc6IHt9LAogICAgYWpheFNldHRpbmdzOiB7CiAgICAgIHVybDogbG9jYXRpb24uaHJlZiwKICAgICAgdHlwZTogIkdFVCIsCiAgICAgIGlzTG9jYWw6IHJsb2NhbFByb3RvY29sLnRlc3QobG9jYXRpb24ucHJvdG9jb2wpLAogICAgICBnbG9iYWw6IHRydWUsCiAgICAgIHByb2Nlc3NEYXRhOiB0cnVlLAogICAgICBhc3luYzogdHJ1ZSwKICAgICAgY29udGVudFR5cGU6ICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQ7IGNoYXJzZXQ9VVRGLTgiLAogICAgICAvKgogICAgICB0aW1lb3V0OiAwLAogICAgICBkYXRhOiBudWxsLAogICAgICBkYXRhVHlwZTogbnVsbCwKICAgICAgdXNlcm5hbWU6IG51bGwsCiAgICAgIHBhc3N3b3JkOiBudWxsLAogICAgICBjYWNoZTogbnVsbCwKICAgICAgdGhyb3dzOiBmYWxzZSwKICAgICAgdHJhZGl0aW9uYWw6IGZhbHNlLAogICAgICBoZWFkZXJzOiB7fSwKICAgICAgKi8KCiAgICAgIGFjY2VwdHM6IHsKICAgICAgICAiKiI6IGFsbFR5cGVzLAogICAgICAgIHRleHQ6ICJ0ZXh0L3BsYWluIiwKICAgICAgICBodG1sOiAidGV4dC9odG1sIiwKICAgICAgICB4bWw6ICJhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sIiwKICAgICAgICBqc29uOiAiYXBwbGljYXRpb24vanNvbiwgdGV4dC9qYXZhc2NyaXB0IgogICAgICB9LAogICAgICBjb250ZW50czogewogICAgICAgIHhtbDogL1xieG1sXGIvLAogICAgICAgIGh0bWw6IC9cYmh0bWwvLAogICAgICAgIGpzb246IC9cYmpzb25cYi8KICAgICAgfSwKICAgICAgcmVzcG9uc2VGaWVsZHM6IHsKICAgICAgICB4bWw6ICJyZXNwb25zZVhNTCIsCiAgICAgICAgdGV4dDogInJlc3BvbnNlVGV4dCIsCiAgICAgICAganNvbjogInJlc3BvbnNlSlNPTiIKICAgICAgfSwKICAgICAgLy8gRGF0YSBjb252ZXJ0ZXJzCiAgICAgIC8vIEtleXMgc2VwYXJhdGUgc291cmNlIChvciBjYXRjaGFsbCAiKiIpIGFuZCBkZXN0aW5hdGlvbiB0eXBlcyB3aXRoIGEgc2luZ2xlIHNwYWNlCiAgICAgIGNvbnZlcnRlcnM6IHsKICAgICAgICAvLyBDb252ZXJ0IGFueXRoaW5nIHRvIHRleHQKICAgICAgICAiKiB0ZXh0IjogU3RyaW5nLAogICAgICAgIC8vIFRleHQgdG8gaHRtbCAodHJ1ZSA9IG5vIHRyYW5zZm9ybWF0aW9uKQogICAgICAgICJ0ZXh0IGh0bWwiOiB0cnVlLAogICAgICAgIC8vIEV2YWx1YXRlIHRleHQgYXMgYSBqc29uIGV4cHJlc3Npb24KICAgICAgICAidGV4dCBqc29uIjogSlNPTi5wYXJzZSwKICAgICAgICAvLyBQYXJzZSB0ZXh0IGFzIHhtbAogICAgICAgICJ0ZXh0IHhtbCI6IGpRdWVyeS5wYXJzZVhNTAogICAgICB9LAogICAgICAvLyBGb3Igb3B0aW9ucyB0aGF0IHNob3VsZG4ndCBiZSBkZWVwIGV4dGVuZGVkOgogICAgICAvLyB5b3UgY2FuIGFkZCB5b3VyIG93biBjdXN0b20gb3B0aW9ucyBoZXJlIGlmCiAgICAgIC8vIGFuZCB3aGVuIHlvdSBjcmVhdGUgb25lIHRoYXQgc2hvdWxkbid0IGJlCiAgICAgIC8vIGRlZXAgZXh0ZW5kZWQgKHNlZSBhamF4RXh0ZW5kKQogICAgICBmbGF0T3B0aW9uczogewogICAgICAgIHVybDogdHJ1ZSwKICAgICAgICBjb250ZXh0OiB0cnVlCiAgICAgIH0KICAgIH0sCiAgICAvLyBDcmVhdGVzIGEgZnVsbCBmbGVkZ2VkIHNldHRpbmdzIG9iamVjdCBpbnRvIHRhcmdldAogICAgLy8gd2l0aCBib3RoIGFqYXhTZXR0aW5ncyBhbmQgc2V0dGluZ3MgZmllbGRzLgogICAgLy8gSWYgdGFyZ2V0IGlzIG9taXR0ZWQsIHdyaXRlcyBpbnRvIGFqYXhTZXR0aW5ncy4KICAgIGFqYXhTZXR1cDogZnVuY3Rpb24gKHRhcmdldCwgc2V0dGluZ3MpIHsKICAgICAgcmV0dXJuIHNldHRpbmdzID8KICAgICAgLy8gQnVpbGRpbmcgYSBzZXR0aW5ncyBvYmplY3QKICAgICAgYWpheEV4dGVuZChhamF4RXh0ZW5kKHRhcmdldCwgalF1ZXJ5LmFqYXhTZXR0aW5ncyksIHNldHRpbmdzKSA6CiAgICAgIC8vIEV4dGVuZGluZyBhamF4U2V0dGluZ3MKICAgICAgYWpheEV4dGVuZChqUXVlcnkuYWpheFNldHRpbmdzLCB0YXJnZXQpOwogICAgfSwKICAgIGFqYXhQcmVmaWx0ZXI6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyhwcmVmaWx0ZXJzKSwKICAgIGFqYXhUcmFuc3BvcnQ6IGFkZFRvUHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzKSwKICAgIC8vIE1haW4gbWV0aG9kCiAgICBhamF4OiBmdW5jdGlvbiAodXJsLCBvcHRpb25zKSB7CiAgICAgIC8vIElmIHVybCBpcyBhbiBvYmplY3QsIHNpbXVsYXRlIHByZS0xLjUgc2lnbmF0dXJlCiAgICAgIGlmICh0eXBlb2YgdXJsID09PSAib2JqZWN0IikgewogICAgICAgIG9wdGlvbnMgPSB1cmw7CiAgICAgICAgdXJsID0gdW5kZWZpbmVkOwogICAgICB9CgogICAgICAvLyBGb3JjZSBvcHRpb25zIHRvIGJlIGFuIG9iamVjdAogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHRyYW5zcG9ydCwKICAgICAgICAvLyBVUkwgd2l0aG91dCBhbnRpLWNhY2hlIHBhcmFtCiAgICAgICAgY2FjaGVVUkwsCiAgICAgICAgLy8gUmVzcG9uc2UgaGVhZGVycwogICAgICAgIHJlc3BvbnNlSGVhZGVyc1N0cmluZywKICAgICAgICByZXNwb25zZUhlYWRlcnMsCiAgICAgICAgLy8gdGltZW91dCBoYW5kbGUKICAgICAgICB0aW1lb3V0VGltZXIsCiAgICAgICAgLy8gVXJsIGNsZWFudXAgdmFyCiAgICAgICAgdXJsQW5jaG9yLAogICAgICAgIC8vIFJlcXVlc3Qgc3RhdGUgKGJlY29tZXMgZmFsc2UgdXBvbiBzZW5kIGFuZCB0cnVlIHVwb24gY29tcGxldGlvbikKICAgICAgICBjb21wbGV0ZWQsCiAgICAgICAgLy8gVG8ga25vdyBpZiBnbG9iYWwgZXZlbnRzIGFyZSB0byBiZSBkaXNwYXRjaGVkCiAgICAgICAgZmlyZUdsb2JhbHMsCiAgICAgICAgLy8gTG9vcCB2YXJpYWJsZQogICAgICAgIGksCiAgICAgICAgLy8gdW5jYWNoZWQgcGFydCBvZiB0aGUgdXJsCiAgICAgICAgdW5jYWNoZWQsCiAgICAgICAgLy8gQ3JlYXRlIHRoZSBmaW5hbCBvcHRpb25zIG9iamVjdAogICAgICAgIHMgPSBqUXVlcnkuYWpheFNldHVwKHt9LCBvcHRpb25zKSwKICAgICAgICAvLyBDYWxsYmFja3MgY29udGV4dAogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IHMuY29udGV4dCB8fCBzLAogICAgICAgIC8vIENvbnRleHQgZm9yIGdsb2JhbCBldmVudHMgaXMgY2FsbGJhY2tDb250ZXh0IGlmIGl0IGlzIGEgRE9NIG5vZGUgb3IgalF1ZXJ5IGNvbGxlY3Rpb24KICAgICAgICBnbG9iYWxFdmVudENvbnRleHQgPSBzLmNvbnRleHQgJiYgKGNhbGxiYWNrQ29udGV4dC5ub2RlVHlwZSB8fCBjYWxsYmFja0NvbnRleHQuanF1ZXJ5KSA/IGpRdWVyeShjYWxsYmFja0NvbnRleHQpIDogalF1ZXJ5LmV2ZW50LAogICAgICAgIC8vIERlZmVycmVkcwogICAgICAgIGRlZmVycmVkID0galF1ZXJ5LkRlZmVycmVkKCksCiAgICAgICAgY29tcGxldGVEZWZlcnJlZCA9IGpRdWVyeS5DYWxsYmFja3MoIm9uY2UgbWVtb3J5IiksCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBzdGF0dXNDb2RlID0gcy5zdGF0dXNDb2RlIHx8IHt9LAogICAgICAgIC8vIEhlYWRlcnMgKHRoZXkgYXJlIHNlbnQgYWxsIGF0IG9uY2UpCiAgICAgICAgcmVxdWVzdEhlYWRlcnMgPSB7fSwKICAgICAgICByZXF1ZXN0SGVhZGVyc05hbWVzID0ge30sCiAgICAgICAgLy8gRGVmYXVsdCBhYm9ydCBtZXNzYWdlCiAgICAgICAgc3RyQWJvcnQgPSAiY2FuY2VsZWQiLAogICAgICAgIC8vIEZha2UgeGhyCiAgICAgICAganFYSFIgPSB7CiAgICAgICAgICByZWFkeVN0YXRlOiAwLAogICAgICAgICAgLy8gQnVpbGRzIGhlYWRlcnMgaGFzaHRhYmxlIGlmIG5lZWRlZAogICAgICAgICAgZ2V0UmVzcG9uc2VIZWFkZXI6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICAgICAgdmFyIG1hdGNoOwogICAgICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICAgICAgaWYgKCFyZXNwb25zZUhlYWRlcnMpIHsKICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVycyA9IHt9OwogICAgICAgICAgICAgICAgd2hpbGUgKG1hdGNoID0gcmhlYWRlcnMuZXhlYyhyZXNwb25zZUhlYWRlcnNTdHJpbmcpKSB7CiAgICAgICAgICAgICAgICAgIHJlc3BvbnNlSGVhZGVyc1ttYXRjaFsxXS50b0xvd2VyQ2FzZSgpICsgIiAiXSA9IChyZXNwb25zZUhlYWRlcnNbbWF0Y2hbMV0udG9Mb3dlckNhc2UoKSArICIgIl0gfHwgW10pLmNvbmNhdChtYXRjaFsyXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIG1hdGNoID0gcmVzcG9uc2VIZWFkZXJzW2tleS50b0xvd2VyQ2FzZSgpICsgIiAiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbWF0Y2ggPT0gbnVsbCA/IG51bGwgOiBtYXRjaC5qb2luKCIsICIpOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIFJhdyBzdHJpbmcKICAgICAgICAgIGdldEFsbFJlc3BvbnNlSGVhZGVyczogZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gY29tcGxldGVkID8gcmVzcG9uc2VIZWFkZXJzU3RyaW5nIDogbnVsbDsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYWNoZXMgdGhlIGhlYWRlcgogICAgICAgICAgc2V0UmVxdWVzdEhlYWRlcjogZnVuY3Rpb24gKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIGlmIChjb21wbGV0ZWQgPT0gbnVsbCkgewogICAgICAgICAgICAgIG5hbWUgPSByZXF1ZXN0SGVhZGVyc05hbWVzW25hbWUudG9Mb3dlckNhc2UoKV0gPSByZXF1ZXN0SGVhZGVyc05hbWVzW25hbWUudG9Mb3dlckNhc2UoKV0gfHwgbmFtZTsKICAgICAgICAgICAgICByZXF1ZXN0SGVhZGVyc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgICAgfSwKICAgICAgICAgIC8vIE92ZXJyaWRlcyByZXNwb25zZSBjb250ZW50LXR5cGUgaGVhZGVyCiAgICAgICAgICBvdmVycmlkZU1pbWVUeXBlOiBmdW5jdGlvbiAodHlwZSkgewogICAgICAgICAgICBpZiAoY29tcGxldGVkID09IG51bGwpIHsKICAgICAgICAgICAgICBzLm1pbWVUeXBlID0gdHlwZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBTdGF0dXMtZGVwZW5kZW50IGNhbGxiYWNrcwogICAgICAgICAgc3RhdHVzQ29kZTogZnVuY3Rpb24gKG1hcCkgewogICAgICAgICAgICB2YXIgY29kZTsKICAgICAgICAgICAgaWYgKG1hcCkgewogICAgICAgICAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICAgICAgICAgIC8vIEV4ZWN1dGUgdGhlIGFwcHJvcHJpYXRlIGNhbGxiYWNrcwogICAgICAgICAgICAgICAganFYSFIuYWx3YXlzKG1hcFtqcVhIUi5zdGF0dXNdKTsKICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTGF6eS1hZGQgdGhlIG5ldyBjYWxsYmFja3MgaW4gYSB3YXkgdGhhdCBwcmVzZXJ2ZXMgb2xkIG9uZXMKICAgICAgICAgICAgICAgIGZvciAoY29kZSBpbiBtYXApIHsKICAgICAgICAgICAgICAgICAgc3RhdHVzQ29kZVtjb2RlXSA9IFtzdGF0dXNDb2RlW2NvZGVdLCBtYXBbY29kZV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAgIH0sCiAgICAgICAgICAvLyBDYW5jZWwgdGhlIHJlcXVlc3QKICAgICAgICAgIGFib3J0OiBmdW5jdGlvbiAoc3RhdHVzVGV4dCkgewogICAgICAgICAgICB2YXIgZmluYWxUZXh0ID0gc3RhdHVzVGV4dCB8fCBzdHJBYm9ydDsKICAgICAgICAgICAgaWYgKHRyYW5zcG9ydCkgewogICAgICAgICAgICAgIHRyYW5zcG9ydC5hYm9ydChmaW5hbFRleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGRvbmUoMCwgZmluYWxUZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgICB9CiAgICAgICAgfTsKCiAgICAgIC8vIEF0dGFjaCBkZWZlcnJlZHMKICAgICAgZGVmZXJyZWQucHJvbWlzZShqcVhIUik7CgogICAgICAvLyBBZGQgcHJvdG9jb2wgaWYgbm90IHByb3ZpZGVkIChwcmVmaWx0ZXJzIG1pZ2h0IGV4cGVjdCBpdCkKICAgICAgLy8gSGFuZGxlIGZhbHN5IHVybCBpbiB0aGUgc2V0dGluZ3Mgb2JqZWN0ICh0cmFjLTEwMDkzOiBjb25zaXN0ZW5jeSB3aXRoIG9sZCBzaWduYXR1cmUpCiAgICAgIC8vIFdlIGFsc28gdXNlIHRoZSB1cmwgcGFyYW1ldGVyIGlmIGF2YWlsYWJsZQogICAgICBzLnVybCA9ICgodXJsIHx8IHMudXJsIHx8IGxvY2F0aW9uLmhyZWYpICsgIiIpLnJlcGxhY2UocnByb3RvY29sLCBsb2NhdGlvbi5wcm90b2NvbCArICIvLyIpOwoKICAgICAgLy8gQWxpYXMgbWV0aG9kIG9wdGlvbiB0byB0eXBlIGFzIHBlciB0aWNrZXQgdHJhYy0xMjAwNAogICAgICBzLnR5cGUgPSBvcHRpb25zLm1ldGhvZCB8fCBvcHRpb25zLnR5cGUgfHwgcy5tZXRob2QgfHwgcy50eXBlOwoKICAgICAgLy8gRXh0cmFjdCBkYXRhVHlwZXMgbGlzdAogICAgICBzLmRhdGFUeXBlcyA9IChzLmRhdGFUeXBlIHx8ICIqIikudG9Mb3dlckNhc2UoKS5tYXRjaChybm90aHRtbHdoaXRlKSB8fCBbIiJdOwoKICAgICAgLy8gQSBjcm9zcy1kb21haW4gcmVxdWVzdCBpcyBpbiBvcmRlciB3aGVuIHRoZSBvcmlnaW4gZG9lc24ndCBtYXRjaCB0aGUgY3VycmVudCBvcmlnaW4uCiAgICAgIGlmIChzLmNyb3NzRG9tYWluID09IG51bGwpIHsKICAgICAgICB1cmxBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CgogICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OCAtIDExLCBFZGdlIDEyIC0gMTUKICAgICAgICAvLyBJRSB0aHJvd3MgZXhjZXB0aW9uIG9uIGFjY2Vzc2luZyB0aGUgaHJlZiBwcm9wZXJ0eSBpZiB1cmwgaXMgbWFsZm9ybWVkLAogICAgICAgIC8vIGUuZy4gaHR0cDovL2V4YW1wbGUuY29tOjgweC8KICAgICAgICB0cnkgewogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSBzLnVybDsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTggLSAxMSBvbmx5CiAgICAgICAgICAvLyBBbmNob3IncyBob3N0IHByb3BlcnR5IGlzbid0IGNvcnJlY3RseSBzZXQgd2hlbiBzLnVybCBpcyByZWxhdGl2ZQogICAgICAgICAgdXJsQW5jaG9yLmhyZWYgPSB1cmxBbmNob3IuaHJlZjsKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSBvcmlnaW5BbmNob3IucHJvdG9jb2wgKyAiLy8iICsgb3JpZ2luQW5jaG9yLmhvc3QgIT09IHVybEFuY2hvci5wcm90b2NvbCArICIvLyIgKyB1cmxBbmNob3IuaG9zdDsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBJZiB0aGVyZSBpcyBhbiBlcnJvciBwYXJzaW5nIHRoZSBVUkwsIGFzc3VtZSBpdCBpcyBjcm9zc0RvbWFpbiwKICAgICAgICAgIC8vIGl0IGNhbiBiZSByZWplY3RlZCBieSB0aGUgdHJhbnNwb3J0IGlmIGl0IGlzIGludmFsaWQKICAgICAgICAgIHMuY3Jvc3NEb21haW4gPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gQ29udmVydCBkYXRhIGlmIG5vdCBhbHJlYWR5IGEgc3RyaW5nCiAgICAgIGlmIChzLmRhdGEgJiYgcy5wcm9jZXNzRGF0YSAmJiB0eXBlb2Ygcy5kYXRhICE9PSAic3RyaW5nIikgewogICAgICAgIHMuZGF0YSA9IGpRdWVyeS5wYXJhbShzLmRhdGEsIHMudHJhZGl0aW9uYWwpOwogICAgICB9CgogICAgICAvLyBBcHBseSBwcmVmaWx0ZXJzCiAgICAgIGluc3BlY3RQcmVmaWx0ZXJzT3JUcmFuc3BvcnRzKHByZWZpbHRlcnMsIHMsIG9wdGlvbnMsIGpxWEhSKTsKCiAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGEgcHJlZmlsdGVyLCBzdG9wIHRoZXJlCiAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICByZXR1cm4ganFYSFI7CiAgICAgIH0KCiAgICAgIC8vIFdlIGNhbiBmaXJlIGdsb2JhbCBldmVudHMgYXMgb2Ygbm93IGlmIGFza2VkIHRvCiAgICAgIC8vIERvbid0IGZpcmUgZXZlbnRzIGlmIGpRdWVyeS5ldmVudCBpcyB1bmRlZmluZWQgaW4gYW4gQU1ELXVzYWdlIHNjZW5hcmlvICh0cmFjLTE1MTE4KQogICAgICBmaXJlR2xvYmFscyA9IGpRdWVyeS5ldmVudCAmJiBzLmdsb2JhbDsKCiAgICAgIC8vIFdhdGNoIGZvciBhIG5ldyBzZXQgb2YgcmVxdWVzdHMKICAgICAgaWYgKGZpcmVHbG9iYWxzICYmIGpRdWVyeS5hY3RpdmUrKyA9PT0gMCkgewogICAgICAgIGpRdWVyeS5ldmVudC50cmlnZ2VyKCJhamF4U3RhcnQiKTsKICAgICAgfQoKICAgICAgLy8gVXBwZXJjYXNlIHRoZSB0eXBlCiAgICAgIHMudHlwZSA9IHMudHlwZS50b1VwcGVyQ2FzZSgpOwoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHJlcXVlc3QgaGFzIGNvbnRlbnQKICAgICAgcy5oYXNDb250ZW50ID0gIXJub0NvbnRlbnQudGVzdChzLnR5cGUpOwoKICAgICAgLy8gU2F2ZSB0aGUgVVJMIGluIGNhc2Ugd2UncmUgdG95aW5nIHdpdGggdGhlIElmLU1vZGlmaWVkLVNpbmNlCiAgICAgIC8vIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciBsYXRlciBvbgogICAgICAvLyBSZW1vdmUgaGFzaCB0byBzaW1wbGlmeSB1cmwgbWFuaXB1bGF0aW9uCiAgICAgIGNhY2hlVVJMID0gcy51cmwucmVwbGFjZShyaGFzaCwgIiIpOwoKICAgICAgLy8gTW9yZSBvcHRpb25zIGhhbmRsaW5nIGZvciByZXF1ZXN0cyB3aXRoIG5vIGNvbnRlbnQKICAgICAgaWYgKCFzLmhhc0NvbnRlbnQpIHsKICAgICAgICAvLyBSZW1lbWJlciB0aGUgaGFzaCBzbyB3ZSBjYW4gcHV0IGl0IGJhY2sKICAgICAgICB1bmNhY2hlZCA9IHMudXJsLnNsaWNlKGNhY2hlVVJMLmxlbmd0aCk7CgogICAgICAgIC8vIElmIGRhdGEgaXMgYXZhaWxhYmxlIGFuZCBzaG91bGQgYmUgcHJvY2Vzc2VkLCBhcHBlbmQgZGF0YSB0byB1cmwKICAgICAgICBpZiAocy5kYXRhICYmIChzLnByb2Nlc3NEYXRhIHx8IHR5cGVvZiBzLmRhdGEgPT09ICJzdHJpbmciKSkgewogICAgICAgICAgY2FjaGVVUkwgKz0gKHJxdWVyeS50ZXN0KGNhY2hlVVJMKSA/ICImIiA6ICI/IikgKyBzLmRhdGE7CgogICAgICAgICAgLy8gdHJhYy05NjgyOiByZW1vdmUgZGF0YSBzbyB0aGF0IGl0J3Mgbm90IHVzZWQgaW4gYW4gZXZlbnR1YWwgcmV0cnkKICAgICAgICAgIGRlbGV0ZSBzLmRhdGE7CiAgICAgICAgfQoKICAgICAgICAvLyBBZGQgb3IgdXBkYXRlIGFudGktY2FjaGUgcGFyYW0gaWYgbmVlZGVkCiAgICAgICAgaWYgKHMuY2FjaGUgPT09IGZhbHNlKSB7CiAgICAgICAgICBjYWNoZVVSTCA9IGNhY2hlVVJMLnJlcGxhY2UocmFudGlDYWNoZSwgIiQxIik7CiAgICAgICAgICB1bmNhY2hlZCA9IChycXVlcnkudGVzdChjYWNoZVVSTCkgPyAiJiIgOiAiPyIpICsgIl89IiArIG5vbmNlLmd1aWQrKyArIHVuY2FjaGVkOwogICAgICAgIH0KCiAgICAgICAgLy8gUHV0IGhhc2ggYW5kIGFudGktY2FjaGUgb24gdGhlIFVSTCB0aGF0IHdpbGwgYmUgcmVxdWVzdGVkIChnaC0xNzMyKQogICAgICAgIHMudXJsID0gY2FjaGVVUkwgKyB1bmNhY2hlZDsKCiAgICAgICAgLy8gQ2hhbmdlICclMjAnIHRvICcrJyBpZiB0aGlzIGlzIGVuY29kZWQgZm9ybSBib2R5IGNvbnRlbnQgKGdoLTI2NTgpCiAgICAgIH0gZWxzZSBpZiAocy5kYXRhICYmIHMucHJvY2Vzc0RhdGEgJiYgKHMuY29udGVudFR5cGUgfHwgIiIpLmluZGV4T2YoImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCIpID09PSAwKSB7CiAgICAgICAgcy5kYXRhID0gcy5kYXRhLnJlcGxhY2UocjIwLCAiKyIpOwogICAgICB9CgogICAgICAvLyBTZXQgdGhlIElmLU1vZGlmaWVkLVNpbmNlIGFuZC9vciBJZi1Ob25lLU1hdGNoIGhlYWRlciwgaWYgaW4gaWZNb2RpZmllZCBtb2RlLgogICAgICBpZiAocy5pZk1vZGlmaWVkKSB7CiAgICAgICAgaWYgKGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdKSB7CiAgICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKCJJZi1Nb2RpZmllZC1TaW5jZSIsIGpRdWVyeS5sYXN0TW9kaWZpZWRbY2FjaGVVUkxdKTsKICAgICAgICB9CiAgICAgICAgaWYgKGpRdWVyeS5ldGFnW2NhY2hlVVJMXSkgewogICAgICAgICAganFYSFIuc2V0UmVxdWVzdEhlYWRlcigiSWYtTm9uZS1NYXRjaCIsIGpRdWVyeS5ldGFnW2NhY2hlVVJMXSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBTZXQgdGhlIGNvcnJlY3QgaGVhZGVyLCBpZiBkYXRhIGlzIGJlaW5nIHNlbnQKICAgICAgaWYgKHMuZGF0YSAmJiBzLmhhc0NvbnRlbnQgJiYgcy5jb250ZW50VHlwZSAhPT0gZmFsc2UgfHwgb3B0aW9ucy5jb250ZW50VHlwZSkgewogICAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsIHMuY29udGVudFR5cGUpOwogICAgICB9CgogICAgICAvLyBTZXQgdGhlIEFjY2VwdHMgaGVhZGVyIGZvciB0aGUgc2VydmVyLCBkZXBlbmRpbmcgb24gdGhlIGRhdGFUeXBlCiAgICAgIGpxWEhSLnNldFJlcXVlc3RIZWFkZXIoIkFjY2VwdCIsIHMuZGF0YVR5cGVzWzBdICYmIHMuYWNjZXB0c1tzLmRhdGFUeXBlc1swXV0gPyBzLmFjY2VwdHNbcy5kYXRhVHlwZXNbMF1dICsgKHMuZGF0YVR5cGVzWzBdICE9PSAiKiIgPyAiLCAiICsgYWxsVHlwZXMgKyAiOyBxPTAuMDEiIDogIiIpIDogcy5hY2NlcHRzWyIqIl0pOwoKICAgICAgLy8gQ2hlY2sgZm9yIGhlYWRlcnMgb3B0aW9uCiAgICAgIGZvciAoaSBpbiBzLmhlYWRlcnMpIHsKICAgICAgICBqcVhIUi5zZXRSZXF1ZXN0SGVhZGVyKGksIHMuaGVhZGVyc1tpXSk7CiAgICAgIH0KCiAgICAgIC8vIEFsbG93IGN1c3RvbSBoZWFkZXJzL21pbWV0eXBlcyBhbmQgZWFybHkgYWJvcnQKICAgICAgaWYgKHMuYmVmb3JlU2VuZCAmJiAocy5iZWZvcmVTZW5kLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBqcVhIUiwgcykgPT09IGZhbHNlIHx8IGNvbXBsZXRlZCkpIHsKICAgICAgICAvLyBBYm9ydCBpZiBub3QgZG9uZSBhbHJlYWR5IGFuZCByZXR1cm4KICAgICAgICByZXR1cm4ganFYSFIuYWJvcnQoKTsKICAgICAgfQoKICAgICAgLy8gQWJvcnRpbmcgaXMgbm8gbG9uZ2VyIGEgY2FuY2VsbGF0aW9uCiAgICAgIHN0ckFib3J0ID0gImFib3J0IjsKCiAgICAgIC8vIEluc3RhbGwgY2FsbGJhY2tzIG9uIGRlZmVycmVkcwogICAgICBjb21wbGV0ZURlZmVycmVkLmFkZChzLmNvbXBsZXRlKTsKICAgICAganFYSFIuZG9uZShzLnN1Y2Nlc3MpOwogICAgICBqcVhIUi5mYWlsKHMuZXJyb3IpOwoKICAgICAgLy8gR2V0IHRyYW5zcG9ydAogICAgICB0cmFuc3BvcnQgPSBpbnNwZWN0UHJlZmlsdGVyc09yVHJhbnNwb3J0cyh0cmFuc3BvcnRzLCBzLCBvcHRpb25zLCBqcVhIUik7CgogICAgICAvLyBJZiBubyB0cmFuc3BvcnQsIHdlIGF1dG8tYWJvcnQKICAgICAgaWYgKCF0cmFuc3BvcnQpIHsKICAgICAgICBkb25lKC0xLCAiTm8gVHJhbnNwb3J0Iik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAganFYSFIucmVhZHlTdGF0ZSA9IDE7CgogICAgICAgIC8vIFNlbmQgZ2xvYmFsIGV2ZW50CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcigiYWpheFNlbmQiLCBbanFYSFIsIHNdKTsKICAgICAgICB9CgogICAgICAgIC8vIElmIHJlcXVlc3Qgd2FzIGFib3J0ZWQgaW5zaWRlIGFqYXhTZW5kLCBzdG9wIHRoZXJlCiAgICAgICAgaWYgKGNvbXBsZXRlZCkgewogICAgICAgICAgcmV0dXJuIGpxWEhSOwogICAgICAgIH0KCiAgICAgICAgLy8gVGltZW91dAogICAgICAgIGlmIChzLmFzeW5jICYmIHMudGltZW91dCA+IDApIHsKICAgICAgICAgIHRpbWVvdXRUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAganFYSFIuYWJvcnQoInRpbWVvdXQiKTsKICAgICAgICAgIH0sIHMudGltZW91dCk7CiAgICAgICAgfQogICAgICAgIHRyeSB7CiAgICAgICAgICBjb21wbGV0ZWQgPSBmYWxzZTsKICAgICAgICAgIHRyYW5zcG9ydC5zZW5kKHJlcXVlc3RIZWFkZXJzLCBkb25lKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAvLyBSZXRocm93IHBvc3QtY29tcGxldGlvbiBleGNlcHRpb25zCiAgICAgICAgICBpZiAoY29tcGxldGVkKSB7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gUHJvcGFnYXRlIG90aGVycyBhcyByZXN1bHRzCiAgICAgICAgICBkb25lKC0xLCBlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIENhbGxiYWNrIGZvciB3aGVuIGV2ZXJ5dGhpbmcgaXMgZG9uZQogICAgICBmdW5jdGlvbiBkb25lKHN0YXR1cywgbmF0aXZlU3RhdHVzVGV4dCwgcmVzcG9uc2VzLCBoZWFkZXJzKSB7CiAgICAgICAgdmFyIGlzU3VjY2VzcywKICAgICAgICAgIHN1Y2Nlc3MsCiAgICAgICAgICBlcnJvciwKICAgICAgICAgIHJlc3BvbnNlLAogICAgICAgICAgbW9kaWZpZWQsCiAgICAgICAgICBzdGF0dXNUZXh0ID0gbmF0aXZlU3RhdHVzVGV4dDsKCiAgICAgICAgLy8gSWdub3JlIHJlcGVhdCBpbnZvY2F0aW9ucwogICAgICAgIGlmIChjb21wbGV0ZWQpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29tcGxldGVkID0gdHJ1ZTsKCiAgICAgICAgLy8gQ2xlYXIgdGltZW91dCBpZiBpdCBleGlzdHMKICAgICAgICBpZiAodGltZW91dFRpbWVyKSB7CiAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRpbWVvdXRUaW1lcik7CiAgICAgICAgfQoKICAgICAgICAvLyBEZXJlZmVyZW5jZSB0cmFuc3BvcnQgZm9yIGVhcmx5IGdhcmJhZ2UgY29sbGVjdGlvbgogICAgICAgIC8vIChubyBtYXR0ZXIgaG93IGxvbmcgdGhlIGpxWEhSIG9iamVjdCB3aWxsIGJlIHVzZWQpCiAgICAgICAgdHJhbnNwb3J0ID0gdW5kZWZpbmVkOwoKICAgICAgICAvLyBDYWNoZSByZXNwb25zZSBoZWFkZXJzCiAgICAgICAgcmVzcG9uc2VIZWFkZXJzU3RyaW5nID0gaGVhZGVycyB8fCAiIjsKCiAgICAgICAgLy8gU2V0IHJlYWR5U3RhdGUKICAgICAgICBqcVhIUi5yZWFkeVN0YXRlID0gc3RhdHVzID4gMCA/IDQgOiAwOwoKICAgICAgICAvLyBEZXRlcm1pbmUgaWYgc3VjY2Vzc2Z1bAogICAgICAgIGlzU3VjY2VzcyA9IHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwIHx8IHN0YXR1cyA9PT0gMzA0OwoKICAgICAgICAvLyBHZXQgcmVzcG9uc2UgZGF0YQogICAgICAgIGlmIChyZXNwb25zZXMpIHsKICAgICAgICAgIHJlc3BvbnNlID0gYWpheEhhbmRsZVJlc3BvbnNlcyhzLCBqcVhIUiwgcmVzcG9uc2VzKTsKICAgICAgICB9CgogICAgICAgIC8vIFVzZSBhIG5vb3AgY29udmVydGVyIGZvciBtaXNzaW5nIHNjcmlwdCBidXQgbm90IGlmIGpzb25wCiAgICAgICAgaWYgKCFpc1N1Y2Nlc3MgJiYgalF1ZXJ5LmluQXJyYXkoInNjcmlwdCIsIHMuZGF0YVR5cGVzKSA+IC0xICYmIGpRdWVyeS5pbkFycmF5KCJqc29uIiwgcy5kYXRhVHlwZXMpIDwgMCkgewogICAgICAgICAgcy5jb252ZXJ0ZXJzWyJ0ZXh0IHNjcmlwdCJdID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgfQoKICAgICAgICAvLyBDb252ZXJ0IG5vIG1hdHRlciB3aGF0ICh0aGF0IHdheSByZXNwb25zZVhYWCBmaWVsZHMgYXJlIGFsd2F5cyBzZXQpCiAgICAgICAgcmVzcG9uc2UgPSBhamF4Q29udmVydChzLCByZXNwb25zZSwganFYSFIsIGlzU3VjY2Vzcyk7CgogICAgICAgIC8vIElmIHN1Y2Nlc3NmdWwsIGhhbmRsZSB0eXBlIGNoYWluaW5nCiAgICAgICAgaWYgKGlzU3VjY2VzcykgewogICAgICAgICAgLy8gU2V0IHRoZSBJZi1Nb2RpZmllZC1TaW5jZSBhbmQvb3IgSWYtTm9uZS1NYXRjaCBoZWFkZXIsIGlmIGluIGlmTW9kaWZpZWQgbW9kZS4KICAgICAgICAgIGlmIChzLmlmTW9kaWZpZWQpIHsKICAgICAgICAgICAgbW9kaWZpZWQgPSBqcVhIUi5nZXRSZXNwb25zZUhlYWRlcigiTGFzdC1Nb2RpZmllZCIpOwogICAgICAgICAgICBpZiAobW9kaWZpZWQpIHsKICAgICAgICAgICAgICBqUXVlcnkubGFzdE1vZGlmaWVkW2NhY2hlVVJMXSA9IG1vZGlmaWVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1vZGlmaWVkID0ganFYSFIuZ2V0UmVzcG9uc2VIZWFkZXIoImV0YWciKTsKICAgICAgICAgICAgaWYgKG1vZGlmaWVkKSB7CiAgICAgICAgICAgICAgalF1ZXJ5LmV0YWdbY2FjaGVVUkxdID0gbW9kaWZpZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBpZiBubyBjb250ZW50CiAgICAgICAgICBpZiAoc3RhdHVzID09PSAyMDQgfHwgcy50eXBlID09PSAiSEVBRCIpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJub2NvbnRlbnQiOwoKICAgICAgICAgICAgLy8gaWYgbm90IG1vZGlmaWVkCiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMzA0KSB7CiAgICAgICAgICAgIHN0YXR1c1RleHQgPSAibm90bW9kaWZpZWQiOwoKICAgICAgICAgICAgLy8gSWYgd2UgaGF2ZSBkYXRhLCBsZXQncyBjb252ZXJ0IGl0CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzdGF0dXNUZXh0ID0gcmVzcG9uc2Uuc3RhdGU7CiAgICAgICAgICAgIHN1Y2Nlc3MgPSByZXNwb25zZS5kYXRhOwogICAgICAgICAgICBlcnJvciA9IHJlc3BvbnNlLmVycm9yOwogICAgICAgICAgICBpc1N1Y2Nlc3MgPSAhZXJyb3I7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIEV4dHJhY3QgZXJyb3IgZnJvbSBzdGF0dXNUZXh0IGFuZCBub3JtYWxpemUgZm9yIG5vbi1hYm9ydHMKICAgICAgICAgIGVycm9yID0gc3RhdHVzVGV4dDsKICAgICAgICAgIGlmIChzdGF0dXMgfHwgIXN0YXR1c1RleHQpIHsKICAgICAgICAgICAgc3RhdHVzVGV4dCA9ICJlcnJvciI7CiAgICAgICAgICAgIGlmIChzdGF0dXMgPCAwKSB7CiAgICAgICAgICAgICAgc3RhdHVzID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gU2V0IGRhdGEgZm9yIHRoZSBmYWtlIHhociBvYmplY3QKICAgICAgICBqcVhIUi5zdGF0dXMgPSBzdGF0dXM7CiAgICAgICAganFYSFIuc3RhdHVzVGV4dCA9IChuYXRpdmVTdGF0dXNUZXh0IHx8IHN0YXR1c1RleHQpICsgIiI7CgogICAgICAgIC8vIFN1Y2Nlc3MvRXJyb3IKICAgICAgICBpZiAoaXNTdWNjZXNzKSB7CiAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlV2l0aChjYWxsYmFja0NvbnRleHQsIFtzdWNjZXNzLCBzdGF0dXNUZXh0LCBqcVhIUl0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBkZWZlcnJlZC5yZWplY3RXaXRoKGNhbGxiYWNrQ29udGV4dCwgW2pxWEhSLCBzdGF0dXNUZXh0LCBlcnJvcl0pOwogICAgICAgIH0KCiAgICAgICAgLy8gU3RhdHVzLWRlcGVuZGVudCBjYWxsYmFja3MKICAgICAgICBqcVhIUi5zdGF0dXNDb2RlKHN0YXR1c0NvZGUpOwogICAgICAgIHN0YXR1c0NvZGUgPSB1bmRlZmluZWQ7CiAgICAgICAgaWYgKGZpcmVHbG9iYWxzKSB7CiAgICAgICAgICBnbG9iYWxFdmVudENvbnRleHQudHJpZ2dlcihpc1N1Y2Nlc3MgPyAiYWpheFN1Y2Nlc3MiIDogImFqYXhFcnJvciIsIFtqcVhIUiwgcywgaXNTdWNjZXNzID8gc3VjY2VzcyA6IGVycm9yXSk7CiAgICAgICAgfQoKICAgICAgICAvLyBDb21wbGV0ZQogICAgICAgIGNvbXBsZXRlRGVmZXJyZWQuZmlyZVdpdGgoY2FsbGJhY2tDb250ZXh0LCBbanFYSFIsIHN0YXR1c1RleHRdKTsKICAgICAgICBpZiAoZmlyZUdsb2JhbHMpIHsKICAgICAgICAgIGdsb2JhbEV2ZW50Q29udGV4dC50cmlnZ2VyKCJhamF4Q29tcGxldGUiLCBbanFYSFIsIHNdKTsKCiAgICAgICAgICAvLyBIYW5kbGUgdGhlIGdsb2JhbCBBSkFYIGNvdW50ZXIKICAgICAgICAgIGlmICghIC0talF1ZXJ5LmFjdGl2ZSkgewogICAgICAgICAgICBqUXVlcnkuZXZlbnQudHJpZ2dlcigiYWpheFN0b3AiKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGpxWEhSOwogICAgfSwKICAgIGdldEpTT046IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrKSB7CiAgICAgIHJldHVybiBqUXVlcnkuZ2V0KHVybCwgZGF0YSwgY2FsbGJhY2ssICJqc29uIik7CiAgICB9LAogICAgZ2V0U2NyaXB0OiBmdW5jdGlvbiAodXJsLCBjYWxsYmFjaykgewogICAgICByZXR1cm4galF1ZXJ5LmdldCh1cmwsIHVuZGVmaW5lZCwgY2FsbGJhY2ssICJzY3JpcHQiKTsKICAgIH0KICB9KTsKICBqUXVlcnkuZWFjaChbImdldCIsICJwb3N0Il0sIGZ1bmN0aW9uIChfaSwgbWV0aG9kKSB7CiAgICBqUXVlcnlbbWV0aG9kXSA9IGZ1bmN0aW9uICh1cmwsIGRhdGEsIGNhbGxiYWNrLCB0eXBlKSB7CiAgICAgIC8vIFNoaWZ0IGFyZ3VtZW50cyBpZiBkYXRhIGFyZ3VtZW50IHdhcyBvbWl0dGVkCiAgICAgIGlmIChpc0Z1bmN0aW9uKGRhdGEpKSB7CiAgICAgICAgdHlwZSA9IHR5cGUgfHwgY2FsbGJhY2s7CiAgICAgICAgY2FsbGJhY2sgPSBkYXRhOwogICAgICAgIGRhdGEgPSB1bmRlZmluZWQ7CiAgICAgIH0KCiAgICAgIC8vIFRoZSB1cmwgY2FuIGJlIGFuIG9wdGlvbnMgb2JqZWN0ICh3aGljaCB0aGVuIG11c3QgaGF2ZSAudXJsKQogICAgICByZXR1cm4galF1ZXJ5LmFqYXgoalF1ZXJ5LmV4dGVuZCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgdHlwZTogbWV0aG9kLAogICAgICAgIGRhdGFUeXBlOiB0eXBlLAogICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgc3VjY2VzczogY2FsbGJhY2sKICAgICAgfSwgalF1ZXJ5LmlzUGxhaW5PYmplY3QodXJsKSAmJiB1cmwpKTsKICAgIH07CiAgfSk7CiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoZnVuY3Rpb24gKHMpIHsKICAgIHZhciBpOwogICAgZm9yIChpIGluIHMuaGVhZGVycykgewogICAgICBpZiAoaS50b0xvd2VyQ2FzZSgpID09PSAiY29udGVudC10eXBlIikgewogICAgICAgIHMuY29udGVudFR5cGUgPSBzLmhlYWRlcnNbaV0gfHwgIiI7CiAgICAgIH0KICAgIH0KICB9KTsKICBqUXVlcnkuX2V2YWxVcmwgPSBmdW5jdGlvbiAodXJsLCBvcHRpb25zLCBkb2MpIHsKICAgIHJldHVybiBqUXVlcnkuYWpheCh7CiAgICAgIHVybDogdXJsLAogICAgICAvLyBNYWtlIHRoaXMgZXhwbGljaXQsIHNpbmNlIHVzZXIgY2FuIG92ZXJyaWRlIHRoaXMgdGhyb3VnaCBhamF4U2V0dXAgKHRyYWMtMTEyNjQpCiAgICAgIHR5cGU6ICJHRVQiLAogICAgICBkYXRhVHlwZTogInNjcmlwdCIsCiAgICAgIGNhY2hlOiB0cnVlLAogICAgICBhc3luYzogZmFsc2UsCiAgICAgIGdsb2JhbDogZmFsc2UsCiAgICAgIC8vIE9ubHkgZXZhbHVhdGUgdGhlIHJlc3BvbnNlIGlmIGl0IGlzIHN1Y2Nlc3NmdWwgKGdoLTQxMjYpCiAgICAgIC8vIGRhdGFGaWx0ZXIgaXMgbm90IGludm9rZWQgZm9yIGZhaWx1cmUgcmVzcG9uc2VzLCBzbyB1c2luZyBpdCBpbnN0ZWFkCiAgICAgIC8vIG9mIHRoZSBkZWZhdWx0IGNvbnZlcnRlciBpcyBrbHVkZ3kgYnV0IGl0IHdvcmtzLgogICAgICBjb252ZXJ0ZXJzOiB7CiAgICAgICAgInRleHQgc2NyaXB0IjogZnVuY3Rpb24gKCkge30KICAgICAgfSwKICAgICAgZGF0YUZpbHRlcjogZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgalF1ZXJ5Lmdsb2JhbEV2YWwocmVzcG9uc2UsIG9wdGlvbnMsIGRvYyk7CiAgICAgIH0KICAgIH0pOwogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICB3cmFwQWxsOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgd3JhcDsKICAgICAgaWYgKHRoaXNbMF0pIHsKICAgICAgICBpZiAoaXNGdW5jdGlvbihodG1sKSkgewogICAgICAgICAgaHRtbCA9IGh0bWwuY2FsbCh0aGlzWzBdKTsKICAgICAgICB9CgogICAgICAgIC8vIFRoZSBlbGVtZW50cyB0byB3cmFwIHRoZSB0YXJnZXQgYXJvdW5kCiAgICAgICAgd3JhcCA9IGpRdWVyeShodG1sLCB0aGlzWzBdLm93bmVyRG9jdW1lbnQpLmVxKDApLmNsb25lKHRydWUpOwogICAgICAgIGlmICh0aGlzWzBdLnBhcmVudE5vZGUpIHsKICAgICAgICAgIHdyYXAuaW5zZXJ0QmVmb3JlKHRoaXNbMF0pOwogICAgICAgIH0KICAgICAgICB3cmFwLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB2YXIgZWxlbSA9IHRoaXM7CiAgICAgICAgICB3aGlsZSAoZWxlbS5maXJzdEVsZW1lbnRDaGlsZCkgewogICAgICAgICAgICBlbGVtID0gZWxlbS5maXJzdEVsZW1lbnRDaGlsZDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBlbGVtOwogICAgICAgIH0pLmFwcGVuZCh0aGlzKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICB3cmFwSW5uZXI6IGZ1bmN0aW9uIChodG1sKSB7CiAgICAgIGlmIChpc0Z1bmN0aW9uKGh0bWwpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBJbm5lcihodG1sLmNhbGwodGhpcywgaSkpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBzZWxmID0galF1ZXJ5KHRoaXMpLAogICAgICAgICAgY29udGVudHMgPSBzZWxmLmNvbnRlbnRzKCk7CiAgICAgICAgaWYgKGNvbnRlbnRzLmxlbmd0aCkgewogICAgICAgICAgY29udGVudHMud3JhcEFsbChodG1sKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgc2VsZi5hcHBlbmQoaHRtbCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbiAoaHRtbCkgewogICAgICB2YXIgaHRtbElzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uKGh0bWwpOwogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgalF1ZXJ5KHRoaXMpLndyYXBBbGwoaHRtbElzRnVuY3Rpb24gPyBodG1sLmNhbGwodGhpcywgaSkgOiBodG1sKTsKICAgICAgfSk7CiAgICB9LAogICAgdW53cmFwOiBmdW5jdGlvbiAoc2VsZWN0b3IpIHsKICAgICAgdGhpcy5wYXJlbnQoc2VsZWN0b3IpLm5vdCgiYm9keSIpLmVhY2goZnVuY3Rpb24gKCkgewogICAgICAgIGpRdWVyeSh0aGlzKS5yZXBsYWNlV2l0aCh0aGlzLmNoaWxkTm9kZXMpOwogICAgICB9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7CiAgalF1ZXJ5LmV4cHIucHNldWRvcy5oaWRkZW4gPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuICFqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUoZWxlbSk7CiAgfTsKICBqUXVlcnkuZXhwci5wc2V1ZG9zLnZpc2libGUgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuICEhKGVsZW0ub2Zmc2V0V2lkdGggfHwgZWxlbS5vZmZzZXRIZWlnaHQgfHwgZWxlbS5nZXRDbGllbnRSZWN0cygpLmxlbmd0aCk7CiAgfTsKICBqUXVlcnkuYWpheFNldHRpbmdzLnhociA9IGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCk7CiAgICB9IGNhdGNoIChlKSB7fQogIH07CiAgdmFyIHhoclN1Y2Nlc3NTdGF0dXMgPSB7CiAgICAgIC8vIEZpbGUgcHJvdG9jb2wgYWx3YXlzIHlpZWxkcyBzdGF0dXMgY29kZSAwLCBhc3N1bWUgMjAwCiAgICAgIDA6IDIwMCwKICAgICAgLy8gU3VwcG9ydDogSUUgPD05IG9ubHkKICAgICAgLy8gdHJhYy0xNDUwOiBzb21ldGltZXMgSUUgcmV0dXJucyAxMjIzIHdoZW4gaXQgc2hvdWxkIGJlIDIwNAogICAgICAxMjIzOiAyMDQKICAgIH0sCiAgICB4aHJTdXBwb3J0ZWQgPSBqUXVlcnkuYWpheFNldHRpbmdzLnhocigpOwogIHN1cHBvcnQuY29ycyA9ICEheGhyU3VwcG9ydGVkICYmICJ3aXRoQ3JlZGVudGlhbHMiIGluIHhoclN1cHBvcnRlZDsKICBzdXBwb3J0LmFqYXggPSB4aHJTdXBwb3J0ZWQgPSAhIXhoclN1cHBvcnRlZDsKICBqUXVlcnkuYWpheFRyYW5zcG9ydChmdW5jdGlvbiAob3B0aW9ucykgewogICAgdmFyIGNhbGxiYWNrLCBlcnJvckNhbGxiYWNrOwoKICAgIC8vIENyb3NzIGRvbWFpbiBvbmx5IGFsbG93ZWQgaWYgc3VwcG9ydGVkIHRocm91Z2ggWE1MSHR0cFJlcXVlc3QKICAgIGlmIChzdXBwb3J0LmNvcnMgfHwgeGhyU3VwcG9ydGVkICYmICFvcHRpb25zLmNyb3NzRG9tYWluKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKGhlYWRlcnMsIGNvbXBsZXRlKSB7CiAgICAgICAgICB2YXIgaSwKICAgICAgICAgICAgeGhyID0gb3B0aW9ucy54aHIoKTsKICAgICAgICAgIHhoci5vcGVuKG9wdGlvbnMudHlwZSwgb3B0aW9ucy51cmwsIG9wdGlvbnMuYXN5bmMsIG9wdGlvbnMudXNlcm5hbWUsIG9wdGlvbnMucGFzc3dvcmQpOwoKICAgICAgICAgIC8vIEFwcGx5IGN1c3RvbSBmaWVsZHMgaWYgcHJvdmlkZWQKICAgICAgICAgIGlmIChvcHRpb25zLnhockZpZWxkcykgewogICAgICAgICAgICBmb3IgKGkgaW4gb3B0aW9ucy54aHJGaWVsZHMpIHsKICAgICAgICAgICAgICB4aHJbaV0gPSBvcHRpb25zLnhockZpZWxkc1tpXTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIC8vIE92ZXJyaWRlIG1pbWUgdHlwZSBpZiBuZWVkZWQKICAgICAgICAgIGlmIChvcHRpb25zLm1pbWVUeXBlICYmIHhoci5vdmVycmlkZU1pbWVUeXBlKSB7CiAgICAgICAgICAgIHhoci5vdmVycmlkZU1pbWVUeXBlKG9wdGlvbnMubWltZVR5cGUpOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIFgtUmVxdWVzdGVkLVdpdGggaGVhZGVyCiAgICAgICAgICAvLyBGb3IgY3Jvc3MtZG9tYWluIHJlcXVlc3RzLCBzZWVpbmcgYXMgY29uZGl0aW9ucyBmb3IgYSBwcmVmbGlnaHQgYXJlCiAgICAgICAgICAvLyBha2luIHRvIGEgamlnc2F3IHB1enpsZSwgd2Ugc2ltcGx5IG5ldmVyIHNldCBpdCB0byBiZSBzdXJlLgogICAgICAgICAgLy8gKGl0IGNhbiBhbHdheXMgYmUgc2V0IG9uIGEgcGVyLXJlcXVlc3QgYmFzaXMgb3IgZXZlbiB1c2luZyBhamF4U2V0dXApCiAgICAgICAgICAvLyBGb3Igc2FtZS1kb21haW4gcmVxdWVzdHMsIHdvbid0IGNoYW5nZSBoZWFkZXIgaWYgYWxyZWFkeSBwcm92aWRlZC4KICAgICAgICAgIGlmICghb3B0aW9ucy5jcm9zc0RvbWFpbiAmJiAhaGVhZGVyc1siWC1SZXF1ZXN0ZWQtV2l0aCJdKSB7CiAgICAgICAgICAgIGhlYWRlcnNbIlgtUmVxdWVzdGVkLVdpdGgiXSA9ICJYTUxIdHRwUmVxdWVzdCI7CiAgICAgICAgICB9CgogICAgICAgICAgLy8gU2V0IGhlYWRlcnMKICAgICAgICAgIGZvciAoaSBpbiBoZWFkZXJzKSB7CiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKGksIGhlYWRlcnNbaV0pOwogICAgICAgICAgfQoKICAgICAgICAgIC8vIENhbGxiYWNrCiAgICAgICAgICBjYWxsYmFjayA9IGZ1bmN0aW9uICh0eXBlKSB7CiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayA9IGVycm9yQ2FsbGJhY2sgPSB4aHIub25sb2FkID0geGhyLm9uZXJyb3IgPSB4aHIub25hYm9ydCA9IHhoci5vbnRpbWVvdXQgPSB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gbnVsbDsKICAgICAgICAgICAgICAgIGlmICh0eXBlID09PSAiYWJvcnQiKSB7CiAgICAgICAgICAgICAgICAgIHhoci5hYm9ydCgpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiZXJyb3IiKSB7CiAgICAgICAgICAgICAgICAgIC8vIFN1cHBvcnQ6IElFIDw9OSBvbmx5CiAgICAgICAgICAgICAgICAgIC8vIE9uIGEgbWFudWFsIG5hdGl2ZSBhYm9ydCwgSUU5IHRocm93cwogICAgICAgICAgICAgICAgICAvLyBlcnJvcnMgb24gYW55IHByb3BlcnR5IGFjY2VzcyB0aGF0IGlzIG5vdCByZWFkeVN0YXRlCiAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeGhyLnN0YXR1cyAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZSgwLCAiZXJyb3IiKTsKICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb21wbGV0ZSgKICAgICAgICAgICAgICAgICAgICAvLyBGaWxlOiBwcm90b2NvbCBhbHdheXMgeWllbGRzIHN0YXR1cyAwOyBzZWUgdHJhYy04NjA1LCB0cmFjLTE0MjA3CiAgICAgICAgICAgICAgICAgICAgeGhyLnN0YXR1cywgeGhyLnN0YXR1c1RleHQpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICBjb21wbGV0ZSh4aHJTdWNjZXNzU3RhdHVzW3hoci5zdGF0dXNdIHx8IHhoci5zdGF0dXMsIHhoci5zdGF0dXNUZXh0LAogICAgICAgICAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA8PTkgb25seQogICAgICAgICAgICAgICAgICAvLyBJRTkgaGFzIG5vIFhIUjIgYnV0IHRocm93cyBvbiBiaW5hcnkgKHRyYWMtMTE0MjYpCiAgICAgICAgICAgICAgICAgIC8vIEZvciBYSFIyIG5vbi10ZXh0LCBsZXQgdGhlIGNhbGxlciBoYW5kbGUgaXQgKGdoLTI0OTgpCiAgICAgICAgICAgICAgICAgICh4aHIucmVzcG9uc2VUeXBlIHx8ICJ0ZXh0IikgIT09ICJ0ZXh0IiB8fCB0eXBlb2YgeGhyLnJlc3BvbnNlVGV4dCAhPT0gInN0cmluZyIgPyB7CiAgICAgICAgICAgICAgICAgICAgYmluYXJ5OiB4aHIucmVzcG9uc2UKICAgICAgICAgICAgICAgICAgfSA6IHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB4aHIucmVzcG9uc2VUZXh0CiAgICAgICAgICAgICAgICAgIH0sIHhoci5nZXRBbGxSZXNwb25zZUhlYWRlcnMoKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgfTsKCiAgICAgICAgICAvLyBMaXN0ZW4gdG8gZXZlbnRzCiAgICAgICAgICB4aHIub25sb2FkID0gY2FsbGJhY2soKTsKICAgICAgICAgIGVycm9yQ2FsbGJhY2sgPSB4aHIub25lcnJvciA9IHhoci5vbnRpbWVvdXQgPSBjYWxsYmFjaygiZXJyb3IiKTsKCiAgICAgICAgICAvLyBTdXBwb3J0OiBJRSA5IG9ubHkKICAgICAgICAgIC8vIFVzZSBvbnJlYWR5c3RhdGVjaGFuZ2UgdG8gcmVwbGFjZSBvbmFib3J0CiAgICAgICAgICAvLyB0byBoYW5kbGUgdW5jYXVnaHQgYWJvcnRzCiAgICAgICAgICBpZiAoeGhyLm9uYWJvcnQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICB4aHIub25hYm9ydCA9IGVycm9yQ2FsbGJhY2s7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIC8vIENoZWNrIHJlYWR5U3RhdGUgYmVmb3JlIHRpbWVvdXQgYXMgaXQgY2hhbmdlcwogICAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgICAgICAgICAgLy8gQWxsb3cgb25lcnJvciB0byBiZSBjYWxsZWQgZmlyc3QsCiAgICAgICAgICAgICAgICAvLyBidXQgdGhhdCB3aWxsIG5vdCBoYW5kbGUgYSBuYXRpdmUgYWJvcnQKICAgICAgICAgICAgICAgIC8vIEFsc28sIHNhdmUgZXJyb3JDYWxsYmFjayB0byBhIHZhcmlhYmxlCiAgICAgICAgICAgICAgICAvLyBhcyB4aHIub25lcnJvciBjYW5ub3QgYmUgYWNjZXNzZWQKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgZXJyb3JDYWxsYmFjaygpOwogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICB9CgogICAgICAgICAgLy8gQ3JlYXRlIHRoZSBhYm9ydCBjYWxsYmFjawogICAgICAgICAgY2FsbGJhY2sgPSBjYWxsYmFjaygiYWJvcnQiKTsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIC8vIERvIHNlbmQgdGhlIHJlcXVlc3QgKHRoaXMgbWF5IHJhaXNlIGFuIGV4Y2VwdGlvbikKICAgICAgICAgICAgeGhyLnNlbmQob3B0aW9ucy5oYXNDb250ZW50ICYmIG9wdGlvbnMuZGF0YSB8fCBudWxsKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgLy8gdHJhYy0xNDY4MzogT25seSByZXRocm93IGlmIHRoaXMgaGFzbid0IGJlZW4gbm90aWZpZWQgYXMgYW4gZXJyb3IgeWV0CiAgICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIGFib3J0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgY2FsbGJhY2soKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH07CiAgICB9CiAgfSk7CgogIC8vIFByZXZlbnQgYXV0by1leGVjdXRpb24gb2Ygc2NyaXB0cyB3aGVuIG5vIGV4cGxpY2l0IGRhdGFUeXBlIHdhcyBwcm92aWRlZCAoU2VlIGdoLTI0MzIpCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNyb3NzRG9tYWluKSB7CiAgICAgIHMuY29udGVudHMuc2NyaXB0ID0gZmFsc2U7CiAgICB9CiAgfSk7CgogIC8vIEluc3RhbGwgc2NyaXB0IGRhdGFUeXBlCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBhY2NlcHRzOiB7CiAgICAgIHNjcmlwdDogInRleHQvamF2YXNjcmlwdCwgYXBwbGljYXRpb24vamF2YXNjcmlwdCwgIiArICJhcHBsaWNhdGlvbi9lY21hc2NyaXB0LCBhcHBsaWNhdGlvbi94LWVjbWFzY3JpcHQiCiAgICB9LAogICAgY29udGVudHM6IHsKICAgICAgc2NyaXB0OiAvXGIoPzpqYXZhfGVjbWEpc2NyaXB0XGIvCiAgICB9LAogICAgY29udmVydGVyczogewogICAgICAidGV4dCBzY3JpcHQiOiBmdW5jdGlvbiAodGV4dCkgewogICAgICAgIGpRdWVyeS5nbG9iYWxFdmFsKHRleHQpOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgICB9CiAgICB9CiAgfSk7CgogIC8vIEhhbmRsZSBjYWNoZSdzIHNwZWNpYWwgY2FzZSBhbmQgY3Jvc3NEb21haW4KICBqUXVlcnkuYWpheFByZWZpbHRlcigic2NyaXB0IiwgZnVuY3Rpb24gKHMpIHsKICAgIGlmIChzLmNhY2hlID09PSB1bmRlZmluZWQpIHsKICAgICAgcy5jYWNoZSA9IGZhbHNlOwogICAgfQogICAgaWYgKHMuY3Jvc3NEb21haW4pIHsKICAgICAgcy50eXBlID0gIkdFVCI7CiAgICB9CiAgfSk7CgogIC8vIEJpbmQgc2NyaXB0IHRhZyBoYWNrIHRyYW5zcG9ydAogIGpRdWVyeS5hamF4VHJhbnNwb3J0KCJzY3JpcHQiLCBmdW5jdGlvbiAocykgewogICAgLy8gVGhpcyB0cmFuc3BvcnQgb25seSBkZWFscyB3aXRoIGNyb3NzIGRvbWFpbiBvciBmb3JjZWQtYnktYXR0cnMgcmVxdWVzdHMKICAgIGlmIChzLmNyb3NzRG9tYWluIHx8IHMuc2NyaXB0QXR0cnMpIHsKICAgICAgdmFyIHNjcmlwdCwgY2FsbGJhY2s7CiAgICAgIHJldHVybiB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24gKF8sIGNvbXBsZXRlKSB7CiAgICAgICAgICBzY3JpcHQgPSBqUXVlcnkoIjxzY3JpcHQ+IikuYXR0cihzLnNjcmlwdEF0dHJzIHx8IHt9KS5wcm9wKHsKICAgICAgICAgICAgY2hhcnNldDogcy5zY3JpcHRDaGFyc2V0LAogICAgICAgICAgICBzcmM6IHMudXJsCiAgICAgICAgICB9KS5vbigibG9hZCBlcnJvciIsIGNhbGxiYWNrID0gZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICBzY3JpcHQucmVtb3ZlKCk7CiAgICAgICAgICAgIGNhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgaWYgKGV2dCkgewogICAgICAgICAgICAgIGNvbXBsZXRlKGV2dC50eXBlID09PSAiZXJyb3IiID8gNDA0IDogMjAwLCBldnQudHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIFVzZSBuYXRpdmUgRE9NIG1hbmlwdWxhdGlvbiB0byBhdm9pZCBvdXIgZG9tTWFuaXAgQUpBWCB0cmlja2VyeQogICAgICAgICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHRbMF0pOwogICAgICAgIH0sCiAgICAgICAgYWJvcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChjYWxsYmFjaykgewogICAgICAgICAgICBjYWxsYmFjaygpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKICAgIH0KICB9KTsKICB2YXIgb2xkQ2FsbGJhY2tzID0gW10sCiAgICByanNvbnAgPSAvKD0pXD8oPz0mfCQpfFw/XD8vOwoKICAvLyBEZWZhdWx0IGpzb25wIHNldHRpbmdzCiAgalF1ZXJ5LmFqYXhTZXR1cCh7CiAgICBqc29ucDogImNhbGxiYWNrIiwKICAgIGpzb25wQ2FsbGJhY2s6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGNhbGxiYWNrID0gb2xkQ2FsbGJhY2tzLnBvcCgpIHx8IGpRdWVyeS5leHBhbmRvICsgIl8iICsgbm9uY2UuZ3VpZCsrOwogICAgICB0aGlzW2NhbGxiYWNrXSA9IHRydWU7CiAgICAgIHJldHVybiBjYWxsYmFjazsKICAgIH0KICB9KTsKCiAgLy8gRGV0ZWN0LCBub3JtYWxpemUgb3B0aW9ucyBhbmQgaW5zdGFsbCBjYWxsYmFja3MgZm9yIGpzb25wIHJlcXVlc3RzCiAgalF1ZXJ5LmFqYXhQcmVmaWx0ZXIoImpzb24ganNvbnAiLCBmdW5jdGlvbiAocywgb3JpZ2luYWxTZXR0aW5ncywganFYSFIpIHsKICAgIHZhciBjYWxsYmFja05hbWUsCiAgICAgIG92ZXJ3cml0dGVuLAogICAgICByZXNwb25zZUNvbnRhaW5lciwKICAgICAganNvblByb3AgPSBzLmpzb25wICE9PSBmYWxzZSAmJiAocmpzb25wLnRlc3Qocy51cmwpID8gInVybCIgOiB0eXBlb2Ygcy5kYXRhID09PSAic3RyaW5nIiAmJiAocy5jb250ZW50VHlwZSB8fCAiIikuaW5kZXhPZigiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIikgPT09IDAgJiYgcmpzb25wLnRlc3Qocy5kYXRhKSAmJiAiZGF0YSIpOwoKICAgIC8vIEhhbmRsZSBpZmYgdGhlIGV4cGVjdGVkIGRhdGEgdHlwZSBpcyAianNvbnAiIG9yIHdlIGhhdmUgYSBwYXJhbWV0ZXIgdG8gc2V0CiAgICBpZiAoanNvblByb3AgfHwgcy5kYXRhVHlwZXNbMF0gPT09ICJqc29ucCIpIHsKICAgICAgLy8gR2V0IGNhbGxiYWNrIG5hbWUsIHJlbWVtYmVyaW5nIHByZWV4aXN0aW5nIHZhbHVlIGFzc29jaWF0ZWQgd2l0aCBpdAogICAgICBjYWxsYmFja05hbWUgPSBzLmpzb25wQ2FsbGJhY2sgPSBpc0Z1bmN0aW9uKHMuanNvbnBDYWxsYmFjaykgPyBzLmpzb25wQ2FsbGJhY2soKSA6IHMuanNvbnBDYWxsYmFjazsKCiAgICAgIC8vIEluc2VydCBjYWxsYmFjayBpbnRvIHVybCBvciBmb3JtIGRhdGEKICAgICAgaWYgKGpzb25Qcm9wKSB7CiAgICAgICAgc1tqc29uUHJvcF0gPSBzW2pzb25Qcm9wXS5yZXBsYWNlKHJqc29ucCwgIiQxIiArIGNhbGxiYWNrTmFtZSk7CiAgICAgIH0gZWxzZSBpZiAocy5qc29ucCAhPT0gZmFsc2UpIHsKICAgICAgICBzLnVybCArPSAocnF1ZXJ5LnRlc3Qocy51cmwpID8gIiYiIDogIj8iKSArIHMuanNvbnAgKyAiPSIgKyBjYWxsYmFja05hbWU7CiAgICAgIH0KCiAgICAgIC8vIFVzZSBkYXRhIGNvbnZlcnRlciB0byByZXRyaWV2ZSBqc29uIGFmdGVyIHNjcmlwdCBleGVjdXRpb24KICAgICAgcy5jb252ZXJ0ZXJzWyJzY3JpcHQganNvbiJdID0gZnVuY3Rpb24gKCkgewogICAgICAgIGlmICghcmVzcG9uc2VDb250YWluZXIpIHsKICAgICAgICAgIGpRdWVyeS5lcnJvcihjYWxsYmFja05hbWUgKyAiIHdhcyBub3QgY2FsbGVkIik7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXNwb25zZUNvbnRhaW5lclswXTsKICAgICAgfTsKCiAgICAgIC8vIEZvcmNlIGpzb24gZGF0YVR5cGUKICAgICAgcy5kYXRhVHlwZXNbMF0gPSAianNvbiI7CgogICAgICAvLyBJbnN0YWxsIGNhbGxiYWNrCiAgICAgIG92ZXJ3cml0dGVuID0gd2luZG93W2NhbGxiYWNrTmFtZV07CiAgICAgIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gYXJndW1lbnRzOwogICAgICB9OwoKICAgICAgLy8gQ2xlYW4tdXAgZnVuY3Rpb24gKGZpcmVzIGFmdGVyIGNvbnZlcnRlcnMpCiAgICAgIGpxWEhSLmFsd2F5cyhmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gSWYgcHJldmlvdXMgdmFsdWUgZGlkbid0IGV4aXN0IC0gcmVtb3ZlIGl0CiAgICAgICAgaWYgKG92ZXJ3cml0dGVuID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGpRdWVyeSh3aW5kb3cpLnJlbW92ZVByb3AoY2FsbGJhY2tOYW1lKTsKCiAgICAgICAgICAvLyBPdGhlcndpc2UgcmVzdG9yZSBwcmVleGlzdGluZyB2YWx1ZQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB3aW5kb3dbY2FsbGJhY2tOYW1lXSA9IG92ZXJ3cml0dGVuOwogICAgICAgIH0KCiAgICAgICAgLy8gU2F2ZSBiYWNrIGFzIGZyZWUKICAgICAgICBpZiAoc1tjYWxsYmFja05hbWVdKSB7CiAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCByZS11c2luZyB0aGUgb3B0aW9ucyBkb2Vzbid0IHNjcmV3IHRoaW5ncyBhcm91bmQKICAgICAgICAgIHMuanNvbnBDYWxsYmFjayA9IG9yaWdpbmFsU2V0dGluZ3MuanNvbnBDYWxsYmFjazsKCiAgICAgICAgICAvLyBTYXZlIHRoZSBjYWxsYmFjayBuYW1lIGZvciBmdXR1cmUgdXNlCiAgICAgICAgICBvbGRDYWxsYmFja3MucHVzaChjYWxsYmFja05hbWUpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ2FsbCBpZiBpdCB3YXMgYSBmdW5jdGlvbiBhbmQgd2UgaGF2ZSBhIHJlc3BvbnNlCiAgICAgICAgaWYgKHJlc3BvbnNlQ29udGFpbmVyICYmIGlzRnVuY3Rpb24ob3ZlcndyaXR0ZW4pKSB7CiAgICAgICAgICBvdmVyd3JpdHRlbihyZXNwb25zZUNvbnRhaW5lclswXSk7CiAgICAgICAgfQogICAgICAgIHJlc3BvbnNlQ29udGFpbmVyID0gb3ZlcndyaXR0ZW4gPSB1bmRlZmluZWQ7CiAgICAgIH0pOwoKICAgICAgLy8gRGVsZWdhdGUgdG8gc2NyaXB0CiAgICAgIHJldHVybiAic2NyaXB0IjsKICAgIH0KICB9KTsKCiAgLy8gU3VwcG9ydDogU2FmYXJpIDggb25seQogIC8vIEluIFNhZmFyaSA4IGRvY3VtZW50cyBjcmVhdGVkIHZpYSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQKICAvLyBjb2xsYXBzZSBzaWJsaW5nIGZvcm1zOiB0aGUgc2Vjb25kIG9uZSBiZWNvbWVzIGEgY2hpbGQgb2YgdGhlIGZpcnN0IG9uZS4KICAvLyBCZWNhdXNlIG9mIHRoYXQsIHRoaXMgc2VjdXJpdHkgbWVhc3VyZSBoYXMgdG8gYmUgZGlzYWJsZWQgaW4gU2FmYXJpIDguCiAgLy8gaHR0cHM6Ly9idWdzLndlYmtpdC5vcmcvc2hvd19idWcuY2dpP2lkPTEzNzMzNwogIHN1cHBvcnQuY3JlYXRlSFRNTERvY3VtZW50ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGJvZHkgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoIiIpLmJvZHk7CiAgICBib2R5LmlubmVySFRNTCA9ICI8Zm9ybT48L2Zvcm0+PGZvcm0+PC9mb3JtPiI7CiAgICByZXR1cm4gYm9keS5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMjsKICB9KCk7CgogIC8vIEFyZ3VtZW50ICJkYXRhIiBzaG91bGQgYmUgc3RyaW5nIG9mIGh0bWwKICAvLyBjb250ZXh0IChvcHRpb25hbCk6IElmIHNwZWNpZmllZCwgdGhlIGZyYWdtZW50IHdpbGwgYmUgY3JlYXRlZCBpbiB0aGlzIGNvbnRleHQsCiAgLy8gZGVmYXVsdHMgdG8gZG9jdW1lbnQKICAvLyBrZWVwU2NyaXB0cyAob3B0aW9uYWwpOiBJZiB0cnVlLCB3aWxsIGluY2x1ZGUgc2NyaXB0cyBwYXNzZWQgaW4gdGhlIGh0bWwgc3RyaW5nCiAgalF1ZXJ5LnBhcnNlSFRNTCA9IGZ1bmN0aW9uIChkYXRhLCBjb250ZXh0LCBrZWVwU2NyaXB0cykgewogICAgaWYgKHR5cGVvZiBkYXRhICE9PSAic3RyaW5nIikgewogICAgICByZXR1cm4gW107CiAgICB9CiAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJib29sZWFuIikgewogICAgICBrZWVwU2NyaXB0cyA9IGNvbnRleHQ7CiAgICAgIGNvbnRleHQgPSBmYWxzZTsKICAgIH0KICAgIHZhciBiYXNlLCBwYXJzZWQsIHNjcmlwdHM7CiAgICBpZiAoIWNvbnRleHQpIHsKICAgICAgLy8gU3RvcCBzY3JpcHRzIG9yIGlubGluZSBldmVudCBoYW5kbGVycyBmcm9tIGJlaW5nIGV4ZWN1dGVkIGltbWVkaWF0ZWx5CiAgICAgIC8vIGJ5IHVzaW5nIGRvY3VtZW50LmltcGxlbWVudGF0aW9uCiAgICAgIGlmIChzdXBwb3J0LmNyZWF0ZUhUTUxEb2N1bWVudCkgewogICAgICAgIGNvbnRleHQgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoIiIpOwoKICAgICAgICAvLyBTZXQgdGhlIGJhc2UgaHJlZiBmb3IgdGhlIGNyZWF0ZWQgZG9jdW1lbnQKICAgICAgICAvLyBzbyBhbnkgcGFyc2VkIGVsZW1lbnRzIHdpdGggVVJMcwogICAgICAgIC8vIGFyZSBiYXNlZCBvbiB0aGUgZG9jdW1lbnQncyBVUkwgKGdoLTI5NjUpCiAgICAgICAgYmFzZSA9IGNvbnRleHQuY3JlYXRlRWxlbWVudCgiYmFzZSIpOwogICAgICAgIGJhc2UuaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CiAgICAgICAgY29udGV4dC5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogICAgICB9IGVsc2UgewogICAgICAgIGNvbnRleHQgPSBkb2N1bWVudDsKICAgICAgfQogICAgfQogICAgcGFyc2VkID0gcnNpbmdsZVRhZy5leGVjKGRhdGEpOwogICAgc2NyaXB0cyA9ICFrZWVwU2NyaXB0cyAmJiBbXTsKCiAgICAvLyBTaW5nbGUgdGFnCiAgICBpZiAocGFyc2VkKSB7CiAgICAgIHJldHVybiBbY29udGV4dC5jcmVhdGVFbGVtZW50KHBhcnNlZFsxXSldOwogICAgfQogICAgcGFyc2VkID0gYnVpbGRGcmFnbWVudChbZGF0YV0sIGNvbnRleHQsIHNjcmlwdHMpOwogICAgaWYgKHNjcmlwdHMgJiYgc2NyaXB0cy5sZW5ndGgpIHsKICAgICAgalF1ZXJ5KHNjcmlwdHMpLnJlbW92ZSgpOwogICAgfQogICAgcmV0dXJuIGpRdWVyeS5tZXJnZShbXSwgcGFyc2VkLmNoaWxkTm9kZXMpOwogIH07CgogIC8qKgogICAqIExvYWQgYSB1cmwgaW50byBhIHBhZ2UKICAgKi8KICBqUXVlcnkuZm4ubG9hZCA9IGZ1bmN0aW9uICh1cmwsIHBhcmFtcywgY2FsbGJhY2spIHsKICAgIHZhciBzZWxlY3RvciwKICAgICAgdHlwZSwKICAgICAgcmVzcG9uc2UsCiAgICAgIHNlbGYgPSB0aGlzLAogICAgICBvZmYgPSB1cmwuaW5kZXhPZigiICIpOwogICAgaWYgKG9mZiA+IC0xKSB7CiAgICAgIHNlbGVjdG9yID0gc3RyaXBBbmRDb2xsYXBzZSh1cmwuc2xpY2Uob2ZmKSk7CiAgICAgIHVybCA9IHVybC5zbGljZSgwLCBvZmYpOwogICAgfQoKICAgIC8vIElmIGl0J3MgYSBmdW5jdGlvbgogICAgaWYgKGlzRnVuY3Rpb24ocGFyYW1zKSkgewogICAgICAvLyBXZSBhc3N1bWUgdGhhdCBpdCdzIHRoZSBjYWxsYmFjawogICAgICBjYWxsYmFjayA9IHBhcmFtczsKICAgICAgcGFyYW1zID0gdW5kZWZpbmVkOwoKICAgICAgLy8gT3RoZXJ3aXNlLCBidWlsZCBhIHBhcmFtIHN0cmluZwogICAgfSBlbHNlIGlmIChwYXJhbXMgJiYgdHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIpIHsKICAgICAgdHlwZSA9ICJQT1NUIjsKICAgIH0KCiAgICAvLyBJZiB3ZSBoYXZlIGVsZW1lbnRzIHRvIG1vZGlmeSwgbWFrZSB0aGUgcmVxdWVzdAogICAgaWYgKHNlbGYubGVuZ3RoID4gMCkgewogICAgICBqUXVlcnkuYWpheCh7CiAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgLy8gSWYgInR5cGUiIHZhcmlhYmxlIGlzIHVuZGVmaW5lZCwgdGhlbiAiR0VUIiBtZXRob2Qgd2lsbCBiZSB1c2VkLgogICAgICAgIC8vIE1ha2UgdmFsdWUgb2YgdGhpcyBmaWVsZCBleHBsaWNpdCBzaW5jZQogICAgICAgIC8vIHVzZXIgY2FuIG92ZXJyaWRlIGl0IHRocm91Z2ggYWpheFNldHVwIG1ldGhvZAogICAgICAgIHR5cGU6IHR5cGUgfHwgIkdFVCIsCiAgICAgICAgZGF0YVR5cGU6ICJodG1sIiwKICAgICAgICBkYXRhOiBwYXJhbXMKICAgICAgfSkuZG9uZShmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgLy8gU2F2ZSByZXNwb25zZSBmb3IgdXNlIGluIGNvbXBsZXRlIGNhbGxiYWNrCiAgICAgICAgcmVzcG9uc2UgPSBhcmd1bWVudHM7CiAgICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAvLyBJZiBhIHNlbGVjdG9yIHdhcyBzcGVjaWZpZWQsIGxvY2F0ZSB0aGUgcmlnaHQgZWxlbWVudHMgaW4gYSBkdW1teSBkaXYKICAgICAgICAvLyBFeGNsdWRlIHNjcmlwdHMgdG8gYXZvaWQgSUUgJ1Blcm1pc3Npb24gRGVuaWVkJyBlcnJvcnMKICAgICAgICBqUXVlcnkoIjxkaXY+IikuYXBwZW5kKGpRdWVyeS5wYXJzZUhUTUwocmVzcG9uc2VUZXh0KSkuZmluZChzZWxlY3RvcikgOgogICAgICAgIC8vIE90aGVyd2lzZSB1c2UgdGhlIGZ1bGwgcmVzdWx0CiAgICAgICAgcmVzcG9uc2VUZXh0KTsKCiAgICAgICAgLy8gSWYgdGhlIHJlcXVlc3Qgc3VjY2VlZHMsIHRoaXMgZnVuY3Rpb24gZ2V0cyAiZGF0YSIsICJzdGF0dXMiLCAianFYSFIiCiAgICAgICAgLy8gYnV0IHRoZXkgYXJlIGlnbm9yZWQgYmVjYXVzZSByZXNwb25zZSB3YXMgc2V0IGFib3ZlLgogICAgICAgIC8vIElmIGl0IGZhaWxzLCB0aGlzIGZ1bmN0aW9uIGdldHMgImpxWEhSIiwgInN0YXR1cyIsICJlcnJvciIKICAgICAgfSkuYWx3YXlzKGNhbGxiYWNrICYmIGZ1bmN0aW9uIChqcVhIUiwgc3RhdHVzKSB7CiAgICAgICAgc2VsZi5lYWNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIHJlc3BvbnNlIHx8IFtqcVhIUi5yZXNwb25zZVRleHQsIHN0YXR1cywganFYSFJdKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9OwogIGpRdWVyeS5leHByLnBzZXVkb3MuYW5pbWF0ZWQgPSBmdW5jdGlvbiAoZWxlbSkgewogICAgcmV0dXJuIGpRdWVyeS5ncmVwKGpRdWVyeS50aW1lcnMsIGZ1bmN0aW9uIChmbikgewogICAgICByZXR1cm4gZWxlbSA9PT0gZm4uZWxlbTsKICAgIH0pLmxlbmd0aDsKICB9OwogIGpRdWVyeS5vZmZzZXQgPSB7CiAgICBzZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtLCBvcHRpb25zLCBpKSB7CiAgICAgIHZhciBjdXJQb3NpdGlvbiwKICAgICAgICBjdXJMZWZ0LAogICAgICAgIGN1ckNTU1RvcCwKICAgICAgICBjdXJUb3AsCiAgICAgICAgY3VyT2Zmc2V0LAogICAgICAgIGN1ckNTU0xlZnQsCiAgICAgICAgY2FsY3VsYXRlUG9zaXRpb24sCiAgICAgICAgcG9zaXRpb24gPSBqUXVlcnkuY3NzKGVsZW0sICJwb3NpdGlvbiIpLAogICAgICAgIGN1ckVsZW0gPSBqUXVlcnkoZWxlbSksCiAgICAgICAgcHJvcHMgPSB7fTsKCiAgICAgIC8vIFNldCBwb3NpdGlvbiBmaXJzdCwgaW4tY2FzZSB0b3AvbGVmdCBhcmUgc2V0IGV2ZW4gb24gc3RhdGljIGVsZW0KICAgICAgaWYgKHBvc2l0aW9uID09PSAic3RhdGljIikgewogICAgICAgIGVsZW0uc3R5bGUucG9zaXRpb24gPSAicmVsYXRpdmUiOwogICAgICB9CiAgICAgIGN1ck9mZnNldCA9IGN1ckVsZW0ub2Zmc2V0KCk7CiAgICAgIGN1ckNTU1RvcCA9IGpRdWVyeS5jc3MoZWxlbSwgInRvcCIpOwogICAgICBjdXJDU1NMZWZ0ID0galF1ZXJ5LmNzcyhlbGVtLCAibGVmdCIpOwogICAgICBjYWxjdWxhdGVQb3NpdGlvbiA9IChwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIikgJiYgKGN1ckNTU1RvcCArIGN1ckNTU0xlZnQpLmluZGV4T2YoImF1dG8iKSA+IC0xOwoKICAgICAgLy8gTmVlZCB0byBiZSBhYmxlIHRvIGNhbGN1bGF0ZSBwb3NpdGlvbiBpZiBlaXRoZXIKICAgICAgLy8gdG9wIG9yIGxlZnQgaXMgYXV0byBhbmQgcG9zaXRpb24gaXMgZWl0aGVyIGFic29sdXRlIG9yIGZpeGVkCiAgICAgIGlmIChjYWxjdWxhdGVQb3NpdGlvbikgewogICAgICAgIGN1clBvc2l0aW9uID0gY3VyRWxlbS5wb3NpdGlvbigpOwogICAgICAgIGN1clRvcCA9IGN1clBvc2l0aW9uLnRvcDsKICAgICAgICBjdXJMZWZ0ID0gY3VyUG9zaXRpb24ubGVmdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJUb3AgPSBwYXJzZUZsb2F0KGN1ckNTU1RvcCkgfHwgMDsKICAgICAgICBjdXJMZWZ0ID0gcGFyc2VGbG9hdChjdXJDU1NMZWZ0KSB8fCAwOwogICAgICB9CiAgICAgIGlmIChpc0Z1bmN0aW9uKG9wdGlvbnMpKSB7CiAgICAgICAgLy8gVXNlIGpRdWVyeS5leHRlbmQgaGVyZSB0byBhbGxvdyBtb2RpZmljYXRpb24gb2YgY29vcmRpbmF0ZXMgYXJndW1lbnQgKGdoLTE4NDgpCiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMuY2FsbChlbGVtLCBpLCBqUXVlcnkuZXh0ZW5kKHt9LCBjdXJPZmZzZXQpKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50b3AgIT0gbnVsbCkgewogICAgICAgIHByb3BzLnRvcCA9IG9wdGlvbnMudG9wIC0gY3VyT2Zmc2V0LnRvcCArIGN1clRvcDsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy5sZWZ0ICE9IG51bGwpIHsKICAgICAgICBwcm9wcy5sZWZ0ID0gb3B0aW9ucy5sZWZ0IC0gY3VyT2Zmc2V0LmxlZnQgKyBjdXJMZWZ0OwogICAgICB9CiAgICAgIGlmICgidXNpbmciIGluIG9wdGlvbnMpIHsKICAgICAgICBvcHRpb25zLnVzaW5nLmNhbGwoZWxlbSwgcHJvcHMpOwogICAgICB9IGVsc2UgewogICAgICAgIGN1ckVsZW0uY3NzKHByb3BzKTsKICAgICAgfQogICAgfQogIH07CiAgalF1ZXJ5LmZuLmV4dGVuZCh7CiAgICAvLyBvZmZzZXQoKSByZWxhdGVzIGFuIGVsZW1lbnQncyBib3JkZXIgYm94IHRvIHRoZSBkb2N1bWVudCBvcmlnaW4KICAgIG9mZnNldDogZnVuY3Rpb24gKG9wdGlvbnMpIHsKICAgICAgLy8gUHJlc2VydmUgY2hhaW5pbmcgZm9yIHNldHRlcgogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCkgewogICAgICAgIHJldHVybiBvcHRpb25zID09PSB1bmRlZmluZWQgPyB0aGlzIDogdGhpcy5lYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICBqUXVlcnkub2Zmc2V0LnNldE9mZnNldCh0aGlzLCBvcHRpb25zLCBpKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICB2YXIgcmVjdCwKICAgICAgICB3aW4sCiAgICAgICAgZWxlbSA9IHRoaXNbMF07CiAgICAgIGlmICghZWxlbSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgLy8gUmV0dXJuIHplcm9zIGZvciBkaXNjb25uZWN0ZWQgYW5kIGhpZGRlbiAoZGlzcGxheTogbm9uZSkgZWxlbWVudHMgKGdoLTIzMTApCiAgICAgIC8vIFN1cHBvcnQ6IElFIDw9MTEgb25seQogICAgICAvLyBSdW5uaW5nIGdldEJvdW5kaW5nQ2xpZW50UmVjdCBvbiBhCiAgICAgIC8vIGRpc2Nvbm5lY3RlZCBub2RlIGluIElFIHRocm93cyBhbiBlcnJvcgogICAgICBpZiAoIWVsZW0uZ2V0Q2xpZW50UmVjdHMoKS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIEdldCBkb2N1bWVudC1yZWxhdGl2ZSBwb3NpdGlvbiBieSBhZGRpbmcgdmlld3BvcnQgc2Nyb2xsIHRvIHZpZXdwb3J0LXJlbGF0aXZlIGdCQ1IKICAgICAgcmVjdCA9IGVsZW0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHdpbiA9IGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldzsKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IHJlY3QudG9wICsgd2luLnBhZ2VZT2Zmc2V0LAogICAgICAgIGxlZnQ6IHJlY3QubGVmdCArIHdpbi5wYWdlWE9mZnNldAogICAgICB9OwogICAgfSwKICAgIC8vIHBvc2l0aW9uKCkgcmVsYXRlcyBhbiBlbGVtZW50J3MgbWFyZ2luIGJveCB0byBpdHMgb2Zmc2V0IHBhcmVudCdzIHBhZGRpbmcgYm94CiAgICAvLyBUaGlzIGNvcnJlc3BvbmRzIHRvIHRoZSBiZWhhdmlvciBvZiBDU1MgYWJzb2x1dGUgcG9zaXRpb25pbmcKICAgIHBvc2l0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICghdGhpc1swXSkgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgICB2YXIgb2Zmc2V0UGFyZW50LAogICAgICAgIG9mZnNldCwKICAgICAgICBkb2MsCiAgICAgICAgZWxlbSA9IHRoaXNbMF0sCiAgICAgICAgcGFyZW50T2Zmc2V0ID0gewogICAgICAgICAgdG9wOiAwLAogICAgICAgICAgbGVmdDogMAogICAgICAgIH07CgogICAgICAvLyBwb3NpdGlvbjpmaXhlZCBlbGVtZW50cyBhcmUgb2Zmc2V0IGZyb20gdGhlIHZpZXdwb3J0LCB3aGljaCBpdHNlbGYgYWx3YXlzIGhhcyB6ZXJvIG9mZnNldAogICAgICBpZiAoalF1ZXJ5LmNzcyhlbGVtLCAicG9zaXRpb24iKSA9PT0gImZpeGVkIikgewogICAgICAgIC8vIEFzc3VtZSBwb3NpdGlvbjpmaXhlZCBpbXBsaWVzIGF2YWlsYWJpbGl0eSBvZiBnZXRCb3VuZGluZ0NsaWVudFJlY3QKICAgICAgICBvZmZzZXQgPSBlbGVtLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICB9IGVsc2UgewogICAgICAgIG9mZnNldCA9IHRoaXMub2Zmc2V0KCk7CgogICAgICAgIC8vIEFjY291bnQgZm9yIHRoZSAqcmVhbCogb2Zmc2V0IHBhcmVudCwgd2hpY2ggY2FuIGJlIHRoZSBkb2N1bWVudCBvciBpdHMgcm9vdCBlbGVtZW50CiAgICAgICAgLy8gd2hlbiBhIHN0YXRpY2FsbHkgcG9zaXRpb25lZCBlbGVtZW50IGlzIGlkZW50aWZpZWQKICAgICAgICBkb2MgPSBlbGVtLm93bmVyRG9jdW1lbnQ7CiAgICAgICAgb2Zmc2V0UGFyZW50ID0gZWxlbS5vZmZzZXRQYXJlbnQgfHwgZG9jLmRvY3VtZW50RWxlbWVudDsKICAgICAgICB3aGlsZSAob2Zmc2V0UGFyZW50ICYmIChvZmZzZXRQYXJlbnQgPT09IGRvYy5ib2R5IHx8IG9mZnNldFBhcmVudCA9PT0gZG9jLmRvY3VtZW50RWxlbWVudCkgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgewogICAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50LnBhcmVudE5vZGU7CiAgICAgICAgfQogICAgICAgIGlmIChvZmZzZXRQYXJlbnQgJiYgb2Zmc2V0UGFyZW50ICE9PSBlbGVtICYmIG9mZnNldFBhcmVudC5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgLy8gSW5jb3Jwb3JhdGUgYm9yZGVycyBpbnRvIGl0cyBvZmZzZXQsIHNpbmNlIHRoZXkgYXJlIG91dHNpZGUgaXRzIGNvbnRlbnQgb3JpZ2luCiAgICAgICAgICBwYXJlbnRPZmZzZXQgPSBqUXVlcnkob2Zmc2V0UGFyZW50KS5vZmZzZXQoKTsKICAgICAgICAgIHBhcmVudE9mZnNldC50b3AgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJib3JkZXJUb3BXaWR0aCIsIHRydWUpOwogICAgICAgICAgcGFyZW50T2Zmc2V0LmxlZnQgKz0galF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJib3JkZXJMZWZ0V2lkdGgiLCB0cnVlKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIFN1YnRyYWN0IHBhcmVudCBvZmZzZXRzIGFuZCBlbGVtZW50IG1hcmdpbnMKICAgICAgcmV0dXJuIHsKICAgICAgICB0b3A6IG9mZnNldC50b3AgLSBwYXJlbnRPZmZzZXQudG9wIC0galF1ZXJ5LmNzcyhlbGVtLCAibWFyZ2luVG9wIiwgdHJ1ZSksCiAgICAgICAgbGVmdDogb2Zmc2V0LmxlZnQgLSBwYXJlbnRPZmZzZXQubGVmdCAtIGpRdWVyeS5jc3MoZWxlbSwgIm1hcmdpbkxlZnQiLCB0cnVlKQogICAgICB9OwogICAgfSwKICAgIC8vIFRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGRvY3VtZW50RWxlbWVudCBpbiB0aGUgZm9sbG93aW5nIGNhc2VzOgogICAgLy8gMSkgRm9yIHRoZSBlbGVtZW50IGluc2lkZSB0aGUgaWZyYW1lIHdpdGhvdXQgb2Zmc2V0UGFyZW50LCB0aGlzIG1ldGhvZCB3aWxsIHJldHVybgogICAgLy8gICAgZG9jdW1lbnRFbGVtZW50IG9mIHRoZSBwYXJlbnQgd2luZG93CiAgICAvLyAyKSBGb3IgdGhlIGhpZGRlbiBvciBkZXRhY2hlZCBlbGVtZW50CiAgICAvLyAzKSBGb3IgYm9keSBvciBodG1sIGVsZW1lbnQsIGkuZS4gaW4gY2FzZSBvZiB0aGUgaHRtbCBub2RlIC0gaXQgd2lsbCByZXR1cm4gaXRzZWxmCiAgICAvLwogICAgLy8gYnV0IHRob3NlIGV4Y2VwdGlvbnMgd2VyZSBuZXZlciBwcmVzZW50ZWQgYXMgYSByZWFsIGxpZmUgdXNlLWNhc2VzCiAgICAvLyBhbmQgbWlnaHQgYmUgY29uc2lkZXJlZCBhcyBtb3JlIHByZWZlcmFibGUgcmVzdWx0cy4KICAgIC8vCiAgICAvLyBUaGlzIGxvZ2ljLCBob3dldmVyLCBpcyBub3QgZ3VhcmFudGVlZCBhbmQgY2FuIGNoYW5nZSBhdCBhbnkgcG9pbnQgaW4gdGhlIGZ1dHVyZQogICAgb2Zmc2V0UGFyZW50OiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG9mZnNldFBhcmVudCA9IHRoaXMub2Zmc2V0UGFyZW50OwogICAgICAgIHdoaWxlIChvZmZzZXRQYXJlbnQgJiYgalF1ZXJ5LmNzcyhvZmZzZXRQYXJlbnQsICJwb3NpdGlvbiIpID09PSAic3RhdGljIikgewogICAgICAgICAgb2Zmc2V0UGFyZW50ID0gb2Zmc2V0UGFyZW50Lm9mZnNldFBhcmVudDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG9mZnNldFBhcmVudCB8fCBkb2N1bWVudEVsZW1lbnQ7CiAgICAgIH0pOwogICAgfQogIH0pOwoKICAvLyBDcmVhdGUgc2Nyb2xsTGVmdCBhbmQgc2Nyb2xsVG9wIG1ldGhvZHMKICBqUXVlcnkuZWFjaCh7CiAgICBzY3JvbGxMZWZ0OiAicGFnZVhPZmZzZXQiLAogICAgc2Nyb2xsVG9wOiAicGFnZVlPZmZzZXQiCiAgfSwgZnVuY3Rpb24gKG1ldGhvZCwgcHJvcCkgewogICAgdmFyIHRvcCA9ICJwYWdlWU9mZnNldCIgPT09IHByb3A7CiAgICBqUXVlcnkuZm5bbWV0aG9kXSA9IGZ1bmN0aW9uICh2YWwpIHsKICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgbWV0aG9kLCB2YWwpIHsKICAgICAgICAvLyBDb2FsZXNjZSBkb2N1bWVudHMgYW5kIHdpbmRvd3MKICAgICAgICB2YXIgd2luOwogICAgICAgIGlmIChpc1dpbmRvdyhlbGVtKSkgewogICAgICAgICAgd2luID0gZWxlbTsKICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgIHdpbiA9IGVsZW0uZGVmYXVsdFZpZXc7CiAgICAgICAgfQogICAgICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgcmV0dXJuIHdpbiA/IHdpbltwcm9wXSA6IGVsZW1bbWV0aG9kXTsKICAgICAgICB9CiAgICAgICAgaWYgKHdpbikgewogICAgICAgICAgd2luLnNjcm9sbFRvKCF0b3AgPyB2YWwgOiB3aW4ucGFnZVhPZmZzZXQsIHRvcCA/IHZhbCA6IHdpbi5wYWdlWU9mZnNldCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGVsZW1bbWV0aG9kXSA9IHZhbDsKICAgICAgICB9CiAgICAgIH0sIG1ldGhvZCwgdmFsLCBhcmd1bWVudHMubGVuZ3RoKTsKICAgIH07CiAgfSk7CgogIC8vIFN1cHBvcnQ6IFNhZmFyaSA8PTcgLSA5LjEsIENocm9tZSA8PTM3IC0gNDkKICAvLyBBZGQgdGhlIHRvcC9sZWZ0IGNzc0hvb2tzIHVzaW5nIGpRdWVyeS5mbi5wb3NpdGlvbgogIC8vIFdlYmtpdCBidWc6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD0yOTA4NAogIC8vIEJsaW5rIGJ1ZzogaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NTg5MzQ3CiAgLy8gZ2V0Q29tcHV0ZWRTdHlsZSByZXR1cm5zIHBlcmNlbnQgd2hlbiBzcGVjaWZpZWQgZm9yIHRvcC9sZWZ0L2JvdHRvbS9yaWdodDsKICAvLyByYXRoZXIgdGhhbiBtYWtlIHRoZSBjc3MgbW9kdWxlIGRlcGVuZCBvbiB0aGUgb2Zmc2V0IG1vZHVsZSwganVzdCBjaGVjayBmb3IgaXQgaGVyZQogIGpRdWVyeS5lYWNoKFsidG9wIiwgImxlZnQiXSwgZnVuY3Rpb24gKF9pLCBwcm9wKSB7CiAgICBqUXVlcnkuY3NzSG9va3NbcHJvcF0gPSBhZGRHZXRIb29rSWYoc3VwcG9ydC5waXhlbFBvc2l0aW9uLCBmdW5jdGlvbiAoZWxlbSwgY29tcHV0ZWQpIHsKICAgICAgaWYgKGNvbXB1dGVkKSB7CiAgICAgICAgY29tcHV0ZWQgPSBjdXJDU1MoZWxlbSwgcHJvcCk7CgogICAgICAgIC8vIElmIGN1ckNTUyByZXR1cm5zIHBlcmNlbnRhZ2UsIGZhbGxiYWNrIHRvIG9mZnNldAogICAgICAgIHJldHVybiBybnVtbm9ucHgudGVzdChjb21wdXRlZCkgPyBqUXVlcnkoZWxlbSkucG9zaXRpb24oKVtwcm9wXSArICJweCIgOiBjb21wdXRlZDsKICAgICAgfQogICAgfSk7CiAgfSk7CgogIC8vIENyZWF0ZSBpbm5lckhlaWdodCwgaW5uZXJXaWR0aCwgaGVpZ2h0LCB3aWR0aCwgb3V0ZXJIZWlnaHQgYW5kIG91dGVyV2lkdGggbWV0aG9kcwogIGpRdWVyeS5lYWNoKHsKICAgIEhlaWdodDogImhlaWdodCIsCiAgICBXaWR0aDogIndpZHRoIgogIH0sIGZ1bmN0aW9uIChuYW1lLCB0eXBlKSB7CiAgICBqUXVlcnkuZWFjaCh7CiAgICAgIHBhZGRpbmc6ICJpbm5lciIgKyBuYW1lLAogICAgICBjb250ZW50OiB0eXBlLAogICAgICAiIjogIm91dGVyIiArIG5hbWUKICAgIH0sIGZ1bmN0aW9uIChkZWZhdWx0RXh0cmEsIGZ1bmNOYW1lKSB7CiAgICAgIC8vIE1hcmdpbiBpcyBvbmx5IGZvciBvdXRlckhlaWdodCwgb3V0ZXJXaWR0aAogICAgICBqUXVlcnkuZm5bZnVuY05hbWVdID0gZnVuY3Rpb24gKG1hcmdpbiwgdmFsdWUpIHsKICAgICAgICB2YXIgY2hhaW5hYmxlID0gYXJndW1lbnRzLmxlbmd0aCAmJiAoZGVmYXVsdEV4dHJhIHx8IHR5cGVvZiBtYXJnaW4gIT09ICJib29sZWFuIiksCiAgICAgICAgICBleHRyYSA9IGRlZmF1bHRFeHRyYSB8fCAobWFyZ2luID09PSB0cnVlIHx8IHZhbHVlID09PSB0cnVlID8gIm1hcmdpbiIgOiAiYm9yZGVyIik7CiAgICAgICAgcmV0dXJuIGFjY2Vzcyh0aGlzLCBmdW5jdGlvbiAoZWxlbSwgdHlwZSwgdmFsdWUpIHsKICAgICAgICAgIHZhciBkb2M7CiAgICAgICAgICBpZiAoaXNXaW5kb3coZWxlbSkpIHsKICAgICAgICAgICAgLy8gJCggd2luZG93ICkub3V0ZXJXaWR0aC9IZWlnaHQgcmV0dXJuIHcvaCBpbmNsdWRpbmcgc2Nyb2xsYmFycyAoZ2gtMTcyOSkKICAgICAgICAgICAgcmV0dXJuIGZ1bmNOYW1lLmluZGV4T2YoIm91dGVyIikgPT09IDAgPyBlbGVtWyJpbm5lciIgKyBuYW1lXSA6IGVsZW0uZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WyJjbGllbnQiICsgbmFtZV07CiAgICAgICAgICB9CgogICAgICAgICAgLy8gR2V0IGRvY3VtZW50IHdpZHRoIG9yIGhlaWdodAogICAgICAgICAgaWYgKGVsZW0ubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgZG9jID0gZWxlbS5kb2N1bWVudEVsZW1lbnQ7CgogICAgICAgICAgICAvLyBFaXRoZXIgc2Nyb2xsW1dpZHRoL0hlaWdodF0gb3Igb2Zmc2V0W1dpZHRoL0hlaWdodF0gb3IgY2xpZW50W1dpZHRoL0hlaWdodF0sCiAgICAgICAgICAgIC8vIHdoaWNoZXZlciBpcyBncmVhdGVzdAogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgoZWxlbS5ib2R5WyJzY3JvbGwiICsgbmFtZV0sIGRvY1sic2Nyb2xsIiArIG5hbWVdLCBlbGVtLmJvZHlbIm9mZnNldCIgKyBuYW1lXSwgZG9jWyJvZmZzZXQiICsgbmFtZV0sIGRvY1siY2xpZW50IiArIG5hbWVdKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gdW5kZWZpbmVkID8KICAgICAgICAgIC8vIEdldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQsIHJlcXVlc3RpbmcgYnV0IG5vdCBmb3JjaW5nIHBhcnNlRmxvYXQKICAgICAgICAgIGpRdWVyeS5jc3MoZWxlbSwgdHlwZSwgZXh0cmEpIDoKICAgICAgICAgIC8vIFNldCB3aWR0aCBvciBoZWlnaHQgb24gdGhlIGVsZW1lbnQKICAgICAgICAgIGpRdWVyeS5zdHlsZShlbGVtLCB0eXBlLCB2YWx1ZSwgZXh0cmEpOwogICAgICAgIH0sIHR5cGUsIGNoYWluYWJsZSA/IG1hcmdpbiA6IHVuZGVmaW5lZCwgY2hhaW5hYmxlKTsKICAgICAgfTsKICAgIH0pOwogIH0pOwogIGpRdWVyeS5lYWNoKFsiYWpheFN0YXJ0IiwgImFqYXhTdG9wIiwgImFqYXhDb21wbGV0ZSIsICJhamF4RXJyb3IiLCAiYWpheFN1Y2Nlc3MiLCAiYWpheFNlbmQiXSwgZnVuY3Rpb24gKF9pLCB0eXBlKSB7CiAgICBqUXVlcnkuZm5bdHlwZV0gPSBmdW5jdGlvbiAoZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZSwgZm4pOwogICAgfTsKICB9KTsKICBqUXVlcnkuZm4uZXh0ZW5kKHsKICAgIGJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub24odHlwZXMsIG51bGwsIGRhdGEsIGZuKTsKICAgIH0sCiAgICB1bmJpbmQ6IGZ1bmN0aW9uICh0eXBlcywgZm4pIHsKICAgICAgcmV0dXJuIHRoaXMub2ZmKHR5cGVzLCBudWxsLCBmbik7CiAgICB9LAogICAgZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGRhdGEsIGZuKSB7CiAgICAgIHJldHVybiB0aGlzLm9uKHR5cGVzLCBzZWxlY3RvciwgZGF0YSwgZm4pOwogICAgfSwKICAgIHVuZGVsZWdhdGU6IGZ1bmN0aW9uIChzZWxlY3RvciwgdHlwZXMsIGZuKSB7CiAgICAgIC8vICggbmFtZXNwYWNlICkgb3IgKCBzZWxlY3RvciwgdHlwZXMgWywgZm5dICkKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyB0aGlzLm9mZihzZWxlY3RvciwgIioqIikgOiB0aGlzLm9mZih0eXBlcywgc2VsZWN0b3IgfHwgIioqIiwgZm4pOwogICAgfSwKICAgIGhvdmVyOiBmdW5jdGlvbiAoZm5PdmVyLCBmbk91dCkgewogICAgICByZXR1cm4gdGhpcy5tb3VzZWVudGVyKGZuT3ZlcikubW91c2VsZWF2ZShmbk91dCB8fCBmbk92ZXIpOwogICAgfQogIH0pOwogIGpRdWVyeS5lYWNoKCgiYmx1ciBmb2N1cyBmb2N1c2luIGZvY3Vzb3V0IHJlc2l6ZSBzY3JvbGwgY2xpY2sgZGJsY2xpY2sgIiArICJtb3VzZWRvd24gbW91c2V1cCBtb3VzZW1vdmUgbW91c2VvdmVyIG1vdXNlb3V0IG1vdXNlZW50ZXIgbW91c2VsZWF2ZSAiICsgImNoYW5nZSBzZWxlY3Qgc3VibWl0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgY29udGV4dG1lbnUiKS5zcGxpdCgiICIpLCBmdW5jdGlvbiAoX2ksIG5hbWUpIHsKICAgIC8vIEhhbmRsZSBldmVudCBiaW5kaW5nCiAgICBqUXVlcnkuZm5bbmFtZV0gPSBmdW5jdGlvbiAoZGF0YSwgZm4pIHsKICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPiAwID8gdGhpcy5vbihuYW1lLCBudWxsLCBkYXRhLCBmbikgOiB0aGlzLnRyaWdnZXIobmFtZSk7CiAgICB9OwogIH0pOwoKICAvLyBTdXBwb3J0OiBBbmRyb2lkIDw9NC4wIG9ubHkKICAvLyBNYWtlIHN1cmUgd2UgdHJpbSBCT00gYW5kIE5CU1AKICAvLyBSZXF1aXJlIHRoYXQgdGhlICJ3aGl0ZXNwYWNlIHJ1biIgc3RhcnRzIGZyb20gYSBub24td2hpdGVzcGFjZQogIC8vIHRvIGF2b2lkIE8oTl4yKSBiZWhhdmlvciB3aGVuIHRoZSBlbmdpbmUgd291bGQgdHJ5IG1hdGNoaW5nICJccyskIiBhdCBlYWNoIHNwYWNlIHBvc2l0aW9uLgogIHZhciBydHJpbSA9IC9eW1xzXHVGRUZGXHhBMF0rfChbXlxzXHVGRUZGXHhBMF0pW1xzXHVGRUZGXHhBMF0rJC9nOwoKICAvLyBCaW5kIGEgZnVuY3Rpb24gdG8gYSBjb250ZXh0LCBvcHRpb25hbGx5IHBhcnRpYWxseSBhcHBseWluZyBhbnkKICAvLyBhcmd1bWVudHMuCiAgLy8galF1ZXJ5LnByb3h5IGlzIGRlcHJlY2F0ZWQgdG8gcHJvbW90ZSBzdGFuZGFyZHMgKHNwZWNpZmljYWxseSBGdW5jdGlvbiNiaW5kKQogIC8vIEhvd2V2ZXIsIGl0IGlzIG5vdCBzbGF0ZWQgZm9yIHJlbW92YWwgYW55IHRpbWUgc29vbgogIGpRdWVyeS5wcm94eSA9IGZ1bmN0aW9uIChmbiwgY29udGV4dCkgewogICAgdmFyIHRtcCwgYXJncywgcHJveHk7CiAgICBpZiAodHlwZW9mIGNvbnRleHQgPT09ICJzdHJpbmciKSB7CiAgICAgIHRtcCA9IGZuW2NvbnRleHRdOwogICAgICBjb250ZXh0ID0gZm47CiAgICAgIGZuID0gdG1wOwogICAgfQoKICAgIC8vIFF1aWNrIGNoZWNrIHRvIGRldGVybWluZSBpZiB0YXJnZXQgaXMgY2FsbGFibGUsIGluIHRoZSBzcGVjCiAgICAvLyB0aGlzIHRocm93cyBhIFR5cGVFcnJvciwgYnV0IHdlIHdpbGwganVzdCByZXR1cm4gdW5kZWZpbmVkLgogICAgaWYgKCFpc0Z1bmN0aW9uKGZuKSkgewogICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQoKICAgIC8vIFNpbXVsYXRlZCBiaW5kCiAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcHJveHkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBmbi5hcHBseShjb250ZXh0IHx8IHRoaXMsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgfTsKCiAgICAvLyBTZXQgdGhlIGd1aWQgb2YgdW5pcXVlIGhhbmRsZXIgdG8gdGhlIHNhbWUgb2Ygb3JpZ2luYWwgaGFuZGxlciwgc28gaXQgY2FuIGJlIHJlbW92ZWQKICAgIHByb3h5Lmd1aWQgPSBmbi5ndWlkID0gZm4uZ3VpZCB8fCBqUXVlcnkuZ3VpZCsrOwogICAgcmV0dXJuIHByb3h5OwogIH07CiAgalF1ZXJ5LmhvbGRSZWFkeSA9IGZ1bmN0aW9uIChob2xkKSB7CiAgICBpZiAoaG9sZCkgewogICAgICBqUXVlcnkucmVhZHlXYWl0Kys7CiAgICB9IGVsc2UgewogICAgICBqUXVlcnkucmVhZHkodHJ1ZSk7CiAgICB9CiAgfTsKICBqUXVlcnkuaXNBcnJheSA9IEFycmF5LmlzQXJyYXk7CiAgalF1ZXJ5LnBhcnNlSlNPTiA9IEpTT04ucGFyc2U7CiAgalF1ZXJ5Lm5vZGVOYW1lID0gbm9kZU5hbWU7CiAgalF1ZXJ5LmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uOwogIGpRdWVyeS5pc1dpbmRvdyA9IGlzV2luZG93OwogIGpRdWVyeS5jYW1lbENhc2UgPSBjYW1lbENhc2U7CiAgalF1ZXJ5LnR5cGUgPSB0b1R5cGU7CiAgalF1ZXJ5Lm5vdyA9IERhdGUubm93OwogIGpRdWVyeS5pc051bWVyaWMgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAvLyBBcyBvZiBqUXVlcnkgMy4wLCBpc051bWVyaWMgaXMgbGltaXRlZCB0bwogICAgLy8gc3RyaW5ncyBhbmQgbnVtYmVycyAocHJpbWl0aXZlcyBvciBvYmplY3RzKQogICAgLy8gdGhhdCBjYW4gYmUgY29lcmNlZCB0byBmaW5pdGUgbnVtYmVycyAoZ2gtMjY2MikKICAgIHZhciB0eXBlID0galF1ZXJ5LnR5cGUob2JqKTsKICAgIHJldHVybiAodHlwZSA9PT0gIm51bWJlciIgfHwgdHlwZSA9PT0gInN0cmluZyIpICYmCiAgICAvLyBwYXJzZUZsb2F0IE5hTnMgbnVtZXJpYy1jYXN0IGZhbHNlIHBvc2l0aXZlcyAoIiIpCiAgICAvLyAuLi5idXQgbWlzaW50ZXJwcmV0cyBsZWFkaW5nLW51bWJlciBzdHJpbmdzLCBwYXJ0aWN1bGFybHkgaGV4IGxpdGVyYWxzICgiMHguLi4iKQogICAgLy8gc3VidHJhY3Rpb24gZm9yY2VzIGluZmluaXRpZXMgdG8gTmFOCiAgICAhaXNOYU4ob2JqIC0gcGFyc2VGbG9hdChvYmopKTsKICB9OwogIGpRdWVyeS50cmltID0gZnVuY3Rpb24gKHRleHQpIHsKICAgIHJldHVybiB0ZXh0ID09IG51bGwgPyAiIiA6ICh0ZXh0ICsgIiIpLnJlcGxhY2UocnRyaW0sICIkMSIpOwogIH07CgogIC8vIFJlZ2lzdGVyIGFzIGEgbmFtZWQgQU1EIG1vZHVsZSwgc2luY2UgalF1ZXJ5IGNhbiBiZSBjb25jYXRlbmF0ZWQgd2l0aCBvdGhlcgogIC8vIGZpbGVzIHRoYXQgbWF5IHVzZSBkZWZpbmUsIGJ1dCBub3QgdmlhIGEgcHJvcGVyIGNvbmNhdGVuYXRpb24gc2NyaXB0IHRoYXQKICAvLyB1bmRlcnN0YW5kcyBhbm9ueW1vdXMgQU1EIG1vZHVsZXMuIEEgbmFtZWQgQU1EIGlzIHNhZmVzdCBhbmQgbW9zdCByb2J1c3QKICAvLyB3YXkgdG8gcmVnaXN0ZXIuIExvd2VyY2FzZSBqcXVlcnkgaXMgdXNlZCBiZWNhdXNlIEFNRCBtb2R1bGUgbmFtZXMgYXJlCiAgLy8gZGVyaXZlZCBmcm9tIGZpbGUgbmFtZXMsIGFuZCBqUXVlcnkgaXMgbm9ybWFsbHkgZGVsaXZlcmVkIGluIGEgbG93ZXJjYXNlCiAgLy8gZmlsZSBuYW1lLiBEbyB0aGlzIGFmdGVyIGNyZWF0aW5nIHRoZSBnbG9iYWwgc28gdGhhdCBpZiBhbiBBTUQgbW9kdWxlIHdhbnRzCiAgLy8gdG8gY2FsbCBub0NvbmZsaWN0IHRvIGhpZGUgdGhpcyB2ZXJzaW9uIG9mIGpRdWVyeSwgaXQgd2lsbCB3b3JrLgoKICAvLyBOb3RlIHRoYXQgZm9yIG1heGltdW0gcG9ydGFiaWxpdHksIGxpYnJhcmllcyB0aGF0IGFyZSBub3QgalF1ZXJ5IHNob3VsZAogIC8vIGRlY2xhcmUgdGhlbXNlbHZlcyBhcyBhbm9ueW1vdXMgbW9kdWxlcywgYW5kIGF2b2lkIHNldHRpbmcgYSBnbG9iYWwgaWYgYW4KICAvLyBBTUQgbG9hZGVyIGlzIHByZXNlbnQuIGpRdWVyeSBpcyBhIHNwZWNpYWwgY2FzZS4gRm9yIG1vcmUgaW5mb3JtYXRpb24sIHNlZQogIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcmJ1cmtlL3JlcXVpcmVqcy93aWtpL1VwZGF0aW5nLWV4aXN0aW5nLWxpYnJhcmllcyN3aWtpLWFub24KCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKCJqcXVlcnkiLCBbXSwgZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4galF1ZXJ5OwogICAgfSk7CiAgfQogIHZhcgogICAgLy8gTWFwIG92ZXIgalF1ZXJ5IGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfalF1ZXJ5ID0gd2luZG93LmpRdWVyeSwKICAgIC8vIE1hcCBvdmVyIHRoZSAkIGluIGNhc2Ugb2Ygb3ZlcndyaXRlCiAgICBfJCA9IHdpbmRvdy4kOwogIGpRdWVyeS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24gKGRlZXApIHsKICAgIGlmICh3aW5kb3cuJCA9PT0galF1ZXJ5KSB7CiAgICAgIHdpbmRvdy4kID0gXyQ7CiAgICB9CiAgICBpZiAoZGVlcCAmJiB3aW5kb3cualF1ZXJ5ID09PSBqUXVlcnkpIHsKICAgICAgd2luZG93LmpRdWVyeSA9IF9qUXVlcnk7CiAgICB9CiAgICByZXR1cm4galF1ZXJ5OwogIH07CgogIC8vIEV4cG9zZSBqUXVlcnkgYW5kICQgaWRlbnRpZmllcnMsIGV2ZW4gaW4gQU1ECiAgLy8gKHRyYWMtNzEwMiNjb21tZW50OjEwLCBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS9wdWxsLzU1NykKICAvLyBhbmQgQ29tbW9uSlMgZm9yIGJyb3dzZXIgZW11bGF0b3JzICh0cmFjLTEzNTY2KQogIGlmICh0eXBlb2Ygbm9HbG9iYWwgPT09ICJ1bmRlZmluZWQiKSB7CiAgICB3aW5kb3cualF1ZXJ5ID0gd2luZG93LiQgPSBqUXVlcnk7CiAgfQogIHJldHVybiBqUXVlcnk7Cn0pOw=="},null]}